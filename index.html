<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOGI-OPS V12.2 (TACTICAL)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>

    <!-- FIREBASE (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap');
        body { font-family: 'JetBrains Mono', monospace; background-color: #050505; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #000; border-left: 1px solid #14532d; }
        ::-webkit-scrollbar-thumb { background: #14532d; border: 1px solid #000; }
        ::-webkit-scrollbar-thumb:hover { background: #22c55e; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        .login-scan {
            background: linear-gradient(to bottom, transparent 50%, rgba(0, 255, 0, 0.02) 51%, transparent 51%);
            background-size: 100% 4px;
            animation: scan 2s linear infinite;
        }
        @keyframes scan { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }
        @keyframes flash-red {
            0%, 100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.8); }
            50% { box-shadow: 0 0 40px rgba(239, 68, 68, 0.5); border-color: rgba(239, 68, 68, 1); }
        }
        .animate-alert { animation: flash-red 2s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ... (Configuration Firebase identique)
        const firebaseConfig = {
            apiKey: "AIzaSyASPGZJO1JU5GeoBtmj5UTP8ErPSQIPeFA",
            authDomain: "logiops-data.firebaseapp.com",
            projectId: "logiops-data",
            storageBucket: "logiops-data.firebasestorage.app",
            messagingSenderId: "791163499354",
            appId: "1:791163499354:web:2bb76506331db9d240b963",
            measurementId: "G-FFMXKH47M9"
        };

        let db = null;
        let USE_FIREBASE = false;
        const isConfigured = firebaseConfig.projectId !== "PROJECT_ID";

        if (typeof __firebase_config !== 'undefined') {
            try {
                const envConfig = JSON.parse(__firebase_config);
                if (!firebase.apps.length) firebase.initializeApp(envConfig);
                db = firebase.firestore();
                USE_FIREBASE = true;
            } catch (e) { console.warn("Erreur init Canvas config", e); }
        } else if (isConfigured) {
            try {
                if (!firebase.apps.length) {
                    const app = firebase.initializeApp(firebaseConfig);
                    if (firebase.analytics) { firebase.analytics(); }
                }
                db = firebase.firestore();
                USE_FIREBASE = true;
            } catch (e) {
                USE_FIREBASE = false;
            }
        } else {
            USE_FIREBASE = false;
        }

        const SESSION_ID = typeof __app_id !== 'undefined' ? __app_id : "operation_actuelle";
        const LOCAL_STORAGE_KEY = "logiops_data_v12";

        const StorageService = {
            save: (data) => {
                if (USE_FIREBASE && db) {
                    db.collection('logiops').doc(SESSION_ID).set(data, { merge: true }).catch(err => console.warn(err));
                } else {
                    try {
                        const existing = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '{}');
                        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ ...existing, ...data }));
                    } catch (e) { console.warn(e); }
                }
            },
            loadLocal: () => {
                try {
                    const local = localStorage.getItem(LOCAL_STORAGE_KEY);
                    return local ? JSON.parse(local) : null;
                } catch (e) { return null; }
            },
            loadInitial: (callback) => {
                if (USE_FIREBASE && db) {
                    return db.collection('logiops').doc(SESSION_ID).onSnapshot((doc) => {
                        if (doc.exists) callback(doc.data()); else callback(null);
                    }, err => {
                        const local = localStorage.getItem(LOCAL_STORAGE_KEY);
                        if (local) callback(JSON.parse(local));
                    });
                } else {
                    const local = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (local) callback(JSON.parse(local)); else callback(null);
                    return () => {};
                }
            }
        };

        const { useState, useMemo, useEffect } = React;

        // ... (Données Statiques identiques)
        const INITIAL_CATALOG = [
            { id: 'l1', cat: 'LOGI', name: 'JEEP EM', type: 'TRANSPORT EM', cost: 110, stock: 2 },
            { id: 'l2', cat: 'LOGI', name: 'CAMION RÉPA.', type: 'MAINTENANCE', cost: 175, stock: 1 },
            { id: 'l4', cat: 'LOGI', name: 'CAMION CITERNE', type: 'RAVITAILLEMENT', cost: 160, stock: 1 },
            { id: 'l5', cat: 'LOGI', name: 'CAMION ARSENAL', type: 'RAVITAILLEMENT', cost: 380, stock: 1 },
            { id: 'l6', cat: 'LOGI', name: 'CAMION CONST.', type: 'RAVITAILLEMENT', cost: 260, stock: 1 },
            { id: 't1', cat: 'TRANS', name: 'CAMION TROUPES', type: 'TRANSPORT', cost: 200, stock: 4 },
            { id: 't2', cat: 'TRANS', name: 'VAB', type: 'TRANSPORT BLINDÉ', cost: 1200, stock: 1 },
            { id: 'b1', cat: 'BLINDE', name: 'JLTV M1280', type: 'LÉGER NON-ARMÉ', cost: 650, stock: 1 },
            { id: 'b2', cat: 'BLINDE', name: 'JLTV M1281', type: 'LÉGER 12.7', cost: 1000, stock: 1 },
            { id: 'b4', cat: 'BLINDE', name: 'JLTV M1278', type: 'LÉGER TÉLÉ-OP', cost: 1500, stock: 1 },
            { id: 'c1', cat: 'VCI', name: 'STRYKER M1126', type: 'COMBAT INFANTERIE', cost: 2000, stock: 2 },
            { id: 'c2', cat: 'VCI', name: 'STRYKER M1296', type: 'CANON 30MM', cost: 3000, stock: 1 },
            { id: 's1', cat: 'SANTE', name: 'STRYKER EVASAN', type: 'SANITAIRE', cost: 975, stock: 1 },
            { id: 'h1', cat: 'CHAR', name: 'LECLERC', type: 'CHAR DE BATAILLE', cost: 8000, stock: 1 },
            { id: 'h2', cat: 'CHAR', name: 'LECLERC XLR', type: 'CHAR DE BATAILLE', cost: 8300, stock: 1 },
            { id: 'a1', cat: 'AIR', name: 'NH90 FAUCON', type: 'MEDEVAC', cost: 3000, stock: 1 },
            { id: 'a2', cat: 'AIR', name: 'NH90 FAUCON', type: 'TRANSPORT', cost: 3000, stock: 1 },
            { id: 'a6', cat: 'AIR', name: 'GAZELLE HAP', type: 'ATTAQUE', cost: 3500, stock: 1 },
        ];

        const CATEGORIES = {
            'LOGI': { label: 'LOGISTIQUE', icon: 'Truck', color: 'border-yellow-600 text-yellow-500 bg-yellow-900/10' },
            'TRANS': { label: 'TRANSPORT', icon: 'Package', color: 'border-blue-600 text-blue-400 bg-blue-900/10' },
            'BLINDE': { label: 'BLINDÉS', icon: 'Shield', color: 'border-orange-600 text-orange-400 bg-orange-900/10' },
            'VCI': { label: 'VCI', icon: 'Crosshair', color: 'border-red-600 text-red-400 bg-red-900/10' },
            'SANTE': { label: 'SANITAIRE', icon: 'Activity', color: 'border-emerald-600 text-emerald-400 bg-emerald-900/10' },
            'CHAR': { label: 'LOURD', icon: 'Shield', color: 'border-purple-600 text-purple-400 bg-purple-900/10' },
            'AIR': { label: 'AÉRIEN', icon: 'Plane', color: 'border-cyan-600 text-cyan-300 bg-cyan-900/10' },
        };

        const MISSION_TYPES = {
            'LOGI': ['RAVITAILLEMENT (AMMO)', 'RAVITAILLEMENT (BUILD)', 'CONSTRUCTION FOB', 'RÉPARATION SITE', 'RÉCUPÉRATION ÉPAVE', 'ORGANISATION'],
            'TRANS': ['DÉPLOIEMENT INFANTERIE', 'EXTRACTION', 'NAVETTE BASE/FRONT', 'RAVITAILLEMENT TROUPES'],
            'BLINDE': ['APPUI FEU', 'ESCORTE CONVOI', 'PATROUILLE', 'RECONNAISSANCE', 'DÉMINAGE (EOD)'],
            'VCI': ['ASSAUT MÉCANISÉ', 'TRANSPORT ASSAUT', 'APPUI INFANTERIE'],
            'SANTE': ['EVASAN (URGENCE)', 'SOUTIEN MÉDICAL', 'VADROUILLE SANITAIRE'],
            'CHAR': ['ASSAUT BLINDÉ', 'DESTRUCTION OBJECTIF', 'DÉFENSE DE ZONE'],
            'AIR': ['TRANSPORT AÉRIEN', 'CAS (APPUI FEU)', 'RECONNAISSANCE AÉRIENNE', 'EVASAN AÉRIENNE']
        };

        // ... (Icons setup - same as before)
        const SVG_PATHS = {
            'Power': <path d="M18.36 6.64a9 9 0 1 1-12.73 0M12 2v10" />,
            'Activity': <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />,
            'Shield': <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />,
            'Lock': <><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>,
            'User': <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></>,
            'Menu': <><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></>,
            'XCircle': <><circle cx="12" cy="12" r="10" /><line x1="15" y1="9" x2="9" y2="15" /><line x1="9" y1="9" x2="15" y2="15" /></>,
            'Trash2': <><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></>,
            'Plus': <><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></>,
            'Play': <polygon points="5 3 19 12 5 21 5 3" />,
            'Settings': <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.18-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.18-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />,
            'ChevronDown': <polyline points="6 9 12 15 18 9" />,
            'Truck': <><rect x="1" y="3" width="15" height="13" rx="2" ry="2"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></>,
            'Package': <><path d="M16.5 9.4 7.55 4.24" /><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /><polyline points="3.27 6.96 12 12.01 20.73 6.96" /><line x1="12" y1="22.08" x2="12" y2="12" /></>,
            'Crosshair': <><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></>,
            'Plane': <path d="M20.38 3.4a1.6 1.6 0 0 1 2.36 2.26L20 8.4l-6.6 1.3-5.7-5.7-1.4 1.4 5 5.7-7.7 2.7-2.8-2.9L0 12.4l6.4 3.2 3.2 6.4 1.4-1.4-2.9-2.8 2.7-7.7 5.7 5 1.4-1.4-5.7-5.7 2.7-2.7z" />,
            'Edit': <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" />,
            'Wrench': <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />,
            'List': <><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></>,
            'AlertOctagon': <><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></>,
            'Check': <polyline points="20 6 9 17 4 12" />,
            'LogOut': <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>,
            'Send': <><line x1="22" y1="2" x2="11" y2="13" /><polygon points="22 2 15 22 11 13 2 9 22 2" /></>,
            'PlusCircle': <><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></>,
            'MinusCircle': <><circle cx="12" cy="12" r="10"/><line x1="8" y1="12" x2="16" y2="12"/></>,
            'Bell': <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" />,
            'UserPlus': <><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="8.5" cy="7" r="4" /><line x1="20" y1="8" x2="20" y2="14" /><line x1="23" y1="11" x2="17" y2="11" /></>,
            'Flag': <><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" /><line x1="4" y1="22" x2="4" y2="15" /></>,
            'MessageSquare': <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />,
            'ClipboardList': <><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></>,
            'Calendar': <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
            'CheckSquare': <><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></>,
            'Map': <><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></>,
            'Target': <><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></>,
            'Briefcase': <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />,
            'Users': <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></>,
            'SteeringWheel': <><circle cx="12" cy="12" r="10"/><path d="M12 2v20"/><path d="M2 12h20"/></> // Fallback representation
        };

        const Icon = ({ name, size = 24, className, ...props }) => {
            if (typeof lucide !== 'undefined' && lucide.icons) {
                const keys = Object.keys(lucide.icons);
                const key = keys.find(k => k.toLowerCase() === name.toLowerCase());
                if (key) {
                    const iconData = lucide.icons[key];
                    if (Array.isArray(iconData)) {
                        const [tag, attrs, children] = iconData;
                        return React.createElement(tag, { ...attrs, width: size, height: size, className, ...props, stroke: props.color || "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" }, 
                            children.map(([childTag, childAttrs], i) => React.createElement(childTag, { ...childAttrs, key: i }))
                        );
                    }
                }
            }
            const fallbackContent = SVG_PATHS[name];
            if (fallbackContent) {
                return (
                    <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                        {fallbackContent}
                    </svg>
                );
            }
            return null;
        };

        const Icons = {};
        ['Truck','Activity','AlertTriangle','Crosshair','Shield','Plane','Package','Plus','ArrowRight','RotateCcw','XCircle','LayoutGrid','List','PlayCircle','CheckCircle','Wrench','Skull','MapPin','User','FileText','Clock','ArrowUpRight','PieChart','BarChart3','Timer','Database','Trash2','Save','Users','UserPlus','UserMinus','LogOut','ScrollText','Warehouse','LayoutDashboard','Settings','Target','Radio','Wifi','PlusCircle','MinusCircle','Edit','Play','Lock','Unlock','Menu','Power','ChevronDown','AlertOctagon','Check','Send','Bell','Flag','MessageSquare','ClipboardList','Calendar','CheckSquare','Map','Briefcase','SteeringWheel'].forEach(name => {
            Icons[name] = (props) => <Icon name={name} {...props} />;
        });

        // ... (Sous-Composants: ClockDisplay, NotificationToast, StatCard, ActionButton, etc. identiques)
        const ClockDisplay = () => {
            const [time, setTime] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);
            return (
                <div className="text-[10px] md:text-xs font-mono text-green-600 border border-green-900/30 px-2 py-1 bg-black rounded hidden md:block ml-auto">
                    {time.toLocaleDateString()} - {time.toLocaleTimeString()}
                </div>
            );
        };

        const NotificationToast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 5000); 
                return () => clearTimeout(timer);
            }, []);

            let bgClass = "bg-blue-600";
            if (type === 'alert') bgClass = "bg-red-600";
            if (type === 'success') bgClass = "bg-green-600";

            return (
                <div className={`fixed top-16 right-4 z-[200] ${bgClass} text-white px-4 py-3 rounded shadow-2xl border border-white/20 flex items-center gap-4 toast-enter max-w-[90vw] sm:max-w-sm`}>
                    <div className="flex-1 font-bold text-xs sm:text-sm uppercase tracking-wide">{message}</div>
                    <button onClick={onClose} className="text-white/70 hover:text-white"><Icon name="XCircle" size={18}/></button>
                </div>
            );
        };

        const StatCard = ({ color, value, label, active, onClick }) => {
            const colors = { 
                gray: "border-gray-800 bg-gray-900/10 text-gray-400", 
                green: "border-green-800 bg-green-900/10 text-green-500", 
                blue: "border-blue-800 bg-blue-900/10 text-blue-500", 
                orange: "border-orange-800 bg-orange-900/10 text-orange-500", 
                red: "border-red-800 bg-red-900/10 text-red-500",
                purple: "border-purple-800 bg-purple-900/10 text-purple-500" 
            };
            const activeClass = active ? `ring-1 ring-offset-1 ring-${color}-500 bg-opacity-30` : 'opacity-70 hover:opacity-100';
            return <button onClick={onClick} className={`border p-1 md:p-4 text-center relative overflow-hidden transition-all rounded ${colors[color]} ${activeClass} flex-1 min-w-[60px]`}><span className="text-xl md:text-4xl font-black block leading-none">{value}</span><span className="text-[8px] md:text-xs font-bold uppercase tracking-widest">{label}</span></button>;
        };

        const ActionButton = ({ onClick, icon: Icon, label, color }) => (<button onClick={onClick} className={`text-[10px] md:text-xs font-bold bg-${color}-900/20 border border-${color}-800 px-3 py-2 md:py-1.5 text-${color}-400 hover:bg-${color}-900/40 hover:border-${color}-500 flex items-center justify-center gap-2 transition-colors rounded`}>{Icon && <Icon size={14} />} {label}</button>);
        const NavButton = ({ icon: Icon, label, active, onClick, disabled }) => (<button onClick={onClick} disabled={disabled} className={`flex flex-col items-center justify-center gap-1 transition-all border-t-2 ${active?'text-green-400 border-green-500 bg-green-900/20':disabled?'text-green-900 opacity-30':'text-green-900 border-transparent hover:text-green-600'}`}>{Icon && <Icon size={18}/>} <span className="text-[8px] font-black tracking-widest">{label}</span></button>);
        const NavButtonDesktop = ({ icon: Icon, label, active, onClick, disabled }) => (<button onClick={onClick} disabled={disabled} className={`w-full flex items-center gap-3 px-4 py-3 transition-all border-l-4 text-left ${active?'text-green-400 border-green-500 bg-green-900/20':disabled?'text-green-900 border-transparent opacity-30':'text-gray-500 border-transparent hover:text-green-500 hover:bg-green-900/10'}`}>{Icon && <Icon size={20}/>} <span className="text-xs font-black tracking-widest uppercase">{label}</span></button>);
        const EmptyState = ({ canEdit, Target }) => (<div className="flex flex-col items-center justify-center h-64 md:h-96 border border-dashed border-green-900 bg-green-900/5 rounded-lg m-2">{Target && <Target size={48} className="mb-4 text-green-900 opacity-50" />}<p className="text-sm font-bold uppercase text-green-800 tracking-widest">AUCUNE UNITÉ DÉPLOYÉE</p>{canEdit && <p className="text-xs text-green-900 mt-2">ACCÉDER AU GARAGE POUR DÉPLOIEMENT</p>}</div>);
        const GarageSlot = ({ model, index, activeCount, onDeploy, ArrowUpRight }) => { const isAvailable = index >= activeCount; return (<button disabled={!isAvailable} onClick={isAvailable ? onDeploy : undefined} className={`relative p-1 md:p-3 border flex flex-col items-center justify-center text-center h-20 md:h-32 transition-all rounded ${isAvailable ? 'bg-green-900/10 border-green-800 hover:bg-green-900/30 hover:border-green-500 active:scale-95 group' : 'bg-black border-green-900/30 opacity-30 cursor-default'}`}>{isAvailable ? (<><div className="absolute top-1 right-1 w-1.5 h-1.5 bg-green-500 shadow-[0_0_5px_#22c55e] rounded-full"></div><span className="mt-1 text-[9px] md:text-xs font-black text-green-400 leading-tight uppercase px-1 truncate w-full">{model.name}</span><span className="text-[9px] text-green-800 font-mono mt-1 hidden sm:block">{model.cost} PTS</span></>) : (<div className="flex flex-col items-center">{ArrowUpRight && <ArrowUpRight size={20} className="text-green-900 mb-1"/>}<span className="text-[9px] font-black text-green-900 uppercase tracking-widest">MISS.</span></div>)}<div className="absolute bottom-0.5 left-1 text-[7px] font-mono text-green-900">#{index+1}</div></button>); };
        const Modal = ({ title, color, onClose, children, Icon }) => (<div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in"><div className={`bg-black border border-${color}-800 w-full max-w-lg p-4 md:p-6 relative shadow-[0_0_30px_rgba(0,0,0,0.5)] max-h-[90vh] overflow-y-auto rounded`}><div className="flex justify-between items-center mb-6"><h3 className={`text-lg font-black uppercase text-${color}-500 tracking-widest`}>{title}</h3><button onClick={onClose} className={`text-${color}-700 hover:text-${color}-400`}>{Icon && <Icon size={20} />}</button></div>{children}</div></div>);
        function StatusBtn({ label, active, color, onClick }) { const styles = { green: active ? 'bg-green-600 text-black' : 'bg-black text-green-700 border-green-900 hover:text-green-500', blue: active ? 'bg-blue-600 text-black' : 'bg-black text-blue-700 border-blue-900 hover:text-blue-500', orange: active ? 'bg-orange-600 text-black' : 'bg-black text-orange-700 border-orange-900 hover:text-orange-500', red: 'bg-black text-red-800 border-red-900 hover:text-red-500' }; return <button onClick={onClick} className={`text-[9px] font-black py-1 border ${styles[color]} transition-all uppercase rounded`}>{label}</button>; }
        function MissionTimer({ startTime }) { const [d, sD] = useState('00:00:00'); useEffect(() => { const t = setInterval(() => { const df = Date.now() - startTime; const h = Math.floor(df / 3600000).toString().padStart(2, '0'); const m = Math.floor((df % 3600000) / 60000).toString().padStart(2, '0'); const s = Math.floor((df % 60000) / 1000).toString().padStart(2, '0'); sD(`${h}:${m}:${s}`); }, 1000); return () => clearInterval(t); }, [startTime]); return <span className="font-mono text-blue-400 font-bold bg-blue-900/30 px-2 py-0.5 text-[10px] border border-blue-900 rounded">T+{d}</span>; }

        // UPDATED UNIT CARD to support self-assignment
        function UnitCard({ unit, onStatusChange, onEndMission, onRTB, onShowLogs, Icons, readOnly, userIdentity, onStartMission, onRequestRTB, onValidateRTB, onAddCrew, onSitrep, onConfirmArrival, canAssignSelf, onTakeDriver, onTakePax }) { 
            let borderColor='border-green-600'; let statusText='text-green-500';
            if(unit.status.includes('mission')){ borderColor='border-blue-600'; statusText='text-blue-500'; }
            else if(unit.status==='damaged'){ borderColor='border-orange-600'; statusText='text-orange-500'; }
            else if(unit.status==='destroyed'){ borderColor='border-red-600'; statusText='text-red-600'; }
            
            const isMyUnit = unit.responsible === userIdentity; 
            const isInCrew = unit.crew && unit.crew.includes(userIdentity);
            const isSL = !readOnly;
            const isPendingMission = unit.status === 'mission_reserved'; // New status for unassigned vehicles

            const IconComp=Icons[CATEGORIES[unit.cat]?.icon||'Truck']; const List=Icons['List']; const Clock=Icons['Clock']; const RotateCcw=Icons['RotateCcw']; const XCircle=Icons['XCircle']; const Send=Icons['Send']; const Check=Icons['Check']; const UserPlus=Icons['UserPlus']; const MessageSquare=Icons['MessageSquare']; const CheckSquare=Icons['CheckSquare']; const SteeringWheel=Icons['SteeringWheel'];
            
            return (<div className={`relative border-l-4 ${borderColor} bg-green-900/5 p-2 md:p-3 flex flex-col h-auto border-t border-r border-b border-green-900/30 hover:bg-green-900/10 transition-all rounded-r min-h-[8rem]`}>
                <div className="flex justify-between items-start mb-2"><div className="flex gap-2 overflow-hidden"><div className={`p-1.5 bg-black border border-green-900 flex items-center justify-center h-8 w-8 shrink-0 rounded ${statusText}`}>{IconComp && <IconComp size={16}/>}</div><div className="min-w-0"><h3 className={`font-black text-xs md:text-sm text-gray-300 truncate uppercase leading-tight ${unit.status === 'destroyed' && 'line-through opacity-50'}`}>{unit.name}</h3><div className="flex flex-col gap-0.5 mt-0.5"><span className="text-[9px] text-green-800 font-mono hidden sm:block">{unit.cost} PTS</span>
                {/* RESPONSIBLE DISPLAY OR ASSIGN BUTTON */}
                {(unit.responsible!=='BASE' && unit.responsible!=='PENDING') ? (
                    <div className="flex flex-wrap gap-1 mt-1">
                        <span className={`text-[8px] px-1 border truncate max-w-[80px] rounded ${isMyUnit?'bg-yellow-900/20 text-yellow-400 border-yellow-900':'bg-blue-900/20 text-blue-400 border-blue-900/50'}`}>{unit.responsible}</span>
                        {unit.crew && unit.crew.map((c, idx) => (
                            <span key={idx} className="text-[8px] px-1 border border-green-900/50 text-green-600 bg-green-900/10 rounded" title="Équipier">{c}</span>
                        ))}
                    </div>
                ) : (
                    canAssignSelf && unit.status !== 'operational' && (
                        <div className="flex gap-1 mt-1">
                            <button onClick={onTakeDriver} className="text-[8px] px-2 py-1 bg-green-900/30 border border-green-600 text-green-400 font-bold rounded hover:bg-green-900/60 flex items-center gap-1">
                                {SteeringWheel && <SteeringWheel size={10}/>} CONDUIRE
                            </button>
                            <button onClick={onTakePax} className="text-[8px] px-2 py-1 bg-blue-900/30 border border-blue-600 text-blue-400 font-bold rounded hover:bg-blue-900/60 flex items-center gap-1">
                                {UserPlus && <UserPlus size={10}/>} MONTER
                            </button>
                        </div>
                    )
                )}
                </div></div></div><button onClick={onShowLogs} className="text-green-900 hover:text-green-500 p-1 shrink-0">{List && <List size={14} />}</button></div>
                
                <div className="mt-auto space-y-2">
                    {/* MISSION TYPE DISPLAY */}
                    {unit.missionObjective && unit.status !== 'destroyed' && unit.status !== 'operational' && (
                        <div className="text-[9px] font-bold text-gray-400 uppercase bg-black/50 px-1 border-l-2 border-blue-500">
                            OBJ: {unit.missionObjective}
                        </div>
                    )}

                    {unit.status === 'destroyed' ? (
                        <div className="bg-red-900/10 border border-red-900/50 p-1 text-center mb-2 rounded"><p className="text-[8px] text-red-700 font-bold uppercase">CAUSE: {unit.reasonHS}</p></div>
                    ) : (
                        <>
                            {/* STATUS LOGIC */}
                            {(unit.status === 'mission' || unit.status === 'mission_pending' || unit.status === 'mission_reserved') && (
                                <div className="space-y-2">
                                    {/* TIMER IF STARTED */}
                                    {unit.missionStartTime && <div className="flex items-center gap-1 justify-center">{Clock && <Clock size={10} className="text-blue-600"/>}<MissionTimer startTime={unit.missionStartTime} /></div>}
                                    
                                    {/* ACTIONS FOR DRIVER */}
                                    {isMyUnit && unit.status === 'mission_pending' && (
                                         <button onClick={onStartMission} className="w-full py-1.5 bg-green-600 text-black font-black text-[10px] hover:bg-green-500 flex items-center justify-center gap-1 rounded">{Send && <Send size={12}/>} DÉPART MISSION</button>
                                    )}

                                    {isMyUnit && unit.status === 'mission' && (
                                        <div className="grid grid-cols-2 gap-1">
                                            <button onClick={onSitrep} className="py-1 bg-yellow-900/20 border border-yellow-700 text-yellow-500 font-black text-[10px] hover:bg-yellow-900/40 flex items-center justify-center gap-1 rounded">{MessageSquare && <MessageSquare size={12}/>} SITREP</button>
                                            <button onClick={onRequestRTB} className="py-1 bg-blue-900/30 border border-blue-600 text-blue-400 font-black text-[10px] hover:bg-blue-900/50 rounded">RTB</button>
                                        </div>
                                    )}
                                    
                                    {/* RTB STATES */}
                                    {unit.status === 'mission_rtb_request' && (
                                        <div className="text-center">
                                            {isSL ? (
                                                <button onClick={onValidateRTB} className="w-full py-1 bg-green-600 text-black font-black text-[10px] hover:bg-green-500 flex items-center justify-center gap-1 animate-pulse rounded">{Check && <Check size={12}/>} AUTORISER RETOUR</button>
                                            ) : (
                                                <span className="text-[10px] text-blue-400 font-bold border border-blue-900/50 px-2 py-1 bg-blue-900/10 animate-pulse rounded">ATTENTE SL</span>
                                            )}
                                        </div>
                                    )}
                                    {unit.status === 'mission_rtb_transit' && (
                                        <div className="text-center space-y-2">
                                            <div className="text-[9px] text-blue-300 font-mono animate-pulse">RETOUR BASE EN COURS</div>
                                            {isMyUnit && (
                                                <button onClick={onConfirmArrival} className="w-full py-1.5 bg-green-900/30 border border-green-600 text-green-400 font-black text-[10px] hover:bg-green-900/50 rounded flex items-center justify-center gap-1">{CheckSquare && <CheckSquare size={12}/>} ARRIVÉE BASE</button>
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {/* 5. STANDARD STATUS (OPS/DAMAGED) */}
                            {(unit.status === 'operational' || unit.status === 'damaged') && (
                                isSL ? (
                                    <div className="grid grid-cols-4 gap-1">
                                        <StatusBtn label="OPS" active={unit.status === 'operational'} color="green" onClick={() => !readOnly && onStatusChange('operational')} />
                                        <StatusBtn label="MIS" active={false} color="blue" onClick={() => !readOnly && onStatusChange('mission')} />
                                        <StatusBtn label="RÉP" active={unit.status === 'damaged'} color="orange" onClick={() => !readOnly && onStatusChange('damaged')} />
                                        <StatusBtn label="HS" active={false} color="red" onClick={() => !readOnly && onStatusChange('destroyed')} />
                                    </div>
                                ) : (
                                    <div className="text-center py-1"><span className={`text-[10px] font-black ${unit.status==='operational'?'text-green-600':'text-orange-600'}`}>{unit.status.toUpperCase()}</span></div>
                                )
                            )}
                        </>
                    )}
                </div>
                {isSL && (
                    <div className="flex justify-end pt-1 border-t border-green-900/20 mt-2">
                         {unit.status !== 'destroyed' ? 
                            <button onClick={onRTB} className="text-[9px] font-bold text-green-800 hover:text-green-500 uppercase flex items-center gap-1">{RotateCcw && <RotateCcw size={10} />} RETOUR</button> :
                            <button onClick={onRTB} className="text-[9px] font-bold text-red-800 hover:text-red-500 uppercase flex items-center gap-1">{XCircle && <XCircle size={10} />} ARCHIVER</button>
                         }
                    </div>
                )}
            </div>); 
        }

        // --- LOGIN SCREEN (Identique) ---
        function LoginScreen({ onLogin, squad }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [mode, setMode] = useState('MAIN'); 
            const [selectedMember, setSelectedMember] = useState('');
            const Shield = Icons['Shield']; const Lock = Icons['Lock']; const User = Icons['User'];

            const handleSL = (e) => { e.preventDefault(); if (username === 'SLLOGI' && password === 'sllogi') { onLogin('SL'); } else { setError('IDENTIFIANTS INCORRECTS'); } };
            const handleLogi = () => { if(!selectedMember) return; onLogin('LOGI', selectedMember); };

            if (mode === 'MAIN') {
                return (
                    <div className="min-h-screen bg-black flex items-center justify-center p-4 login-scan w-full h-full fixed inset-0 overflow-hidden">
                        <div className="w-full max-w-md border border-green-800 bg-black relative p-8 shadow-[0_0_50px_rgba(0,255,0,0.1)] z-10 text-center space-y-6 rounded">
                            <h1 className="text-2xl font-black text-green-500 tracking-[0.3em]">LOGI-OPS</h1>
                            <div className="space-y-4">
                                <button onClick={() => setMode('SL')} className="w-full py-4 border border-green-600 text-green-500 font-bold hover:bg-green-900/20 rounded">COMMANDEMENT (SL)</button>
                                <button onClick={() => setMode('LOGI')} className="w-full py-4 border border-blue-600 text-blue-500 font-bold hover:bg-blue-900/20 rounded">LOGISTICIEN</button>
                            </div>
                        </div>
                    </div>
                );
            }
            if (mode === 'SL') {
                return (
                      <div className="min-h-screen bg-black flex items-center justify-center p-4 login-scan w-full h-full fixed inset-0 overflow-hidden">
                        <div className="w-full max-w-md border border-green-800 bg-black relative p-8 shadow-[0_0_50px_rgba(0,255,0,0.1)] z-10 rounded">
                            <h2 className="text-xs font-bold text-green-600 uppercase mb-4 text-center">CONNEXION SL</h2>
                            <form onSubmit={handleSL} className="space-y-4">
                                <input type="text" placeholder="ID" value={username} onChange={e => setUsername(e.target.value)} className="w-full bg-green-900/10 border border-green-800 p-3 text-green-400 text-xs font-bold outline-none focus:border-green-500 rounded" />
                                <input type="password" placeholder="MDP" value={password} onChange={e => setPassword(e.target.value)} className="w-full bg-green-900/10 border border-green-800 p-3 text-green-400 text-xs font-bold outline-none focus:border-green-500 rounded" />
                                {error && <p className="text-red-500 text-center text-xs">{error}</p>}
                                <button type="submit" className="w-full bg-green-600 text-black font-black py-3 rounded">ENTRER</button>
                            </form>
                             <button onClick={() => setMode('MAIN')} className="text-xs text-green-800 mt-4 w-full text-center hover:text-green-500">RETOUR</button>
                        </div>
                    </div>
                );
            }
            if (mode === 'LOGI') {
                 return (
                      <div className="min-h-screen bg-black flex items-center justify-center p-4 login-scan w-full h-full fixed inset-0 overflow-hidden">
                        <div className="w-full max-w-md border border-blue-800 bg-black relative p-8 shadow-[0_0_50px_rgba(0,0,255,0.1)] z-10 rounded">
                            <h2 className="text-xs font-bold text-blue-600 uppercase mb-4 text-center">IDENTIFICATION LOGISTICIEN</h2>
                            <div className="space-y-4">
                                <select value={selectedMember} onChange={(e) => setSelectedMember(e.target.value)} className="w-full bg-blue-900/10 border border-blue-800 p-3 text-blue-400 outline-none font-bold rounded">
                                    <option value="">-- QUI ÊTES-VOUS ? --</option>
                                    {squad && squad.map(m => <option key={m.id} value={m.name}>{m.name}</option>)}
                                </select>
                                <button onClick={handleLogi} disabled={!selectedMember} className="w-full bg-blue-600 text-black font-black py-3 hover:bg-blue-500 disabled:opacity-50 rounded">VALIDER</button>
                            </div>
                             <button onClick={() => setMode('MAIN')} className="text-xs text-blue-800 mt-4 w-full text-center hover:text-blue-500">RETOUR</button>
                        </div>
                    </div>
                );
            }
        }
        
        // ==========================================
        // 5. APPLICATION PRINCIPALE
        // ==========================================
        function LogiOpsV9() {
            // ... (States and Logic)
            const [userRole, setUserRole] = useState(null); 
            const [userIdentity, setUserIdentity] = useState(null); 
            const [activeTab, setActiveTab] = useState('dashboard'); 
            const [activeUnits, setActiveUnits] = useState([]);
            const [catalog, setCatalog] = useState(INITIAL_CATALOG);
            const [squad, setSquad] = useState([]); 
            const [globalLogs, setGlobalLogs] = useState([]); 
            const [supplySources, setSupplySources] = useState([{ id: 'base', name: 'BASE PRINCIPALE', amount: 38000 }]);
            const [slName, setSlName] = useState(''); 
            const [isSlActive, setIsSlActive] = useState(false);
            const [configurations, setConfigurations] = useState([]);
            const [dataLoaded, setDataLoaded] = useState(false);
            const [actionModal, setActionModal] = useState(null);
            const [showSupplyModal, setShowSupplyModal] = useState(false);
            const [showStockModal, setShowStockModal] = useState(false);
            const [showConfigModal, setShowConfigModal] = useState(false);
            const [showCreateVehicleModal, setShowCreateVehicleModal] = useState(false);
            const [showCrewModal, setShowCrewModal] = useState(false); 
            const [showSitrepModal, setShowSitrepModal] = useState(false); 
            const [showMissionManagerModal, setShowMissionManagerModal] = useState(false); 
            const [showPostMissionModal, setShowPostMissionModal] = useState(false);
            
            // --- MISSION GLOBALE STATE ---
            const [showGlobalMissionModal, setShowGlobalMissionModal] = useState(false);
            const [missions, setMissions] = useState([]); 
            const [selectedMissionId, setSelectedMissionId] = useState(null);
            const [globalMissionData, setGlobalMissionData] = useState({
                title: '',
                type: 'TRANS',
                objective: '',
                squadTarget: '',
                vehicles: [] // Liste des Uuids sélectionnés par le SL
            });
            
            const [currentConfigId, setCurrentConfigId] = useState(null);
            const [inputReason, setInputReason] = useState('');
            const [selectedMemberId, setSelectedMemberId] = useState('');
            const [selectedMissionType, setSelectedMissionType] = useState(''); 
            const [newModelData, setNewModelData] = useState({ name: '', cat: 'LOGI', type: '', cost: 0, stock: 1 });
            const [filterStatus, setFilterStatus] = useState('ALL');
            const [expandedCats, setExpandedCats] = useState(Object.keys(CATEGORIES).reduce((acc, key) => ({...acc, [key]: true}), {}));
            const [showReminderModal, setShowReminderModal] = useState(false);
            const [showShiftCheckModal, setShowShiftCheckModal] = useState(false);
            const [notification, setNotification] = useState(null);
            
            const [incomingSitrep, setIncomingSitrep] = useState(null); 
            const [sitrepData, setSitrepData] = useState({ location: '', status: 'green', message: '' });
            
            // Ancienne ref missions
            const [newMissionData, setNewMissionData] = useState({ title: '', type: 'COMBAT', vehicles: [], personnel: [] });

            const canEdit = userRole === 'SL';

            // --- LOGIQUE TACTIQUE (New in V12) ---
            
            // 1. SL Crée la mission (véhicules réservés mais pas de conducteurs)
            const toggleGlobalMissionVehicle = (uuid) => {
                setGlobalMissionData(prev => {
                    const list = prev.vehicles.includes(uuid) 
                        ? prev.vehicles.filter(id => id !== uuid) 
                        : [...prev.vehicles, uuid];
                    return { ...prev, vehicles: list };
                });
            };

            const submitGlobalMission = () => {
                if (!globalMissionData.title || globalMissionData.vehicles.length === 0) {
                    alert("Veuillez remplir le titre et sélectionner au moins un véhicule.");
                    return;
                }

                const timestamp = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                const missionId = `OP_${Date.now()}`; 
                const missionLog = `ORDRE OPÉRATIONNEL: ${globalMissionData.title} (OBJ: ${globalMissionData.objective})`;

                // Créer l'objet mission
                const newMissionObj = {
                    id: missionId,
                    title: globalMissionData.title,
                    type: globalMissionData.type,
                    objective: globalMissionData.objective,
                    squadTarget: globalMissionData.squadTarget,
                    startTime: timestamp,
                    status: 'pending', // En attente d'un leader
                    leader: null,      // Personne pour l'instant
                    participants: []   // Liste des logisticiens
                };

                setMissions([...missions, newMissionObj]);
                save('missions', [...missions, newMissionObj]);

                // Mise à jour des véhicules: "RÉSERVÉS"
                const nu = activeUnits.map(u => {
                    if (globalMissionData.vehicles.includes(u.uuid)) {
                        return {
                            ...u,
                            status: 'mission_reserved', // Nouveau statut
                            responsible: 'PENDING',     // Pas encore de chauffeur
                            missionObjective: globalMissionData.objective + (globalMissionData.squadTarget ? ` [${globalMissionData.squadTarget}]` : ''),
                            missionId: missionId,
                            logs: [...(u.logs || []), { time: timestamp, msg: `RÉSERVÉ OP: ${globalMissionData.title}` }]
                        };
                    }
                    return u;
                });

                setActiveUnits(nu);
                save('activeUnits', nu);
                logEvent('OPS', missionLog);
                
                setGlobalMissionData({ title: '', type: 'TRANS', objective: '', squadTarget: '', vehicles: [] });
                setShowGlobalMissionModal(false);
            };

            // 2. Logisticien prend le Lead
            const takeMissionCommand = (mId) => {
                if(!confirm("Prendre le commandement de cette mission ?")) return;
                const nm = missions.map(m => m.id === mId ? {...m, status: 'active', leader: userIdentity, participants: [userIdentity]} : m);
                setMissions(nm);
                save('missions', nm);
                logEvent('OPS', `${userIdentity} PREND LE COMMANDEMENT DE L'OPÉRATION.`);
            };

            // 3. Logisticien rejoint
            const joinMission = (mId) => {
                const mission = missions.find(m => m.id === mId);
                if(mission.participants.includes(userIdentity)) return;
                
                const nm = missions.map(m => m.id === mId ? {...m, participants: [...m.participants, userIdentity]} : m);
                setMissions(nm);
                save('missions', nm);
                logEvent('OPS', `${userIdentity} REJOINT L'OPÉRATION.`);
            };

            // 4. Assigner un véhicule (Soi-même)
            const selfAssignDriver = (unitUuid) => {
                const nu = activeUnits.map(u => {
                    if(u.uuid === unitUuid) {
                        return { 
                            ...u, 
                            responsible: userIdentity,
                            status: 'mission_pending', // Prêt au départ
                            logs: [...(u.logs||[]), {time: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), msg: `${userIdentity} PREND LE VOLANT`}] 
                        };
                    }
                    return u;
                });
                setActiveUnits(nu);
                save('activeUnits', nu);
            };

            const selfAssignPax = (unitUuid) => {
                const nu = activeUnits.map(u => {
                    if(u.uuid === unitUuid) {
                        const currentCrew = u.crew || [];
                        if(currentCrew.includes(userIdentity)) return u;
                        return { 
                            ...u, 
                            crew: [...currentCrew, userIdentity],
                            logs: [...(u.logs||[]), {time: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), msg: `${userIdentity} MONTE À BORD`}] 
                        };
                    }
                    return u;
                });
                setActiveUnits(nu);
                save('activeUnits', nu);
            };

            // -----------------------------------------

            // SITREP LOGIC
            const openSitrepModal = (unit) => { 
                setSitrepData({ unit: unit, location: '', status: 'green', message: '' }); 
                setShowSitrepModal(true); 
            };

            const submitSitrep = () => {
                if (!sitrepData.unit) return;
                const msg = `SITREP [${sitrepData.status.toUpperCase()}] LOC: ${sitrepData.location} // ${sitrepData.message}`;
                updateUnitData(sitrepData.unit.uuid, {
                    logs: [...(sitrepData.unit.logs || []), { time: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), msg: msg }]
                });
                logEvent('FLOTTE', `SITREP ${sitrepData.unit.name}: ${sitrepData.status.toUpperCase()}`);
                setShowSitrepModal(false);
            };

            const confirmArrival = (unit) => {
                if (!canEdit && unit.responsible !== userIdentity) return; 
                setActionModal({ type: 'post_mission', unit });
                setShowPostMissionModal(true);
            };

            const endMission = (unit) => { confirmArrival(unit); };

            const finalizeMission = (finalStatus) => {
                if (!actionModal || !actionModal.unit) return;
                const unit = actionModal.unit;
                const logMsg = finalStatus === 'operational' ? 'MISSION TERMINÉE: RETOUR DISPO (RAS)' : 'MISSION TERMINÉE: ENVOI ATELIER (DOMMAGES)';
                updateUnitData(unit.uuid, {
                    status: finalStatus, responsible: 'BASE', crew: [], missionStartTime: null, missionId: null,
                    logs: [...(unit.logs || []), { time: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), msg: logMsg }]
                });
                logEvent('OPS', `${unit.name}: ${logMsg}`);
                setShowPostMissionModal(false);
                setActionModal(null);
            };

            const endWholeMission = (mId) => {
                if(!confirm("TERMINER LA MISSION ET LIBÉRER TOUS LES VÉHICULES ?")) return;
                const nu = activeUnits.map(u => {
                    if(u.missionId === mId) {
                        return { ...u, status: 'operational', responsible: 'BASE', crew: [], missionId: null, missionStartTime: null, missionObjective: null, logs: [...(u.logs||[]), {time: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), msg: "FIN DE MISSION GLOBALE"}]};
                    }
                    return u;
                });
                setActiveUnits(nu); save('activeUnits', nu);
                const nm = missions.map(m => m.id === mId ? {...m, status: 'ended'} : m);
                setMissions(nm); save('missions', nm);
                setSelectedMissionId(null);
            };

            useEffect(() => {
                let isMounted = true;
                const timeout = setTimeout(() => {
                    if (isMounted && !dataLoaded) {
                        const localData = StorageService.loadLocal();
                        if (localData) {
                           if(localData.activeUnits) setActiveUnits(localData.activeUnits);
                           if(localData.catalog) setCatalog(localData.catalog);
                           if(localData.squad) setSquad(localData.squad);
                           if(localData.globalLogs) setGlobalLogs(localData.globalLogs);
                           if(localData.supplySources) setSupplySources(localData.supplySources);
                           if(localData.slName) setSlName(localData.slName);
                           if(typeof localData.isSlActive !== 'undefined') setIsSlActive(localData.isSlActive);
                           if(localData.configurations) setConfigurations(localData.configurations);
                           if(localData.missions) setMissions(localData.missions); 
                        }
                        setDataLoaded(true);
                    }
                }, 2500);
                const unsubscribe = StorageService.loadInitial((data) => {
                    if (!isMounted) return;
                    clearTimeout(timeout);
                    if (data) {
                        if (data.activeUnits) {
                            // Notification logic (simplified for brevity)
                            const pendingMission = data.missions?.find(m => m.status === 'pending');
                            if (pendingMission && !missions.find(m => m.id === pendingMission.id)) {
                                setNotification({ message: "NOUVELLE MISSION DISPONIBLE !", type: 'alert' });
                            }
                        }
                        if(data.activeUnits) setActiveUnits(data.activeUnits);
                        if(data.catalog) setCatalog(data.catalog);
                        if(data.squad) setSquad(data.squad);
                        if(data.globalLogs) setGlobalLogs(data.globalLogs);
                        if(data.supplySources) setSupplySources(data.supplySources);
                        if(data.slName) setSlName(data.slName);
                        if(typeof data.isSlActive !== 'undefined') setIsSlActive(data.isSlActive);
                        if(data.configurations) setConfigurations(data.configurations);
                        if(data.missions) setMissions(data.missions); 
                    }
                    setDataLoaded(true);
                });
                return () => { isMounted = false; if(unsubscribe) unsubscribe(); clearTimeout(timeout); };
            }, [activeUnits, userIdentity, userRole, missions]);
            
            useEffect(() => { if (!isSlActive) return; const interval = setInterval(() => { setShowReminderModal(true); }, 30 * 60 * 1000); return () => clearInterval(interval); }, [isSlActive]);

            const isMyUnit = (u, id) => u.responsible === id;
            const save = (key, val) => StorageService.save({ [key]: val });
            const logEvent = (type, message) => { const newLog = { id: Date.now(), time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), type, msg: message }; const newLogs = [newLog, ...globalLogs].slice(0, 50); setGlobalLogs(newLogs); save('globalLogs', newLogs); };
            const clearJMO = () => { if(confirm("VIDER JMO ?")) { setGlobalLogs([]); save('globalLogs', []); } };
            const updateStock = (id, d) => { if(!canEdit)return; const c = catalog.map(m=>m.id===id?{...m,stock:Math.max(0,m.stock+d)}:m); setCatalog(c); save('catalog', c); };
            const deleteModel = (id) => { if(!canEdit||!confirm("Supprimer ?"))return; const c = catalog.filter(m=>m.id!==id); setCatalog(c); save('catalog', c); };
            const deployUnit = (id) => { if(!canEdit) return; const model = catalog.find(x=>x.id===id); if(!model) return; if(activeUnits.filter(u=>u.modelId===id).length >= model.stock) return; const source = supplySources[0]; if (!source || source.amount < model.cost) { alert(`SUPPLY INSUFFISANT !`); return; } const newSupply = supplySources.map((s, i) => i === 0 ? { ...s, amount: s.amount - model.cost } : s); setSupplySources(newSupply); save('supplySources', newSupply); const u = { uuid: Date.now()+Math.random(), modelId: model.id, name: model.name, cat: model.cat, cost: model.cost, status: 'operational', responsible: 'BASE', crew: [], reasonHS: '', missionStartTime: null, deployTime: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), logs: [] }; const nu = [u, ...activeUnits]; setActiveUnits(nu); save('activeUnits', nu); logEvent('GARAGE', `DÉPLOIEMENT: ${model.name}`); };
            const createModel = () => { if(!canEdit||!newModelData.name)return; const m={id:`custom_${Date.now()}`, cat:newModelData.cat, name:newModelData.name.toUpperCase(), type:newModelData.type.toUpperCase()||'STD', cost:parseInt(newModelData.cost)||0, stock:parseInt(newModelData.stock)||1}; const c=[...catalog, m]; setCatalog(c); save('catalog', c); setShowCreateVehicleModal(false); setNewModelData({name:'',cat:'LOGI',type:'',cost:0,stock:1}); logEvent('GARAGE', `NOUVEAU MODÈLE: ${m.name}`); };
            const toggleSlShift = () => { if(!canEdit||!slName)return; if (!isSlActive) setShowShiftCheckModal(true); else { const s=!isSlActive; setIsSlActive(s); save('isSlActive', s); save('slName', slName); logEvent('RH', `FIN SERVICE SL: ${slName}`); } };
            const confirmShiftStart = () => { setIsSlActive(true); setShowShiftCheckModal(false); save('isSlActive', true); save('slName', slName); logEvent('RH', `PRISE POSTE SL: ${slName}`); };
            const addSquadMember = (n) => { if(!canEdit||!n)return; const s=[...squad, {id:Date.now(), name:n.toUpperCase(), startTime:new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}]; setSquad(s); save('squad', s); logEvent('RH', `RENFORT: ${n.toUpperCase()}`); };
            const removeSquadMember = (id) => { if(!canEdit)return; const m=squad.find(x=>x.id===id); if(m && confirm(`DÉPART ${m.name} ?`)){ const s=squad.filter(x=>x.id!==id); setSquad(s); save('squad', s); logEvent('RH', `DÉPART: ${m.name}`); } };
            const renameSquadMember = (id) => { if (!canEdit) return; const m = squad.find(x => x.id === id); if (!m) return; const nn = prompt("Nouveau nom :", m.name); if (nn && nn !== m.name) { const ns = squad.map(x => x.id === id ? { ...x, name: nn.toUpperCase() } : x); setSquad(ns); save('squad', ns); logEvent('RH', `NOM MODIFIÉ: ${m.name} -> ${nn.toUpperCase()}`); } };
            const updateUnitData = (uuid, newData) => { const nu = activeUnits.map(u => u.uuid === uuid ? { ...u, ...newData } : u); setActiveUnits(nu); save('activeUnits', nu); };
            const confirmMission = () => { if (!actionModal) return; let respName = "INDÉFINI"; if (selectedMemberId === 'SL') respName = slName || "CHEF LOGI"; else { const member = squad.find(m => m.id === parseInt(selectedMemberId)); if (member) respName = member.name; } updateUnitData(actionModal.unit.uuid, { status: 'mission_pending', responsible: respName, logs: [...(actionModal.unit.logs || []), { time: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), msg: `ORDRE MISSION -> ${respName}` }] }); logEvent('FLOTTE', `${actionModal.unit.name}: ORDRE MISSION POUR ${respName}`); setActionModal(null); };
            const acceptMission = (unit) => { updateUnitData(unit.uuid, { status: 'mission', missionStartTime: Date.now(), logs: [...(unit.logs || []), { time: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), msg: `DÉPART MISSION` }] }); logEvent('FLOTTE', `${unit.name}: DÉPART MISSION CONFIRMÉ`); };
            const requestRTB = (unit) => { updateUnitData(unit.uuid, { status: 'mission_rtb_request', logs: [...(unit.logs || []), { time: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), msg: `DEMANDE RTB` }] }); logEvent('FLOTTE', `${unit.name}: DEMANDE RTB`); };
            const validateRTB = (unit) => { const durationMs = Date.now() - unit.missionStartTime; const minutes = Math.floor(durationMs / 60000); updateUnitData(unit.uuid, { status: 'mission_rtb_transit', logs: [...(unit.logs || []), { time: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), msg: `RETOUR AUTORISÉ` }] }); logEvent('FLOTTE', `${unit.name}: RETOUR AUTORISÉ PAR SL`); };
            const confirmDestruction = () => { if (!actionModal || !inputReason) return; updateUnitData(actionModal.unit.uuid, { status: 'destroyed', reasonHS: inputReason, missionStartTime: null, logs: [...(actionModal.unit.logs || []), {time: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), msg: `DÉTRUIT: ${inputReason}`}] }); setActionModal(null); };
            const returnToBase = (uuid) => { if(!canEdit)return; if(confirm("FORCER RTB ?")) { const u=activeUnits.find(x=>x.uuid===uuid); const nu=activeUnits.filter(x=>x.uuid!==uuid); setActiveUnits(nu); save('activeUnits', nu); if(u) logEvent('GARAGE', `RTB FORCÉ: ${u.name}`); } };
            const updateSupplySource = (id, f, v) => { if(!canEdit)return; const s=supplySources.map(x=>x.id===id?{...x,[f]:v}:x); setSupplySources(s); save('supplySources', s); };
            const addSupplySource = () => { if(!canEdit)return; const s=[...supplySources, {id:Date.now(), name:'NOUVELLE SOURCE', amount:0}]; setSupplySources(s); save('supplySources', s); };
            const removeSupplySource = (id) => { if(!canEdit||supplySources.length<=1)return; const s=supplySources.filter(x=>x.id!==id); setSupplySources(s); save('supplySources', s); };
            const createConfig = () => { if(!canEdit)return; const c=[...configurations, {id:Date.now(), name:`PHASE ${configurations.length+1}`, content:{}}]; setConfigurations(c); setCurrentConfigId(c[c.length-1].id); save('configurations', c); };
            const updateConfig = (cid, mid, d) => { if(!canEdit)return; const c=configurations.find(x=>x.id===cid); if(!c)return; const cnt=Math.max(0, (c.content[mid]||0)+d); const nc={...c.content, [mid]:cnt}; if(cnt===0) delete nc[mid]; const ncs=configurations.map(x=>x.id===cid?{...x, content:nc}:x); setConfigurations(ncs); save('configurations', ncs); };
            const setConfigCount = (cid, mid, val) => { if(!canEdit)return; const c=configurations.find(x=>x.id===cid); if(!c)return; const cnt=Math.max(0, parseInt(val)||0); const nc={...c.content, [mid]:cnt}; if(cnt===0) delete nc[mid]; const ncs=configurations.map(x=>x.id===cid?{...x, content:nc}:x); setConfigurations(ncs); save('configurations', ncs); };
            const renameConfig = (cid, val) => { if(!canEdit)return; const ncs=configurations.map(x=>x.id===cid?{...x, name:val.toUpperCase()}:x); setConfigurations(ncs); save('configurations', ncs); };
            const deleteConfig = (cid) => { if(!canEdit||!confirm("Supprimer ?"))return; const ncs=configurations.filter(x=>x.id!==cid); setConfigurations(ncs); if(currentConfigId===cid) setCurrentConfigId(null); save('configurations', ncs); };
            const deployConfig = (cid) => { if(!canEdit)return; const config=configurations.find(x=>x.id===cid); if(!config)return; let count=0; let nu=[...activeUnits]; let totalCost = 0; let pendingDeployment = []; Object.entries(config.content).forEach(([mid, target]) => { const m=catalog.find(x=>x.id===mid); if(!m)return; const curr=nu.filter(u=>u.modelId===mid).length; const needed=target-curr; if(needed>0) { const avail=m.stock-curr; const toAdd=Math.min(needed, avail); if (toAdd > 0) { totalCost += toAdd * m.cost; pendingDeployment.push({ model: m, count: toAdd }); } } }); const source = supplySources[0]; if (!source || source.amount < totalCost) { alert(`SUPPLY INSUFFISANT !\nCoût: ${totalCost}`); return; } if(pendingDeployment.length > 0) { const newSupply = supplySources.map((s, i) => i === 0 ? { ...s, amount: s.amount - totalCost } : s); setSupplySources(newSupply); save('supplySources', newSupply); pendingDeployment.forEach(item => { for(let i=0;i<item.count;i++) { nu.push({uuid:Date.now()+Math.random()+i, modelId:item.model.id, name:item.model.name, cat:item.model.cat, cost:item.model.cost, status:'operational', responsible:'BASE', crew:[], reasonHS:'', missionStartTime:null, deployTime:new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), logs:[]}); count++; } }); setActiveUnits(nu); save('activeUnits', nu); logEvent('GARAGE', `DÉPLOIEMENT PHASE: ${config.name} (+${count} UNITÉS, -${totalCost} Supply)`); } else alert("Rien à déployer."); };
            const addToCrew = (member) => { if(!actionModal || !actionModal.unit) return; const u = actionModal.unit; const currentCrew = u.crew || []; if(currentCrew.includes(member)) return; const newCrew = [...currentCrew, member]; updateUnitData(u.uuid, { crew: newCrew }); setShowCrewModal(false); };
            const acknowledgeSitrep = () => { if (incomingSitrep && incomingSitrep.unitUuid) { updateUnitData(incomingSitrep.unitUuid, { logs: [...(activeUnits.find(u=>u.uuid===incomingSitrep.unitUuid)?.logs || []), { time: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), msg: `SITREP REÇU PAR SL` }] }); } setIncomingSitrep(null); };
            const handleStatusClick = (unit, targetStatus) => { if (!canEdit) return; if (unit.status === targetStatus && targetStatus !== 'mission') return; if (targetStatus === 'mission') { setSelectedMemberId(''); setSelectedMissionType(''); setActionModal({ type: 'mission', unit }); } else if (targetStatus === 'destroyed') { setInputReason(''); setActionModal({ type: 'destroy', unit }); } else { updateUnitData(unit.uuid, { status: targetStatus }); } };
            const toggleCat = (key) => setExpandedCats(prev => ({...prev, [key]: !prev[key]}));
            const stats = useMemo(() => ({ deployedCost: activeUnits.reduce((s, u) => s + (u.status!=='stored'?u.cost:0), 0), destroyedCount: activeUnits.filter(u => u.status === 'destroyed').length, missionCount: activeUnits.filter(u => u.status === 'mission').length, repairCount: activeUnits.filter(u => u.status === 'damaged').length, operationalCount: activeUnits.filter(u => u.status === 'operational').length, totalVehicles: activeUnits.length, activeCount: activeUnits.length, totalSupply: supplySources.reduce((a, s) => a + (parseInt(s.amount)||0), 0) }), [activeUnits, supplySources]);
            const Activity = Icons['Activity']; const Database = Icons['Database']; const LayoutDashboard = Icons['LayoutDashboard']; const Warehouse = Icons['Warehouse']; const Users = Icons['Users']; const ScrollText = Icons['ScrollText']; const Target = Icons['Target']; const Shield = Icons['Shield']; const Plus = Icons['Plus']; const Wifi = Icons['Wifi']; const LogOut = Icons['LogOut']; const ArrowUpRight = Icons['ArrowUpRight']; const Settings = Icons['Settings']; const XCircle = Icons['XCircle']; const Trash2 = Icons['Trash2']; const RotateCcw = Icons['RotateCcw']; const Clock = Icons['Clock']; const List = Icons['List']; const Play = Icons['Play']; const PlusCircle = Icons['PlusCircle']; const MinusCircle = Icons['MinusCircle']; const Power = Icons['Power']; const ChevronDown = Icons['ChevronDown']; const Edit = Icons['Edit']; const Wrench = Icons['Wrench']; const AlertOctagon = Icons['AlertOctagon']; const Check = Icons['Check']; const Send = Icons['Send']; const MessageSquare = Icons['MessageSquare']; const ClipboardList = Icons['ClipboardList']; const Calendar = Icons['Calendar']; const CheckSquare = Icons['CheckSquare']; const MapIcon = Icons['Map']; const Briefcase = Icons['Briefcase'];

            if (!userRole) return <LoginScreen onLogin={(role, identity) => { setUserRole(role); if(identity) setUserIdentity(identity); }} squad={squad} />;
            if (!dataLoaded) return <div className="min-h-screen bg-black flex items-center justify-center text-green-500 font-mono animate-pulse">CHARGEMENT...</div>;

            return (
                <div className="h-screen w-screen bg-black text-green-500 flex flex-col overflow-hidden relative">
                    <div className="absolute inset-0 pointer-events-none z-0 opacity-10 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] bg-[length:100%_4px,3px_100%]"></div>
                    
                    {notification && <NotificationToast message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}

                    {incomingSitrep && (
                        <Modal title="SITREP REÇU" color="blue" onClose={() => setIncomingSitrep(null)} Icon={MessageSquare}>
                            <div className="text-center mb-4">
                                <h3 className="text-xl font-black text-white uppercase mb-1">{incomingSitrep.unitName}</h3>
                                <span className="text-xs text-blue-400 font-mono">{incomingSitrep.time}</span>
                            </div>
                            <div className="bg-blue-900/20 border border-blue-800 p-4 text-left space-y-3">
                                <p className="text-sm text-gray-300 font-bold break-words">{incomingSitrep.log}</p>
                            </div>
                            <button onClick={acknowledgeSitrep} className="w-full py-3 bg-blue-600 text-black font-black text-xs hover:bg-blue-500 mt-4">
                                REÇU (FERMER)
                            </button>
                        </Modal>
                    )}

                    <header className="bg-black border-b border-green-900 h-16 shrink-0 flex justify-between items-center px-4 z-50 shadow-lg shadow-green-900/10">
                        <div className="flex items-center gap-4">
                            <div className="p-1.5 rounded">{Activity && <Activity size={24} className="text-green-500 animate-pulse"/>}</div>
                            <div>
                                <h1 className="font-black text-lg md:text-2xl tracking-[0.2em] text-green-500 leading-none">LOGI-OPS <span className="text-xs align-top text-green-700">V12.0</span></h1>
                                <div className="flex items-center gap-3 text-[10px] md:text-xs font-bold text-green-700 mt-0.5">
                                    <span className={`flex items-center gap-1 ${isSlActive ? "text-green-400" : "text-red-500 animate-pulse"}`}><div className={`w-2 h-2 rounded-full ${isSlActive ? "bg-green-500" : "bg-red-500"}`}></div>SL: {slName || "N/A"}</span>
                                    <span className="border-l border-green-900 pl-3">SQD: {squad.length}</span>
                                    <ClockDisplay />
                                    {userIdentity && <span className="ml-2 text-blue-400 border border-blue-900 px-1 bg-blue-900/10">{userIdentity}</span>}
                                </div>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="text-right hidden sm:block">
                                <div className="text-[9px] font-bold text-green-800 uppercase mb-1 flex items-center justify-end gap-1">{Database && <Database size={10}/>} SUPPLY</div>
                                <button onClick={() => canEdit && setShowSupplyModal(true)} className={`text-xl font-black bg-green-900/10 px-3 py-1 border border-green-800 flex items-center gap-2 ${canEdit?'hover:bg-green-900/30 hover:border-green-500 text-green-400':'text-gray-500'}`}>{stats.totalSupply.toLocaleString()}</button>
                            </div>
                            <button onClick={() => setUserRole(null)} className="h-10 w-10 flex items-center justify-center border border-red-900/50 bg-red-900/10 text-red-600 hover:bg-red-900/30 hover:text-red-400 hover:border-red-500 transition-all rounded" title="Déconnexion">{Power && <Power size={18} />}</button>
                        </div>
                    </header>

                    <div className="flex flex-1 overflow-hidden">
                        <aside className="hidden md:flex w-64 bg-black border-r border-green-900 flex-col shrink-0">
                            <nav className="flex-1 p-2 space-y-2">
                                <NavButtonDesktop icon={LayoutDashboard} label="OPÉRATIONS" active={activeTab==='dashboard'} onClick={()=>setActiveTab('dashboard')} />
                                <NavButtonDesktop icon={MapIcon} label="MISSIONS (C2)" active={activeTab==='missions'} onClick={()=>setActiveTab('missions')} />
                                <NavButtonDesktop icon={Warehouse} label="GARAGE" active={activeTab==='garage'} onClick={()=>setActiveTab('garage')} disabled={!canEdit} />
                                <NavButtonDesktop icon={Users} label="ESCOUADE" active={activeTab==='squad'} onClick={()=>setActiveTab('squad')} />
                                <NavButtonDesktop icon={ScrollText} label="JOURNAL (JMO)" active={activeTab==='journal'} onClick={()=>setActiveTab('journal')} disabled={!canEdit} />
                            </nav>
                            <div className="p-4 border-t border-green-900 text-center"><p className="text-[10px] text-green-900 font-mono">ROLE: {userRole}</p></div>
                        </aside>

                        <main className="flex-1 overflow-y-auto p-4 md:p-6 bg-black/90 relative scrollbar-thin scrollbar-thumb-green-900 pb-20 md:pb-6">
                            
                            {/* DASHBOARD (MAIN VIEW) */}
                            {activeTab === 'dashboard' && (
                                <div className="space-y-6 animate-in fade-in flex flex-col h-full">
                                    <div className="grid grid-cols-5 gap-2 md:gap-4 shrink-0 mb-4">
                                        <StatCard color="purple" value={missions.filter(m=>m.status!=='ended').length} label="OPS GROUPÉES" active={activeTab === 'missions'} onClick={() => setActiveTab('missions')} />
                                        <StatCard color="green" value={stats.operationalCount} label="DISPO" active={filterStatus === 'operational'} onClick={() => setFilterStatus('operational')} />
                                        <StatCard color="blue" value={stats.missionCount} label="MISSION" active={filterStatus === 'mission'} onClick={() => setFilterStatus('mission')} />
                                        <StatCard color="orange" value={stats.repairCount} label="RÉP." active={filterStatus === 'damaged'} onClick={() => setFilterStatus('damaged')} />
                                        <StatCard color="red" value={stats.destroyedCount} label="PERTES" active={filterStatus === 'destroyed'} onClick={() => setFilterStatus('destroyed')} />
                                    </div>

                                    {/* NEW: GLOBAL MISSION BUTTON (SL ONLY) */}
                                    {canEdit && (
                                        <button onClick={() => setShowGlobalMissionModal(true)} className="w-full py-4 border-2 border-green-600 bg-green-900/20 text-green-400 font-black text-sm hover:bg-green-900/40 hover:text-green-300 hover:border-green-400 transition-all flex items-center justify-center gap-3 mb-4 uppercase tracking-widest shadow-[0_0_15px_rgba(22,163,74,0.2)]">
                                            <Icon name="PlusCircle" size={20} /> CRÉER MISSION GROUPE (CONVOI / OP)
                                        </button>
                                    )}

                                    {/* STANDARD SL VIEW / LOGI VIEW (FILTERED) */}
                                    <div className="flex-1 overflow-y-auto space-y-2 pr-2">
                                        {Object.keys(CATEGORIES).map(catKey => {
                                            // Filter logic: Show all for SL, Show assigned for Logi UNLESS operational
                                            const unitsInCat = activeUnits.filter(u => {
                                                const isAssignedToMe = u.responsible === userIdentity || (u.crew && u.crew.includes(userIdentity));
                                                const isOp = u.status === 'operational';
                                                const matchesFilter = filterStatus === 'ALL' || u.status === filterStatus;
                                                if(canEdit) return u.cat === catKey && matchesFilter;
                                                return u.cat === catKey && (isAssignedToMe || isOp) && matchesFilter;
                                            });

                                            if (unitsInCat.length === 0) return null;
                                            const conf = CATEGORIES[catKey];
                                            const isOpen = expandedCats[catKey];
                                            const stats = { mis: unitsInCat.filter(u=>u.status.includes('mission')).length, rep: unitsInCat.filter(u=>u.status==='damaged').length, hs: unitsInCat.filter(u=>u.status==='destroyed').length };
                                            return (
                                                <div key={catKey} className="border border-green-900/30 bg-green-900/5 mb-1">
                                                    <div onClick={() => toggleCat(catKey)} className={`flex items-center justify-between p-3 cursor-pointer hover:bg-green-900/10 transition-colors ${isOpen ? 'border-b border-green-900/30' : ''}`}>
                                                        <div className="flex items-center gap-3">
                                                            <span className={`text-${conf.color.split('-')[1]}-500`}><Icon name={conf.icon} size={20} /></span>
                                                            <span className="font-black text-sm text-gray-300 tracking-wider">{conf.label}</span>
                                                            <span className="text-xs font-mono text-green-600 bg-green-900/20 px-2 py-0.5 rounded ml-2">{unitsInCat.length}</span>
                                                        </div>
                                                        <div className="flex items-center gap-4">
                                                            <div className="flex gap-2 text-[10px] font-bold uppercase mr-4">
                                                                {stats.mis > 0 && <span className="text-blue-500 bg-blue-900/20 px-1.5 py-0.5 rounded border border-blue-900/30">MIS: {stats.mis}</span>}
                                                                {stats.rep > 0 && <span className="text-orange-500 bg-orange-900/20 px-1.5 py-0.5 rounded border border-orange-900/30">RÉP: {stats.rep}</span>}
                                                                {stats.hs > 0 && <span className="text-red-500 bg-red-900/20 px-1.5 py-0.5 rounded border border-red-900/30">HS: {stats.hs}</span>}
                                                            </div>
                                                            {ChevronDown && <ChevronDown size={16} className={`text-gray-500 transition-transform ${isOpen ? 'rotate-180' : ''}`} />}
                                                        </div>
                                                    </div>
                                                    {isOpen && (
                                                        <div className="p-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-3 animate-in fade-in">
                                                            {unitsInCat.map(unit => (
                                                                <UnitCard 
                                                                    key={unit.uuid} unit={unit} Icons={Icons} readOnly={!canEdit}
                                                                    userIdentity={userIdentity}
                                                                    onStatusChange={(s) => handleStatusClick(unit, s)}
                                                                    onEndMission={() => endMission(unit)}
                                                                    onRTB={() => returnToBase(unit.uuid)}
                                                                    onValidateRTB={() => validateRTB(unit)}
                                                                    onSitrep={() => openSitrepModal(unit)} 
                                                                    onShowLogs={() => setActionModal({ type: 'logs', unit })}
                                                                    onTakeDriver={() => selfAssignDriver(unit.uuid)}
                                                                    onTakePax={() => selfAssignPax(unit.uuid)}
                                                                    canAssignSelf={false} // Not on main dashboard
                                                                />
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {/* MISSIONS TAB (NEW LOGIC) */}
                            {activeTab === 'missions' && (
                                <div className="animate-in fade-in h-full flex flex-col">
                                    {!selectedMissionId ? (
                                        // LISTE DES MISSIONS
                                        <div className="space-y-6">
                                            <div className="flex justify-between items-center border-b border-purple-900 pb-4">
                                                <h2 className="text-lg font-black text-purple-500 flex items-center gap-2 uppercase tracking-widest">
                                                    {MapIcon && <MapIcon size={20}/>} OPÉRATIONS EN COURS
                                                </h2>
                                                {canEdit && (
                                                    <button onClick={() => setShowGlobalMissionModal(true)} className="bg-purple-900/20 border border-purple-500 text-purple-400 px-4 py-2 text-xs font-bold hover:bg-purple-900/40 flex items-center gap-2">
                                                        {Plus && <Plus size={14}/>} CRÉER
                                                    </button>
                                                )}
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                {missions.filter(m => m.status !== 'ended').map(mission => {
                                                    const isLeader = mission.leader === userIdentity;
                                                    const hasJoined = mission.participants?.includes(userIdentity);
                                                    return (
                                                        <div key={mission.id} className="bg-black border border-purple-900 p-4 relative overflow-hidden group">
                                                            <div className="absolute top-0 left-0 w-1 h-full bg-purple-600"></div>
                                                            <div className="flex justify-between items-start mb-2">
                                                                <h3 className="font-black text-white uppercase text-sm">{mission.title}</h3>
                                                                <span className={`text-[10px] px-2 py-1 border font-bold rounded ${mission.leader ? 'bg-green-900/30 text-green-400 border-green-800' : 'bg-red-900/30 text-red-400 border-red-800 animate-pulse'}`}>
                                                                    {mission.leader ? `LEAD: ${mission.leader}` : 'LEADER REQUIS'}
                                                                </span>
                                                            </div>
                                                            <div className="space-y-1 mb-4">
                                                                <p className="text-xs text-gray-400 font-bold flex items-center gap-2"><Icon name="Target" size={12}/> {mission.objective}</p>
                                                                <p className="text-[10px] text-gray-500 flex items-center gap-2"><Icon name="Clock" size={12}/> {mission.startTime}</p>
                                                            </div>
                                                            
                                                            {/* ACTIONS DE JOIN/LEAD */}
                                                            {!canEdit && (
                                                                <div className="grid grid-cols-2 gap-2 mb-2">
                                                                    {!mission.leader && (
                                                                        <button onClick={() => takeMissionCommand(mission.id)} className="col-span-2 py-2 border border-green-500 text-green-400 font-black text-[10px] hover:bg-green-900/30 uppercase">
                                                                            PRENDRE LE COMMANDEMENT
                                                                        </button>
                                                                    )}
                                                                    {mission.leader && !hasJoined && (
                                                                        <button onClick={() => joinMission(mission.id)} className="col-span-2 py-2 border border-blue-500 text-blue-400 font-black text-[10px] hover:bg-blue-900/30 uppercase">
                                                                            REJOINDRE L'UNITÉ
                                                                        </button>
                                                                    )}
                                                                </div>
                                                            )}

                                                            <button onClick={() => setSelectedMissionId(mission.id)} className="w-full py-2 bg-purple-900/20 text-purple-400 font-bold text-xs hover:bg-purple-900/40 flex items-center justify-between px-4 border-t border-purple-900/30">
                                                                <span>{activeUnits.filter(u => u.missionId === mission.id).length} VÉHICULES</span>
                                                                <Icon name="ArrowRight" size={16}/>
                                                            </button>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    ) : (
                                        // DÉTAIL MISSION (VUE TYPE OPS)
                                        <div className="flex flex-col h-full">
                                            {/* MISSION HEADER */}
                                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 border-b-2 border-purple-600 pb-4 mb-6 bg-purple-900/10 p-4 -mx-4 md:-mx-6 -mt-4 md:-mt-6">
                                                <div className="flex items-center gap-4">
                                                    <button onClick={() => setSelectedMissionId(null)} className="p-2 border border-purple-900 text-purple-400 hover:bg-purple-900/30"><Icon name="ArrowRight" size={20} className="rotate-180"/></button>
                                                    <div>
                                                        <div className="flex items-center gap-3">
                                                            <h2 className="text-lg md:text-2xl font-black text-white uppercase leading-none">{missions.find(m=>m.id===selectedMissionId)?.title}</h2>
                                                            <span className="text-[10px] font-bold bg-purple-600 text-black px-2 py-0.5 rounded">EN COURS</span>
                                                        </div>
                                                        <div className="flex gap-4 text-xs text-purple-300 mt-1 font-mono">
                                                            <span>LEAD: {missions.find(m=>m.id===selectedMissionId)?.leader || "N/A"}</span>
                                                            <span>|</span>
                                                            <span>PAX: {missions.find(m=>m.id===selectedMissionId)?.participants?.length || 0}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                {canEdit && (
                                                    <button onClick={() => endWholeMission(selectedMissionId)} className="px-4 py-2 bg-red-600 text-black font-black text-xs hover:bg-red-500 flex items-center gap-2 shadow-[0_0_10px_rgba(220,38,38,0.4)]">
                                                        {XCircle && <XCircle size={16}/>} TERMINER MISSION
                                                    </button>
                                                )}
                                            </div>

                                            {/* MISSION VEHICLES (FILTERED VIEW) */}
                                            <div className="flex-1 overflow-y-auto space-y-4">
                                                {Object.keys(CATEGORIES).map(catKey => {
                                                    // CRITICAL CHANGE: Filter strictly by missionId
                                                    const unitsInMission = activeUnits.filter(u => u.missionId === selectedMissionId && u.cat === catKey);
                                                    if (unitsInMission.length === 0) return null;
                                                    
                                                    const currentMission = missions.find(m => m.id === selectedMissionId);
                                                    const hasJoined = currentMission?.participants?.includes(userIdentity);

                                                    const conf = CATEGORIES[catKey];
                                                    return (
                                                        <div key={catKey} className="border border-purple-900/30 bg-purple-900/5">
                                                            <div className="flex items-center gap-3 p-2 border-b border-purple-900/20 bg-purple-900/10">
                                                                <span className={`text-${conf.color.split('-')[1]}-500`}><Icon name={conf.icon} size={18} /></span>
                                                                <span className="font-black text-sm text-gray-300 tracking-wider">{conf.label}</span>
                                                                <span className="text-xs font-mono text-purple-400 bg-purple-900/20 px-2 py-0.5 rounded ml-2">{unitsInMission.length}</span>
                                                            </div>
                                                            <div className="p-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                                                                {unitsInMission.map(unit => (
                                                                    <UnitCard 
                                                                        key={unit.uuid} unit={unit} Icons={Icons} readOnly={!canEdit}
                                                                        userIdentity={userIdentity}
                                                                        onStatusChange={(s) => handleStatusClick(unit, s)}
                                                                        onEndMission={() => endMission(unit)}
                                                                        onRTB={() => returnToBase(unit.uuid)}
                                                                        onValidateRTB={() => validateRTB(unit)}
                                                                        onSitrep={() => openSitrepModal(unit)} 
                                                                        onShowLogs={() => setActionModal({ type: 'logs', unit })}
                                                                        // Self Assign Logic
                                                                        canAssignSelf={hasJoined}
                                                                        onTakeDriver={() => selfAssignDriver(unit.uuid)}
                                                                        onTakePax={() => selfAssignPax(unit.uuid)}
                                                                    />
                                                                ))}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                                {activeUnits.filter(u => u.missionId === selectedMissionId).length === 0 && (
                                                    <div className="text-center py-12 text-gray-500 italic">Aucun véhicule actif dans cette mission.</div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* (GARAGE / SQUAD / JMO : Identique au précédent) */}
                            {activeTab === 'garage' && canEdit && (
                                <div className="space-y-6 animate-in fade-in">
                                    {/* ... (Contenu Garage identique) ... */}
                                    <div className="flex flex-col md:flex-row justify-between md:items-center gap-4 border-b border-green-900 pb-4">
                                        <h2 className="text-lg font-black text-green-500 flex items-center gap-2 uppercase tracking-widest">
                                            {Warehouse && <Warehouse size={20}/>} CATALOGUE DÉPLOIEMENT
                                        </h2>
                                        <div className="flex flex-wrap gap-2">
                                            <ActionButton onClick={()=>setShowConfigModal(true)} icon={List} label="PHASES" color="blue" />
                                            <ActionButton onClick={()=>setShowCreateVehicleModal(true)} icon={Plus} label="CRÉER" color="green" />
                                            <ActionButton onClick={()=>setShowStockModal(true)} icon={Settings} label="STOCKS" color="green" />
                                        </div>
                                    </div>
                                    {configurations.length > 0 && (
                                        <div className="flex gap-3 overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-green-900/50">
                                            {configurations.map(config => (
                                                <button key={config.id} onClick={() => deployConfig(config.id)} className="flex items-center gap-2 px-4 py-3 bg-black border border-green-900 hover:border-green-500 hover:bg-green-900/10 whitespace-nowrap group transition-all min-w-[120px] justify-center">
                                                    {Play && <Play size={14} className="text-green-700 group-hover:text-green-400"/>}
                                                    <span className="text-xs font-black text-green-600 group-hover:text-green-400 uppercase">{config.name}</span>
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                    <div className="space-y-8">
                                        {Object.keys(CATEGORIES).map(catKey => {
                                            const models = catalog.filter(m => m.cat === catKey);
                                            if(models.length === 0) return null;
                                            const IconComp = Icons[CATEGORIES[catKey].icon];
                                            return (
                                                <div key={catKey} className="bg-black border border-green-900/50 p-4 relative">
                                                    <div className="flex items-center gap-2 mb-4 pb-2 border-b border-green-900/30">
                                                        <span className={CATEGORIES[catKey].color.split(' ')[1]}>{IconComp && <IconComp size={20}/>}</span>
                                                        <span className="font-black text-sm text-gray-400 tracking-wider">{CATEGORIES[catKey].label}</span>
                                                    </div>
                                                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-3">
                                                        {models.map(model => {
                                                            const activeCount = activeUnits.filter(u => u.modelId === model.id).length;
                                                            return Array.from({ length: model.stock }).map((_, index) => <GarageSlot key={`${model.id}-${index}`} model={model} index={index} activeCount={activeCount} onDeploy={() => deployUnit(model.id)} ArrowUpRight={ArrowUpRight} />);
                                                        })}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {(activeTab === 'squad' || activeTab === 'journal') && (
                                <div className="max-w-3xl mx-auto">
                                    {activeTab === 'squad' && (
                                        <div className="space-y-6">
                                            <div className="bg-black border border-green-800 p-6 relative">
                                                <h3 className="text-sm font-black text-green-500 mb-4 flex items-center gap-2">{Shield && <Shield size={16}/>} COMMANDEMENT</h3>
                                                <div className="flex gap-4">
                                                    <input type="text" placeholder="NOM DU SL..." value={slName} disabled={!canEdit || isSlActive} onChange={(e) => setSlName(e.target.value)} className="flex-1 bg-green-900/10 border border-green-800 px-4 py-2 text-sm font-bold text-green-400 outline-none focus:border-green-500 disabled:opacity-50" />
                                                    {canEdit && <button onClick={toggleSlShift} disabled={!slName} className={`px-6 py-2 border font-bold text-xs tracking-widest ${isSlActive?'bg-red-900/20 border-red-800 text-red-500':'bg-green-900/20 border-green-800 text-green-400'}`}>{isSlActive?'FIN':'PRISE'}</button>}
                                                </div>
                                            </div>
                                            <div className="bg-black border border-green-900/50 p-6">
                                                <h3 className="text-sm font-black text-gray-400 mb-4 flex items-center gap-2">{Users && <Users size={16}/>} EFFECTIFS ({squad.length})</h3>
                                                {canEdit && <div className="flex gap-2 mb-4 border-b border-green-900/30 pb-4"><input id="newMemberName" type="text" placeholder="NOUVEAU MEMBRE..." className="flex-1 bg-black border border-green-900 px-3 py-2 text-sm text-green-400 uppercase focus:border-green-500 outline-none" onKeyDown={(e)=>{if(e.key==='Enter'){addSquadMember(e.target.value);e.target.value='';}}} /><button onClick={()=>{const e=document.getElementById('newMemberName');addSquadMember(e.value);e.value='';}} className="bg-green-900/20 px-4 border border-green-800 text-green-500 hover:bg-green-900/40"><Plus size={18}/></button></div>}
                                                <div className="space-y-2 mb-4">
                                                    {squad.map(m => (
                                                        <div key={m.id} className="flex justify-between items-center bg-green-900/5 p-3 border border-green-900/30">
                                                            <div><div className="font-bold text-sm text-green-400">{m.name}</div><div className="text-[10px] text-green-800">IN: {m.startTime}</div></div>
                                                            {canEdit && (
                                                                <div className="flex items-center gap-2">
                                                                    <button onClick={() => renameSquadMember(m.id)} className="text-blue-600 hover:text-blue-400 p-1 border border-blue-900/30 bg-blue-900/10" title="Renommer">{Edit && <Edit size={14}/>}</button>
                                                                    <button onClick={()=>removeSquadMember(m.id)} className="text-red-500 hover:text-red-400 p-1 border border-red-900/30 bg-red-900/10 flex items-center gap-1" title="Fin de Service"><span className="text-[9px] font-bold hidden md:inline">SORTIE</span> {LogOut && <LogOut size={14}/>}</button>
                                                                </div>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    {activeTab === 'journal' && canEdit && (
                                        <div className="bg-black border border-green-900/50 p-6">
                                            <div className="flex justify-between items-center border-b border-green-900 pb-2 mb-4">
                                                <h2 className="text-sm font-black text-green-500 flex gap-2 items-center">{ScrollText && <ScrollText size={16}/>} JMO</h2>
                                                <button onClick={clearJMO} className="text-red-500 hover:text-red-400" title="Vider le journal">{Trash2 && <Trash2 size={16} />}</button>
                                            </div>
                                            <div className="space-y-0 font-mono text-xs md:text-sm">
                                                {globalLogs.map(log => (
                                                    <div key={log.id} className="flex gap-4 py-2 border-b border-green-900/10 text-green-400 hover:bg-green-900/5 px-2">
                                                        <span className="text-green-800 font-bold w-16 shrink-0">{log.time}</span>
                                                        <div><span className="font-black text-green-700 mr-2">[{log.type}]</span><span className="text-gray-300">{log.msg}</span></div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                        </main>
                    </div>

                    <nav className="md:hidden fixed bottom-0 w-full bg-black border-t border-green-900 grid grid-cols-4 h-14 z-50 pb-safe">
                        <NavButton icon={LayoutDashboard} label="OPS" active={activeTab==='dashboard'} onClick={()=>setActiveTab('dashboard')} />
                        <NavButton icon={Warehouse} label="GARAGE" active={activeTab==='garage'} onClick={()=>canEdit&&setActiveTab('garage')} disabled={!canEdit} />
                        <NavButton icon={Users} label="SQUAD" active={activeTab==='squad'} onClick={()=>setActiveTab('squad')} />
                        <NavButton icon={ScrollText} label="JMO" active={activeTab==='journal'} onClick={()=>canEdit&&setActiveTab('journal')} disabled={!canEdit} />
                    </nav>

                    {/* MODAL: SHIFT START CHECK */}
                    {showShiftCheckModal && (
                        <Modal title="PRISE DE SERVICE" color="green" onClose={()=>setShowShiftCheckModal(false)} Icon={XCircle}>
                            <div className="space-y-4 mb-6">
                                <p className="text-xs font-bold text-green-400 text-center">AVANT DE PRENDRE LE SERVICE, VEUILLEZ VALIDER :</p>
                                <div className="bg-green-900/10 border border-green-800 p-3 space-y-2">
                                    <div className="flex items-center gap-2 text-xs font-bold text-green-500">{Check && <Check size={16}/>} ÉTAT DES VÉHICULES OK</div>
                                    <div className="flex items-center gap-2 text-xs font-bold text-green-500">{Check && <Check size={16}/>} SUPPLY VÉRIFIÉ ({stats.totalSupply})</div>
                                    <div className="flex items-center gap-2 text-xs font-bold text-green-500">{Check && <Check size={16}/>} EFFECTIFS COMPLETS</div>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={()=>setShowShiftCheckModal(false)} className="py-3 border border-green-900 text-green-500 font-bold text-xs">ANNULER</button>
                                <button onClick={confirmShiftStart} className="py-3 bg-green-600 text-black font-black text-xs hover:bg-green-500">VALIDER</button>
                            </div>
                        </Modal>
                    )}

                    {/* NEW: GLOBAL MISSION MODAL (SL ONLY - SIMPLIFIED) */}
                    {showGlobalMissionModal && canEdit && (
                        <Modal title="ORDRE DE MISSION GLOBAL" color="green" onClose={()=>setShowGlobalMissionModal(false)} Icon={XCircle}>
                            <div className="space-y-6 max-h-[70vh] overflow-y-auto pr-2">
                                {/* STEP 1: INFO MISSION */}
                                <div className="space-y-3 pb-4 border-b border-green-900/30">
                                    <h4 className="text-xs font-black text-green-500 uppercase tracking-widest mb-2">1. DÉTAILS OPÉRATION</h4>
                                    <div>
                                        <label className="text-[10px] font-bold text-green-800 block mb-1">NOM DE L'OPÉRATION</label>
                                        <input type="text" className="w-full bg-green-900/10 border border-green-800 p-2 text-green-400 font-bold uppercase text-sm" 
                                            value={globalMissionData.title} 
                                            onChange={e => setGlobalMissionData({...globalMissionData, title: e.target.value})} 
                                            placeholder="EX: CONVOI ALPHA..." 
                                        />
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-[10px] font-bold text-green-800 block mb-1">TYPE</label>
                                            <select className="w-full bg-green-900/10 border border-green-800 p-2 text-green-400 font-bold text-xs"
                                                value={globalMissionData.type}
                                                onChange={e => setGlobalMissionData({...globalMissionData, type: e.target.value})}
                                            >
                                                <option value="TRANS">TRANSPORT</option>
                                                <option value="LOGI">LOGISTIQUE / SUPPLY</option>
                                                <option value="BLINDE">ESCORTE BLINDÉE</option>
                                                <option value="ASSAUT">ASSAUT / COMBAT</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-green-800 block mb-1">SQUAD CIBLE</label>
                                            <input type="text" className="w-full bg-green-900/10 border border-green-800 p-2 text-green-400 font-bold text-xs uppercase" 
                                                value={globalMissionData.squadTarget} 
                                                onChange={e => setGlobalMissionData({...globalMissionData, squadTarget: e.target.value})} 
                                                placeholder="EX: SQUAD 1..." 
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-green-800 block mb-1">OBJECTIF</label>
                                        <input type="text" className="w-full bg-green-900/10 border border-green-800 p-2 text-green-400 font-bold text-xs" 
                                            value={globalMissionData.objective} 
                                            onChange={e => setGlobalMissionData({...globalMissionData, objective: e.target.value})} 
                                            placeholder="EX: FOB RUSTY..." 
                                        />
                                    </div>
                                </div>

                                {/* STEP 2: VEHICLE SELECTION (NO DRIVER ASSIGNMENT) */}
                                <div>
                                    <h4 className="text-xs font-black text-green-500 uppercase tracking-widest mb-2">2. SÉLECTION VÉHICULES</h4>
                                    <div className="space-y-2">
                                        {activeUnits.filter(u => u.status === 'operational').length === 0 && (
                                            <p className="text-xs text-gray-500 italic">Aucun véhicule opérationnel.</p>
                                        )}
                                        {activeUnits.filter(u => u.status === 'operational').map(unit => {
                                            const isSelected = globalMissionData.vehicles.includes(unit.uuid);
                                            return (
                                                <div key={unit.uuid} onClick={() => toggleGlobalMissionVehicle(unit.uuid)} className={`flex items-center justify-between p-3 border cursor-pointer transition-all ${isSelected ? 'border-green-500 bg-green-900/20' : 'border-green-900/30 bg-black hover:bg-green-900/10'}`}>
                                                    <div className="flex flex-col">
                                                        <span className={`text-xs font-bold ${isSelected ? 'text-white' : 'text-gray-500'}`}>{unit.name}</span>
                                                        <span className="text-[9px] text-green-800">{CATEGORIES[unit.cat]?.label}</span>
                                                    </div>
                                                    <div className={`w-6 h-6 rounded border flex items-center justify-center ${isSelected ? 'bg-green-600 border-green-500' : 'border-green-900'}`}>
                                                        {isSelected && <Check size={14} className="text-black"/>}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                            <div className="mt-6 pt-4 border-t border-green-900">
                                <button onClick={submitGlobalMission} className="w-full py-3 bg-green-600 text-black font-black text-sm hover:bg-green-500 uppercase tracking-widest shadow-[0_0_15px_rgba(22,163,74,0.4)]">
                                    CRÉER L'OPÉRATION
                                </button>
                            </div>
                        </Modal>
                    )}

                    {/* OTHER MODALS (Mission, Destroy, etc.) same as before */}
                    {actionModal?.type === 'mission' && (
                        <Modal title="ORDRE DE MISSION" color="blue" onClose={()=>setActionModal(null)} Icon={XCircle}>
                            <div className="mb-6 space-y-4">
                                <div>
                                    <label className="text-[10px] font-bold text-blue-800 block mb-1">CHEF DE BORD</label>
                                    <select value={selectedMemberId} onChange={(e) => setSelectedMemberId(e.target.value)} className="w-full bg-blue-900/10 border border-blue-800 p-3 text-blue-300 text-sm font-bold outline-none"><option value="">-- SÉLECTIONNER --</option>{slName&&<option value="SL">SL - {slName}</option>}{squad.map(m=><option key={m.id} value={m.id}>{m.name}</option>)}</select>
                                </div>
                                {/* NEW: MISSION OBJECTIVE SELECTOR */}
                                <div>
                                    <label className="text-[10px] font-bold text-blue-800 block mb-1">OBJECTIF / TYPE DE MISSION</label>
                                    <select value={selectedMissionType} onChange={(e) => setSelectedMissionType(e.target.value)} className="w-full bg-blue-900/10 border border-blue-800 p-3 text-blue-300 text-sm font-bold outline-none">
                                        <option value="">-- SÉLECTIONNER TYPE --</option>
                                        {MISSION_TYPES[actionModal.unit.cat] && MISSION_TYPES[actionModal.unit.cat].map(mission => (
                                            <option key={mission} value={mission}>{mission}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={() => setActionModal(null)} className="py-3 border border-blue-900 text-blue-500 font-bold text-xs">ANNULER</button>
                                <button onClick={confirmMission} disabled={!selectedMemberId || !selectedMissionType} className="py-3 bg-blue-600 text-black font-black text-xs hover:bg-blue-500 disabled:opacity-50">DÉPART</button>
                            </div>
                        </Modal>
                    )}
                    {actionModal?.type === 'destroy' && (
                        <Modal title="RAPPORT DE PERTE" color="red" onClose={()=>setActionModal(null)} Icon={XCircle}>
                            <input autoFocus type="text" value={inputReason} onChange={(e)=>setInputReason(e.target.value)} className="w-full bg-red-900/10 border border-red-800 p-3 text-red-200 mb-6 outline-none font-bold" placeholder="CAUSE..." />
                            <div className="grid grid-cols-2 gap-3"><button onClick={()=>setActionModal(null)} className="py-3 border border-red-900 text-red-500 text-xs font-bold">ANNULER</button><button onClick={confirmDestruction} disabled={!inputReason} className="py-3 bg-red-700 text-black font-black text-xs">CONFIRMER</button></div>
                        </Modal>
                    )}
                    {showSupplyModal && canEdit && <Modal title="INVENTAIRE" color="green" onClose={()=>setShowSupplyModal(false)} Icon={XCircle}><div className="space-y-2">{supplySources.map(s=><div key={s.id} className="flex justify-between bg-black p-2 border border-green-900/50"><span className="text-green-500 font-bold">{s.name}</span><div className="flex gap-2"><input type="number" value={s.amount} onChange={(e)=>updateSupplySource(s.id,'amount',parseInt(e.target.value)||0)} className="w-20 bg-green-900/10 text-right text-green-400 border border-green-900"/><button onClick={()=>removeSupplySource(s.id)} className="text-red-500"><Trash2 size={14}/></button></div></div>)}<button onClick={addSupplySource} className="w-full border border-dashed border-green-700 text-green-500 py-2 text-xs font-bold mt-4">AJOUTER</button></div></Modal>}
                    {showCreateVehicleModal && canEdit && <Modal title="NOUVEAU MODÈLE" color="green" onClose={()=>setShowCreateVehicleModal(false)} Icon={XCircle}><div className="space-y-3 mb-4"><div><label className="text-[10px] text-green-800 font-bold block">NOM</label><input type="text" className="w-full bg-green-900/10 border border-green-800 p-2 text-green-400 font-bold uppercase" value={newModelData.name} onChange={e=>setNewModelData({...newModelData,name:e.target.value})}/></div><div><label className="text-[10px] text-green-800 font-bold block">CATÉGORIE</label><select className="w-full bg-green-900/10 border border-green-800 p-2 text-green-400 font-bold" value={newModelData.cat} onChange={e=>setNewModelData({...newModelData,cat:e.target.value})}>{Object.entries(CATEGORIES).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}</select></div></div><button onClick={createModel} className="w-full bg-green-600 text-black font-black py-3 text-xs">CRÉER</button></Modal>}
                    {showConfigModal && canEdit && <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in"><div className="bg-black border border-blue-800 w-full max-w-4xl h-[80vh] flex flex-col shadow-[0_0_50px_rgba(30,64,175,0.2)]"><div className="p-4 border-b border-blue-900 bg-blue-900/10 flex justify-between items-center"><h3 className="font-black text-blue-500">PHASES</h3><button onClick={()=>{setShowConfigModal(false); setCurrentConfigId(null);}}><XCircle size={20} className="text-blue-500"/></button></div><div className="flex-1 flex overflow-hidden"><div className="w-1/3 border-r border-blue-900/50 overflow-y-auto p-2 bg-black space-y-2"><button onClick={createConfig} className="w-full py-3 border border-dashed border-blue-700 text-blue-500 text-xs font-bold">NOUVELLE PHASE</button>{configurations.map(c=><div key={c.id} onClick={()=>setCurrentConfigId(c.id)} className={`p-3 border cursor-pointer flex justify-between ${currentConfigId===c.id?'bg-blue-900/20 border-blue-500':'border-blue-900/30 hover:bg-blue-900/10'}`}><span className="text-blue-400 font-bold text-xs">{c.name}</span><button onClick={(e)=>{e.stopPropagation();deleteConfig(c.id)}} className="text-blue-800 hover:text-red-500"><Trash2 size={14}/></button></div>)}</div><div className="w-2/3 overflow-y-auto p-4 bg-black">{currentConfigId && ( <div className="space-y-4"><div className="flex items-center gap-2 border-b border-blue-900 pb-2 mb-4"><span className="text-[10px] font-bold text-blue-700">NOM :</span><input type="text" value={configurations.find(c => c.id === currentConfigId)?.name || ''} onChange={(e) => renameConfiguration(currentConfigId, e.target.value)} className="bg-transparent text-blue-400 font-black uppercase outline-none w-full" /></div><div className="grid grid-cols-2 gap-3">{catalog.map(model => { const cnt = configurations.find(c => c.id === currentConfigId)?.content[model.id]||0; return (<div key={model.id} className={`flex justify-between items-center p-2 border mb-2 ${cnt>0?'border-blue-600 bg-blue-900/10':'border-blue-900/20 opacity-50'}`}><span className="text-xs font-bold text-gray-400 w-1/2 truncate">{model.name}</span><div className="flex items-center gap-2"><button onClick={()=>updateConfig(currentConfigId,model.id,-1)} className="text-blue-500"><MinusCircle size={16}/></button><input type="number" value={cnt} onChange={(e)=>setConfigCount(currentConfigId,model.id,e.target.value)} className="w-10 bg-transparent text-center text-blue-400 font-bold border-b border-blue-900" /><button onClick={()=>updateConfig(currentConfigId,model.id,1)} className="text-blue-500"><PlusCircle size={16}/></button></div></div>) })}</div></div>)}</div></div><div className="p-3 border-t border-blue-900 bg-black flex justify-end"><button onClick={() => { setShowConfigModal(false); setCurrentConfigId(null); }} className="px-6 py-2 bg-blue-900/20 border border-blue-800 text-blue-500 text-[10px] font-bold hover:bg-blue-900/40">FERMER</button></div></div></div>}
                    {showStockModal && canEdit && <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in"><div className="bg-black border border-green-800 w-full max-w-4xl h-[80vh] flex flex-col"><div className="p-4 border-b border-green-900 bg-green-900/20 flex justify-between items-center"><h3 className="font-black text-green-500">STOCKS</h3><button onClick={()=>setShowStockModal(false)}><XCircle size={20} className="text-green-500"/></button></div><div className="flex-1 overflow-y-auto p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{catalog.map(m => (<div key={m.id} className="flex justify-between items-center p-3 border border-green-900/30 bg-green-900/5"><div className="overflow-hidden"><div className="font-bold text-xs text-gray-300 truncate">{m.name}</div><div className="text-[10px] text-green-800">{CATEGORIES[m.cat]?.label}</div></div><div className="flex items-center gap-2 shrink-0"><button onClick={()=>deleteModel(m.id)} className="text-green-900 hover:text-red-500 mr-2"><Trash2 size={14}/></button><button onClick={()=>updateStock(m.id,-1)} className="w-6 h-6 border border-red-900 text-red-500 flex items-center justify-center">-</button><span className="w-6 text-center font-mono text-green-400 font-bold">{m.stock}</span><button onClick={()=>updateStock(m.id,1)} className="w-6 h-6 border border-green-900 text-green-500 flex items-center justify-center">+</button></div></div>))}</div><div className="p-3 border-t border-green-900/20 bg-black"><button onClick={() => setShowStockModal(false)} className="w-full py-2 bg-green-900/20 border border-green-800 text-green-500 text-[10px] font-bold hover:bg-green-900/40 flex items-center justify-center gap-2">FERMER</button></div></div></div>}
                    {actionModal?.type === 'logs' && <Modal title="HISTORIQUE" color="green" onClose={()=>setActionModal(null)} Icon={XCircle}><div className="h-64 overflow-y-auto space-y-2 font-mono text-xs text-gray-400">{actionModal.unit.logs?.slice().reverse().map((l,i)=><div key={i} className="border-l border-green-900 pl-2"><span className="text-green-700">{l.time}</span> {l.msg}</div>)}</div></Modal>}
                    {showCrewModal && actionModal && actionModal.unit && (
                        <Modal title="AJOUTER ÉQUIPIER" color="blue" onClose={()=>setShowCrewModal(false)} Icon={XCircle}>
                            <div className="space-y-2 max-h-60 overflow-y-auto">
                                {squad.filter(m => m.name !== actionModal.unit.responsible && (!actionModal.unit.crew || !actionModal.unit.crew.includes(m.name))).map(m => (
                                    <button key={m.id} onClick={() => addToCrew(m.name)} className="w-full text-left p-3 border border-blue-900/30 hover:bg-blue-900/20 text-blue-400 font-bold text-xs">
                                        {m.name}
                                    </button>
                                ))}
                                {squad.filter(m => m.name !== actionModal.unit.responsible && (!actionModal.unit.crew || !actionModal.unit.crew.includes(m.name))).length === 0 && (
                                    <p className="text-center text-gray-500 text-xs italic">Aucun personnel disponible.</p>
                                )}
                            </div>
                        </Modal>
                    )}
                    {showSitrepModal && sitrepData.unit && (
                        <Modal title="ENVOI SITREP" color="blue" onClose={() => setShowSitrepModal(false)} Icon={XCircle}>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-[10px] font-bold text-blue-800 block mb-1">POSITION</label>
                                    <input type="text" className="w-full bg-blue-900/10 border border-blue-800 p-2 text-blue-400 font-bold text-xs" value={sitrepData.location} onChange={(e) => setSitrepData({...sitrepData, location: e.target.value})} placeholder="EX: SUR ZONE, EN ROUTE..." />
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-blue-800 block mb-1">ÉTAT</label>
                                    <div className="flex gap-2">
                                        <button onClick={() => setSitrepData({...sitrepData, status: 'green'})} className={`flex-1 py-2 border text-xs font-bold ${sitrepData.status === 'green' ? 'bg-green-600 text-black border-green-600' : 'border-green-900 text-green-600'}`}>VERT</button>
                                        <button onClick={() => setSitrepData({...sitrepData, status: 'orange'})} className={`flex-1 py-2 border text-xs font-bold ${sitrepData.status === 'orange' ? 'bg-orange-600 text-black border-orange-600' : 'border-orange-900 text-orange-600'}`}>ORANGE</button>
                                        <button onClick={() => setSitrepData({...sitrepData, status: 'red'})} className={`flex-1 py-2 border text-xs font-bold ${sitrepData.status === 'red' ? 'bg-red-600 text-black border-red-600' : 'border-red-900 text-red-600'}`}>ROUGE</button>
                                    </div>
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-blue-800 block mb-1">MESSAGE / BESOINS</label>
                                    <textarea className="w-full bg-blue-900/10 border border-blue-800 p-2 text-blue-400 font-bold text-xs h-20" value={sitrepData.message} onChange={(e) => setSitrepData({...sitrepData, message: e.target.value})} placeholder="RAS ou DÉTAILS..." />
                                </div>
                                <button onClick={submitSitrep} className="w-full py-3 bg-blue-600 text-black font-black text-xs hover:bg-blue-500">ENVOYER RAPPORT</button>
                            </div>
                        </Modal>
                    )}

                    {/* POST MISSION MODAL */}
                    {showPostMissionModal && actionModal && actionModal.unit && (
                        <Modal title="RAPPORT FIN DE MISSION" color="green" onClose={()=>setShowPostMissionModal(false)} Icon={CheckSquare}>
                            <div className="text-center space-y-6 p-2">
                                <h3 className="text-lg font-black text-white">ÉTAT DU VÉHICULE ?</h3>
                                <div className="grid grid-cols-1 gap-3">
                                    <button onClick={() => finalizeMission('operational')} className="py-4 bg-green-600/20 border border-green-500 text-green-400 font-black text-sm hover:bg-green-600/40 rounded flex flex-col items-center justify-center gap-1">
                                        <Icon name="Check" size={24}/>
                                        <span>INTACT / RAS</span>
                                        <span className="text-[9px] opacity-70 font-normal">RETOURNE EN DISPO</span>
                                    </button>
                                    <button onClick={() => finalizeMission('damaged')} className="py-4 bg-orange-600/20 border border-orange-500 text-orange-400 font-black text-sm hover:bg-orange-600/40 rounded flex flex-col items-center justify-center gap-1">
                                        <Icon name="Wrench" size={24}/>
                                        <span>ENDOMMAGÉ / PANNE</span>
                                        <span className="text-[9px] opacity-70 font-normal">VA À L'ATELIER</span>
                                    </button>
                                </div>
                            </div>
                        </Modal>
                    )}

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LogiOpsV9 />);
    </script>
</body>
</html>
