<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>LOGIOPS V2 // MILITARY LOGISTICS</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts: Share Tech Mono for that HUD look -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, setDoc, getDoc, updateDoc, 
            onSnapshot, deleteDoc, serverTimestamp, query, orderBy, addDoc, where, getDocs, writeBatch 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyASPGZJO1JU5GeoBtmj5UTP8ErPSQIPeFA",
            authDomain: "logiops-data.firebaseapp.com",
            projectId: "logiops-data",
            storageBucket: "logiops-data.firebasestorage.app",
            messagingSenderId: "791163499354",
            appId: "1:791163499354:web:2bb76506331db9d240b963",
            measurementId: "G-FFMXKH47M9"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'logiops-v2-production';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global State
        let currentUser = null;
        let userRole = null; // 'SL' or 'LOG'
        let userPseudo = null;
        let userGrade = null;
        let currentUserId = null;
        let lastNotificationTime = 0; 
        
        // Listeners cleanups
        let unsubMissionDetails = null;
        let unsubMissionVehicles = null;
        let unsubGlobalSettings = null;

        // --- UTILS ---
        const formatTime = (date) => {
            if (!date) return "--:--:--";
            const d = date.toDate ? date.toDate() : new Date(date);
            return d.toLocaleTimeString('fr-FR', { hour12: false, hour: '2-digit', minute: '2-digit' });
        };
        
        const getMillis = (d) => {
             if (!d) return 0;
             return d.toMillis ? d.toMillis() : new Date(d).getTime();
        };

        const safeSetText = (id, text) => {
            const el = document.getElementById(id);
            if(el) el.innerText = text;
        };

        // --- PATH HELPERS ---
        const publicPath = (col) => collection(db, 'artifacts', appId, 'public', 'data', col);
        const publicDoc = (col, id) => doc(db, 'artifacts', appId, 'public', 'data', col, id);

        // --- AUTHENTICATION & INIT ---
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                     await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                alert("Erreur de connexion au système. Veuillez rafraîchir.");
            }
        }

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                currentUserId = user.uid;
                console.log("System Connected. UID:", currentUserId);
                checkAppState();
            }
        });

        // --- APP LOGIC ---

        function checkAppState() {
            // Listen to Global Settings
            if (unsubGlobalSettings) unsubGlobalSettings();
            
            unsubGlobalSettings = onSnapshot(publicDoc('settings', 'global'), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    safeSetText('supply-count', data.supply || 0);
                    
                    const headerSlEl = document.getElementById('header-sl-name');
                    if (headerSlEl && data.slName) {
                        headerSlEl.innerText = `CMD: ${data.slName}`;
                    }

                    // GLOBAL SERVICE END CHECK
                    // If service is inactive AND I am currently logged in (role is set), kick me out
                    if (data.serviceStatus === 'ENDED' && userRole) {
                        forceLogout("FIN DE SERVICE ORDONNÉE PAR LE COMMANDEMENT");
                    }

                } else {
                    // Create if not exists (fail-safe)
                    setDoc(publicDoc('settings', 'global'), { supply: 1000, slSessionId: null, slName: 'AUCUN', serviceStatus: 'ACTIVE' }).catch(console.error);
                }
            });

            // Only load UI if we have a role locally defined (logged in via app flow)
            if (userRole) {
                loadInterface();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        }

        async function addLog(message, type = 'INFO', isPriority = false) {
            if (!currentUserId) return;
            try {
                await addDoc(publicPath('logs'), {
                    message: message,
                    type: type,
                    timestamp: serverTimestamp()
                });
                await addDoc(publicPath('notifications'), {
                    message: message,
                    type: type,
                    timestamp: serverTimestamp(),
                    read: false,
                    isPriority: isPriority,
                    senderName: `${userGrade} ${userPseudo}`
                });
            } catch (e) { console.error(e); }
        }

        // --- ACTIONS ---
        
        // 1. Login SL
        window.loginSL = async () => {
            if (!currentUserId) return alert("Connexion au réseau en cours...");
            
            const pseudo = document.getElementById('sl-pseudo').value.toUpperCase();
            const grade = document.getElementById('sl-grade').value;
            if (!pseudo) return alert("Pseudo requis");

            try {
                const globalSnap = await getDoc(publicDoc('settings', 'global'));
                const globalData = globalSnap.data();

                if (globalData && globalData.slSessionId && globalData.slSessionId !== currentUserId && globalData.serviceStatus === 'ACTIVE') {
                    if(!confirm(`⚠️ ALERTE\n\nLe SL ${globalData.slName} est déjà en poste.\n\nÉcraser sa session ?`)) return;
                }

                // Start Service
                await setDoc(publicDoc('settings', 'global'), {
                    slSessionId: currentUserId,
                    slName: `${grade} ${pseudo}`,
                    serviceStatus: 'ACTIVE', // START SERVICE
                    lastLogin: serverTimestamp()
                }, { merge: true });

                await setDoc(publicDoc('users', currentUserId), {
                    pseudo: pseudo, grade: grade, role: 'SL', isOnline: true, lastActive: serverTimestamp()
                });

                userRole = 'SL'; userPseudo = pseudo; userGrade = grade;
                lastNotificationTime = Date.now();

                addLog(`DÉBUT DE SERVICE SL: ${grade} ${pseudo}`, 'CMD', true);
                document.getElementById('auth-screen').classList.add('hidden');
                loadInterface();

            } catch (error) { console.error(error); alert("Erreur login SL"); }
        };

        // 2. Login LOG
        window.showLogLogin = async () => {
            document.getElementById('login-sl-form').classList.add('hidden');
            document.getElementById('login-log-form').classList.remove('hidden');
            const rosterDiv = document.getElementById('roster-list-login');
            rosterDiv.innerHTML = '<div class="text-center animate-pulse py-4">CHARGEMENT...</div>';

            onSnapshot(publicPath('roster'), (snapshot) => {
                rosterDiv.innerHTML = '';
                if(snapshot.empty) {
                    rosterDiv.innerHTML = '<div class="text-red-500 text-center py-4">Aucun effectif.</div>';
                    return;
                }
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left border border-green-900 bg-gray-900/50 active:bg-green-900/30 p-4 mb-2 rounded flex justify-between items-center group transition-all touch-manipulation";
                    btn.innerHTML = `<span class="font-bold text-green-400 text-lg">${data.grade} ${data.pseudo}</span><i class="fas fa-sign-in-alt text-green-600"></i>`;
                    btn.onclick = () => loginLOG(doc.id, data.pseudo, data.grade);
                    rosterDiv.appendChild(btn);
                });
            });
        };

        window.loginLOG = async (rosterId, pseudo, grade) => {
            if (!currentUserId) return alert("Connexion...");
            
            // Check if service is active first
            const globalSnap = await getDoc(publicDoc('settings', 'global'));
            if (globalSnap.exists() && globalSnap.data().serviceStatus === 'ENDED') {
                return alert("AUCUN SERVICE EN COURS. ATTENDEZ LE SQUAD LEADER.");
            }

            try {
                await setDoc(publicDoc('users', currentUserId), {
                    pseudo: pseudo, grade: grade, role: 'LOG', rosterId: rosterId, isOnline: true, currentVehicle: null, lastActive: serverTimestamp()
                });
                userRole = 'LOG'; userPseudo = pseudo; userGrade = grade;
                lastNotificationTime = Date.now();

                addLog(`CONNEXION: ${grade} ${pseudo}`, 'CONNECT');
                document.getElementById('auth-screen').classList.add('hidden');
                loadInterface();
            } catch (error) { console.error(error); alert("Erreur login LOG"); }
        };

        // 3. Disconnect & End Service
        window.logoutSelf = async () => {
            if(confirm("Confirmer la déconnexion ?")) {
                addLog(`${userGrade} ${userPseudo} S'EST DÉCONNECTÉ`, 'CONNECT');
                location.reload(); // Simple reload to reset state
            }
        };

        window.endServiceGlobal = async () => {
            if(!confirm("⚠️ ATTENTION ⚠️\n\nVous allez terminer le service pour TOUS les utilisateurs connectés.\n\nContinuer ?")) return;

            await updateDoc(publicDoc('settings', 'global'), {
                serviceStatus: 'ENDED'
            });
            addLog("FIN DE SERVICE GÉNÉRALE", "CMD", true);
            // Triggers auto-logout via listener for everyone
        };

        function forceLogout(reason) {
            alert(reason);
            location.reload();
        }

        function loadInterface() {
            const ui = document.getElementById('main-interface');
            ui.classList.remove('hidden');
            safeSetText('user-identity', `${userGrade} ${userPseudo}`);
            safeSetText('user-badge', userRole);

            setupNotifications();
            setupVehiclesListener();
            setupMissionsListener();

            const slControls = document.getElementById('sl-controls');
            const logControls = document.getElementById('log-controls');
            const garageBtn = document.getElementById('garage-btn');
            const endServiceBtn = document.getElementById('btn-end-service');

            if (userRole === 'SL') {
                setupSLInterface();
                slControls.classList.remove('hidden');
                logControls.classList.add('hidden');
                garageBtn.classList.remove('hidden');
                endServiceBtn.classList.remove('hidden'); // SL Only
            } else {
                slControls.classList.add('hidden');
                logControls.classList.remove('hidden');
                garageBtn.classList.add('hidden');
                endServiceBtn.classList.add('hidden');
            }
        }

        // --- NOTIFICATIONS & ALERTS ---
        function setupNotifications() {
            const feed = document.getElementById('notif-feed');
            const q = publicPath('notifications');
            onSnapshot(q, (snapshot) => {
                if (userRole === 'SL') {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            const data = change.doc.data();
                            const msgTime = getMillis(data.timestamp);
                            if (data.isPriority && msgTime > lastNotificationTime) {
                                showAlertModal(data.type, data.message, data.senderName);
                            }
                        }
                    });
                }
                if(!feed) return;
                feed.innerHTML = '';
                let docs = snapshot.docs.map(doc => doc.data());
                docs.sort((a, b) => getMillis(b.timestamp) - getMillis(a.timestamp));
                docs.slice(0, 50).forEach(data => {
                    const div = document.createElement('div');
                    const priorityClass = data.isPriority ? "border-l-4 border-l-red-500 bg-red-900/10" : "border-green-900/50";
                    const textClass = data.isPriority ? "text-red-300" : "text-green-300";
                    div.className = `text-xs border-b p-2 font-mono break-words ${priorityClass} ${textClass}`;
                    div.innerHTML = `<span class="opacity-50">[${formatTime(data.timestamp)}]</span> <span class="font-bold">${data.type}:</span> ${data.message}`;
                    feed.appendChild(div);
                });
            });
        }

        window.showAlertModal = (title, message, sender) => {
            const modal = document.getElementById('alert-modal');
            document.getElementById('alert-title').innerText = `ALERTE : ${title}`;
            document.getElementById('alert-message').innerText = message;
            document.getElementById('alert-sender').innerText = sender || "INCONNU";
            modal.classList.remove('hidden');
        };
        window.closeAlertModal = () => document.getElementById('alert-modal').classList.add('hidden');

        // --- VEHICLE MANAGEMENT ---
        function setupVehiclesListener() {
            const container = document.getElementById('vehicle-grid');
            onSnapshot(publicPath('vehicles'), (snapshot) => {
                if(!container) return;
                container.innerHTML = '';
                let stats = { total: 0, ops: 0, mission: 0, repair: 0, destroyed: 0 };
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    stats.total++;
                    if(data.status === 'OPS') stats.ops++;
                    if(data.status === 'MISSION') stats.mission++;
                    if(data.status === 'REPAIR') stats.repair++;
                    if(data.status === 'DESTROYED') stats.destroyed++;
                    container.appendChild(createVehicleCard(id, data));
                });
                updateDashboardStats(stats);
            });
        }

        function updateDashboardStats(stats) {
            safeSetText('stat-total-veh', stats.total);
            safeSetText('stat-ops', stats.ops);
            safeSetText('stat-mission', stats.mission);
            safeSetText('stat-repair', stats.repair);
            safeSetText('stat-destroyed', stats.destroyed);
        }

        function createVehicleCard(id, data) {
            const statusColors = {
                'OPS': 'border-green-500 shadow-[0_0_10px_rgba(34,197,94,0.2)]',
                'MISSION': 'border-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.2)]',
                'REPAIR': 'border-orange-500 opacity-80',
                'DESTROYED': 'border-red-600 opacity-50 grayscale'
            };
            
            const div = document.createElement('div');
            div.className = `relative bg-gray-900/90 border-2 ${statusColors[data.status] || 'border-gray-500'} p-3 rounded clip-corner flex flex-col gap-2 transition-all active:scale-[0.99] touch-manipulation`;
            
            div.innerHTML = `
                <div class="flex justify-between items-start border-b border-gray-700 pb-2 mb-1">
                    <div>
                        <div class="text-[10px] text-gray-400 font-mono">${data.category}</div>
                        <div class="text-lg font-bold font-mono tracking-widest text-white truncate max-w-[150px]">${data.name}</div>
                    </div>
                    <div class="font-bold text-xs px-2 py-1 bg-black/50 rounded ${data.status === 'DESTROYED' ? 'text-red-500' : 'text-white'}">${data.status}</div>
                </div>
            `;

            const seatsContainer = document.createElement('div');
            seatsContainer.className = "grid grid-cols-3 gap-2 my-2";
            
            ['driver', 'copilot', 'gunner'].forEach(role => {
                const occupant = data.seats[role];
                const seatBtn = document.createElement('button');
                
                let icon = role === 'driver' ? 'fa-steering-wheel' : (role === 'copilot' ? 'fa-map' : 'fa-crosshairs');
                
                // If I am in the seat, highlight it
                const isMe = occupant && occupant.uid === currentUserId;
                
                seatBtn.className = `p-2 text-xs border rounded flex flex-col items-center justify-center h-16 active:scale-95 transition-transform touch-manipulation
                    ${isMe ? 'bg-green-500 border-white text-black font-bold shadow-lg' : (occupant ? 'bg-green-900/60 border-green-500 text-green-300' : 'bg-gray-800 border-gray-700 text-gray-500 hover:border-green-500')}`;
                
                seatBtn.innerHTML = `
                    <i class="fas ${icon} mb-1 text-base"></i>
                    <span class="truncate w-full text-center text-[9px] font-bold">${occupant ? occupant.name : 'LIBRE'}</span>
                `;

                if (data.status !== 'DESTROYED') {
                    seatBtn.onclick = (e) => { e.stopPropagation(); handleSeatClick(id, data, role); };
                }
                
                seatsContainer.appendChild(seatBtn);
            });
            div.appendChild(seatsContainer);

            if (userRole === 'SL') {
                const actions = document.createElement('div');
                actions.className = "mt-auto pt-2 border-t border-gray-700 grid grid-cols-2 gap-2 text-xs";
                const btnClass = "p-3 border rounded font-bold active:bg-opacity-50 touch-manipulation";

                if (data.status !== 'DESTROYED') {
                    actions.innerHTML = `
                        <button onclick="setVehicleStatus('${id}', 'REPAIR')" class="${btnClass} border-orange-500 text-orange-500 hover:bg-orange-500 hover:text-black">RÉPARER</button>
                        <button onclick="setVehicleStatus('${id}', 'DESTROYED')" class="${btnClass} border-red-500 text-red-500 hover:bg-red-500 hover:text-black">DÉTRUIRE</button>
                        <button onclick="setVehicleStatus('${id}', 'OPS')" class="${btnClass} border-green-500 text-green-500 hover:bg-green-500 hover:text-black col-span-2">RÉTABLIR OPS</button>
                    `;
                } else {
                    actions.innerHTML = `
                         <button onclick="deleteVehicle('${id}')" class="${btnClass} border-red-900 text-red-900 hover:bg-red-900 hover:text-white col-span-2">ARCHIVER ÉPAVE</button>
                    `;
                }
                div.appendChild(actions);
            }
            return div;
        }

        window.handleSeatClick = async (vehId, vehData, seatRole) => {
            if(!currentUserId) return;
            const currentSeat = vehData.seats[seatRole];
            
            // GET OUT
            if (currentSeat && currentSeat.uid === currentUserId) {
                const newSeats = { ...vehData.seats, [seatRole]: null };
                await updateDoc(publicDoc('vehicles', vehId), { seats: newSeats });
                addLog(`${userPseudo} est descendu de ${vehData.name} (${seatRole})`);
                return;
            }
            
            // ALREADY OCCUPIED
            if (currentSeat) {
                alert(`Place occupée par ${currentSeat.name}`);
                return;
            }
            
            // GET IN
            const newSeats = { ...vehData.seats, [seatRole]: { uid: currentUserId, name: userPseudo } };
            await updateDoc(publicDoc('vehicles', vehId), { seats: newSeats });
            addLog(`${userPseudo} est monté dans ${vehData.name} (${seatRole})`);
        };

        window.setVehicleStatus = async (id, status) => {
            if(!currentUserId) return;
            
            // AUTO-EJECT LOGIC ON DESTROY
            let updateData = { status: status };
            
            if (status === 'DESTROYED') {
                if(confirm("Confirmer la DESTRUCTION du véhicule ? Cela éjectera tous les passagers.")) {
                    updateData.seats = { driver: null, copilot: null, gunner: null }; // Clear seats
                    addLog(`VÉHICULE ${id} DÉTRUIT - ÉVACUATION IMMÉDIATE`, 'ALERTE', true);
                } else {
                    return;
                }
            } else {
                addLog(`Véhicule passé en ${status}`, 'VEHICULE');
            }

            await updateDoc(publicDoc('vehicles', id), updateData);
        };

        window.deleteVehicle = async (id) => {
            if(!currentUserId) return;
            if(confirm('Archiver ce véhicule détruit (le retirer du tableau) ?')) {
                await deleteDoc(publicDoc('vehicles', id));
                addLog("Véhicule détruit archivé.", "ADMIN");
            }
        };

        // --- SL LOGIC & REST ---
        window.createVehicle = async () => {
            if(!currentUserId) return;
            if(userRole !== 'SL') return alert("Interdit");
            const typeEl = document.getElementById('new-veh-type');
            const nameEl = document.getElementById('new-veh-name');
            const cost = { 'LOGI': 300, 'JEEP': 100, 'TRANSPORT': 200, 'BLINDE': 600 }[typeEl.value];
            const globalSnap = await getDoc(publicDoc('settings', 'global'));
            const currentSupply = globalSnap.data()?.supply || 0;

            if (currentSupply < cost) return alert("Supply insuffisant");

            await setDoc(publicDoc('settings', 'global'), { supply: currentSupply - cost }, {merge: true});
            await addDoc(publicPath('vehicles'), {
                name: nameEl.value || `${typeEl.value}-${Math.floor(Math.random()*100)}`,
                category: typeEl.value, cost: cost, status: 'OPS', missionId: null,
                seats: { driver: null, copilot: null, gunner: null }, createdAt: serverTimestamp()
            });
            addLog(`Véhicule sorti: ${typeEl.value}`, 'LOGISTICS');
            toggleModal('garage-modal');
        };

        window.addToRoster = async () => {
            const pseudo = prompt("Pseudo:"); if(!pseudo) return;
            const grade = prompt("Grade:", "Sdt");
            await addDoc(publicPath('roster'), { pseudo, grade, addedAt: serverTimestamp() });
            addLog(`Ajout roster: ${grade} ${pseudo}`, 'ADMIN');
        };

        function setupSLInterface() {
            const list = document.getElementById('sl-roster-list');
            if(!list) return;
            onSnapshot(publicPath('roster'), (snap) => {
                list.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center text-sm p-3 border-b border-green-900/30";
                    div.innerHTML = `<span class="text-green-300 font-bold">${d.grade} ${d.pseudo}</span><button class="text-red-500 p-2" onclick="removeFromRoster('${doc.id}')"><i class="fas fa-trash"></i></button>`;
                    list.appendChild(div);
                });
                safeSetText('stat-log-count', snap.size);
            });
        }
        window.removeFromRoster = async(id) => { if(confirm('Retirer ?')) await deleteDoc(publicDoc('roster', id)); };
        window.addSupply = async (amount) => {
            const s = await getDoc(publicDoc('settings', 'global'));
            await setDoc(publicDoc('settings', 'global'), { supply: (s.data()?.supply||0) + amount }, {merge: true});
            addLog(`Ravitaillement: +${amount}`, 'SUPPLY');
        };
        window.clearLogs = async () => { if(confirm("Effacer le journal ?")) addLog("JOURNAL EFFACÉ", "ADMIN"); };

        // --- MISSION LOGIC ---
        window.openMissionModal = async () => {
            toggleModal('mission-modal');
            const vehiclesList = document.getElementById('mission-vehicle-list');
            vehiclesList.innerHTML = '<div class="text-center animate-pulse text-xs">RECHERCHE...</div>';
            const vehSnap = await getDocs(publicPath('vehicles'));
            vehiclesList.innerHTML = '';
            let count = 0;
            vehSnap.forEach(doc => {
                const d = doc.data();
                if (d.status === 'OPS' && !d.missionId) {
                    count++;
                    const div = document.createElement('label');
                    div.className = "flex items-center gap-3 p-3 border border-green-900/50 bg-black/40 rounded cursor-pointer";
                    div.innerHTML = `<input type="checkbox" class="accent-green-500 w-5 h-5 mission-veh-checkbox" value="${doc.id}"><div class="flex-1"><div class="text-xs text-gray-400">${d.category}</div><div class="text-green-300 font-bold">${d.name}</div></div>`;
                    vehiclesList.appendChild(div);
                }
            });
            if (count === 0) vehiclesList.innerHTML = '<div class="text-center text-gray-500 text-xs py-4">AUCUN VÉHICULE OPS DISPO</div>';
        };

        window.confirmMission = async () => {
            const name = document.getElementById('mission-name').value;
            if(!name) return alert("Nom requis");
            const checkboxes = document.querySelectorAll('.mission-veh-checkbox:checked');
            const selectedVehicles = Array.from(checkboxes).map(cb => cb.value);
            const missionRef = await addDoc(publicPath('missions'), {
                name: name, status: 'ACTIVE', leaderId: null, leaderName: null, createdAt: serverTimestamp(), vehicleCount: selectedVehicles.length
            });
            if (selectedVehicles.length > 0) {
                const batch = writeBatch(db);
                selectedVehicles.forEach(vehId => {
                    batch.update(publicDoc('vehicles', vehId), { status: 'MISSION', missionId: missionRef.id });
                });
                await batch.commit();
            }
            addLog(`Mission: ${name} (Véhicules: ${selectedVehicles.length})`, 'MISSION');
            toggleModal('mission-modal');
        };

        window.openMissionDetails = (missionId) => {
            if(unsubMissionDetails) unsubMissionDetails();
            if(unsubMissionVehicles) unsubMissionVehicles();
            const modal = document.getElementById('mission-details-modal');
            const titleEl = document.getElementById('detail-mission-name');
            const leaderEl = document.getElementById('detail-mission-leader');
            const vehiclesEl = document.getElementById('detail-mission-vehicles');
            const actionsEl = document.getElementById('sl-mission-actions');
            modal.classList.remove('hidden');
            vehiclesEl.innerHTML = '<div class="text-center animate-pulse mt-4">CHARGEMENT...</div>';

            if (userRole === 'SL') {
                actionsEl.innerHTML = `
                    <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-green-900/50">
                        <button onclick="closeMission('${missionId}', 'COMPLETED')" class="btn-tac bg-green-900/40 hover:bg-green-500 py-3 rounded font-bold">ACCOMPLIE</button>
                        <button onclick="closeMission('${missionId}', 'CANCELLED')" class="btn-tac border-red-500 text-red-500 hover:bg-red-900/50 py-3 rounded font-bold">ANNULER</button>
                    </div>`;
                actionsEl.classList.remove('hidden');
            } else { actionsEl.classList.add('hidden'); }

            unsubMissionDetails = onSnapshot(publicDoc('missions', missionId), (doc) => {
                if(!doc.exists()) return closeMissionDetails();
                const data = doc.data();
                titleEl.innerText = data.name;
                leaderEl.innerHTML = data.leaderName 
                    ? `<div class="text-xs text-gray-500 mb-1">CHEF</div><div class="text-xl font-bold text-green-400 border border-green-500/50 p-2 rounded bg-green-900/20 text-center"><i class="fas fa-crown mr-2 text-yellow-500"></i>${data.leaderName}</div>` 
                    : `<div class="text-xs text-gray-500 mb-1">COMMANDEMENT</div><button onclick="volunteerForMission('${doc.id}')" class="w-full py-3 border border-yellow-500 text-yellow-500 bg-yellow-900/20 animate-pulse font-bold rounded">SE PROPOSER</button>`;
            });

            unsubMissionVehicles = onSnapshot(publicPath('vehicles'), (snap) => {
                vehiclesEl.innerHTML = '';
                snap.forEach(doc => {
                    const data = doc.data();
                    if(data.missionId === missionId) vehiclesEl.appendChild(createVehicleCard(doc.id, data));
                });
            });
        };

        window.closeMissionDetails = () => {
            document.getElementById('mission-details-modal').classList.add('hidden');
            if(unsubMissionDetails) unsubMissionDetails();
            if(unsubMissionVehicles) unsubMissionVehicles();
        };

        window.volunteerForMission = async (missionId) => {
            if(!confirm("Prendre le commandement ?")) return;
            const myName = `${userGrade} ${userPseudo}`;
            await updateDoc(publicDoc('missions', missionId), { leaderId: currentUserId, leaderName: myName });
            addLog(`${myName} a pris le commandement.`, 'MISSION');
        };

        window.closeMission = async (missionId, reason) => {
            if (userRole !== 'SL') return;
            if (!confirm("Confirmer ? (Les véhicules repasseront OPS)")) return;
            const vehQuery = query(publicPath('vehicles'), where('missionId', '==', missionId));
            const vehSnap = await getDocs(vehQuery);
            const batch = writeBatch(db);
            batch.update(publicDoc('missions', missionId), { status: reason === 'COMPLETED' ? 'ARCHIVED' : 'CANCELLED' });
            vehSnap.forEach(v => batch.update(v.ref, { status: 'OPS', missionId: null }));
            await batch.commit();
            addLog(reason === 'COMPLETED' ? "MISSION ACCOMPLIE" : "MISSION ANNULÉE", "MISSION", true);
            closeMissionDetails();
        };

        function setupMissionsListener() {
            const container = document.getElementById('mission-list');
            onSnapshot(publicPath('missions'), (snap) => {
                container.innerHTML = '';
                let docs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                docs.sort((a, b) => getMillis(b.createdAt) - getMillis(a.createdAt));
                docs.forEach(data => {
                    if(data.status === 'ARCHIVED' || data.status === 'CANCELLED') return;
                    const el = document.createElement('div');
                    el.className = "border border-green-500/50 p-3 mb-2 bg-green-900/10 rounded cursor-pointer hover:bg-green-900/30";
                    el.onclick = () => openMissionDetails(data.id);
                    const leaderDisplay = data.leaderName ? `<div class="text-[10px] text-green-400 font-bold"><i class="fas fa-crown text-yellow-500 mr-1"></i>${data.leaderName}</div>` : `<div class="text-[10px] text-gray-500 italic">CHEF: AUCUN</div>`;
                    const vehDisplay = data.vehicleCount ? `<span class="text-[9px] bg-gray-800 px-1 rounded text-gray-300 ml-2"><i class="fas fa-car"></i> ${data.vehicleCount}</span>` : '';
                    el.innerHTML = `<div class="flex justify-between items-start mb-1 pointer-events-none"><div><h3 class="font-bold text-green-400 truncate pr-2">${data.name}</h3>${leaderDisplay}</div><div class="flex items-center"><span class="text-[9px] bg-green-900 text-green-200 px-1 rounded flex-shrink-0">ACTIF</span>${vehDisplay}</div></div>`;
                    container.appendChild(el);
                });
            });
        }

        window.sendCitrep = async (m) => { const t = prompt("Message:"); if(t) addLog(`[CITREP ${m}] ${t}`, 'RADIO', true); };
        window.requestRTB = () => addLog(`DEMANDE DE RTB POUR ${userPseudo}`, 'RADIO', true);
        window.toggleModal = (id) => document.getElementById(id).classList.toggle('hidden');
        window.toggleSidebar = () => {
            const s = document.getElementById('sidebar'), b = document.getElementById('sidebar-backdrop');
            s.classList.contains('-translate-x-full') ? (s.classList.remove('-translate-x-full'), b.classList.remove('hidden')) : (s.classList.add('-translate-x-full'), b.classList.add('hidden'));
        };
    </script>

    <!-- Custom CSS -->
    <style>
        :root { --neon-green: #22c55e; --bg-dark: #0f172a; }
        html, body { height: 100%; overflow: hidden; background-color: #050505; color: #e2e8f0; font-family: 'Share Tech Mono', monospace; -webkit-tap-highlight-color: transparent; -webkit-text-size-adjust: 100%; }
        body { overscroll-behavior: none; }
        ::-webkit-scrollbar { width: 4px; height: 4px;}
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #15803d; border-radius: 2px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @media screen and (max-width: 768px) { input, select, textarea { font-size: 16px !important; } }
        .hud-panel { background: rgba(10, 20, 10, 0.95); border: 1px solid rgba(34, 197, 94, 0.3); box-shadow: 0 0 15px rgba(34, 197, 94, 0.1), inset 0 0 30px rgba(0, 0, 0, 0.9); position: relative; }
        .hud-panel::before { content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%); background-size: 100% 2px; pointer-events: none; z-index: 0; }
        .clip-corner { clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%); }
        .text-glow { text-shadow: 0 0 5px rgba(34, 197, 94, 0.8); }
        .scan-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, transparent, rgba(34, 197, 94, 0.05), transparent); animation: scanline 6s linear infinite; pointer-events: none; z-index: 9999; }
        @keyframes scanline { 0% { transform: translateY(-100%); } 100% { transform: translateY(100vh); } }
        .btn-tac { background: rgba(34, 197, 94, 0.1); border: 1px solid var(--neon-green); color: var(--neon-green); transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; touch-action: manipulation; }
        .btn-tac:active { background: var(--neon-green); color: black; box-shadow: 0 0 15px var(--neon-green); }
        .modal-bg { background-color: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
        .mask-gradient { mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); }
        
        /* Alert Modal Specifics */
        .alert-pulse { animation: alertPulse 1s infinite; }
        @keyframes alertPulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body class="flex flex-col">

    <!-- Scanline Effect -->
    <div class="scan-overlay"></div>

    <!-- ALERT MODAL (SL Only) -->
    <div id="alert-modal" class="modal-bg fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="hud-panel w-full max-w-md p-6 relative rounded shadow-2xl border-2 border-red-500 alert-pulse bg-black/90">
            <h3 id="alert-title" class="text-2xl font-bold text-red-500 mb-2 border-b border-red-900 pb-2 flex items-center gap-2"><i class="fas fa-exclamation-triangle"></i> ALERTE PRIORITAIRE</h3>
            <div id="alert-message" class="text-xl text-white font-mono my-6 text-center break-words">--</div>
            <div class="text-xs text-red-400 mb-4 text-center">SOURCE: <span id="alert-sender">--</span></div>
            <button onclick="closeAlertModal()" class="btn-tac w-full py-4 font-bold rounded border-red-500 text-red-500 hover:bg-red-500 hover:text-black">REÇU 5/5</button>
        </div>
    </div>

    <!-- AUTHENTICATION SCREEN -->
    <div id="auth-screen" class="fixed inset-0 z-[60] bg-black flex items-center justify-center p-4">
        <div class="hud-panel w-full max-w-md p-6 clip-corner relative flex flex-col max-h-[90vh] overflow-y-auto">
            <h1 class="text-3xl md:text-4xl font-bold text-center mb-2 text-green-500 text-glow tracking-tighter">LOGIOPS V2</h1>
            <div class="h-1 w-full bg-green-900 mb-6"></div>

            <!-- Role Selection -->
            <div class="flex gap-4 mb-6">
                <button onclick="document.getElementById('login-sl-form').classList.remove('hidden'); document.getElementById('login-log-form').classList.add('hidden');" class="flex-1 py-4 border border-green-700 active:bg-green-900/40 text-green-400 font-bold rounded touch-manipulation">
                    <i class="fas fa-chess-king mb-1 block text-2xl"></i> SQUAD LEADER
                </button>
                <button onclick="showLogLogin()" class="flex-1 py-4 border border-green-700 active:bg-green-900/40 text-green-400 font-bold rounded touch-manipulation">
                    <i class="fas fa-boxes mb-1 block text-2xl"></i> LOGISTICIEN
                </button>
            </div>

            <!-- SL Form -->
            <div id="login-sl-form" class="space-y-4">
                <div>
                    <label class="text-xs text-green-700 block mb-1">GRADE</label>
                    <div class="relative">
                        <select id="sl-grade" class="w-full bg-gray-900 border border-green-800 p-3 text-white appearance-none rounded">
                            <option>Sgt</option>
                            <option>Sgt-Chef</option>
                            <option>Adj</option>
                            <option>Adj-Chef</option>
                            <option>Lt</option>
                            <option>Cpt</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-green-500">
                            <i class="fas fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="text-xs text-green-700 block mb-1">PSEUDO</label>
                    <input id="sl-pseudo" type="text" class="w-full bg-gray-900 border border-green-800 p-3 text-white uppercase rounded" placeholder="NOM">
                </div>
                <button onclick="loginSL()" class="btn-tac w-full py-4 mt-4 font-bold rounded">PRENDRE LE SERVICE</button>
            </div>

            <!-- LOG Form -->
            <div id="login-log-form" class="hidden flex-1 flex flex-col min-h-0">
                <p class="text-xs text-green-600 mb-2 uppercase tracking-wider font-bold">Effectifs disponibles</p>
                <div id="roster-list-login" class="flex-1 overflow-y-auto pr-1 border border-green-900/30 bg-black/40 rounded p-2">
                    <!-- Dynamic List -->
                </div>
            </div>
            
            <div class="mt-6 text-[10px] text-gray-600 text-center font-mono">
                SECURE CONNECTION // ENCRYPTED // FIREBASE RELAY
            </div>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <div id="main-interface" class="flex-1 flex hidden relative z-10 h-full overflow-hidden">
        
        <!-- MOBILE SIDEBAR BACKDROP -->
        <div id="sidebar-backdrop" onclick="toggleSidebar()" class="fixed inset-0 bg-black/80 z-30 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

        <!-- SIDEBAR (DRAWER ON MOBILE) -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 bg-gray-900/95 border-r border-green-900/50 flex flex-col transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out shadow-2xl md:shadow-none md:relative">
            <div class="p-4 border-b border-green-900/50 flex justify-between items-center bg-black/20">
                <div>
                    <h2 class="text-2xl font-bold text-green-500 tracking-tighter">LOGIOPS</h2>
                    <div class="text-[10px] text-green-700">LOGISTICS OPERATIONS COMMAND</div>
                </div>
                <button onclick="toggleSidebar()" class="md:hidden text-green-500 p-2"><i class="fas fa-times text-xl"></i></button>
            </div>

            <!-- User Card -->
            <div class="p-4 bg-green-900/10 border-b border-green-900/30">
                <div class="text-[10px] text-gray-500 uppercase mb-1">Session Active</div>
                <div id="user-identity" class="font-bold text-xl text-white tracking-wide">--</div>
                <div id="user-badge" class="inline-block px-2 py-0.5 bg-green-700 text-black text-xs font-bold rounded mt-2">--</div>
            </div>

            <!-- Active Mission List -->
            <div class="flex-1 p-4 overflow-y-auto -webkit-overflow-scrolling-touch">
                <div class="text-xs text-gray-500 mb-3 uppercase border-b border-gray-800 pb-1 font-bold">Missions en cours</div>
                <div id="mission-list" class="space-y-3 pb-20">
                    <!-- Missions render here -->
                </div>
            </div>

            <!-- Controls (Bottom Sidebar) -->
            <div class="mt-auto border-t border-green-900/50 bg-black/40">
                <div id="sl-controls" class="p-4 hidden space-y-2">
                    <button onclick="openMissionModal()" class="btn-tac w-full py-3 text-sm font-bold rounded flex items-center justify-center gap-2"><i class="fas fa-plus-circle"></i> CRÉER MISSION</button>
                    <button onclick="toggleModal('roster-modal')" class="btn-tac w-full py-3 text-sm font-bold rounded flex items-center justify-center gap-2"><i class="fas fa-users"></i> GÉRER ROSTER</button>
                </div>
                 <div id="log-controls" class="p-4 hidden">
                    <button onclick="requestRTB()" class="btn-tac w-full py-3 text-sm border-orange-500 text-orange-500 active:bg-orange-500 active:text-black font-bold rounded flex items-center justify-center gap-2"><i class="fas fa-home"></i> DEMANDER RTB</button>
                </div>
                
                <!-- GLOBAL LOGOUT / END SERVICE AREA -->
                <div class="p-4 border-t border-green-900/30 space-y-2">
                    <button id="btn-end-service" onclick="endServiceGlobal()" class="hidden btn-tac w-full py-3 text-sm border-red-600 text-red-500 bg-red-900/20 hover:bg-red-600 hover:text-white font-bold rounded flex items-center justify-center gap-2"><i class="fas fa-power-off"></i> FIN DE SERVICE</button>
                    <button onclick="logoutSelf()" class="btn-tac w-full py-2 text-xs border-gray-600 text-gray-400 hover:bg-gray-700 hover:text-white rounded">DÉCONNEXION</button>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col bg-black/80 relative min-w-0">
            
            <!-- HEADER / STATS BAR -->
            <header class="h-16 md:h-16 border-b border-green-900/50 flex items-center px-2 md:px-4 justify-between bg-gray-900/80 backdrop-blur z-20 shadow-md gap-2">
                
                <!-- Burger Menu -->
                <button onclick="toggleSidebar()" class="md:hidden p-3 text-green-500 active:text-white rounded">
                    <i class="fas fa-bars text-xl"></i>
                </button>

                <div id="header-sl-name" class="hidden md:block font-mono text-green-600 text-xs border border-green-900 px-2 py-1 rounded whitespace-nowrap">CMD: --</div>
                
                <!-- KPI SCROLLABLE CONTAINER -->
                <div class="flex-1 overflow-x-auto no-scrollbar mx-2 mask-gradient">
                    <div class="flex gap-4 md:gap-8 text-sm font-mono min-w-max px-2 items-center h-full py-1">
                        <div class="flex flex-col items-center">
                            <span class="text-[9px] text-gray-500 uppercase">Supply</span>
                            <span id="supply-count" class="text-xl font-bold text-white text-glow">0</span>
                        </div>
                        <div class="w-px bg-green-900/50 h-6"></div>
                        <div class="flex flex-col items-center">
                            <span class="text-[9px] text-gray-500 uppercase">Total</span>
                            <span class="text-lg font-bold text-green-400"><span id="stat-total-veh">0</span></span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="text-[9px] text-gray-500 uppercase">Ops</span>
                            <span id="stat-ops" class="text-lg font-bold text-green-500">0</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="text-[9px] text-gray-500 uppercase">Mission</span>
                            <span id="stat-mission" class="text-lg font-bold text-blue-500">0</span>
                        </div>
                         <div class="flex flex-col items-center">
                            <span class="text-[9px] text-gray-500 uppercase">Repair</span>
                            <span id="stat-repair" class="text-lg font-bold text-orange-500">0</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="text-[9px] text-gray-500 uppercase">Détruits</span>
                            <span id="stat-destroyed" class="text-lg font-bold text-red-600">0</span>
                        </div>
                    </div>
                </div>

                <div>
                    <button id="garage-btn" onclick="toggleModal('garage-modal')" class="btn-tac px-3 py-2 font-bold text-xs md:text-sm bg-green-900/20 rounded whitespace-nowrap flex items-center gap-2">
                        <i class="fas fa-warehouse"></i> <span class="hidden sm:inline">GARAGE</span>
                    </button>
                </div>
            </header>

            <!-- DASHBOARD GRID -->
            <div class="flex-1 p-2 md:p-4 overflow-y-auto -webkit-overflow-scrolling-touch bg-gradient-to-b from-transparent to-black/50">
                <div id="vehicle-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 md:gap-4 pb-4">
                    <!-- Vehicle Cards Generated Here -->
                    <div class="col-span-full text-center text-gray-600 mt-20 animate-pulse flex flex-col items-center">
                        <i class="fas fa-satellite-dish text-4xl mb-4 opacity-50"></i>
                        <span>INITIALISATION DU RÉSEAU...</span>
                    </div>
                </div>
            </div>

            <!-- UNIFIED LOGS / LIVE FEED FOOTER -->
            <div class="h-1/3 md:h-56 border-t border-green-900/50 bg-gray-900/95 flex flex-col text-xs font-mono shadow-[0_-5px_15px_rgba(0,0,0,0.5)] z-20">
                <div class="bg-black/40 p-2 text-green-400 font-bold flex justify-between items-center border-b border-green-900/30">
                    <span><i class="fas fa-satellite-dish mr-1"></i> JOURNAL OPÉRATIONNEL / LIVE FEED</span>
                    <span class="animate-pulse text-[10px] text-red-500">● REC</span>
                </div>
                <div id="notif-feed" class="flex-1 overflow-y-auto p-0 no-scrollbar -webkit-overflow-scrolling-touch bg-black/20">
                    <!-- Unified items -->
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL: GARAGE -->
    <div id="garage-modal" class="modal-bg fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="hud-panel w-full max-w-md p-6 relative rounded shadow-2xl">
            <button onclick="toggleModal('garage-modal')" class="absolute top-3 right-3 text-green-500 p-2 active:text-white"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold text-green-500 mb-4 border-b border-green-900 pb-2 flex items-center gap-2"><i class="fas fa-warehouse"></i> GARAGE CENTRAL</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-400 block mb-1">TYPE DE VÉHICULE</label>
                    <div class="relative">
                         <select id="new-veh-type" class="w-full bg-black border border-green-700 p-3 text-white appearance-none rounded">
                            <option value="LOGI">CAMION LOGISTIQUE (300s)</option>
                            <option value="JEEP">JEEP LEGÈRE (100s)</option>
                            <option value="TRANSPORT">CAMION TRANSPORT (200s)</option>
                            <option value="BLINDE">BLINDÉ LÉGER (600s)</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-green-500">
                            <i class="fas fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1">NOM DE CODE</label>
                    <input id="new-veh-name" type="text" class="w-full bg-black border border-green-700 p-3 text-white uppercase rounded" placeholder="EX: ALPHA-1">
                </div>

                <div class="pt-4 border-t border-green-900/50 mt-4 bg-green-900/10 p-3 rounded">
                    <p class="text-[10px] text-gray-500 mb-2 font-bold uppercase">Ravitaillement Rapide</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="addSupply(500)" class="border border-green-800 p-2 text-xs active:bg-green-900 rounded font-bold">+500 SUPPLY</button>
                        <button onclick="addSupply(1000)" class="border border-green-800 p-2 text-xs active:bg-green-900 rounded font-bold">+1000 SUPPLY</button>
                    </div>
                </div>

                <button onclick="createVehicle()" class="btn-tac w-full py-4 mt-2 font-bold rounded shadow-lg">SORTIR DU GARAGE</button>
            </div>
        </div>
    </div>

    <!-- MODAL: ROSTER -->
    <div id="roster-modal" class="modal-bg fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="hud-panel w-full max-w-md p-6 relative rounded shadow-2xl h-[80vh] flex flex-col">
            <button onclick="toggleModal('roster-modal')" class="absolute top-3 right-3 text-green-500 p-2 active:text-white"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold text-green-500 mb-4 border-b border-green-900 pb-2 flex items-center gap-2"><i class="fas fa-users-cog"></i> GESTION PERSONNEL</h3>
            
            <div class="flex-1 flex flex-col min-h-0">
                <div class="flex justify-between text-xs text-gray-400 mb-2 items-center">
                    <span>ENREGISTRÉS: <span id="stat-log-count" class="text-white font-bold">0</span></span>
                    <button onclick="addToRoster()" class="text-green-900 bg-green-500 hover:bg-green-400 px-3 py-2 rounded font-bold shadow-lg shadow-green-500/20 active:translate-y-0.5 transition-all"><i class="fas fa-plus mr-1"></i> AJOUTER</button>
                </div>
                <div id="sl-roster-list" class="flex-1 bg-black/50 border border-green-900 p-2 overflow-y-auto space-y-1 rounded -webkit-overflow-scrolling-touch">
                    <!-- List -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: MISSION CREATE (SL Only) -->
    <div id="mission-modal" class="modal-bg fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="hud-panel w-full max-w-md p-6 relative rounded shadow-2xl h-[90vh] flex flex-col">
            <button onclick="toggleModal('mission-modal')" class="absolute top-3 right-3 text-green-500 p-2 active:text-white"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold text-green-500 mb-4 border-b border-green-900 pb-2 flex items-center gap-2"><i class="fas fa-map-marked-alt"></i> NOUVELLE MISSION</h3>
            
            <div class="flex-1 flex flex-col space-y-4 overflow-hidden">
                <div>
                    <label class="text-xs text-gray-400 block mb-1">NOM DE L'OPÉRATION</label>
                    <input id="mission-name" type="text" class="w-full bg-black border border-green-700 p-3 text-white uppercase rounded" placeholder="EX: OPERATION OVERLORD">
                </div>

                <div class="flex-1 flex flex-col min-h-0">
                    <label class="text-xs text-gray-400 block mb-1">AFFECTATION VÉHICULES (DISPONIBLES)</label>
                    <div id="mission-vehicle-list" class="flex-1 bg-black/50 border border-green-900 p-2 overflow-y-auto space-y-2 rounded -webkit-overflow-scrolling-touch">
                        <!-- Checkboxes populated via JS -->
                    </div>
                </div>
            </div>
            
            <button onclick="confirmMission()" class="btn-tac w-full py-4 mt-4 font-bold rounded shadow-lg">LANCER LA MISSION</button>
        </div>
    </div>

    <!-- MODAL: MISSION DETAILS (Public) -->
    <div id="mission-details-modal" class="modal-bg fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="hud-panel w-full max-w-4xl p-6 relative rounded shadow-2xl h-[95vh] flex flex-col">
            <button onclick="closeMissionDetails()" class="absolute top-3 right-3 text-green-500 p-2 active:text-white z-10"><i class="fas fa-times text-xl"></i></button>
            
            <!-- Mission Header -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b border-green-900 pb-4 mb-4 gap-4">
                <div>
                    <div class="text-[10px] text-gray-500 uppercase tracking-widest">Dossier de Mission</div>
                    <h3 id="detail-mission-name" class="text-2xl md:text-3xl font-bold text-green-500 uppercase">--</h3>
                </div>
                <div id="detail-mission-leader" class="w-full md:w-auto">
                    <!-- Leader Info or "Take Command" button goes here -->
                </div>
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto -webkit-overflow-scrolling-touch bg-black/20 p-2 rounded border border-green-900/30">
                <div id="detail-mission-vehicles" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Vehicle Cards of this mission go here -->
                </div>
            </div>
            
            <!-- ACTIONS SL ONLY -->
            <div id="sl-mission-actions" class="hidden">
                 <!-- Populated by JS -->
            </div>
        </div>
    </div>

</body>
</html>
