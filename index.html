<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOGI-OPS V17 (PROTOCOL & HIERARCHY)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>

    <!-- FIREBASE (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap');
        body { font-family: 'JetBrains Mono', monospace; background-color: #050505; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #000; border-left: 1px solid #14532d; }
        ::-webkit-scrollbar-thumb { background: #14532d; border: 1px solid #000; }
        ::-webkit-scrollbar-thumb:hover { background: #22c55e; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        .login-scan {
            background: linear-gradient(to bottom, transparent 50%, rgba(0, 255, 0, 0.02) 51%, transparent 51%);
            background-size: 100% 4px;
            animation: scan 2s linear infinite;
        }
        @keyframes scan { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); border-color: rgba(34, 197, 94, 0.6); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); border-color: rgba(34, 197, 94, 1); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); border-color: rgba(34, 197, 94, 0.6); }
        }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURATION FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyASPGZJO1JU5GeoBtmj5UTP8ErPSQIPeFA",
            authDomain: "logiops-data.firebaseapp.com",
            projectId: "logiops-data",
            storageBucket: "logiops-data.firebasestorage.app",
            messagingSenderId: "791163499354",
            appId: "1:791163499354:web:2bb76506331db9d240b963",
            measurementId: "G-FFMXKH47M9"
        };

        let db = null;
        let USE_FIREBASE = false;
        const isConfigured = firebaseConfig.projectId !== "PROJECT_ID";

        if (typeof __firebase_config !== 'undefined') {
            try {
                const envConfig = JSON.parse(__firebase_config);
                if (!firebase.apps.length) firebase.initializeApp(envConfig);
                db = firebase.firestore();
                USE_FIREBASE = true;
            } catch (e) { console.warn("Erreur init Canvas config", e); }
        } else if (isConfigured) {
            try {
                if (!firebase.apps.length) {
                    const app = firebase.initializeApp(firebaseConfig);
                    if (firebase.analytics) { firebase.analytics(); }
                }
                db = firebase.firestore();
                USE_FIREBASE = true;
            } catch (e) {
                USE_FIREBASE = false;
            }
        } else {
            USE_FIREBASE = false;
        }

        const SESSION_ID = typeof __app_id !== 'undefined' ? __app_id : "operation_actuelle";
        const LOCAL_STORAGE_KEY = "logiops_v17_protocol";

        const StorageService = {
            save: (data) => {
                if (USE_FIREBASE && db) {
                    db.collection('logiops').doc(SESSION_ID).set(data, { merge: true }).catch(err => console.warn(err));
                } else {
                    try {
                        const existing = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '{}');
                        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ ...existing, ...data }));
                    } catch (e) { console.warn(e); }
                }
            },
            loadLocal: () => {
                try {
                    const local = localStorage.getItem(LOCAL_STORAGE_KEY);
                    return local ? JSON.parse(local) : null;
                } catch (e) { return null; }
            },
            loadInitial: (callback) => {
                if (USE_FIREBASE && db) {
                    return db.collection('logiops').doc(SESSION_ID).onSnapshot((doc) => {
                        if (doc.exists) callback(doc.data()); else callback(null);
                    }, err => {
                        const local = localStorage.getItem(LOCAL_STORAGE_KEY);
                        if (local) callback(JSON.parse(local));
                    });
                } else {
                    const local = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (local) callback(JSON.parse(local)); else callback(null);
                    return () => {};
                }
            }
        };

        const { useState, useMemo, useEffect } = React;

        // --- GRADES (HIÉRARCHIE) ---
        const RANKS = [
            { id: 0, label: 'Recrue', short: 'REC', color: 'text-gray-500' },
            { id: 1, label: 'Soldat', short: 'SDT', color: 'text-green-700' },
            { id: 2, label: '1ere Classe', short: '1CL', color: 'text-red-700' },
            { id: 3, label: 'Caporal', short: 'CPL', color: 'text-red-600' },
            { id: 4, label: 'Caporal-Chef', short: 'CCH', color: 'text-yellow-600' },
            { id: 5, label: 'Caporal-Chef 1CL', short: 'CCH1', color: 'text-yellow-500' },
            { id: 6, label: 'Sergent', short: 'SGT', color: 'text-yellow-400' },
            { id: 7, label: 'Sergent-Chef', short: 'SCH', color: 'text-yellow-300' },
            { id: 8, label: 'Sergent-Chef BM2', short: 'SCH2', color: 'text-yellow-200' },
            { id: 9, label: 'Adjudant', short: 'ADJ', color: 'text-white border-t border-red-500' },
            { id: 10, label: 'Adjudant Chef', short: 'ADC', color: 'text-white border-t border-yellow-500' },
            { id: 11, label: 'Major', short: 'MAJ', color: 'text-white border-b border-yellow-500' },
            { id: 12, label: 'Modérateur', short: 'MOD', color: 'text-red-500 font-bold' },
            { id: 13, label: 'Sous-Lieutenant', short: 'SLT', color: 'text-yellow-100' },
            { id: 14, label: 'Lieutenant', short: 'LNT', color: 'text-yellow-100' },
            { id: 15, label: 'Capitaine', short: 'CNE', color: 'text-yellow-100 font-black' }
        ];

        // --- NOUVEAU CATALOGUE (V17) ---
        const INITIAL_CATALOG = [
            // LOGI / TRANSPORT (Max 2 places)
            { id: 'l1', cat: 'LOGI', name: 'JEEP EM', type: 'TRANSPORT EM', cost: 110, stock: 2, slots: 2, minRank: 0 },
            { id: 'l2', cat: 'LOGI', name: 'CAMION RÉPA.', type: 'MAINTENANCE', cost: 175, stock: 1, slots: 2, minRank: 1 },
            { id: 'l3', cat: 'LOGI', name: 'CAMION CITERNE', type: 'RAVITAILLEMENT', cost: 160, stock: 1, slots: 2, minRank: 1 },
            { id: 'l4', cat: 'LOGI', name: 'CAMION ARSENAL', type: 'RAVITAILLEMENT', cost: 380, stock: 1, slots: 2, minRank: 1 },
            { id: 'l5', cat: 'LOGI', name: 'CAMION CONST.', type: 'RAVITAILLEMENT', cost: 260, stock: 1, slots: 2, minRank: 1 },
            { id: 't1', cat: 'TRANS', name: 'CAMION TROUPES', type: 'TRANSPORT', cost: 200, stock: 4, slots: 2, minRank: 1 }, 
            { id: 't2', cat: 'TRANS', name: 'VAB', type: 'TRANSPORT', cost: 1200, stock: 1, slots: 2, minRank: 1 },

            // BLINDÉS (Max 3 places)
            { id: 'b1', cat: 'BLINDE', name: 'JLTV M1280', type: 'LÉGER NON-ARMÉ', cost: 650, stock: 1, slots: 3, minRank: 1 },
            { id: 'b2', cat: 'BLINDE', name: 'JLTV M1281', type: 'LÉGER 12.7', cost: 1000, stock: 1, slots: 3, minRank: 1 },
            { id: 'b3', cat: 'BLINDE', name: 'JLTV M1278', type: 'LÉGER 12.7 CROWS', cost: 1500, stock: 2, slots: 3, minRank: 1 },
            { id: 'b4', cat: 'BLINDE', name: 'JLTV M1278 30MM', type: 'LÉGER 30MM', cost: 2750, stock: 1, slots: 3, minRank: 3 },
            
            // VCI (Max 3 places)
            { id: 'c1', cat: 'VCI', name: 'STRYKER M1126', type: 'VCI 12.7', cost: 2000, stock: 2, slots: 3, minRank: 1 }, 
            { id: 'c2', cat: 'VCI', name: 'STRYKER M1296', type: 'VCI 30MM', cost: 3000, stock: 0, slots: 3, minRank: 3 },
            { id: 'c3', cat: 'VCI', name: 'STRYKER M1128', type: 'VCI 105MM', cost: 5000, stock: 0, slots: 3, minRank: 3 },
            
            // SANITAIRE
            { id: 's1', cat: 'SANTE', name: 'STRYKER EVASAN', type: 'SANITAIRE', cost: 975, stock: 1, slots: 3, minRank: 1 },

            // CHARS (Max 3 places)
            { id: 'h1', cat: 'CHAR', name: 'LECLERC', type: 'CHAR LOURD', cost: 8000, stock: 0, slots: 3, minRank: 3 }, 
            { id: 'h2', cat: 'CHAR', name: 'LECLERC XLR', type: 'CHAR LOURD', cost: 8300, stock: 2, slots: 3, minRank: 3 },

            // AIR (Max 2 places : Pilote + Copilote)
            { id: 'a1', cat: 'AIR', name: 'NH90 FAUCON (MED)', type: 'MEDEVAC', cost: 3000, stock: 1, slots: 2, minRank: 6 },
            { id: 'a2', cat: 'AIR', name: 'NH90 FAUCON (TRANS)', type: 'TRANSPORT', cost: 3000, stock: 1, slots: 2, minRank: 6 },
            { id: 'a3', cat: 'AIR', name: 'EC665 TIGRE', type: 'HÉLICO ATTAQUE', cost: 7000, stock: 1, slots: 2, minRank: 6 },
        ];

        const CATEGORIES = {
            'LOGI': { label: 'LOGISTIQUE', icon: 'Truck', color: 'border-yellow-600 text-yellow-500 bg-yellow-900/10' },
            'TRANS': { label: 'TRANSPORT', icon: 'Package', color: 'border-blue-600 text-blue-400 bg-blue-900/10' },
            'BLINDE': { label: 'BLINDÉS', icon: 'Shield', color: 'border-orange-600 text-orange-400 bg-orange-900/10' },
            'VCI': { label: 'VCI', icon: 'Crosshair', color: 'border-red-600 text-red-400 bg-red-900/10' },
            'SANTE': { label: 'SANITAIRE', icon: 'Activity', color: 'border-emerald-600 text-emerald-400 bg-emerald-900/10' },
            'CHAR': { label: 'LOURD', icon: 'Shield', color: 'border-purple-600 text-purple-400 bg-purple-900/10' },
            'AIR': { label: 'AÉRIEN', icon: 'Plane', color: 'border-cyan-600 text-cyan-300 bg-cyan-900/10' },
        };

        // ... (SVG PATHS SAME AS BEFORE)
        const SVG_PATHS = {
            'Power': <path d="M18.36 6.64a9 9 0 1 1-12.73 0M12 2v10" />,
            'Activity': <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />,
            'Shield': <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />,
            'Lock': <><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>,
            'User': <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></>,
            'Menu': <><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></>,
            'XCircle': <><circle cx="12" cy="12" r="10" /><line x1="15" y1="9" x2="9" y2="15" /><line x1="9" y1="9" x2="15" y2="15" /></>,
            'Trash2': <><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></>,
            'Plus': <><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></>,
            'Play': <polygon points="5 3 19 12 5 21 5 3" />,
            'Settings': <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.18-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.18-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />,
            'ChevronDown': <polyline points="6 9 12 15 18 9" />,
            'Truck': <><rect x="1" y="3" width="15" height="13" rx="2" ry="2"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></>,
            'Package': <><path d="M16.5 9.4 7.55 4.24" /><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /><polyline points="3.27 6.96 12 12.01 20.73 6.96" /><line x1="12" y1="22.08" x2="12" y2="12" /></>,
            'Crosshair': <><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></>,
            'Plane': <path d="M20.38 3.4a1.6 1.6 0 0 1 2.36 2.26L20 8.4l-6.6 1.3-5.7-5.7-1.4 1.4 5 5.7-7.7 2.7-2.8-2.9L0 12.4l6.4 3.2 3.2 6.4 1.4-1.4-2.9-2.8 2.7-7.7 5.7 5 1.4-1.4-5.7-5.7 2.7-2.7z" />,
            'Edit': <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" />,
            'Wrench': <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />,
            'List': <><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></>,
            'AlertOctagon': <><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></>,
            'Check': <polyline points="20 6 9 17 4 12" />,
            'LogOut': <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>,
            'Send': <><line x1="22" y1="2" x2="11" y2="13" /><polygon points="22 2 15 22 11 13 2 9 22 2" /></>,
            'PlusCircle': <><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></>,
            'MinusCircle': <><circle cx="12" cy="12" r="10"/><line x1="8" y1="12" x2="16" y2="12"/></>,
            'Bell': <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" />,
            'UserPlus': <><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="8.5" cy="7" r="4" /><line x1="20" y1="8" x2="20" y2="14" /><line x1="23" y1="11" x2="17" y2="11" /></>,
            'Flag': <><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" /><line x1="4" y1="22" x2="4" y2="15" /></>,
            'MessageSquare': <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />,
            'ClipboardList': <><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></>,
            'Calendar': <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
            'CheckSquare': <><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></>,
            'Map': <><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></>,
            'Target': <><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></>,
            'Briefcase': <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />,
            'Users': <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></>,
            'SteeringWheel': <><circle cx="12" cy="12" r="10"/><path d="M12 2v20"/><path d="M2 12h20"/></>,
            'Fuel': <><path d="M3 22v-8a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v8"/><path d="M8 12V7a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v5"/><path d="M12 2v3"/></>,
        };

        const Icon = ({ name, size = 24, className, ...props }) => {
            if (typeof lucide !== 'undefined' && lucide.icons) {
                const keys = Object.keys(lucide.icons);
                const key = keys.find(k => k.toLowerCase() === name.toLowerCase());
                if (key) {
                    const iconData = lucide.icons[key];
                    if (Array.isArray(iconData)) {
                        const [tag, attrs, children] = iconData;
                        return React.createElement(tag, { ...attrs, width: size, height: size, className, ...props, stroke: props.color || "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" }, 
                            children.map(([childTag, childAttrs], i) => React.createElement(childTag, { ...childAttrs, key: i }))
                        );
                    }
                }
            }
            const fallbackContent = SVG_PATHS[name];
            if (fallbackContent) {
                return (
                    <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                        {fallbackContent}
                    </svg>
                );
            }
            return null;
        };

        const Icons = {};
        ['Truck','Activity','AlertTriangle','Crosshair','Shield','Plane','Package','Plus','ArrowRight','RotateCcw','XCircle','LayoutGrid','List','PlayCircle','CheckCircle','Wrench','Skull','MapPin','User','FileText','Clock','ArrowUpRight','PieChart','BarChart3','Timer','Database','Trash2','Save','Users','UserPlus','UserMinus','LogOut','ScrollText','Warehouse','LayoutDashboard','Settings','Target','Radio','Wifi','PlusCircle','MinusCircle','Edit','Play','Lock','Unlock','Menu','Power','ChevronDown','AlertOctagon','Check','Send','MessageSquare','ClipboardList','Calendar','CheckSquare','Map','Briefcase','SteeringWheel', 'Fuel'].forEach(name => {
            Icons[name] = (props) => <Icon name={name} {...props} />;
        });

        // Helper Components
        const ClockDisplay = () => {
            const [time, setTime] = useState(new Date());
            useEffect(() => { const timer = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(timer); }, []);
            return <div className="text-[10px] md:text-xs font-mono text-green-600 border border-green-900/30 px-2 py-1 bg-black rounded hidden md:block ml-auto">{time.toLocaleDateString()} - {time.toLocaleTimeString()}</div>;
        };

        const NotificationToast = ({ message, type, onClose }) => {
            useEffect(() => { const timer = setTimeout(onClose, 5000); return () => clearTimeout(timer); }, []);
            let bgClass = type === 'alert' ? "bg-red-600" : (type === 'success' ? "bg-green-600" : "bg-blue-600");
            return <div className={`fixed top-16 right-4 z-[200] ${bgClass} text-white px-4 py-3 rounded shadow-2xl border border-white/20 flex items-center gap-4 max-w-[90vw] sm:max-w-sm`}><div className="flex-1 font-bold text-xs sm:text-sm uppercase tracking-wide">{message}</div><button onClick={onClose}><Icon name="XCircle" size={18}/></button></div>;
        };

        const StatCard = ({ color, value, label, active, onClick }) => {
            const colors = { gray: "border-gray-800 bg-gray-900/10 text-gray-400", green: "border-green-800 bg-green-900/10 text-green-500", blue: "border-blue-800 bg-blue-900/10 text-blue-500", orange: "border-orange-800 bg-orange-900/10 text-orange-500", red: "border-red-800 bg-red-900/10 text-red-500", purple: "border-purple-800 bg-purple-900/10 text-purple-500" };
            return <button onClick={onClick} className={`border p-1 md:p-4 text-center relative overflow-hidden transition-all rounded ${colors[color]} ${active ? 'ring-1 ring-offset-1 ring-white bg-opacity-30' : 'opacity-70 hover:opacity-100'} flex-1 min-w-[60px]`}><span className="text-xl md:text-4xl font-black block leading-none">{value}</span><span className="text-[8px] md:text-xs font-bold uppercase tracking-widest">{label}</span></button>;
        };

        const ActionButton = ({ onClick, icon: Icon, label, color }) => (<button onClick={onClick} className={`text-[10px] md:text-xs font-bold bg-${color}-900/20 border border-${color}-800 px-3 py-2 md:py-1.5 text-${color}-400 hover:bg-${color}-900/40 hover:border-${color}-500 flex items-center justify-center gap-2 transition-colors rounded`}>{Icon && <Icon size={14} />} {label}</button>);
        const NavButtonDesktop = ({ icon: Icon, label, active, onClick, disabled }) => (<button onClick={onClick} disabled={disabled} className={`w-full flex items-center gap-3 px-4 py-3 transition-all border-l-4 text-left ${active?'text-green-400 border-green-500 bg-green-900/20':disabled?'text-green-900 border-transparent opacity-30':'text-gray-500 border-transparent hover:text-green-500 hover:bg-green-900/10'}`}>{Icon && <Icon size={20}/>} <span className="text-xs font-black tracking-widest uppercase">{label}</span></button>);
        const GarageSlot = ({ model, index, activeCount, onDeploy, ArrowUpRight }) => { const isAvailable = index >= activeCount; return (<button disabled={!isAvailable} onClick={isAvailable ? onDeploy : undefined} className={`relative p-1 md:p-3 border flex flex-col items-center justify-center text-center h-20 md:h-32 transition-all rounded ${isAvailable ? 'bg-green-900/10 border-green-800 hover:bg-green-900/30 hover:border-green-500 active:scale-95 group' : 'bg-black border-green-900/30 opacity-30 cursor-default'}`}>{isAvailable ? (<><div className="absolute top-1 right-1 w-1.5 h-1.5 bg-green-500 shadow-[0_0_5px_#22c55e] rounded-full"></div><span className="mt-1 text-[9px] md:text-xs font-black text-green-400 leading-tight uppercase px-1 truncate w-full">{model.name}</span><span className="text-[9px] text-green-800 font-mono mt-1 hidden sm:block">{model.cost} PTS</span></>) : (<div className="flex flex-col items-center">{ArrowUpRight && <ArrowUpRight size={20} className="text-green-900 mb-1"/>}<span className="text-[9px] font-black text-green-900 uppercase tracking-widest">MISS.</span></div>)}<div className="absolute bottom-0.5 left-1 text-[7px] font-mono text-green-900">#{index+1}</div></button>); };
        const Modal = ({ title, color, onClose, children, Icon }) => (<div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in"><div className={`bg-black border border-${color}-800 w-full max-w-lg p-4 md:p-6 relative shadow-[0_0_30px_rgba(0,0,0,0.5)] max-h-[90vh] overflow-y-auto rounded`}><div className="flex justify-between items-center mb-6"><h3 className={`text-lg font-black uppercase text-${color}-500 tracking-widest`}>{title}</h3><button onClick={onClose} className={`text-${color}-700 hover:text-${color}-400`}>{Icon && <Icon size={20} />}</button></div>{children}</div></div>);
        function MissionTimer({ startTime }) { const [d, sD] = useState('00:00:00'); useEffect(() => { const t = setInterval(() => { const df = Date.now() - startTime; const h = Math.floor(df / 3600000).toString().padStart(2, '0'); const m = Math.floor((df % 3600000) / 60000).toString().padStart(2, '0'); const s = Math.floor((df % 60000) / 1000).toString().padStart(2, '0'); sD(`${h}:${m}:${s}`); }, 1000); return () => clearInterval(t); }, [startTime]); return <span className="font-mono text-blue-400 font-bold bg-blue-900/30 px-2 py-0.5 text-[10px] border border-blue-900 rounded">T+{d}</span>; }

        // --- CHECK-UP MODAL (RTB) ---
        const RTBCheckModal = ({ onClose, onConfirm }) => {
            const [fuel, setFuel] = useState(100);
            const [health, setHealth] = useState(100);
            const isPerfect = parseInt(fuel) === 100 && parseInt(health) === 100;

            return (
                <div className="fixed inset-0 bg-black/90 backdrop-blur z-[200] flex items-center justify-center">
                    <div className="w-full max-w-sm border border-green-600 bg-black p-6 shadow-[0_0_30px_rgba(20,83,45,0.3)]">
                        <h3 className="text-lg font-black text-green-500 mb-4 border-b border-green-900 pb-2">CHECK-LIST RETOUR</h3>
                        <div className="space-y-6 mb-6">
                            <div>
                                <label className="flex justify-between text-xs font-bold text-green-700 mb-2"><span>CARBURANT</span><span>{fuel}%</span></label>
                                <input type="range" min="0" max="100" value={fuel} onChange={e=>setFuel(e.target.value)} className="w-full accent-green-500 h-2 bg-gray-800 appearance-none rounded"/>
                            </div>
                            <div>
                                <label className="flex justify-between text-xs font-bold text-green-700 mb-2"><span>INTÉGRITÉ</span><span>{health}%</span></label>
                                <input type="range" min="0" max="100" value={health} onChange={e=>setHealth(e.target.value)} className="w-full accent-green-500 h-2 bg-gray-800 appearance-none rounded"/>
                            </div>
                        </div>
                        <div className="p-3 bg-gray-900 border border-gray-700 mb-4 text-center">
                            <div className={`text-sm font-bold uppercase ${isPerfect ? 'text-green-500' : 'text-orange-500'}`}>{isPerfect ? "STATUS: OPÉRATIONNEL" : "STATUS: MAINTENANCE REQUISE"}</div>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                            <button onClick={onClose} className="py-3 border border-gray-700 text-gray-500 text-xs font-bold">ANNULER</button>
                            <button onClick={() => onConfirm(parseInt(fuel), parseInt(health))} className="py-3 bg-green-600 text-black font-black text-xs hover:bg-green-500">VALIDER</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- UNIT CARD (V17) ---
        function UnitCard({ unit, Icons, userIdentity, userRankId, isSL, onTakeDriver, onReleaseDriver, onTakePax, onLeavePax, onStartMission, onSitrep, onRequestRTB, onValidateRTB, onConfirmArrival, onShowLogs }) {
            const minRank = unit.minRank || 0;
            const canDrive = userRankId >= minRank;
            const rankLabel = RANKS.find(r => r.id === minRank)?.short || "REC";
            
            const driver = unit.responsible !== 'BASE' ? unit.responsible : null; // Object {name, rank} or null
            const passengers = unit.crew || []; // Array of objects {name, rank}
            const totalSlots = unit.slots || 2;
            const paxSlots = totalSlots - 1;
            const freePaxSlots = paxSlots - passengers.length;

            const isDriver = driver?.name === userIdentity;
            const isPax = passengers.some(p => p.name === userIdentity);
            const isOnBoard = isDriver || isPax;

            // Status Logic
            let statusColor = "green";
            let statusText = "DISPO";
            if (unit.status === 'damaged') { statusColor = "orange"; statusText = "MAINTENANCE"; }
            else if (unit.status.includes('mission')) { statusColor = "blue"; statusText = "EN MISSION"; }
            
            const IconComp = Icons[CATEGORIES[unit.cat]?.icon || 'Truck'];
            const SteeringWheel = Icons['SteeringWheel'];
            const Users = Icons['Users'];

            return (
                <div className={`relative border-l-4 border-${statusColor}-600 bg-gray-900/40 p-3 flex flex-col gap-2 border-t border-r border-b border-gray-800 hover:bg-gray-900/60 transition-all`}>
                    {/* Header */}
                    <div className="flex justify-between items-start">
                        <div className="flex gap-2">
                            <div className={`w-8 h-8 flex items-center justify-center border border-${statusColor}-800 bg-${statusColor}-900/20 text-${statusColor}-500 rounded`}>
                                {IconComp && <IconComp size={16}/>}
                            </div>
                            <div>
                                <div className="text-[9px] text-gray-500 font-bold uppercase">{unit.cat} // REQ: {rankLabel}+</div>
                                <h3 className="font-bold text-gray-200 text-xs uppercase leading-tight">{unit.name}</h3>
                            </div>
                        </div>
                        <button onClick={onShowLogs} className="text-gray-600 hover:text-white"><Icons.List size={14}/></button>
                    </div>

                    {/* Slots Info */}
                    <div className="bg-black/50 p-2 rounded border border-gray-800 space-y-1">
                        {/* Driver */}
                        <div className="flex justify-between items-center text-[10px]">
                            <span className="text-gray-500 flex items-center gap-1">{SteeringWheel && <SteeringWheel size={10}/>} PILOTE</span>
                            {driver ? (
                                <span className={`font-bold ${isDriver ? 'text-yellow-400' : 'text-white'}`}>{driver.rank} {driver.name}</span>
                            ) : (
                                <span className="text-gray-600 italic">LIBRE</span>
                            )}
                        </div>
                        {/* Pax */}
                        <div className="flex justify-between items-center text-[10px]">
                            <span className="text-gray-500 flex items-center gap-1">{Users && <Users size={10}/>} PAX ({passengers.length}/{paxSlots})</span>
                            <div className="flex gap-1">
                                {passengers.map((p, i) => (
                                    <span key={i} className={`px-1 border rounded ${p.name === userIdentity ? 'border-yellow-600 text-yellow-500' : 'border-gray-700 text-gray-400'}`} title={p.name}>{p.rank}</span>
                                ))}
                                {Array.from({length: freePaxSlots}).map((_, i) => <span key={i} className="w-4 h-4 border border-dashed border-gray-800 rounded"></span>)}
                            </div>
                        </div>
                    </div>

                    {/* Actions */}
                    <div className="mt-auto space-y-1">
                        {/* BASE ACTIONS */}
                        {unit.status === 'operational' && !isOnBoard && (
                            <div className="grid grid-cols-2 gap-1">
                                {!driver && (
                                    <button onClick={onTakeDriver} disabled={!canDrive} className={`py-1.5 border text-[9px] font-bold uppercase flex items-center justify-center gap-1 ${canDrive ? 'border-green-800 text-green-500 hover:bg-green-900/20' : 'border-red-900/30 text-red-900 cursor-not-allowed'}`}>
                                        {SteeringWheel && <SteeringWheel size={10}/>} {canDrive ? 'CONDUIRE' : 'GRADE NOK'}
                                    </button>
                                )}
                                {freePaxSlots > 0 && (
                                    <button onClick={onTakePax} className={`py-1.5 border border-blue-800 text-blue-500 text-[9px] font-bold uppercase hover:bg-blue-900/20 flex items-center justify-center gap-1 ${driver ? 'col-span-1' : 'col-span-1'}`}>
                                        {Users && <Users size={10}/>} MONTER
                                    </button>
                                )}
                            </div>
                        )}

                        {/* ON BOARD ACTIONS (BASE) */}
                        {unit.status === 'operational' && isDriver && (
                            <div className="grid grid-cols-2 gap-1">
                                <button onClick={onStartMission} className="col-span-2 py-1.5 bg-green-600 text-black font-black text-[10px] hover:bg-green-500 uppercase">DÉPART MISSION</button>
                                <button onClick={onReleaseDriver} className="col-span-2 py-1 border border-red-900 text-red-500 text-[9px] hover:bg-red-900/20 uppercase">DESCENDRE</button>
                            </div>
                        )}
                        {unit.status === 'operational' && isPax && (
                            <button onClick={onLeavePax} className="w-full py-1.5 border border-red-900 text-red-500 text-[9px] hover:bg-red-900/20 uppercase font-bold">DESCENDRE</button>
                        )}

                        {/* MISSION ACTIONS */}
                        {unit.status.includes('mission') && (
                            <div className="space-y-1">
                                {isDriver && unit.status === 'mission' && (
                                    <div className="grid grid-cols-2 gap-1">
                                        <button onClick={onSitrep} className="py-1 bg-yellow-900/20 border border-yellow-700 text-yellow-500 font-bold text-[9px]">SITREP</button>
                                        <button onClick={onRequestRTB} className="py-1 bg-blue-900/20 border border-blue-700 text-blue-500 font-bold text-[9px]">RTB</button>
                                    </div>
                                )}
                                {/* RTB STATUS DISPLAY */}
                                {unit.status === 'mission_rtb_request' && (
                                    <div className="text-center py-1 border border-blue-900/50 bg-blue-900/10 text-blue-400 text-[9px] animate-pulse font-bold">
                                        {isSL ? <button onClick={onValidateRTB} className="w-full h-full underline">VALIDER RTB</button> : "ATTENTE VALIDATION SL"}
                                    </div>
                                )}
                                {unit.status === 'mission_rtb_transit' && (
                                    <div className="space-y-1">
                                        <div className="text-center text-[9px] text-blue-300 font-mono">RETOUR BASE...</div>
                                        {isDriver && <button onClick={onConfirmArrival} className="w-full py-1.5 bg-green-600 text-black font-black text-[10px] hover:bg-green-500 uppercase">VALIDER RETOUR</button>}
                                    </div>
                                )}
                            </div>
                        )}

                        {unit.status === 'damaged' && (
                            <div className="text-center text-[9px] text-orange-500 font-bold border border-orange-900/30 py-1 bg-orange-900/10">
                                EN MAINTENANCE
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- APP PRINCIPALE ---
        function LogiOpsV17() {
            // Data State
            const [userRole, setUserRole] = useState(null);
            const [userIdentity, setUserIdentity] = useState(null); // {name, rankId, rankShort}
            const [catalog, setCatalog] = useState(INITIAL_CATALOG);
            const [activeUnits, setActiveUnits] = useState([]);
            const [squad, setSquad] = useState([]);
            const [logs, setLogs] = useState([]);
            const [supply, setSupply] = useState(5000);
            
            // UI State
            const [tab, setTab] = useState('dashboard');
            const [filter, setFilter] = useState('ALL');
            const [showRTBModal, setShowRTBModal] = useState(null); // Unit object for modal
            const [notification, setNotification] = useState(null);
            const [dataLoaded, setDataLoaded] = useState(false);

            // Load Data
            useEffect(() => {
                StorageService.loadInitial((data) => {
                    if (data) {
                        if (data.activeUnits) setActiveUnits(data.activeUnits);
                        if (data.squad) setSquad(data.squad);
                        if (data.logs) setLogs(data.logs);
                        if (data.supply) setSupply(data.supply);
                    }
                    setDataLoaded(true);
                });
            }, []);

            const save = (key, val) => StorageService.save({ [key]: val });
            const logEvent = (type, msg) => {
                const newLog = { id: Date.now(), time: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), type, msg };
                const newLogs = [newLog, ...logs].slice(0, 50);
                setLogs(newLogs);
                save('logs', newLogs);
            };

            // Actions
            const deployUnit = (modelId) => {
                const model = catalog.find(m => m.id === modelId);
                if (supply < model.cost) return alert("Supply insuffisant");
                setSupply(s => { const ns = s - model.cost; save('supply', ns); return ns; });
                const newUnit = {
                    uuid: Date.now() + Math.random(),
                    ...model,
                    status: 'operational',
                    responsible: 'BASE', // 'BASE' or Object {name, rank}
                    crew: [], // Array of Objects {name, rank}
                    logs: []
                };
                const nu = [newUnit, ...activeUnits];
                setActiveUnits(nu);
                save('activeUnits', nu);
                logEvent('GARAGE', `ACHAT ${model.name}`);
            };

            const takeDriver = (unitUuid) => {
                const nu = activeUnits.map(u => {
                    if (u.uuid === unitUuid) {
                        return { ...u, responsible: { name: userIdentity.name, rank: userIdentity.rankShort }, logs: [...u.logs, {time: new Date().toLocaleTimeString(), msg: `${userIdentity.name} PRIS VOLANT`}] };
                    }
                    return u;
                });
                setActiveUnits(nu); save('activeUnits', nu);
            };

            const releaseDriver = (unitUuid) => {
                const nu = activeUnits.map(u => {
                    if (u.uuid === unitUuid) return { ...u, responsible: 'BASE' };
                    return u;
                });
                setActiveUnits(nu); save('activeUnits', nu);
            };

            const takePax = (unitUuid) => {
                const nu = activeUnits.map(u => {
                    if (u.uuid === unitUuid) {
                        return { ...u, crew: [...(u.crew || []), { name: userIdentity.name, rank: userIdentity.rankShort }] };
                    }
                    return u;
                });
                setActiveUnits(nu); save('activeUnits', nu);
            };

            const leavePax = (unitUuid) => {
                const nu = activeUnits.map(u => {
                    if (u.uuid === unitUuid) {
                        return { ...u, crew: u.crew.filter(p => p.name !== userIdentity.name) };
                    }
                    return u;
                });
                setActiveUnits(nu); save('activeUnits', nu);
            };

            const startMission = (unitUuid) => {
                const nu = activeUnits.map(u => u.uuid === unitUuid ? { ...u, status: 'mission', logs: [...u.logs, {time:new Date().toLocaleTimeString(), msg: "DÉPART MISSION"}] } : u);
                setActiveUnits(nu); save('activeUnits', nu);
                logEvent('OPS', `${userIdentity.name} DÉPART MISSION`);
            };

            const requestRTB = (unitUuid) => {
                const nu = activeUnits.map(u => u.uuid === unitUuid ? { ...u, status: 'mission_rtb_request' } : u);
                setActiveUnits(nu); save('activeUnits', nu);
                logEvent('RADIO', `DEMANDE RTB`);
                if (userRole !== 'SL') setNotification({ type: 'success', message: 'DEMANDE ENVOYÉE AU SL' });
            };

            const validateRTB = (unitUuid) => {
                const nu = activeUnits.map(u => u.uuid === unitUuid ? { ...u, status: 'mission_rtb_transit' } : u);
                setActiveUnits(nu); save('activeUnits', nu);
            };

            const sendSitrep = (unit) => {
                const msg = `SITREP ${unit.name}: RAS / POSITION OK`;
                logEvent('SITREP', msg);
                setNotification({ type: 'success', message: 'SITREP ENVOYÉ' });
                // Highlight unit briefly (optional logic omitted for brevity)
            };

            const finalizeRTB = (fuel, health) => {
                if (!showRTBModal) return;
                const needsRepair = fuel < 100 || health < 100;
                const finalStatus = needsRepair ? 'damaged' : 'operational';
                
                const nu = activeUnits.map(u => {
                    if (u.uuid === showRTBModal.uuid) {
                        return { 
                            ...u, 
                            status: finalStatus, 
                            responsible: needsRepair ? 'BASE' : u.responsible, // Kick driver if damaged
                            crew: needsRepair ? [] : u.crew, // Kick pax if damaged
                            logs: [...u.logs, {time: new Date().toLocaleTimeString(), msg: `RETOUR BASE (F:${fuel}% H:${health}%) -> ${finalStatus.toUpperCase()}`}] 
                        };
                    }
                    return u;
                });
                setActiveUnits(nu);
                save('activeUnits', nu);
                setShowRTBModal(null);
                logEvent('OPS', `RETOUR ${showRTBModal.name}: ${finalStatus === 'damaged' ? 'EN PANNE' : 'DISPO'}`);
            };

            // Login Logic
            const handleLogin = (role, identity) => {
                setUserRole(role);
                if (role === 'SL') setUserIdentity({ name: identity.name, rankId: 15, rankShort: 'SL' }); // SL Force Max
                else setUserIdentity(identity); // {name, rankId, rankShort}
            };

            const filteredUnits = activeUnits.filter(u => {
                if (filter === 'ALL') return true;
                if (filter === 'operational') return u.status === 'operational';
                if (filter === 'mission') return u.status.includes('mission');
                if (filter === 'damaged') return u.status === 'damaged';
                return true;
            });

            // Login Component
            if (!userRole) return (
                <div className="min-h-screen bg-black flex flex-col items-center justify-center p-4 login-scan text-center">
                    <div className="w-full max-w-md border border-green-800 bg-black p-8 shadow-2xl">
                        <h1 className="text-3xl font-black text-green-500 mb-2 tracking-widest">LOGI-OPS V17</h1>
                        <div className="text-xs text-green-800 mb-8">PROTOCOL & HIERARCHY</div>
                        
                        <LoginComp onLogin={handleLogin} squad={squad} />
                    </div>
                </div>
            );

            return (
                <div className="h-screen bg-black text-green-500 flex flex-col overflow-hidden font-mono">
                    {/* HEADER */}
                    <header className="h-14 border-b border-green-900 flex justify-between items-center px-4 bg-black z-20">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-green-900/20 border border-green-800 flex items-center justify-center rounded text-green-400 font-bold">
                                {userIdentity.rankShort}
                            </div>
                            <div>
                                <h1 className="font-black text-lg tracking-widest leading-none">LOGI-OPS</h1>
                                <div className="text-[10px] text-gray-500">{userIdentity.name} // {userRole}</div>
                            </div>
                        </div>
                        <div className="text-right">
                            <div className="text-[9px] text-green-800 font-bold">SUPPLY</div>
                            <div className="text-xl font-black text-white">{supply.toLocaleString()}</div>
                        </div>
                    </header>

                    {/* NOTIFICATION */}
                    {notification && <NotificationToast message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}

                    {/* BODY */}
                    <div className="flex-1 flex overflow-hidden">
                        {/* SIDEBAR */}
                        <nav className="w-16 bg-black border-r border-green-900 flex flex-col items-center py-4 gap-4 shrink-0">
                            <NavBtn icon="LayoutDashboard" active={tab==='dashboard'} onClick={()=>setTab('dashboard')} Icons={Icons}/>
                            {userRole === 'SL' && <NavBtn icon="Warehouse" active={tab==='garage'} onClick={()=>setTab('garage')} Icons={Icons}/>}
                            <NavBtn icon="Users" active={tab==='squad'} onClick={()=>setTab('squad')} Icons={Icons}/>
                            <NavBtn icon="ScrollText" active={tab==='logs'} onClick={()=>setTab('logs')} Icons={Icons}/>
                        </nav>

                        {/* MAIN CONTENT */}
                        <main className="flex-1 p-4 overflow-y-auto bg-grid-pattern">
                            {tab === 'dashboard' && (
                                <div className="space-y-4">
                                    <div className="flex gap-2 overflow-x-auto pb-2">
                                        {['ALL','operational','mission','damaged'].map(f => (
                                            <button key={f} onClick={()=>setFilter(f)} className={`px-4 py-2 border text-xs font-bold uppercase whitespace-nowrap ${filter===f ? 'bg-green-900/40 border-green-500 text-white' : 'border-gray-800 text-gray-600'}`}>{f === 'operational' ? 'DISPO' : f}</button>
                                        ))}
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                        {filteredUnits.map(u => (
                                            <UnitCard 
                                                key={u.uuid} 
                                                unit={u} 
                                                Icons={Icons} 
                                                userIdentity={userIdentity.name} 
                                                userRankId={userIdentity.rankId}
                                                isSL={userRole === 'SL'}
                                                onTakeDriver={() => takeDriver(u.uuid)}
                                                onReleaseDriver={() => releaseDriver(u.uuid)}
                                                onTakePax={() => takePax(u.uuid)}
                                                onLeavePax={() => leavePax(u.uuid)}
                                                onStartMission={() => startMission(u.uuid)}
                                                onRequestRTB={() => requestRTB(u.uuid)}
                                                onValidateRTB={() => validateRTB(u.uuid)}
                                                onSitrep={() => sendSitrep(u)}
                                                onConfirmArrival={() => setShowRTBModal(u)}
                                                onShowLogs={() => { /* Optional Log Modal */ }}
                                            />
                                        ))}
                                        {filteredUnits.length === 0 && <div className="col-span-full text-center text-gray-600 py-10">AUCUNE UNITÉ</div>}
                                    </div>
                                </div>
                            )}

                            {tab === 'garage' && userRole === 'SL' && (
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                    {catalog.map(model => (
                                        <div key={model.id} className="bg-black border border-gray-800 p-3 flex flex-col gap-2 hover:border-green-600">
                                            <div className="flex justify-between">
                                                <span className="text-[9px] bg-gray-900 text-gray-400 px-1 rounded">{CATEGORIES[model.cat]?.label}</span>
                                                <span className="text-green-500 font-bold text-xs">{model.cost}</span>
                                            </div>
                                            <div className="font-bold text-gray-200 text-xs">{model.name}</div>
                                            <div className="text-[9px] text-gray-600 flex gap-2">
                                                <span>REQ: {RANKS.find(r=>r.id===model.minRank)?.short}</span>
                                                <span>SLOTS: {model.slots}</span>
                                            </div>
                                            <button onClick={()=>deployUnit(model.id)} className="mt-auto py-2 bg-green-900/20 border border-green-800 text-green-500 text-xs hover:bg-green-500 hover:text-black font-bold">ACHETER</button>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {tab === 'squad' && (
                                <div className="max-w-xl mx-auto bg-black border border-green-900 p-6">
                                    <h2 className="text-lg font-black text-green-500 mb-4">EFFECTIFS</h2>
                                    {userRole === 'SL' && (
                                        <div className="flex gap-2 mb-4">
                                            <input id="newMember" type="text" className="flex-1 bg-gray-900 border border-green-800 p-2 text-green-400 font-bold outline-none uppercase" placeholder="NOM..." />
                                            <button onClick={()=>{
                                                const el=document.getElementById('newMember');
                                                if(el.value) {
                                                    const ns = [...squad, {id: Date.now(), name: el.value.toUpperCase()}];
                                                    setSquad(ns); save('squad', ns);
                                                    el.value='';
                                                }
                                            }} className="px-4 bg-green-600 text-black font-bold">AJOUTER</button>
                                        </div>
                                    )}
                                    <div className="space-y-2">
                                        {squad.map(m => (
                                            <div key={m.id} className="flex justify-between items-center p-2 border border-gray-800 bg-gray-900/30">
                                                <span className="text-gray-300 font-bold">{m.name}</span>
                                                {userRole === 'SL' && <button onClick={()=>{const ns=squad.filter(x=>x.id!==m.id); setSquad(ns); save('squad', ns);}} className="text-red-500 text-xs">EXCLURE</button>}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {tab === 'logs' && (
                                <div className="max-w-2xl mx-auto bg-black border border-green-900 p-4 h-[80vh] overflow-y-auto font-mono text-xs">
                                    {logs.map(l => (
                                        <div key={l.id} className="flex gap-2 mb-1 text-gray-400 border-b border-gray-900 pb-1">
                                            <span className="text-green-700 w-16">{l.time}</span>
                                            <span className="font-bold w-16 text-green-600">[{l.type}]</span>
                                            <span>{l.msg}</span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </main>
                    </div>

                    {showRTBModal && <RTBCheckModal onClose={()=>setShowRTBModal(null)} onConfirm={finalizeRTB} />}
                </div>
            );
        }

        // Internal Components
        const NavBtn = ({ icon, active, onClick, Icons }) => {
            const I = Icons[icon];
            return <button onClick={onClick} className={`p-3 rounded transition-all ${active ? 'bg-green-900/20 text-green-400' : 'text-gray-600 hover:text-green-500'}`}>{I && <I size={24}/>}</button>;
        };

        const LoginComp = ({ onLogin, squad }) => {
            const [step, setStep] = useState(0);
            const [role, setRole] = useState('');
            const [name, setName] = useState('');
            const [rankId, setRankId] = useState(1);

            const goNext = (r) => { setRole(r); setStep(1); };
            const confirm = () => { 
                const rankShort = RANKS.find(r=>r.id===parseInt(rankId))?.short || "REC";
                onLogin(role, { name: name.toUpperCase(), rankId: parseInt(rankId), rankShort }); 
            };

            if (step === 0) return (
                <div className="space-y-4">
                    <button onClick={()=>goNext('SL')} className="w-full py-4 border border-green-600 text-green-500 font-bold hover:bg-green-900/20">COMMANDEMENT</button>
                    <button onClick={()=>goNext('LOGI')} className="w-full py-4 border border-blue-600 text-blue-500 font-bold hover:bg-blue-900/20">LOGISTICIEN</button>
                </div>
            );

            return (
                <div className="space-y-4 text-left">
                    <div>
                        <label className="text-[10px] text-gray-500 font-bold">GRADE</label>
                        <select className="w-full bg-gray-900 border border-gray-700 p-2 text-white text-sm" value={rankId} onChange={e=>setRankId(e.target.value)}>
                            {RANKS.map(r => <option key={r.id} value={r.id}>{r.label} ({r.short})</option>)}
                        </select>
                    </div>
                    <div>
                        <label className="text-[10px] text-gray-500 font-bold">IDENTITÉ</label>
                        {role === 'LOGI' && squad.length > 0 ? (
                            <select className="w-full bg-gray-900 border border-gray-700 p-2 text-white text-sm" value={name} onChange={e=>setName(e.target.value)}>
                                <option value="">-- SÉLECTIONNER --</option>
                                {squad.map(m => <option key={m.id} value={m.name}>{m.name}</option>)}
                            </select>
                        ) : (
                            <input type="text" className="w-full bg-gray-900 border border-gray-700 p-2 text-white uppercase" placeholder="PSEUDO..." value={name} onChange={e=>setName(e.target.value)} />
                        )}
                    </div>
                    <div className="flex gap-2 pt-4">
                        <button onClick={()=>setStep(0)} className="flex-1 py-2 border border-gray-700 text-gray-500 font-bold text-xs">RETOUR</button>
                        <button onClick={confirm} disabled={!name} className="flex-1 py-2 bg-green-600 text-black font-bold text-xs disabled:opacity-50">VALIDER</button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LogiOpsV17 />);
    </script>
</body>
</html>
