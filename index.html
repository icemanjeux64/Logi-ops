<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>LOGIOPS V2 // MILITARY LOGISTICS</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, setDoc, getDoc, updateDoc, 
            onSnapshot, deleteDoc, serverTimestamp, query, orderBy, addDoc, where, getDocs, writeBatch 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyASPGZJO1JU5GeoBtmj5UTP8ErPSQIPeFA",
            authDomain: "logiops-data.firebaseapp.com",
            projectId: "logiops-data",
            storageBucket: "logiops-data.firebasestorage.app",
            messagingSenderId: "791163499354",
            appId: "1:791163499354:web:2bb76506331db9d240b963",
            measurementId: "G-FFMXKH47M9"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'logiops-v2-production';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global State
        let currentUser = null;
        let userRole = null;
        let userPseudo = null;
        let userGrade = null;
        let currentUserId = null;
        let lastNotificationTime = 0; 
        
        // Cleanups
        let listeners = [];

        // --- UTILS & HUD UI SYSTEM ---
        const formatTime = (date) => {
            if (!date) return "--:--";
            const d = date.toDate ? date.toDate() : new Date(date);
            return d.toLocaleTimeString('fr-FR', { hour12: false, hour: '2-digit', minute: '2-digit' });
        };
        
        const getMillis = (d) => d && d.toMillis ? d.toMillis() : (new Date(d).getTime() || 0);
        const safeSetText = (id, text) => { const el = document.getElementById(id); if(el) el.innerText = text; };

        // CUSTOM DIALOG SYSTEM (Replaces confirm/prompt)
        window.hudConfirm = (title, message, onYes) => {
            const m = document.getElementById('hud-confirm-modal');
            document.getElementById('hud-confirm-title').innerText = title;
            document.getElementById('hud-confirm-msg').innerHTML = message; // Allow HTML
            m.classList.remove('hidden');
            window._onConfirmYes = () => { m.classList.add('hidden'); onYes(); };
        };
        
        window.hudPrompt = (title, message, onSubmit) => {
            const m = document.getElementById('hud-prompt-modal');
            document.getElementById('hud-prompt-title').innerText = title;
            document.getElementById('hud-prompt-msg').innerText = message;
            const input = document.getElementById('hud-prompt-input');
            input.value = '';
            m.classList.remove('hidden');
            input.focus();
            window._onPromptSubmit = () => { 
                if(input.value.trim()) { m.classList.add('hidden'); onSubmit(input.value.trim()); }
            };
        };

        window.hudAlert = (title, message) => {
            const m = document.getElementById('hud-alert-modal');
            document.getElementById('hud-alert-title').innerText = title;
            document.getElementById('hud-alert-msg').innerText = message;
            m.classList.remove('hidden');
        };

        // --- PATH HELPERS ---
        const publicPath = (col) => collection(db, 'artifacts', appId, 'public', 'data', col);
        const publicDoc = (col, id) => doc(db, 'artifacts', appId, 'public', 'data', col, id);

        // --- AUTHENTICATION ---
        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                 await signInWithCustomToken(auth, __initial_auth_token);
            } else { await signInAnonymously(auth); }
        }
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                currentUserId = user.uid;
                checkAppState();
                // Listener for MY OWN USER DOC to handle RTB validation
                const unsubMe = onSnapshot(publicDoc('users', user.uid), (doc) => {
                    if(doc.exists()) {
                        const d = doc.data();
                        if(d.rtbStatus === 'APPROVED') {
                            hudAlert("FIN DE SERVICE", "Votre demande de RTB a été validée par le Commandement. Rompez.");
                            updateDoc(publicDoc('users', user.uid), { rtbStatus: 'OFFLINE', isOnline: false }); // Self disconnect logic
                            location.reload();
                        }
                        // Handle Mission Transfer Invites (Target side)
                        // We check missions collection instead usually, but let's keep it centralized
                    }
                });
                listeners.push(unsubMe);
            }
        });

        // --- APP LOGIC ---

        function checkAppState() {
            const unsub = onSnapshot(publicDoc('settings', 'global'), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const headerSlEl = document.getElementById('header-sl-name');
                    if (headerSlEl && data.slName) headerSlEl.innerText = `CMD: ${data.slName}`;
                    if (data.serviceStatus === 'ENDED' && userRole) {
                        alert("FIN DE SERVICE ORDONNÉE PAR LE COMMANDEMENT");
                        location.reload();
                    }
                } else {
                    setDoc(publicDoc('settings', 'global'), { slSessionId: null, slName: 'AUCUN', serviceStatus: 'ACTIVE' });
                }
            });
            listeners.push(unsub);

            setupDepotsListener();
            setupPresenceListener();
            setupMissionsGlobalListener(); // For leadership transfers

            if (userRole) loadInterface();
            else document.getElementById('auth-screen').classList.remove('hidden');
        }

        function setupDepotsListener() {
            listeners.push(onSnapshot(publicPath('depots'), (snapshot) => {
                let total = 0;
                snapshot.forEach(doc => total += (parseInt(doc.data().amount) || 0));
                safeSetText('supply-count', total);
                if (!document.getElementById('supply-modal').classList.contains('hidden')) renderDepotsList(snapshot);
            }));
        }

        function setupPresenceListener() {
            // Listen to all users to filter online & validated
            listeners.push(onSnapshot(publicPath('users'), (snap) => {
                let connected = 0;
                let total = 0; // Count only valid roster members? For now count all users doc
                // Better: count from Roster collection for Total, and Users collection for Online
                // Simplified for this file:
                snap.forEach(d => {
                    if (d.data().role === 'LOG') { // Only count LOGs
                        total++; 
                        if (d.data().isOnline && d.data().rtbStatus !== 'APPROVED') connected++;
                    }
                });
                safeSetText('stat-log-count', `${connected}/${total}`);
            }));
        }

        function setupMissionsGlobalListener() {
            // Watch for leadership transfer requests involving ME
            listeners.push(onSnapshot(publicPath('missions'), (snap) => {
                snap.docChanges().forEach(change => {
                    const mData = change.doc.data();
                    const mId = change.doc.id;
                    if (change.type === 'modified' && mData.transferRequest) {
                        const req = mData.transferRequest; // { targetId, targetName, state: 'WAITING_TARGET' | 'WAITING_SL' }
                        
                        // 1. I am the TARGET -> I must accept
                        if (req.targetId === currentUserId && req.state === 'WAITING_TARGET') {
                            hudConfirm("PROMOTION CHAMP", `On vous propose le commandement de la mission <strong>${mData.name}</strong>.<br>Accepter ?`, async () => {
                                await updateDoc(publicDoc('missions', mId), {
                                    "transferRequest.state": 'WAITING_SL'
                                });
                                addLog(`${userPseudo} a accepté le commandement (En attente SL).`, 'MISSION');
                            });
                        }

                        // 2. I am the SL -> I must validate (Stage 2 or Direct request)
                        if (userRole === 'SL' && req.state === 'WAITING_SL') {
                            hudConfirm("VALIDATION COMMANDEMENT", `Transfert de lead mission <strong>${mData.name}</strong> demandé pour <strong>${req.targetName}</strong>.<br>Valider ?`, async () => {
                                await updateDoc(publicDoc('missions', mId), {
                                    leaderId: req.targetId,
                                    leaderName: req.targetName,
                                    transferRequest: null // Clear request
                                });
                                addLog(`Le SL a validé ${req.targetName} comme nouveau Chef de Mission.`, 'CMD', true);
                            });
                        }
                    }
                });
            }));
        }

        async function addLog(message, type = 'INFO', isPriority = false) {
            if (!currentUserId) return;
            await addDoc(publicPath('logs'), { message, type, timestamp: serverTimestamp() });
            await addDoc(publicPath('notifications'), {
                message, type, timestamp: serverTimestamp(), read: false, isPriority, senderName: `${userGrade} ${userPseudo}`
            });
        }

        // --- LOGIN ACTIONS ---
        window.loginSL = async () => {
            if (!currentUserId) return hudAlert("Système", "Connexion réseau...");
            const pseudo = document.getElementById('sl-pseudo').value.toUpperCase();
            const grade = document.getElementById('sl-grade').value;
            if (!pseudo) return hudAlert("Erreur", "Pseudo requis");

            await setDoc(publicDoc('settings', 'global'), { slSessionId: currentUserId, slName: `${grade} ${pseudo}`, serviceStatus: 'ACTIVE' }, { merge: true });
            await setDoc(publicDoc('users', currentUserId), { pseudo, grade, role: 'SL', isOnline: true, lastActive: serverTimestamp() });

            userRole = 'SL'; userPseudo = pseudo; userGrade = grade; lastNotificationTime = Date.now();
            document.getElementById('auth-screen').classList.add('hidden');
            loadInterface();
        };

        window.showLogLogin = () => {
            document.getElementById('login-sl-form').classList.add('hidden');
            document.getElementById('login-log-form').classList.remove('hidden');
            const list = document.getElementById('roster-list-login');
            list.innerHTML = '<div class="text-center animate-pulse text-green-500">CHARGEMENT...</div>';
            onSnapshot(publicPath('roster'), (snap) => {
                list.innerHTML = '';
                if(snap.empty) list.innerHTML = '<div class="text-red-500 text-center">Aucun effectif.</div>';
                snap.forEach(doc => {
                    const d = doc.data();
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left border border-green-900 bg-black/40 p-4 mb-2 rounded flex justify-between items-center touch-manipulation hover:bg-green-900/20";
                    btn.innerHTML = `<span class="font-bold text-green-400">${d.grade} ${d.pseudo}</span><i class="fas fa-fingerprint text-green-700"></i>`;
                    btn.onclick = () => loginLOG(doc.id, d.pseudo, d.grade);
                    list.appendChild(btn);
                });
            });
        };

        window.loginLOG = async (rosterId, pseudo, grade) => {
            const g = await getDoc(publicDoc('settings', 'global'));
            if (g.exists() && g.data().serviceStatus === 'ENDED') return hudAlert("Erreur", "Service terminé.");
            
            await setDoc(publicDoc('users', currentUserId), { 
                pseudo, grade, role: 'LOG', rosterId, isOnline: true, rtbStatus: 'NONE', lastActive: serverTimestamp() 
            });
            userRole = 'LOG'; userPseudo = pseudo; userGrade = grade; lastNotificationTime = Date.now();
            addLog(`${grade} ${pseudo} est connectée.`, 'CONNECT');
            document.getElementById('auth-screen').classList.add('hidden');
            loadInterface();
        };

        // --- LOGISTICIAN WORKFLOW ---
        window.requestLogRTB = async () => {
            hudConfirm("FIN DE SERVICE", "Demander un retour base (RTB) et quitter les effectifs ?", async () => {
                await updateDoc(publicDoc('users', currentUserId), { rtbStatus: 'REQUESTED' });
                addLog(`${userPseudo} demande une FIN DE SERVICE (RTB).`, 'ADMIN', true);
                hudAlert("EN ATTENTE", "Demande envoyée au Squad Leader. Restez en stand-by.");
            });
        };

        // --- SL WORKFLOW ---
        window.handleRTBRequest = (userId, userName, accept) => {
            if(accept) {
                updateDoc(publicDoc('users', userId), { rtbStatus: 'APPROVED', isOnline: false }); // Approved triggers listener on user side
                addLog(`${userName} a terminé son service.`, 'ADMIN');
            } else {
                updateDoc(publicDoc('users', userId), { rtbStatus: 'DENIED' });
                // Could add a notification to user saying denied
            }
            // Remove alert modal if open
            closeAlertModal();
        };

        window.endServiceGlobal = () => {
            hudConfirm("FIN DE SERVICE GÉNÉRALE", "Ceci déconnectera TOUS les agents.<br>Confirmer ?", async () => {
                await updateDoc(publicDoc('settings', 'global'), { serviceStatus: 'ENDED' });
                addLog("FIN DE SERVICE ORDONNÉE.", "CMD", true);
            });
        };

        function loadInterface() {
            document.getElementById('main-interface').classList.remove('hidden');
            safeSetText('user-identity', `${userGrade} ${userPseudo}`);
            safeSetText('user-badge', userRole);
            
            setupNotifications();
            setupVehiclesListener();
            setupMissionsListener();

            // Show/Hide Buttons based on Role
            const slDiv = document.getElementById('sl-controls');
            const logDiv = document.getElementById('log-controls');
            const garageBtn = document.getElementById('garage-btn');
            const endBtn = document.getElementById('btn-end-service');

            if (userRole === 'SL') {
                slDiv.classList.remove('hidden');
                logDiv.classList.add('hidden');
                garageBtn.classList.remove('hidden');
                endBtn.classList.remove('hidden');
            } else {
                slDiv.classList.add('hidden');
                logDiv.classList.remove('hidden');
                garageBtn.classList.add('hidden');
                endBtn.classList.add('hidden');
            }
        }

        // --- NOTIFICATIONS / ALERTS ---
        function setupNotifications() {
            const feed = document.getElementById('notif-feed');
            listeners.push(onSnapshot(publicPath('notifications'), (snap) => {
                // Detect Alerts
                snap.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const d = change.doc.data();
                        if (d.isPriority && getMillis(d.timestamp) > lastNotificationTime) {
                            // SL Logic for RTB Requests handled specially via User Listener, 
                            // but here we handle generic Priority Messages
                            if(userRole === 'SL' && d.message.includes('demande une FIN DE SERVICE')) {
                                // We need the USER ID to validate. 
                                // Limitation: Log doesn't have UserID easily. 
                                // Better approach: SL listens to USERS collection for 'REQUESTED'.
                            } else {
                                // Generic Alert
                                showAlertModal(d.type, d.message, d.senderName);
                            }
                        }
                    }
                });

                // Render Feed
                feed.innerHTML = '';
                let docs = snap.docs.map(d => d.data()).sort((a,b) => getMillis(b.timestamp) - getMillis(a.timestamp));
                docs.slice(0, 50).forEach(d => {
                    const el = document.createElement('div');
                    el.className = `text-xs border-b border-green-900/30 p-2 font-mono ${d.isPriority ? 'text-red-400 bg-red-900/10' : 'text-green-300'}`;
                    el.innerHTML = `<span class="opacity-50">[${formatTime(d.timestamp)}]</span> <b>${d.type}:</b> ${d.message}`;
                    feed.appendChild(el);
                });
            }));

            // SL Specific: Listen for RTB Requests
            if (userRole === 'SL') {
                listeners.push(onSnapshot(query(publicPath('users'), where('rtbStatus', '==', 'REQUESTED')), (snap) => {
                    snap.forEach(doc => {
                        const d = doc.data();
                        // Custom Modal for Action
                        const m = document.getElementById('hud-action-modal');
                        document.getElementById('hud-action-title').innerText = "DEMANDE FIN DE SERVICE";
                        document.getElementById('hud-action-msg').innerHTML = `L'agent <strong>${d.grade} ${d.pseudo}</strong> demande à quitter le service.`;
                        m.classList.remove('hidden');
                        
                        // Bind buttons
                        document.getElementById('btn-action-yes').onclick = () => { m.classList.add('hidden'); handleRTBRequest(doc.id, d.pseudo, true); };
                        document.getElementById('btn-action-no').onclick = () => { m.classList.add('hidden'); handleRTBRequest(doc.id, d.pseudo, false); };
                    });
                }));
            }
        }

        // --- MISSIONS ---
        
        // 1. Create (SL)
        window.openMissionModal = async () => {
            document.getElementById('mission-modal').classList.remove('hidden');
            const list = document.getElementById('mission-vehicle-list');
            list.innerHTML = '...';
            const snap = await getDocs(publicPath('vehicles'));
            list.innerHTML = '';
            let c = 0;
            snap.forEach(doc => {
                const d = doc.data();
                if(d.status === 'OPS' && !d.missionId) {
                    c++;
                    const l = document.createElement('label');
                    l.className = "flex items-center gap-3 p-3 bg-black/40 border border-green-900/50 rounded cursor-pointer";
                    l.innerHTML = `<input type="checkbox" class="accent-green-500 w-5 h-5 m-chk" value="${doc.id}"><div class="text-sm font-bold text-green-400">${d.name} <span class="text-xs text-gray-500">(${d.category})</span></div>`;
                    list.appendChild(l);
                }
            });
            if(c===0) list.innerHTML = '<div class="text-center text-gray-500 py-4">Aucun véhicule OPS.</div>';
        };

        window.confirmMission = async () => {
            const name = document.getElementById('mission-name').value;
            if(!name) return;
            const chks = document.querySelectorAll('.m-chk:checked');
            const vIds = Array.from(chks).map(c => c.value);
            
            const mRef = await addDoc(publicPath('missions'), {
                name, status: 'ACTIVE', leaderId: null, leaderName: null, createdAt: serverTimestamp(), vehicleCount: vIds.length
            });
            
            const batch = writeBatch(db);
            vIds.forEach(id => batch.update(publicDoc('vehicles', id), { status: 'MISSION', missionId: mRef.id }));
            await batch.commit();
            
            addLog(`Mission lancée : ${name}`, 'MISSION');
            document.getElementById('mission-modal').classList.add('hidden');
        };

        // 2. Details & Leadership
        window.openMissionDetails = (mId) => {
            const modal = document.getElementById('mission-details-modal');
            modal.classList.remove('hidden');
            
            // Setup Leader Transfer UI logic
            const leaderActions = document.getElementById('leader-mission-actions');
            
            // Listener Mission
            listeners.push(onSnapshot(publicDoc('missions', mId), (doc) => {
                if(!doc.exists()) return modal.classList.add('hidden');
                const d = doc.data();
                document.getElementById('detail-mission-name').innerText = d.name;
                const isLeader = d.leaderId === currentUserId;
                
                // Render Header Leader
                const lContainer = document.getElementById('detail-mission-leader');
                if(d.leaderName) {
                    lContainer.innerHTML = `<div class="border border-green-500 p-2 rounded text-center bg-green-900/20"><div class="text-[10px] text-gray-400">CHEF DE MISSION</div><div class="text-xl font-bold text-green-400">${d.leaderName}</div></div>`;
                } else {
                    lContainer.innerHTML = `<button onclick="requestLeadership('${mId}')" class="btn-tac w-full py-2 bg-yellow-900/20 border-yellow-500 text-yellow-500 animate-pulse font-bold rounded">PRENDRE LE COMMANDEMENT</button>`;
                }

                // Actions Area
                let html = '';
                // If I am leader, I can do global actions + transfer
                if(isLeader) {
                    html += `
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button onclick="sendCitrep('${d.name}')" class="btn-tac border-blue-500 text-blue-300 py-2">CITREP</button>
                        <button onclick="requestRTB('${d.name}')" class="btn-tac border-orange-500 text-orange-300 py-2">RTB GLOBAL</button>
                    </div>
                    <div class="mb-4">
                        <button onclick="initiateTransfer('${mId}')" class="btn-tac w-full border-gray-600 text-gray-400 text-xs py-2">TRANSFÉRER LE LEAD</button>
                    </div>
                    `;
                } 
                // If I am just a member (in a vehicle of this mission) AND there is a leader already
                else if (d.leaderId) { 
                     html += `<button onclick="requestLeadership('${mId}')" class="btn-tac w-full border-gray-600 text-gray-400 text-xs py-2 mt-2">DEMANDER LE LEAD (REMPLACEMENT)</button>`;
                }
                
                leaderActions.innerHTML = html;
                leaderActions.classList.remove('hidden');

                // SL Actions
                const slActions = document.getElementById('sl-mission-actions');
                if(userRole === 'SL') {
                    slActions.innerHTML = `<div class="grid grid-cols-2 gap-4 pt-4 border-t border-green-900/50"><button onclick="endMission('${mId}', 'COMPLETED')" class="btn-tac bg-green-900/40 text-green-400 font-bold py-3">ACCOMPLIE</button><button onclick="endMission('${mId}', 'CANCELLED')" class="btn-tac border-red-500 text-red-500 font-bold py-3">ANNULER</button></div>`;
                    slActions.classList.remove('hidden');
                } else slActions.classList.add('hidden');
            }));

            // Listener Vehicles
            const vContainer = document.getElementById('detail-mission-vehicles');
            listeners.push(onSnapshot(publicPath('vehicles'), (snap) => {
                vContainer.innerHTML = '';
                snap.forEach(doc => {
                    if(doc.data().missionId === mId) {
                        vContainer.appendChild(createVehicleCard(doc.id, doc.data(), true));
                    }
                });
            }));
        };

        // LEADERSHIP LOGIC
        window.requestLeadership = (mId) => {
            // If no leader, take it directly (with confirmation)
            // If leader exists, ask SL for override
            hudConfirm("COMMANDEMENT", "Voulez-vous prendre le commandement de cette mission ?", async () => {
                // Simple direct Logic requested: "Un joueur... va pouvoir aussi faire une demande"
                // We route via the 'transferRequest' system to SL
                await updateDoc(publicDoc('missions', mId), {
                    transferRequest: { targetId: currentUserId, targetName: `${userGrade} ${userPseudo}`, state: 'WAITING_SL' }
                });
                hudAlert("ENVOYÉ", "Demande transmise au Squad Leader.");
            });
        };

        window.initiateTransfer = async (mId) => {
            // Logic: Get list of players in mission -> Select one -> Send Invite
            // For this demo, we prompt for a name/ID or simpler: just trigger a generic "Whoever accepts first" or assume the leader knows the roster.
            // Let's use the Roster list for selection to be clean.
            const modal = document.getElementById('transfer-select-modal');
            const list = document.getElementById('transfer-list');
            modal.classList.remove('hidden');
            list.innerHTML = 'Chargement...';
            
            // Get online users
            const snap = await getDocs(query(publicPath('users'), where('isOnline', '==', true)));
            list.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                if (doc.id !== currentUserId) { // Don't transfer to self
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-3 bg-black/60 border border-green-900 hover:bg-green-900/30 mb-1 text-green-400 font-bold";
                    btn.innerText = `${d.grade} ${d.pseudo}`;
                    btn.onclick = async () => {
                        modal.classList.add('hidden');
                        // Start 3-way handshake
                        await updateDoc(publicDoc('missions', mId), {
                            transferRequest: { targetId: doc.id, targetName: `${d.grade} ${d.pseudo}`, state: 'WAITING_TARGET' }
                        });
                        hudAlert("OFFRE ENVOYÉE", `Proposition de commandement envoyée à ${d.pseudo}.`);
                    };
                    list.appendChild(btn);
                }
            });
        };

        window.endMission = (mId, status) => {
            hudConfirm("FIN DE MISSION", "Confirmer la clôture ? Les véhicules repasseront OPS.", async () => {
                const batch = writeBatch(db);
                batch.update(publicDoc('missions', mId), { status: status === 'COMPLETED' ? 'ARCHIVED' : 'CANCELLED' });
                const vSnap = await getDocs(query(publicPath('vehicles'), where('missionId', '==', mId)));
                vSnap.forEach(v => batch.update(v.ref, { status: 'OPS', missionId: null }));
                await batch.commit();
                document.getElementById('mission-details-modal').classList.add('hidden');
            });
        };

        // --- VEHICLES ---
        function setupVehiclesListener() {
            const grid = document.getElementById('vehicle-grid');
            listeners.push(onSnapshot(publicPath('vehicles'), (snap) => {
                if(!grid) return;
                grid.innerHTML = '';
                snap.forEach(doc => grid.appendChild(createVehicleCard(doc.id, doc.data())));
            }));
        }

        function createVehicleCard(id, data, isMissionView = false) {
            const div = document.createElement('div');
            const statusColors = { 'OPS': 'border-green-500', 'MISSION': 'border-blue-500', 'REPAIR': 'border-orange-500', 'DESTROYED': 'border-red-600 opacity-60' };
            div.className = `bg-gray-900/90 border-2 ${statusColors[data.status] || 'border-gray-500'} p-3 rounded relative flex flex-col gap-2`;
            
            div.innerHTML = `
                <div class="flex justify-between items-start border-b border-gray-700 pb-2">
                    <div><div class="text-xs text-gray-400">${data.category}</div><div class="font-bold text-white truncate w-24">${data.name}</div></div>
                    <div class="text-xs font-bold px-1 bg-black rounded">${data.status}</div>
                </div>
            `;
            
            // Seats
            const seatsDiv = document.createElement('div');
            seatsDiv.className = "grid grid-cols-3 gap-1";
            ['driver', 'copilot', 'gunner'].forEach(role => {
                const occ = data.seats[role];
                const btn = document.createElement('button');
                const isMe = occ && occ.uid === currentUserId;
                btn.className = `h-12 border rounded text-[9px] flex flex-col items-center justify-center ${isMe ? 'bg-green-500 text-black font-bold' : (occ ? 'bg-green-900/50 text-green-300' : 'bg-gray-800 text-gray-500')}`;
                btn.innerHTML = `<span>${role.substr(0,3).toUpperCase()}</span><span>${occ ? occ.name : 'LIBRE'}</span>`;
                if(data.status !== 'DESTROYED') btn.onclick = () => toggleSeat(id, data, role);
                seatsDiv.appendChild(btn);
            });
            div.appendChild(seatsDiv);

            // Actions
            if(userRole === 'SL' && !isMissionView) {
                const acts = document.createElement('div');
                acts.className = "grid grid-cols-2 gap-1 mt-auto pt-2 text-[10px]";
                if(data.status === 'DESTROYED') {
                    acts.innerHTML = `<button onclick="deleteVeh('${id}')" class="col-span-2 border border-red-500 text-red-500 p-1">ARCHIVER</button>`;
                } else {
                    acts.innerHTML = `<button onclick="setVeh('${id}', 'REPAIR')" class="border border-orange-500 text-orange-500">RÉPARER</button><button onclick="setVeh('${id}', 'DESTROYED')" class="border border-red-500 text-red-500">DÉTRUIRE</button>`;
                }
                div.appendChild(acts);
            }
            
            // Unit Actions (Mission Leader context)
            if(isMissionView) {
                 const uActs = document.createElement('div');
                 uActs.className = "grid grid-cols-2 gap-1 mt-auto pt-2 text-[10px]";
                 uActs.innerHTML = `<button onclick="unitCitrep('${data.name}')" class="border border-blue-500 text-blue-300">CITREP</button><button onclick="unitRtb('${data.name}')" class="border border-orange-500 text-orange-300">RTB</button>`;
                 div.appendChild(uActs);
            }

            return div;
        }

        window.toggleSeat = async (id, data, role) => {
            const occ = data.seats[role];
            if(occ && occ.uid === currentUserId) {
                await updateDoc(publicDoc('vehicles', id), { [`seats.${role}`]: null });
            } else if(!occ) {
                await updateDoc(publicDoc('vehicles', id), { [`seats.${role}`]: { uid: currentUserId, name: userPseudo } });
            } else {
                hudAlert("Occupé", "Place déjà prise.");
            }
        };

        window.setVeh = (id, s) => updateDoc(publicDoc('vehicles', id), { status: s });
        window.deleteVeh = (id) => { hudConfirm("ARCHIVER", "Retirer le véhicule ?", () => deleteDoc(publicDoc('vehicles', id))); };
        window.unitCitrep = (n) => hudPrompt(`CITREP ${n}`, "Message :", (msg) => addLog(`[CITREP ${n}] ${msg}`, 'RADIO', true));
        window.unitRtb = (n) => addLog(`ORDRE RTB POUR ${n}`, 'CMD', true);
        window.sendCitrep = (m) => hudPrompt(`CITREP MISSION`, "Message global :", (msg) => addLog(`[CITREP GLOBAL] ${msg}`, 'MISSION', true));
        window.requestRTB = (m) => addLog(`ORDRE RTB GLOBAL MISSION ${m}`, 'MISSION', true);

        // --- GLOBAL MODAL UTILS ---
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.toggleModal = (id) => document.getElementById(id).classList.toggle('hidden');
        window.showAlertModal = (t,m,s) => {
            const el = document.getElementById('hud-alert-modal');
            document.getElementById('hud-alert-title').innerText = t;
            document.getElementById('hud-alert-msg').innerText = m;
            el.classList.remove('hidden');
        };
        window.closeAlertModal = () => document.getElementById('hud-alert-modal').classList.add('hidden');

    </script>

    <!-- Custom CSS -->
    <style>
        :root { --neon-green: #22c55e; --bg-dark: #0f172a; }
        body { background-color: #050505; color: #e2e8f0; font-family: 'Share Tech Mono', monospace; overflow: hidden; }
        .hud-panel { background: rgba(10, 15, 10, 0.95); border: 1px solid rgba(34, 197, 94, 0.3); box-shadow: 0 0 15px rgba(34, 197, 94, 0.1); }
        .btn-tac { border: 1px solid #22c55e; color: #22c55e; background: rgba(34, 197, 94, 0.05); transition: 0.1s; }
        .btn-tac:active { background: #22c55e; color: black; }
        .modal-bg { background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); }
        /* Animation for Alerts */
        @keyframes flash { 0%, 100% { border-color: red; } 50% { border-color: transparent; } }
        .alert-border { border: 2px solid red; animation: flash 1s infinite; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-black p-4">
        <div class="hud-panel w-full max-w-md p-6 rounded">
            <h1 class="text-4xl text-green-500 text-center mb-6 font-bold">LOGIOPS V2</h1>
            <div class="flex gap-4 mb-4">
                <button onclick="document.getElementById('login-sl-form').classList.remove('hidden');document.getElementById('login-log-form').classList.add('hidden')" class="flex-1 py-3 border border-green-600 text-green-400 rounded">SQUAD LEADER</button>
                <button onclick="showLogLogin()" class="flex-1 py-3 border border-green-600 text-green-400 rounded">LOGISTICIEN</button>
            </div>
            <div id="login-sl-form">
                <select id="sl-grade" class="w-full bg-gray-900 border border-green-800 p-2 mb-2 text-white"><option>Sgt</option><option>Adj</option><option>Lt</option></select>
                <input id="sl-pseudo" class="w-full bg-gray-900 border border-green-800 p-2 mb-4 text-white uppercase" placeholder="PSEUDO">
                <button onclick="loginSL()" class="btn-tac w-full py-3 font-bold">CONNEXION</button>
            </div>
            <div id="login-log-form" class="hidden">
                <div id="roster-list-login" class="max-h-60 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <!-- MAIN UI -->
    <div id="main-interface" class="hidden flex-1 flex flex-col h-full relative z-10">
        <!-- HEADER -->
        <header class="h-14 border-b border-green-900/50 flex items-center px-4 bg-gray-900/80 gap-4">
            <div id="header-sl-name" class="text-xs border border-green-800 px-2 py-1 rounded text-green-600 font-bold">CMD: --</div>
            <div class="flex-1 flex gap-4 overflow-x-auto items-center no-scrollbar">
                <div class="flex flex-col items-center" onclick="openSupplyModal()"><span class="text-[9px] text-gray-500">SUPPLY</span><span id="supply-count" class="text-lg font-bold text-white">0</span></div>
                <div class="flex flex-col items-center"><span class="text-[9px] text-gray-500">EFFECTIFS</span><span id="stat-log-count" class="text-lg font-bold text-green-400">0/0</span></div>
            </div>
            <button id="garage-btn" onclick="toggleModal('garage-modal')" class="btn-tac px-3 py-1 text-xs font-bold rounded">GARAGE</button>
        </header>

        <!-- CONTENT -->
        <div class="flex-1 flex overflow-hidden">
            <!-- SIDEBAR -->
            <aside class="w-16 md:w-64 bg-black/40 border-r border-green-900/30 flex flex-col items-center md:items-stretch py-2 gap-2">
                <div id="sl-controls" class="flex flex-col gap-2 px-2">
                    <button onclick="openMissionModal()" class="btn-tac py-3 text-xs font-bold rounded">CRÉER MISSION</button>
                    <button onclick="toggleModal('roster-modal')" class="btn-tac py-3 text-xs font-bold rounded">GESTION LOGS</button>
                    <button onclick="endServiceGlobal()" class="btn-tac border-red-500 text-red-500 py-3 text-xs font-bold rounded mt-4">FIN SERVICE</button>
                </div>
                <div id="log-controls" class="flex flex-col gap-2 px-2">
                    <button onclick="requestLogRTB()" class="btn-tac border-orange-500 text-orange-500 py-3 text-xs font-bold rounded">DEMANDE RTB</button>
                </div>
                <!-- Mission List -->
                <div id="mission-list" class="flex-1 overflow-y-auto px-2 mt-4 space-y-2"></div>
            </aside>

            <!-- DASHBOARD -->
            <main class="flex-1 bg-gradient-to-b from-black/50 to-green-900/10 p-4 overflow-y-auto">
                <div id="vehicle-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            </main>
        </div>

        <!-- FOOTER FEED -->
        <footer class="h-40 bg-black border-t border-green-900 flex flex-col">
            <div class="bg-green-900/20 p-1 text-green-500 text-xs font-bold px-2">LIVE FEED</div>
            <div id="notif-feed" class="flex-1 overflow-y-auto p-2"></div>
        </footer>
    </div>

    <!-- MODALS -->
    
    <!-- 1. CONFIRMATION MODAL -->
    <div id="hud-confirm-modal" class="modal-bg fixed inset-0 z-[100] hidden flex items-center justify-center p-6">
        <div class="hud-panel w-full max-w-sm p-6 text-center rounded">
            <h3 id="hud-confirm-title" class="text-xl font-bold text-white mb-4">CONFIRMATION</h3>
            <p id="hud-confirm-msg" class="text-green-300 mb-6"></p>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="window._onConfirmYes()" class="btn-tac py-3 font-bold rounded">OUI</button>
                <button onclick="document.getElementById('hud-confirm-modal').classList.add('hidden')" class="border border-gray-600 text-gray-400 py-3 rounded">NON</button>
            </div>
        </div>
    </div>

    <!-- 2. PROMPT MODAL -->
    <div id="hud-prompt-modal" class="modal-bg fixed inset-0 z-[100] hidden flex items-center justify-center p-6">
        <div class="hud-panel w-full max-w-sm p-6 rounded">
            <h3 id="hud-prompt-title" class="text-xl font-bold text-white mb-2">SAISIE</h3>
            <p id="hud-prompt-msg" class="text-xs text-gray-400 mb-4"></p>
            <input id="hud-prompt-input" class="w-full bg-black border border-green-700 p-3 text-white mb-4 rounded">
            <div class="grid grid-cols-2 gap-4">
                <button onclick="window._onPromptSubmit()" class="btn-tac py-2 font-bold rounded">VALIDER</button>
                <button onclick="document.getElementById('hud-prompt-modal').classList.add('hidden')" class="border border-gray-600 text-gray-400 py-2 rounded">ANNULER</button>
            </div>
        </div>
    </div>

    <!-- 3. ALERT / INFO MODAL -->
    <div id="hud-alert-modal" class="modal-bg fixed inset-0 z-[100] hidden flex items-center justify-center p-6">
        <div class="hud-panel w-full max-w-sm p-6 text-center rounded border-red-500 alert-border">
            <h3 id="hud-alert-title" class="text-2xl font-bold text-red-500 mb-4">ALERTE</h3>
            <p id="hud-alert-msg" class="text-white mb-6 text-lg"></p>
            <button onclick="document.getElementById('hud-alert-modal').classList.add('hidden')" class="w-full py-3 bg-red-900/50 text-white font-bold border border-red-500 rounded">REÇU</button>
        </div>
    </div>

    <!-- 4. ACTION DECISION MODAL (SL RTB) -->
    <div id="hud-action-modal" class="modal-bg fixed inset-0 z-[100] hidden flex items-center justify-center p-6">
        <div class="hud-panel w-full max-w-sm p-6 text-center rounded border-yellow-500">
            <h3 id="hud-action-title" class="text-xl font-bold text-yellow-500 mb-4">ACTION REQUISE</h3>
            <p id="hud-action-msg" class="text-white mb-6"></p>
            <div class="grid grid-cols-2 gap-4">
                <button id="btn-action-yes" class="btn-tac border-green-500 text-green-500 py-3 font-bold rounded">ACCEPTER</button>
                <button id="btn-action-no" class="btn-tac border-red-500 text-red-500 py-3 font-bold rounded">REFUSER</button>
            </div>
        </div>
    </div>

    <!-- 5. MISSION DETAILS -->
    <div id="mission-details-modal" class="modal-bg fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="hud-panel w-full max-w-4xl h-[90vh] flex flex-col p-4 rounded relative">
            <button onclick="closeModal('mission-details-modal')" class="absolute top-4 right-4 text-red-500 text-xl"><i class="fas fa-times"></i></button>
            <div class="flex justify-between items-center border-b border-green-900 pb-4 mb-4">
                <h2 id="detail-mission-name" class="text-3xl font-bold text-white">MISSION</h2>
                <div id="detail-mission-leader"></div>
            </div>
            <div id="leader-mission-actions" class="hidden mb-4 p-2 border border-blue-900/30 rounded bg-blue-900/10"></div>
            
            <div class="flex-1 overflow-y-auto bg-black/30 p-2 rounded border border-green-900/30">
                <div id="detail-mission-vehicles" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </div>
            <div id="sl-mission-actions" class="hidden mt-4"></div>
        </div>
    </div>

    <!-- 6. TRANSFER SELECTOR -->
    <div id="transfer-select-modal" class="modal-bg fixed inset-0 z-[110] hidden flex items-center justify-center p-4">
        <div class="hud-panel w-full max-w-md p-4 rounded max-h-[80vh] flex flex-col">
            <h3 class="text-white font-bold mb-4">SÉLECTIONNER LE NOUVEAU CHEF</h3>
            <div id="transfer-list" class="flex-1 overflow-y-auto"></div>
            <button onclick="closeModal('transfer-select-modal')" class="mt-4 py-2 border border-gray-600 text-gray-400">ANNULER</button>
        </div>
    </div>

    <!-- OTHER MODALS (Garage, Roster, Mission Create) kept simple/standard structure but hidden initially -->
    <!-- ... (Include Garage, Roster, Mission Create using standard hidden div structure similar to above) ... -->
    <div id="garage-modal" class="hidden modal-bg fixed inset-0 z-50 flex items-center justify-center p-4"><div class="hud-panel p-6 rounded w-full max-w-md"><h3 class="text-xl text-green-500 font-bold mb-4">GARAGE</h3><div class="space-y-2"><select id="new-veh-type" class="w-full bg-black border border-green-700 p-2 text-white"><option value="LOGI">LOGI (300)</option><option value="JEEP">JEEP (100)</option><option value="TRANSPORT">TRANSPORT (200)</option></select><input id="new-veh-name" class="w-full bg-black border border-green-700 p-2 text-white" placeholder="NOM"><button onclick="createVehicle()" class="btn-tac w-full py-3 font-bold mt-2">SORTIR</button><button onclick="closeModal('garage-modal')" class="mt-2 text-gray-500 w-full">FERMER</button></div></div></div>
    <div id="mission-modal" class="hidden modal-bg fixed inset-0 z-50 flex items-center justify-center p-4"><div class="hud-panel p-6 rounded w-full max-w-md h-[80vh] flex flex-col"><h3 class="text-xl text-green-500 font-bold mb-4">NOUVELLE MISSION</h3><input id="mission-name" class="w-full bg-black border border-green-700 p-2 text-white mb-4" placeholder="NOM OPÉRATION"><div id="mission-vehicle-list" class="flex-1 overflow-y-auto border border-green-900/50 p-2 mb-4"></div><button onclick="confirmMission()" class="btn-tac w-full py-3 font-bold">LANCER</button><button onclick="closeModal('mission-modal')" class="mt-2 text-gray-500 w-full">ANNULER</button></div></div>
    <div id="roster-modal" class="hidden modal-bg fixed inset-0 z-50 flex items-center justify-center p-4"><div class="hud-panel p-6 rounded w-full max-w-md h-[60vh] flex flex-col"><h3 class="text-xl text-green-500 font-bold mb-4">ROSTER</h3><button onclick="addToRoster()" class="btn-tac w-full py-2 mb-4">AJOUTER PERSONNEL</button><div id="sl-roster-list" class="flex-1 overflow-y-auto"></div><button onclick="closeModal('roster-modal')" class="mt-2 text-gray-500 w-full">FERMER</button></div></div>

</body>
</html>
