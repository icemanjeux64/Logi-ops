<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>LOGIOPS V2 // MILITARY LOGISTICS</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, setDoc, getDoc, updateDoc, 
            onSnapshot, deleteDoc, serverTimestamp, query, orderBy, addDoc, where, getDocs, writeBatch 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyASPGZJO1JU5GeoBtmj5UTP8ErPSQIPeFA",
            authDomain: "logiops-data.firebaseapp.com",
            projectId: "logiops-data",
            storageBucket: "logiops-data.firebasestorage.app",
            messagingSenderId: "791163499354",
            appId: "1:791163499354:web:2bb76506331db9d240b963",
            measurementId: "G-FFMXKH47M9"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'logiops-v2-production';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global State
        let currentUser = null;
        let userRole = null;
        let userPseudo = null;
        let userGrade = null;
        let currentUserId = null;
        let lastNotificationTime = Date.now(); // Initialize to NOW to prevent old alerts on fresh load
        let slSessionActive = false;
        
        // Filtering
        let currentFilter = 'ALL'; 
        let vehicleDataCache = [];

        // Requests Queue
        let pendingRequests = [];

        // Cleanups
        let listeners = [];

        // Data Constants
        const RANKS = [
            "Sdt", "1re Cl", "Cpl", "Cpl-Chef", 
            "Sgt", "Sgt-Chef", "Adj", "Adj-Chef", "Major", 
            "Asp", "S-Lt", "Lt", "Cne", "Cdt", "Lt-Col", "Col", "Gen"
        ];

        // --- UTILS ---
        const formatTime = (date) => {
            if (!date) return "--:--";
            const d = date.toDate ? date.toDate() : new Date(date);
            return d.toLocaleTimeString('fr-FR', { hour12: false, hour: '2-digit', minute: '2-digit' });
        };
        
        const getMillis = (d) => d && d.toMillis ? d.toMillis() : (new Date(d).getTime() || 0);
        const safeSetText = (id, text) => { 
            const els = document.querySelectorAll(`.${id}`); 
            els.forEach(el => el.innerText = text);
            const el = document.getElementById(id);
            if(el) el.innerText = text; 
        };

        // CUSTOM DIALOG SYSTEM
        window.hudConfirm = (title, message, onYes) => {
            const m = document.getElementById('hud-confirm-modal');
            document.getElementById('hud-confirm-title').innerText = title;
            document.getElementById('hud-confirm-msg').innerHTML = message;
            m.classList.remove('hidden');
            window._onConfirmYes = () => { m.classList.add('hidden'); onYes(); };
        };
        
        window.hudPrompt = (title, message, onSubmit) => {
            const m = document.getElementById('hud-prompt-modal');
            document.getElementById('hud-prompt-title').innerText = title;
            document.getElementById('hud-prompt-msg').innerText = message;
            const input = document.getElementById('hud-prompt-input');
            input.value = '';
            m.classList.remove('hidden');
            input.focus();
            window._onPromptSubmit = () => { 
                if(input.value.trim()) { m.classList.add('hidden'); onSubmit(input.value.trim()); }
            };
        };

        window.hudAlert = (title, message) => {
            const m = document.getElementById('hud-alert-modal');
            document.getElementById('hud-alert-title').innerText = title;
            document.getElementById('hud-alert-msg').innerText = message;
            m.classList.remove('hidden');
        };

        // --- PATH HELPERS ---
        const publicPath = (col) => collection(db, 'artifacts', appId, 'public', 'data', col);
        const publicDoc = (col, id) => doc(db, 'artifacts', appId, 'public', 'data', col, id);

        // --- AUTHENTICATION ---
        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                 await signInWithCustomToken(auth, __initial_auth_token);
            } else { await signInAnonymously(auth); }
        }
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                currentUserId = user.uid;
                
                const storedUid = localStorage.getItem('logiops_uid');
                if(storedUid) restoreSession(user.uid);
                else checkAppState();

                const unsubMe = onSnapshot(publicDoc('users', user.uid), (doc) => {
                    if(doc.exists()) {
                        const d = doc.data();
                        if(d.rtbStatus === 'APPROVED') {
                            hudAlert("FIN DE SERVICE", "Demande RTB validée. Rompez.");
                            updateDoc(publicDoc('users', user.uid), { rtbStatus: 'OFFLINE', isOnline: false });
                            localStorage.removeItem('logiops_uid');
                            setTimeout(() => location.reload(), 3000);
                        }
                        if(d.rtbStatus === 'KICKED') {
                            alert("VOUS AVEZ ÉTÉ EXCLU DU SERVICE.");
                            localStorage.removeItem('logiops_uid');
                            location.reload();
                        }
                        if(d.role && d.role !== userRole) {
                            userRole = d.role;
                            loadInterface();
                        }
                    }
                });
                listeners.push(unsubMe);
            }
        });

        async function restoreSession(uid) {
            try {
                const docSnap = await getDoc(publicDoc('users', uid));
                if(docSnap.exists() && docSnap.data().isOnline) {
                    const d = docSnap.data();
                    userRole = d.role; userPseudo = d.pseudo; userGrade = d.grade;
                    
                    // FIX: Set lastNotificationTime to NOW to ignore past alerts on restore
                    lastNotificationTime = Date.now();
                    
                    checkAppState();
                } else {
                    localStorage.removeItem('logiops_uid');
                    checkAppState();
                }
            } catch(e) { checkAppState(); }
        }

        // --- APP LOGIC ---

        function checkAppState() {
            const unsub = onSnapshot(publicDoc('settings', 'global'), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const headerSlEl = document.getElementById('header-sl-name');
                    
                    if (data.slSessionId) {
                        slSessionActive = true;
                        if (headerSlEl) {
                            headerSlEl.innerHTML = `CMD: ${data.slName}`;
                            headerSlEl.className = "text-xs border border-green-800 px-2 py-1 rounded text-green-600 font-bold whitespace-nowrap";
                            headerSlEl.onclick = null;
                        }
                        const slLoginBtn = document.getElementById('btn-login-sl');
                        if(slLoginBtn && currentUserId !== data.slSessionId && !userRole) slLoginBtn.classList.add('hidden');

                    } else {
                        slSessionActive = false;
                        if (headerSlEl) {
                            headerSlEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> PAS DE SQUAD LEADER`;
                            headerSlEl.className = "text-xs border border-red-800 bg-red-900/20 px-2 py-1 rounded text-red-500 font-bold whitespace-nowrap animate-pulse cursor-pointer";
                            headerSlEl.onclick = takeCommand;
                        }
                        const slLoginBtn = document.getElementById('btn-login-sl');
                        if(slLoginBtn) slLoginBtn.classList.remove('hidden');
                    }

                    if (data.serviceStatus === 'ENDED' && userRole) {
                        localStorage.removeItem('logiops_uid');
                        alert("FIN DE SERVICE ORDONNÉE");
                        location.reload();
                    }
                } else {
                    setDoc(publicDoc('settings', 'global'), { slSessionId: null, slName: 'AUCUN', serviceStatus: 'ACTIVE' });
                }
            });
            listeners.push(unsub);

            setupDepotsListener();
            setupPresenceListener();
            
            if(userRole === 'SL') {
                setupSLRequestListeners();
            }
            setupMissionTargetListener();

            if (userRole) loadInterface();
            else {
                document.getElementById('auth-screen').classList.remove('hidden');
                populateRankSelects();
            }
        }

        function populateRankSelects() {
            const opts = RANKS.map(r => `<option value="${r}">${r}</option>`).join('');
            const slSel = document.getElementById('sl-grade');
            if(slSel) slSel.innerHTML = opts;
        }

        // --- STATISTICS ---
        function setupDepotsListener() {
            listeners.push(onSnapshot(publicPath('depots'), (snapshot) => {
                let total = 0;
                snapshot.forEach(doc => total += (parseInt(doc.data().amount) || 0));
                safeSetText('supply-count', total);
                const modal = document.getElementById('supply-modal');
                if (modal && !modal.classList.contains('hidden')) renderDepotsList(snapshot);
            }));
        }

        function setupPresenceListener() {
            listeners.push(onSnapshot(publicPath('users'), (snap) => {
                let connected = 0;
                let total = 0; 
                snap.forEach(d => {
                    if (d.data().role === 'LOG') { 
                        total++; 
                        if (d.data().isOnline && d.data().rtbStatus !== 'APPROVED' && d.data().rtbStatus !== 'KICKED') connected++;
                    }
                });
                safeSetText('stat-log-count', `${connected}/${total}`);
            }));
        }

        // --- REQUESTS SYSTEM (SL SIDE) ---
        
        function setupSLRequestListeners() {
            listeners.push(onSnapshot(query(publicPath('users'), where('rtbStatus', '==', 'REQUESTED')), (snap) => {
                snap.forEach(doc => {
                    addPendingRequest({
                        id: `rtb-${doc.id}`,
                        type: 'RTB',
                        title: 'DEMANDE RTB',
                        desc: `Agent: ${doc.data().pseudo}`,
                        data: { uid: doc.id, name: doc.data().pseudo }
                    });
                });
                updateRequestsUI();
            }));

            listeners.push(onSnapshot(query(publicPath('missions'), where('transferRequest.state', '==', 'WAITING_SL')), (snap) => {
                snap.forEach(doc => {
                    const req = doc.data().transferRequest;
                    addPendingRequest({
                        id: `lead-${doc.id}`,
                        type: 'LEAD',
                        title: 'TRANSFERT DE LEAD',
                        desc: `Mission: ${doc.data().name}<br>Candidat: ${req.targetName}`,
                        data: { mId: doc.id, targetId: req.targetId, targetName: req.targetName }
                    });
                });
                updateRequestsUI();
            }));
        }

        function addPendingRequest(req) {
            if(!pendingRequests.find(r => r.id === req.id)) {
                pendingRequests.push(req);
            }
        }

        function updateRequestsUI() {
            const btn = document.getElementById('btn-requests-alert');
            const countEl = document.getElementById('requests-count');
            if(pendingRequests.length > 0) {
                btn.classList.remove('hidden');
                countEl.innerText = pendingRequests.length;
            } else {
                btn.classList.add('hidden');
            }
        }

        window.openRequestsModal = () => {
            const m = document.getElementById('requests-modal');
            const list = document.getElementById('requests-list');
            m.classList.remove('hidden');
            list.innerHTML = '';
            
            if(pendingRequests.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500">Aucune demande en attente.</div>';
                return;
            }

            pendingRequests.forEach((req, index) => {
                const div = document.createElement('div');
                div.className = "border border-yellow-500/50 bg-yellow-900/10 p-3 rounded mb-2";
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-bold text-yellow-500">${req.title}</div>
                        <div class="text-xs text-gray-400">${req.type}</div>
                    </div>
                    <div class="text-sm text-white mb-3">${req.desc}</div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="resolveRequest(${index}, true)" class="bg-green-900/50 border border-green-500 text-green-400 text-xs py-2 rounded font-bold">ACCEPTER</button>
                        <button onclick="resolveRequest(${index}, false)" class="bg-red-900/50 border border-red-500 text-red-400 text-xs py-2 rounded font-bold">REFUSER</button>
                    </div>
                `;
                list.appendChild(div);
            });
        };

        window.resolveRequest = async (index, accepted) => {
            const req = pendingRequests[index];
            
            if (req.type === 'RTB') {
                const newStatus = accepted ? 'APPROVED' : 'DENIED';
                await updateDoc(publicDoc('users', req.data.uid), { rtbStatus: newStatus, isOnline: accepted ? false : true });
                if(accepted) addLog(`${req.data.name} a terminé son service (Validé).`, 'ADMIN');
            } 
            else if (req.type === 'LEAD') {
                if(accepted) {
                    await updateDoc(publicDoc('missions', req.data.mId), {
                        leaderId: req.data.targetId,
                        leaderName: req.data.targetName,
                        transferRequest: null
                    });
                    addLog(`SL a validé ${req.data.targetName} comme Chef de Mission.`, 'CMD');
                } else {
                    await updateDoc(publicDoc('missions', req.data.mId), { transferRequest: null });
                }
            }

            pendingRequests.splice(index, 1);
            updateRequestsUI();
            
            const m = document.getElementById('requests-modal');
            if(!m.classList.contains('hidden')) openRequestsModal();
        };

        function setupMissionTargetListener() {
            listeners.push(onSnapshot(publicPath('missions'), (snap) => {
                snap.docChanges().forEach(change => {
                    const mData = change.doc.data();
                    const mId = change.doc.id;
                    if (change.type !== 'removed' && mData.transferRequest) {
                        const req = mData.transferRequest;
                        if (req.targetId === currentUserId && req.state === 'WAITING_TARGET') {
                            hudConfirm("PROMOTION CHAMP", `On vous propose le commandement de la mission <strong>${mData.name}</strong>.<br>Accepter ?`, async () => {
                                await updateDoc(publicDoc('missions', mId), { "transferRequest.state": 'WAITING_SL' });
                                addLog(`${userPseudo} a accepté le commandement (En attente SL).`, 'MISSION');
                            });
                        }
                    }
                });
            }));
        }

        // --- VEHICLE & SUPPLY ---
        window.createVehicle = async () => {
            const type = document.getElementById('new-veh-type').value;
            const name = document.getElementById('new-veh-name').value;
            const costs = { 'LOGI': 300, 'JEEP': 100, 'TRANSPORT': 200, 'BLINDE': 600 };
            const cost = costs[type] || 100;

            if(await consumeGlobalSupply(cost)) {
                await addDoc(publicPath('vehicles'), {
                    name: name || `${type}-${Math.floor(Math.random()*100)}`,
                    category: type, status: 'OPS', seats: { driver: null, copilot: null, gunner: null }, missionId: null,
                    cost: cost, createdAt: serverTimestamp(), missionCount: 0
                });
                addLog(`Véhicule sorti: ${type} (-${cost})`, 'LOGISTICS');
                document.getElementById('garage-modal').classList.add('hidden');
            } else {
                hudAlert("Erreur", "Supply insuffisant.");
            }
        };

        async function consumeGlobalSupply(amount) { const snap = await getDocs(publicPath('depots')); let targetDoc = null; snap.forEach(d => { if(d.data().amount >= amount && !targetDoc) targetDoc = d; }); if(!targetDoc) return false; await updateDoc(targetDoc.ref, { amount: targetDoc.data().amount - amount }); return true; }
        async function refundGlobalSupply(amount) { const snap = await getDocs(publicPath('depots')); if(snap.empty) return; const targetDoc = snap.docs[0]; await updateDoc(targetDoc.ref, { amount: targetDoc.data().amount + amount }); }
        async function addLog(message, type = 'INFO', isPriority = false) { if (!currentUserId) return; await addDoc(publicPath('logs'), { message, type, timestamp: serverTimestamp() }); await addDoc(publicPath('notifications'), { message, type, timestamp: serverTimestamp(), read: false, isPriority, senderName: `${userGrade} ${userPseudo}` }); }

        // UI Setup
        function loadInterface() {
            document.getElementById('main-interface').classList.remove('hidden');
            
            document.getElementById('profile-card').innerHTML = `
                <div class="text-xs text-gray-500 mb-1">IDENTITÉ</div>
                <div class="font-bold text-lg text-white">${userGrade} ${userPseudo}</div>
                <div class="text-xs bg-gray-800 px-2 py-1 rounded inline-block mt-1 text-green-400 border border-green-900">${userRole}</div>
            `;

            setupNotifications();
            setupVehiclesListener();
            setupMissionsListener();

            const slDiv = document.getElementById('sl-controls');
            const logDiv = document.getElementById('log-controls');
            const btnLeavePost = document.getElementById('btn-leave-post');
            const btnEndService = document.getElementById('btn-end-service');
            const btnCreateVeh = document.getElementById('btn-create-vehicle');

            if (userRole === 'SL') {
                slDiv.classList.remove('hidden');
                logDiv.classList.add('hidden');
                btnLeavePost.classList.remove('hidden');
                btnEndService.classList.remove('hidden');
                if(btnCreateVeh) btnCreateVeh.classList.remove('hidden');
                setupSLRequestListeners(); 
            } else {
                slDiv.classList.add('hidden');
                logDiv.classList.remove('hidden');
                btnLeavePost.classList.add('hidden');
                btnEndService.classList.add('hidden');
                if(btnCreateVeh) btnCreateVeh.classList.add('hidden');
            }
        }

        function setupVehiclesListener() {
            const grid = document.getElementById('vehicle-grid');
            listeners.push(onSnapshot(publicPath('vehicles'), (snap) => {
                let stats = { total: 0, ops: 0, mission: 0, repair: 0, destroyed: 0 };
                vehicleDataCache = [];
                
                snap.forEach(doc => {
                    const d = doc.data();
                    const item = { id: doc.id, data: d };
                    vehicleDataCache.push(item);
                    
                    stats.total++;
                    if(d.status === 'OPS') stats.ops++;
                    if(d.status === 'MISSION') stats.mission++;
                    if(d.status === 'REPAIR') stats.repair++;
                    if(d.status === 'DESTROYED') stats.destroyed++;
                });

                safeSetText('count-total', stats.total);
                safeSetText('count-ops', stats.ops);
                safeSetText('count-mission', stats.mission);
                safeSetText('count-repair', stats.repair);
                safeSetText('count-destroyed', stats.destroyed);

                renderVehicleGrid();
            }));
        }

        // Standard functions
        window.selectLoginMode = (mode) => {
            if(mode === 'SL') { document.getElementById('btn-login-log').classList.add('hidden'); document.getElementById('login-sl-form').classList.remove('hidden'); }
            else { document.getElementById('btn-login-sl').classList.add('hidden'); document.getElementById('login-log-form').classList.remove('hidden'); showLogLogin(); }
        };
        window.resetLoginSelection = () => {
            document.getElementById('btn-login-sl').classList.remove('hidden'); document.getElementById('btn-login-log').classList.remove('hidden');
            document.getElementById('login-sl-form').classList.add('hidden'); document.getElementById('login-log-form').classList.add('hidden');
        };
        window.loginSL = async () => {
            const p = document.getElementById('sl-pseudo').value.toUpperCase(); const g = document.getElementById('sl-grade').value;
            if(!p) return;
            await setDoc(publicDoc('settings', 'global'), { slSessionId: currentUserId, slName: `${g} ${p}`, serviceStatus: 'ACTIVE' }, {merge:true});
            await setDoc(publicDoc('users', currentUserId), { pseudo: p, grade: g, role: 'SL', isOnline: true });
            userRole = 'SL'; userPseudo = p; userGrade = g; localStorage.setItem('logiops_uid', currentUserId);
            lastNotificationTime = Date.now();
            document.getElementById('auth-screen').classList.add('hidden'); loadInterface();
        };
        window.showLogLogin = () => {
            const list = document.getElementById('roster-list-login');
            onSnapshot(publicPath('roster'), (snap) => {
                list.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left border border-green-900 bg-black/40 p-4 mb-2 rounded flex justify-between items-center touch-manipulation hover:bg-green-900/20";
                    btn.innerHTML = `<span class="font-bold text-green-400">${d.grade} ${d.pseudo}</span><i class="fas fa-fingerprint text-green-700"></i>`;
                    btn.onclick = () => loginLOG(doc.id, d.pseudo, d.grade);
                    list.appendChild(btn);
                });
            });
        };
        window.loginLOG = async (rid, p, g) => {
            await setDoc(publicDoc('users', currentUserId), { pseudo: p, grade: g, role: 'LOG', rosterId: rid, isOnline: true, rtbStatus: 'NONE' });
            userRole = 'LOG'; userPseudo = p; userGrade = g; localStorage.setItem('logiops_uid', currentUserId);
            lastNotificationTime = Date.now();
            document.getElementById('auth-screen').classList.add('hidden'); loadInterface();
        };
        window.leaveSLPost = () => {
            hudConfirm("QUITTER", "Vous passerez Logisticien.", async () => {
                await updateDoc(publicDoc('settings', 'global'), { slSessionId: null, slName: null });
                await updateDoc(publicDoc('users', currentUserId), { role: 'LOG' });
                const rSnap = await getDocs(query(publicPath('roster'), where('pseudo', '==', userPseudo)));
                if(rSnap.empty) await addDoc(publicPath('roster'), { grade: userGrade, pseudo: userPseudo });
                userRole = 'LOG'; loadInterface();
            });
        };
        window.takeCommand = () => {
            if(userRole !== 'SL') hudConfirm("COMMANDEMENT", "Prendre le poste ?", async () => {
                await updateDoc(publicDoc('settings', 'global'), { slSessionId: currentUserId, slName: `${userGrade} ${userPseudo}` });
                await updateDoc(publicDoc('users', currentUserId), { role: 'SL' });
                userRole = 'SL'; loadInterface();
            });
        };
        window.openVehicleDetail = (vid) => {
            document.getElementById('vehicle-detail-modal').classList.remove('hidden');
            onSnapshot(publicDoc('vehicles', vid), (doc) => {
                if(!doc.exists()) return document.getElementById('vehicle-detail-modal').classList.add('hidden');
                const d = doc.data();
                document.getElementById('vd-name').innerText = d.name; document.getElementById('vd-type').innerText = d.category;
                document.getElementById('vd-status').innerText = d.status; document.getElementById('vd-cost').innerText = d.cost;
                const acts = document.getElementById('vd-actions'); acts.innerHTML = '';
                if(d.status === 'DESTROYED') {
                    const b = document.createElement('button'); b.className="btn-tac w-full border-red-500 text-red-500 py-3 font-bold rounded"; b.innerText="ARCHIVER ÉPAVE";
                    b.onclick = () => { hudConfirm("ARCHIVER", "Supprimer ?", async () => { await deleteDoc(publicDoc('vehicles', vid)); document.getElementById('vehicle-detail-modal').classList.add('hidden'); }); };
                    acts.appendChild(b);
                } else if(d.status === 'OPS' && !d.missionId) {
                    if(userRole === 'SL') {
                        const b = document.createElement('button'); b.className="btn-tac w-full border-green-500 text-green-500 py-3 font-bold rounded"; b.innerText=`RETOUR GARAGE (+${d.cost})`;
                        b.onclick = () => { hudConfirm("GARAGE", "Rentrer véhicule ?", async () => { await refundGlobalSupply(d.cost); await deleteDoc(publicDoc('vehicles', vid)); document.getElementById('vehicle-detail-modal').classList.add('hidden'); }); };
                        acts.appendChild(b);
                    } else acts.innerHTML = '<div class="text-center text-gray-500">SL REQUIS</div>';
                }
            });
        };
        window.setFilter = (f) => { currentFilter = f; renderVehicleGrid(); };
        function renderVehicleGrid() {
            const grid = document.getElementById('vehicle-grid'); grid.innerHTML = '';
            const list = currentFilter === 'ALL' ? vehicleDataCache.filter(v => v.data.status !== 'DESTROYED') : vehicleDataCache.filter(v => v.data.status === currentFilter);
            list.forEach(v => grid.appendChild(createVehicleCard(v.id, v.data)));
        }
        function createVehicleCard(id, data, isMissionView = false) {
            const div = document.createElement('div');
            const statusColors = { 'OPS': 'border-green-500', 'MISSION': 'border-blue-500', 'REPAIR': 'border-orange-500', 'DESTROYED': 'border-red-600 opacity-60' };
            div.className = `bg-gray-900/90 border-2 ${statusColors[data.status] || 'border-gray-500'} p-3 rounded relative flex flex-col gap-2 cursor-pointer hover:bg-gray-800 transition`;
            div.onclick = (e) => { if(e.target.tagName === 'BUTTON' || e.target.closest('button')) return; openVehicleDetail(id); };
            div.innerHTML = `<div class="flex justify-between items-start border-b border-gray-700 pb-2"><div><div class="text-xs text-gray-400">${data.category}</div><div class="font-bold text-white truncate w-24">${data.name}</div></div><div class="text-xs font-bold px-1 bg-black rounded">${data.status}</div></div>`;
            const seatsDiv = document.createElement('div'); seatsDiv.className = "grid grid-cols-3 gap-1";
            ['driver', 'copilot', 'gunner'].forEach(role => {
                const occ = data.seats[role]; const btn = document.createElement('button'); const isMe = occ && occ.uid === currentUserId;
                btn.className = `h-12 border rounded text-[9px] flex flex-col items-center justify-center ${isMe ? 'bg-green-500 text-black font-bold' : (occ ? 'bg-green-900/50 text-green-300' : 'bg-gray-800 text-gray-500')}`;
                btn.innerHTML = `<span>${role.substr(0,3).toUpperCase()}</span><span>${occ ? occ.name : 'LIBRE'}</span>`;
                if(data.status !== 'DESTROYED') btn.onclick = () => toggleSeat(id, data, role);
                seatsDiv.appendChild(btn);
            });
            div.appendChild(seatsDiv);
            if(isMissionView) { const uActs = document.createElement('div'); uActs.className = "grid grid-cols-2 gap-1 mt-auto pt-2 text-[10px]"; uActs.innerHTML = `<button onclick="unitCitrep('${data.name}')" class="border border-blue-500 text-blue-300">CITREP</button><button onclick="unitRtb('${data.name}')" class="border border-orange-500 text-orange-300">RTB</button>`; div.appendChild(uActs); }
            return div;
        }
        window.toggleSeat = async (id, data, role) => { const occ = data.seats[role]; if(occ && occ.uid === currentUserId) { await updateDoc(publicDoc('vehicles', id), { [`seats.${role}`]: null }); } else if(!occ) { await updateDoc(publicDoc('vehicles', id), { [`seats.${role}`]: { uid: currentUserId, name: userPseudo } }); } else { hudAlert("Occupé", "Place déjà prise."); } };
        window.toggleSidebar = () => { const s = document.getElementById('sidebar'); const b = document.getElementById('mobile-backdrop'); if(s.classList.contains('-translate-x-full')) { s.classList.remove('-translate-x-full'); b.classList.remove('hidden'); } else { s.classList.add('-translate-x-full'); b.classList.add('hidden'); } };
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden'); window.toggleModal = (id) => document.getElementById(id).classList.toggle('hidden');
        window.setupNotifications = () => { const feed = document.getElementById('notif-feed'); listeners.push(onSnapshot(publicPath('notifications'), (snap) => { snap.docChanges().forEach(change => { if (change.type === 'added') { const d = change.doc.data(); if (d.isPriority && getMillis(d.timestamp) > lastNotificationTime && !(userRole === 'SL' && d.message.includes('demande une FIN DE SERVICE'))) { window.hudAlert(d.type, d.message); } } }); feed.innerHTML = ''; let docs = snap.docs.map(d => d.data()).sort((a,b) => getMillis(b.timestamp) - getMillis(a.timestamp)); docs.slice(0, 50).forEach(d => { const el = document.createElement('div'); el.className = `text-xs border-b border-green-900/30 p-2 font-mono ${d.isPriority ? 'text-red-400 bg-red-900/10' : 'text-green-300'}`; el.innerHTML = `<span class="opacity-50">[${formatTime(d.timestamp)}]</span> <b>${d.type}:</b> ${d.message}`; feed.appendChild(el); }); })); };
        window.requestLogRTB = async () => { hudConfirm("FIN DE SERVICE", "Demander RTB ?", async () => { await updateDoc(publicDoc('users', currentUserId), { rtbStatus: 'REQUESTED' }); addLog(`${userPseudo} demande un RTB.`, 'ADMIN', true); hudAlert("EN ATTENTE", "Demande envoyée."); }); };
        window.logoutSelf = async () => { hudConfirm("DÉCONNEXION", "Quitter ?", async () => { await updateDoc(publicDoc('users', currentUserId), { isOnline: false }); localStorage.removeItem('logiops_uid'); location.reload(); }); };
        window.endServiceGlobal = () => { hudConfirm("FIN SERVICE GLOBAL", "Déconnexion de TOUS ?", async () => { await updateDoc(publicDoc('settings', 'global'), { serviceStatus: 'ENDED' }); addLog("FIN DE SERVICE", "CMD", true); }); };
        window.unitCitrep = (n) => hudPrompt(`CITREP ${n}`, "Message :", (msg) => addLog(`[CITREP ${n}] ${msg}`, 'RADIO', true)); window.unitRtb = (n) => addLog(`ORDRE RTB POUR ${n}`, 'CMD', true); window.sendCitrep = (m) => hudPrompt(`CITREP MISSION`, "Message global :", (msg) => addLog(`[CITREP GLOBAL] ${msg}`, 'MISSION', true)); window.requestRTB = (m) => addLog(`ORDRE RTB GLOBAL MISSION ${m}`, 'MISSION', true);
        window.openMissionModal = async () => { document.getElementById('mission-modal').classList.remove('hidden'); const list = document.getElementById('mission-vehicle-list'); list.innerHTML = '...'; const snap = await getDocs(publicPath('vehicles')); list.innerHTML = ''; let c = 0; snap.forEach(doc => { const d = doc.data(); if(d.status === 'OPS' && !d.missionId) { c++; const l = document.createElement('label'); l.className = "flex items-center gap-3 p-3 bg-black/40 border border-green-900/50 rounded cursor-pointer"; l.innerHTML = `<input type="checkbox" class="accent-green-500 w-5 h-5 m-chk" value="${doc.id}"><div class="text-sm font-bold text-green-400">${d.name} <span class="text-xs text-gray-500">(${d.category})</span></div>`; list.appendChild(l); } }); if(c===0) list.innerHTML = '<div class="text-center text-gray-500 py-4">Aucun véhicule OPS.</div>'; };
        window.confirmMission = async () => { const name = document.getElementById('mission-name').value; if(!name) return; const chks = document.querySelectorAll('.m-chk:checked'); const vIds = Array.from(chks).map(c => c.value); const mRef = await addDoc(publicPath('missions'), { name, status: 'ACTIVE', leaderId: null, leaderName: null, createdAt: serverTimestamp(), vehicleCount: vIds.length }); const batch = writeBatch(db); vIds.forEach(id => batch.update(publicDoc('vehicles', id), { status: 'MISSION', missionId: mRef.id })); await batch.commit(); addLog(`Mission lancée : ${name}`, 'MISSION'); document.getElementById('mission-modal').classList.add('hidden'); };
        window.setupMissionsListener = () => { const container = document.getElementById('mission-list'); onSnapshot(publicPath('missions'), (snap) => { container.innerHTML = ''; let docs = snap.docs.map(d => ({id: d.id, ...d.data()})); docs.sort((a, b) => getMillis(b.createdAt) - getMillis(a.createdAt)); docs.forEach(data => { if(data.status === 'ARCHIVED' || data.status === 'CANCELLED') return; const el = document.createElement('div'); el.className = "border border-green-500/50 p-3 mb-2 bg-green-900/10 rounded cursor-pointer hover:bg-green-900/30"; el.onclick = () => openMissionDetails(data.id); const leaderDisplay = data.leaderName ? `<div class="text-[10px] text-green-400 font-bold"><i class="fas fa-crown text-yellow-500 mr-1"></i>${data.leaderName}</div>` : `<div class="text-[10px] text-gray-500 italic">CHEF: AUCUN</div>`; const vehDisplay = data.vehicleCount ? `<span class="text-[9px] bg-gray-800 px-1 rounded text-gray-300 ml-2"><i class="fas fa-car"></i> ${data.vehicleCount}</span>` : ''; el.innerHTML = `<div class="flex justify-between items-start mb-1 pointer-events-none"><div><h3 class="font-bold text-green-400 truncate pr-2">${data.name}</h3>${leaderDisplay}</div><div class="flex items-center"><span class="text-[9px] bg-green-900 text-green-200 px-1 rounded flex-shrink-0">ACTIF</span>${vehDisplay}</div></div>`; container.appendChild(el); }); }); }
        window.openMissionDetails = (mId) => { const modal = document.getElementById('mission-details-modal'); modal.classList.remove('hidden'); const leaderActions = document.getElementById('leader-mission-actions'); listeners.push(onSnapshot(publicDoc('missions', mId), (doc) => { if(!doc.exists()) return modal.classList.add('hidden'); const d = doc.data(); document.getElementById('detail-mission-name').innerText = d.name; const isLeader = d.leaderId === currentUserId; const lContainer = document.getElementById('detail-mission-leader'); if(d.leaderName) { lContainer.innerHTML = `<div class="border border-green-500 p-2 rounded text-center bg-green-900/20"><div class="text-[10px] text-gray-400">CHEF DE MISSION</div><div class="text-xl font-bold text-green-400">${d.leaderName}</div></div>`; } else { lContainer.innerHTML = `<button onclick="requestLeadership('${mId}')" class="btn-tac w-full py-2 bg-yellow-900/20 border-yellow-500 text-yellow-500 animate-pulse font-bold rounded">PRENDRE LE COMMANDEMENT</button>`; } let html = ''; if(isLeader) { html += `<div class="grid grid-cols-2 gap-2 mb-4"><button onclick="sendCitrep('${d.name}')" class="btn-tac border-blue-500 text-blue-300 py-2">CITREP</button><button onclick="requestRTB('${d.name}')" class="btn-tac border-orange-500 text-orange-300 py-2">RTB GLOBAL</button></div><div class="mb-4"><button onclick="initiateTransfer('${mId}')" class="btn-tac w-full border-gray-600 text-gray-400 text-xs py-2">TRANSFÉRER LE LEAD</button></div>`; } else if (d.leaderId) { html += `<button onclick="requestLeadership('${mId}')" class="btn-tac w-full border-gray-600 text-gray-400 text-xs py-2 mt-2">DEMANDER LE LEAD (REMPLACEMENT)</button>`; } leaderActions.innerHTML = html; leaderActions.classList.remove('hidden'); const slActions = document.getElementById('sl-mission-actions'); if(userRole === 'SL') { slActions.innerHTML = `<div class="grid grid-cols-2 gap-4 pt-4 border-t border-green-900/50"><button onclick="endMission('${mId}', 'COMPLETED')" class="btn-tac bg-green-900/40 text-green-400 font-bold py-3">ACCOMPLIE</button><button onclick="endMission('${mId}', 'CANCELLED')" class="btn-tac border-red-500 text-red-500 font-bold py-3">ANNULER</button></div>`; slActions.classList.remove('hidden'); } else slActions.classList.add('hidden'); })); const vContainer = document.getElementById('detail-mission-vehicles'); listeners.push(onSnapshot(publicPath('vehicles'), (snap) => { vContainer.innerHTML = ''; snap.forEach(doc => { if(doc.data().missionId === mId) { vContainer.appendChild(createVehicleCard(doc.id, doc.data(), true)); } }); })); };
        window.requestLeadership = (mId) => { hudConfirm("COMMANDEMENT", "Voulez-vous prendre le commandement de cette mission ?", async () => { await updateDoc(publicDoc('missions', mId), { transferRequest: { targetId: currentUserId, targetName: `${userGrade} ${userPseudo}`, state: 'WAITING_SL' } }); hudAlert("ENVOYÉ", "Demande transmise au Squad Leader."); }); };
        window.initiateTransfer = async (mId) => { const modal = document.getElementById('transfer-select-modal'); const list = document.getElementById('transfer-list'); modal.classList.remove('hidden'); list.innerHTML = 'Chargement...'; const snap = await getDocs(query(publicPath('users'), where('isOnline', '==', true))); list.innerHTML = ''; snap.forEach(doc => { const d = doc.data(); if (doc.id !== currentUserId) { const btn = document.createElement('button'); btn.className = "w-full text-left p-3 bg-black/60 border border-green-900 hover:bg-green-900/30 mb-1 text-green-400 font-bold"; btn.innerText = `${d.grade} ${d.pseudo}`; btn.onclick = async () => { modal.classList.add('hidden'); await updateDoc(publicDoc('missions', mId), { transferRequest: { targetId: doc.id, targetName: `${d.grade} ${d.pseudo}`, state: 'WAITING_TARGET' } }); hudAlert("OFFRE ENVOYÉE", `Proposition de commandement envoyée à ${d.pseudo}.`); }; list.appendChild(btn); } }); };
        window.endMission = (mId, status) => { hudConfirm("FIN DE MISSION", "Confirmer la clôture ? Les véhicules repasseront OPS.", async () => { const batch = writeBatch(db); batch.update(publicDoc('missions', mId), { status: status === 'COMPLETED' ? 'ARCHIVED' : 'CANCELLED' }); const vSnap = await getDocs(query(publicPath('vehicles'), where('missionId', '==', mId))); vSnap.forEach(v => batch.update(v.ref, { status: 'OPS', missionId: null })); await batch.commit(); document.getElementById('mission-details-modal').classList.add('hidden'); }); };
        window.openRosterModal = () => { const m = document.getElementById('roster-modal'); m.classList.remove('hidden'); const list = document.getElementById('sl-roster-list'); onSnapshot(publicPath('roster'), async (snapRoster) => { const usersSnap = await getDocs(publicPath('users')); const usersMap = {}; usersSnap.forEach(u => usersMap[u.data().rosterId] = { id: u.id, ...u.data() }); list.innerHTML = ''; snapRoster.forEach(doc => { const d = doc.data(); const activeUser = usersMap[doc.id]; const isOnline = activeUser && activeUser.isOnline; const div = document.createElement('div'); div.className = "flex justify-between items-center bg-black/40 p-2 rounded mb-1 border border-green-900/30"; let actionBtn = ''; if(isOnline) { actionBtn = `<button onclick="kickUser('${activeUser.id}', '${d.pseudo}')" class="text-xs bg-red-900/50 text-red-400 border border-red-900 px-2 py-1 rounded">EXCLURE</button>`; } else { actionBtn = `<button onclick="deleteRosterEntry('${doc.id}')" class="text-gray-500 hover:text-red-500"><i class="fas fa-trash"></i></button>`; } div.innerHTML = `<div><span class="font-bold ${isOnline ? 'text-green-400' : 'text-gray-500'}">${d.grade} ${d.pseudo}</span>${isOnline ? '<span class="ml-2 text-[9px] bg-green-900 text-green-200 px-1 rounded">EN LIGNE</span>' : ''}</div><div>${actionBtn}</div>`; list.appendChild(div); }); }); };
        window.kickUser = (uid, name) => { hudConfirm("EXCLURE", `Forcer la déconnexion de ${name} ?`, async () => { await updateDoc(publicDoc('users', uid), { rtbStatus: 'KICKED', isOnline: false }); addLog(`${name} a été exclu par le Commandement.`, 'ADMIN', true); }); };
        window.deleteRosterEntry = (rid) => { hudConfirm("SUPPRIMER", "Retirer du registre ?", async () => await deleteDoc(publicDoc('roster', rid))); };
        window.addToRoster = () => { const m = document.getElementById('hud-prompt-modal'); m.classList.remove('hidden'); window.hudPrompt("NOUVEAU PERSONNEL", "Format: Grade Pseudo (ex: Sgt Major)", async (val) => { if(!val) return; const parts = val.split(' '); const grade = parts[0]; const pseudo = parts.slice(1).join(' '); await addDoc(publicPath('roster'), { grade, pseudo, addedAt: serverTimestamp() }); addLog(`Ajout roster : ${val}`, 'ADMIN'); }); };
        window.createDepot = () => { hudPrompt("NOUVEAU DÉPÔT", "Nom du lieu de stockage :", async (val) => { if(val) { await addDoc(publicPath('depots'), { name: val, amount: 0 }); addLog(`Nouveau dépôt : ${val}`, 'SUPPLY'); } }); };
        window.updateDepot = async (id, delta) => { const ref = publicDoc('depots', id); const snap = await getDoc(ref); const current = snap.data().amount || 0; if(current + delta < 0) return hudAlert("Erreur", "Stock insuffisant."); await updateDoc(ref, { amount: current + delta }); };
        window.renderDepotsList = (snap) => { const list = document.getElementById('depots-list'); if(!list) return; list.innerHTML = ''; snap.forEach(doc => { const d = doc.data(); const el = document.createElement('div'); el.className = "bg-black/40 border border-green-900/50 p-3 rounded mb-2 flex justify-between items-center"; el.innerHTML = `<div><div class="font-bold text-green-400 text-sm">${d.name}</div><div class="text-white font-mono text-lg">${d.amount}</div></div><div class="flex gap-2"><button onclick="updateDepot('${doc.id}', 100)" class="border border-green-600 text-green-600 px-3 py-1 text-xs rounded hover:bg-green-900 font-bold">+100</button><button onclick="updateDepot('${doc.id}', -100)" class="border border-red-600 text-red-600 px-3 py-1 text-xs rounded hover:bg-red-900 font-bold">-100</button></div>`; list.appendChild(el); }); };
    </script>

    <!-- Custom CSS -->
    <style>
        :root { --neon-green: #22c55e; --bg-dark: #0f172a; }
        body { background-color: #050505; color: #e2e8f0; font-family: 'Share Tech Mono', monospace; overflow: hidden; }
        .hud-panel { background: rgba(10, 15, 10, 0.95); border: 1px solid rgba(34, 197, 94, 0.3); box-shadow: 0 0 15px rgba(34, 197, 94, 0.1); }
        .btn-tac { border: 1px solid #22c55e; color: #22c55e; background: rgba(34, 197, 94, 0.05); transition: 0.1s; }
        .btn-tac:active { background: #22c55e; color: black; }
        .modal-bg { background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .mobile-drawer { transition: transform 0.3s ease-in-out; }
        .btn-return { border: 1px solid #6b7280; color: #9ca3af; }
        .alert-border { border: 2px solid red; animation: flash 1s infinite; }
        @keyframes flash { 0%, 100% { border-color: red; } 50% { border-color: transparent; } }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.5; } }
        
        /* Responsive Utilities */
        @media (max-width: 768px) {
            .desktop-only { display: none; }
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col text-sm md:text-base">

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-black p-4">
        <div class="hud-panel w-full max-w-md p-6 rounded relative">
            <h1 class="text-4xl text-green-500 text-center mb-6 font-bold">LOGIOPS V2</h1>
            
            <!-- SELECTION BUTTONS -->
            <div class="flex flex-col gap-4 mb-4">
                <button id="btn-login-sl" onclick="selectLoginMode('SL')" class="py-4 border border-green-600 text-green-400 rounded font-bold hover:bg-green-900/30 transition-all flex items-center justify-center gap-3">
                    <i class="fas fa-chess-king text-2xl"></i> SQUAD LEADER
                </button>
                <button id="btn-login-log" onclick="selectLoginMode('LOG')" class="py-4 border border-green-600 text-green-400 rounded font-bold hover:bg-green-900/30 transition-all flex items-center justify-center gap-3">
                    <i class="fas fa-boxes text-2xl"></i> LOGISTICIEN
                </button>
            </div>

            <!-- SL FORM -->
            <div id="login-sl-form" class="hidden">
                <h2 class="text-green-500 mb-2 font-bold border-b border-green-800 pb-1">AUTHENTIFICATION CMD</h2>
                <select id="sl-grade" class="w-full bg-gray-900 border border-green-800 p-3 mb-3 text-white rounded"></select>
                <input id="sl-pseudo" class="w-full bg-gray-900 border border-green-800 p-3 mb-4 text-white uppercase rounded" placeholder="PSEUDO">
                <button onclick="loginSL()" class="btn-tac w-full py-3 font-bold rounded mb-2">PRENDRE LE SERVICE</button>
                <button onclick="resetLoginSelection()" class="btn-return w-full py-2 rounded text-xs">RETOUR</button>
            </div>

            <!-- LOG FORM -->
            <div id="login-log-form" class="hidden flex flex-col h-64">
                <h2 class="text-green-500 mb-2 font-bold border-b border-green-800 pb-1">SÉLECTION IDENTITÉ</h2>
                <div id="roster-list-login" class="flex-1 overflow-y-auto mb-4 pr-1"></div>
                <button onclick="resetLoginSelection()" class="btn-return w-full py-2 rounded text-xs mt-auto">RETOUR</button>
            </div>
        </div>
    </div>

    <!-- MAIN UI -->
    <div id="main-interface" class="hidden flex-1 flex flex-col h-full relative z-10">
        
        <!-- HEADER -->
        <header class="h-16 border-b border-green-900/50 flex items-center px-4 bg-gray-900/95 gap-4 z-20 justify-between">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="md:hidden text-green-500 p-2"><i class="fas fa-bars text-xl"></i></button>
                <div id="header-sl-name" class="text-xs border border-green-800 px-3 py-1 rounded text-green-600 font-bold whitespace-nowrap">--</div>
            </div>
            
            <!-- DESKTOP KPI (Hidden on mobile) -->
            <div class="hidden md:flex flex-1 gap-6 items-center justify-center">
                <div class="flex flex-col items-center cursor-pointer" onclick="openSupplyModal()">
                    <span class="text-[9px] text-gray-500">SUPPLY</span>
                    <span id="supply-count" class="supply-count text-lg font-bold text-white">0</span>
                </div>
                <div class="w-px bg-green-900/50 h-6"></div>
                <div class="flex flex-col items-center">
                    <span class="text-[9px] text-gray-500">EFFECTIFS</span>
                    <span id="stat-log-count" class="stat-log-count text-lg font-bold text-green-400">0/0</span>
                </div>
                <!-- Vehicle Stats Desktop -->
                <div class="flex gap-4 ml-4">
                    <div class="flex flex-col items-center"><span class="text-[9px] text-gray-500">OPS</span><span id="count-ops" class="count-ops text-lg font-bold text-green-500">0</span></div>
                    <div class="flex flex-col items-center"><span class="text-[9px] text-gray-500">MISS</span><span id="count-mission" class="count-mission text-lg font-bold text-blue-500">0</span></div>
                    <div class="flex flex-col items-center"><span class="text-[9px] text-gray-500">MAINT</span><span id="count-repair" class="count-repair text-lg font-bold text-orange-500">0</span></div>
                </div>
            </div>
            
            <button id="garage-btn" onclick="toggleModal('garage-modal')" class="btn-tac px-3 py-2 text-xs font-bold rounded flex items-center gap-2"><i class="fas fa-warehouse"></i> <span class="hidden md:inline">GARAGE</span></button>
        </header>

        <div class="flex-1 flex overflow-hidden relative">
            <div id="mobile-backdrop" onclick="toggleSidebar()" class="fixed inset-0 bg-black/80 z-30 hidden md:hidden"></div>

            <!-- SIDEBAR (Mobile Drawer) -->
            <aside id="sidebar" class="absolute md:relative inset-y-0 left-0 w-72 bg-gray-900/95 border-r border-green-900/50 flex flex-col transform -translate-x-full md:translate-x-0 mobile-drawer z-40">
                <div class="p-2 flex justify-end md:hidden"><button onclick="toggleSidebar()" class="text-green-500 p-2"><i class="fas fa-times"></i></button></div>

                <!-- MOBILE PROFILE & STATS -->
                <div class="p-4 border-b border-green-900/30 bg-black/20">
                    <div id="profile-card" class="mb-4"></div>
                    
                    <!-- Mobile Stats Grid -->
                    <div class="md:hidden grid grid-cols-2 gap-2 mb-2">
                        <div class="bg-black/40 p-2 rounded flex flex-col items-center" onclick="openSupplyModal()">
                            <span class="text-[9px] text-gray-500">SUPPLY</span>
                            <span class="supply-count text-green-400 font-bold">0</span>
                        </div>
                        <div class="bg-black/40 p-2 rounded flex flex-col items-center">
                            <span class="text-[9px] text-gray-500">EFFECTIFS</span>
                            <span class="stat-log-count text-green-400 font-bold">0</span>
                        </div>
                    </div>
                    <div class="md:hidden grid grid-cols-4 gap-1 text-center text-[9px] text-gray-400">
                        <div onclick="setFilter('ALL')" class="bg-black/40 p-1 rounded cursor-pointer">TOT<br><span class="count-total text-white font-bold">0</span></div>
                        <div onclick="setFilter('OPS')" class="bg-black/40 p-1 rounded cursor-pointer text-green-500">OPS<br><span class="count-ops font-bold">0</span></div>
                        <div onclick="setFilter('MISSION')" class="bg-black/40 p-1 rounded cursor-pointer text-blue-500">MISS<br><span class="count-mission font-bold">0</span></div>
                        <div onclick="setFilter('DESTROYED')" class="bg-black/40 p-1 rounded cursor-pointer text-red-500">DÉTR<br><span class="count-destroyed font-bold">0</span></div>
                    </div>
                </div>

                <div class="p-2 flex flex-col gap-2 overflow-y-auto flex-1">
                    <div id="sl-controls" class="flex flex-col gap-2">
                        <!-- Request Alert Button -->
                        <button id="btn-requests-alert" onclick="openRequestsModal()" class="hidden w-full py-3 bg-yellow-900/50 border border-yellow-500 text-yellow-400 font-bold rounded blink mb-2">
                            <i class="fas fa-bell mr-2"></i> REQUÊTES (<span id="requests-count">0</span>)
                        </button>

                        <button onclick="openMissionModal()" class="btn-tac py-3 text-xs font-bold rounded">CRÉER MISSION</button>
                        <button onclick="openRosterModal()" class="btn-tac py-3 text-xs font-bold rounded">GESTION LOGS</button>
                        <button onclick="toggleModal('garage-modal')" class="btn-tac py-3 text-xs font-bold rounded md:hidden">GARAGE</button>
                        <button id="btn-leave-post" onclick="leaveSLPost()" class="btn-tac border-red-500 text-red-500 py-2 text-xs font-bold rounded mt-2">QUITTER POSTE</button>
                        <button id="btn-end-service" onclick="endServiceGlobal()" class="btn-tac bg-red-900/20 border-red-500 text-red-500 py-2 text-xs font-bold rounded">FIN SERVICE GLOBAL</button>
                    </div>
                    <div id="log-controls" class="flex flex-col gap-2">
                        <!-- Hide default logout for LOGs -->
                    </div>

                    <div class="flex-1 flex flex-col min-h-0 mt-2">
                        <div class="bg-green-900/20 px-2 py-1 text-[10px] font-bold text-green-500 border-y border-green-900/30">MISSIONS EN COURS</div>
                        <div id="mission-list" class="space-y-2 pt-2"></div>
                    </div>
                </div>

                <div class="p-2 border-t border-green-900/30">
                    <button onclick="requestLogRTB()" class="btn-tac w-full border-orange-500 text-orange-500 py-3 text-xs font-bold rounded">DEMANDE RTB</button>
                </div>
            </aside>

            <main class="flex-1 bg-gradient-to-b from-black/50 to-green-900/10 p-4 overflow-y-auto">
                <!-- Desktop Filters (Optional, mostly redundant with header but good for big screens) -->
                <div class="hidden md:flex gap-2 mb-4 border-b border-green-900/30 pb-2">
                    <button onclick="setFilter('ALL')" class="text-xs px-3 py-1 bg-black/40 rounded hover:bg-green-900/30">TOUS</button>
                    <button onclick="setFilter('OPS')" class="text-xs px-3 py-1 bg-black/40 rounded hover:bg-green-900/30 text-green-500">OPÉRATIONNEL</button>
                    <button onclick="setFilter('MISSION')" class="text-xs px-3 py-1 bg-black/40 rounded hover:bg-green-900/30 text-blue-500">EN MISSION</button>
                    <button onclick="setFilter('REPAIR')" class="text-xs px-3 py-1 bg-black/40 rounded hover:bg-green-900/30 text-orange-500">MAINTENANCE</button>
                </div>
                <div id="vehicle-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-20"></div>
            </main>
        </div>

        <footer class="h-32 bg-black border-t border-green-900 flex flex-col z-20">
            <div class="bg-green-900/20 p-1 text-green-500 text-xs font-bold px-2">LIVE FEED</div>
            <div id="notif-feed" class="flex-1 overflow-y-auto p-2"></div>
        </footer>
    </div>

    <!-- REQUESTS MODAL -->
    <div id="requests-modal" class="modal-bg fixed inset-0 z-[80] hidden flex items-center justify-center p-4">
        <div class="hud-panel w-full max-w-md p-6 rounded relative max-h-[80vh] flex flex-col">
            <button onclick="closeModal('requests-modal')" class="absolute top-2 right-2 text-gray-500"><i class="fas fa-times"></i></button>
            <h3 class="text-xl text-yellow-500 font-bold mb-4 border-b border-yellow-900 pb-2">REQUÊTES EN ATTENTE</h3>
            <div id="requests-list" class="flex-1 overflow-y-auto pr-1"></div>
        </div>
    </div>

    <!-- Standard Modals (Restored) -->
    <!-- ... (Previous modals remain the same, re-injected below for completeness) ... -->
    <div id="hud-confirm-modal" class="modal-bg fixed inset-0 z-[100] hidden flex items-center justify-center p-6"><div class="hud-panel w-full max-w-sm p-6 text-center rounded"><h3 id="hud-confirm-title" class="text-xl font-bold text-white mb-4">CONFIRMATION</h3><p id="hud-confirm-msg" class="text-green-300 mb-6"></p><div class="grid grid-cols-2 gap-4"><button onclick="window._onConfirmYes()" class="btn-tac py-3 font-bold rounded">OUI</button><button onclick="document.getElementById('hud-confirm-modal').classList.add('hidden')" class="border border-gray-600 text-gray-400 py-3 rounded">NON</button></div></div></div>
    <div id="hud-prompt-modal" class="modal-bg fixed inset-0 z-[100] hidden flex items-center justify-center p-6"><div class="hud-panel w-full max-w-sm p-6 rounded"><h3 id="hud-prompt-title" class="text-xl font-bold text-white mb-2">SAISIE</h3><p id="hud-prompt-msg" class="text-xs text-gray-400 mb-4"></p><input id="hud-prompt-input" class="w-full bg-black border border-green-700 p-3 text-white mb-4 rounded"><div class="grid grid-cols-2 gap-4"><button onclick="window._onPromptSubmit()" class="btn-tac py-2 font-bold rounded">VALIDER</button><button onclick="document.getElementById('hud-prompt-modal').classList.add('hidden')" class="border border-gray-600 text-gray-400 py-2 rounded">ANNULER</button></div></div></div>
    <div id="hud-alert-modal" class="modal-bg fixed inset-0 z-[100] hidden flex items-center justify-center p-6"><div class="hud-panel w-full max-w-sm p-6 text-center rounded border-red-500 alert-border"><h3 id="hud-alert-title" class="text-2xl font-bold text-red-500 mb-4">ALERTE</h3><p id="hud-alert-msg" class="text-white mb-6 text-lg"></p><button onclick="document.getElementById('hud-alert-modal').classList.add('hidden')" class="w-full py-3 bg-red-900/50 text-white font-bold border border-red-500 rounded">REÇU</button></div></div>
    <div id="vehicle-detail-modal" class="modal-bg fixed inset-0 z-[60] hidden flex items-center justify-center p-4"><div class="hud-panel w-full max-w-md p-6 rounded relative"><button onclick="closeModal('vehicle-detail-modal')" class="absolute top-2 right-2 text-gray-500"><i class="fas fa-times"></i></button><h3 class="text-xl text-green-500 font-bold mb-4 border-b border-green-900 pb-2">FICHE VÉHICULE</h3><div class="space-y-2 mb-6 text-sm font-mono text-gray-300"><div class="flex justify-between"><span>ID:</span><span id="vd-name" class="text-white font-bold">--</span></div><div class="flex justify-between"><span>TYPE:</span><span id="vd-type">--</span></div><div class="flex justify-between"><span>STATUT:</span><span id="vd-status" class="font-bold">--</span></div><div class="flex justify-between"><span>COÛT:</span><span id="vd-cost">--</span></div><div class="flex justify-between"><span>SORTIE:</span><span id="vd-date">--</span></div></div><div id="vd-actions" class="border-t border-green-900/50 pt-4"></div></div></div>
    <div id="roster-modal" class="hidden modal-bg fixed inset-0 z-50 flex items-center justify-center p-4"><div class="hud-panel p-6 rounded w-full max-w-md h-[60vh] flex flex-col"><h3 class="text-xl text-green-500 font-bold mb-4 border-b border-green-900 pb-2">GESTION EFFECTIFS</h3><div id="sl-roster-list" class="flex-1 overflow-y-auto pr-1 mb-4"></div><button onclick="addToRoster()" class="btn-tac w-full py-3 font-bold mb-2">CRÉER PROFIL</button><button onclick="closeModal('roster-modal')" class="btn-return w-full py-2 rounded text-xs">FERMER</button></div></div>
    <div id="mission-details-modal" class="modal-bg fixed inset-0 z-50 hidden flex items-center justify-center p-4"><div class="hud-panel w-full max-w-4xl h-[90vh] flex flex-col p-4 rounded relative"><button onclick="closeModal('mission-details-modal')" class="absolute top-4 right-4 text-red-500 text-xl"><i class="fas fa-times"></i></button><div class="flex justify-between items-center border-b border-green-900 pb-4 mb-4"><h2 id="detail-mission-name" class="text-3xl font-bold text-white">MISSION</h2><div id="detail-mission-leader"></div></div><div id="leader-mission-actions" class="hidden mb-4 p-2 border border-blue-900/30 rounded bg-blue-900/10"></div><div class="flex-1 overflow-y-auto bg-black/30 p-2 rounded border border-green-900/30"><div id="detail-mission-vehicles" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div></div><div id="sl-mission-actions" class="hidden mt-4"></div></div></div>
    <div id="transfer-select-modal" class="modal-bg fixed inset-0 z-[110] hidden flex items-center justify-center p-4"><div class="hud-panel w-full max-w-md p-4 rounded max-h-[80vh] flex flex-col"><h3 class="text-white font-bold mb-4">SÉLECTIONNER LE NOUVEAU CHEF</h3><div id="transfer-list" class="flex-1 overflow-y-auto"></div><button onclick="closeModal('transfer-select-modal')" class="mt-4 py-2 border border-gray-600 text-gray-400">ANNULER</button></div></div>
    <div id="supply-modal" class="hidden modal-bg fixed inset-0 z-50 flex items-center justify-center p-4"><div class="hud-panel p-6 rounded w-full max-w-md h-[70vh] flex flex-col"><h3 class="text-xl text-green-500 font-bold mb-4">LOGISTIQUE & STOCKS</h3><div id="depots-list" class="flex-1 overflow-y-auto space-y-2 pr-1"></div><button onclick="createDepot()" class="btn-tac w-full py-3 font-bold mt-4">NOUVEAU DÉPÔT</button><button onclick="closeModal('supply-modal')" class="mt-2 text-gray-500 w-full text-center">FERMER</button></div></div>
    <div id="garage-modal" class="hidden modal-bg fixed inset-0 z-50 flex items-center justify-center p-4"><div class="hud-panel p-6 rounded w-full max-w-md"><h3 class="text-xl text-green-500 font-bold mb-4">GARAGE</h3><div class="space-y-2"><select id="new-veh-type" class="w-full bg-black border border-green-700 p-2 text-white"><option value="LOGI">LOGI (300)</option><option value="JEEP">JEEP (100)</option><option value="TRANSPORT">TRANSPORT (200)</option></select><input id="new-veh-name" class="w-full bg-black border border-green-700 p-2 text-white" placeholder="NOM"><button id="btn-create-vehicle" onclick="createVehicle()" class="btn-tac w-full py-3 font-bold mt-2">SORTIR DU GARAGE</button><button onclick="closeModal('garage-modal')" class="mt-2 text-gray-500 w-full">FERMER</button></div></div></div>
    <div id="mission-modal" class="hidden modal-bg fixed inset-0 z-50 flex items-center justify-center p-4"><div class="hud-panel p-6 rounded w-full max-w-md h-[80vh] flex flex-col"><h3 class="text-xl text-green-500 font-bold mb-4">NOUVELLE MISSION</h3><input id="mission-name" class="w-full bg-black border border-green-700 p-2 text-white mb-4" placeholder="NOM OPÉRATION"><div id="mission-vehicle-list" class="flex-1 overflow-y-auto border border-green-900/50 p-2 mb-4"></div><button onclick="confirmMission()" class="btn-tac w-full py-3 font-bold">LANCER</button><button onclick="closeModal('mission-modal')" class="mt-2 text-gray-500 w-full">ANNULER</button></div></div>

</body>
</html>
