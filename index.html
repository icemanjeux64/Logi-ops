<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>LOGIOPS V2 // OPTIMIZED</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#050505; color:#e2e8f0; font-family:'Share Tech Mono',monospace; overflow:hidden }
    .hud  { background:rgba(10,15,10,.95); border:1px solid rgba(34,197,94,.3) }
    .btn  { border:1px solid #22c55e; color:#22c55e; background:rgba(34,197,94,.05); transition:.1s }
    .btn:active { background:#22c55e; color:#000 }
    .modal { background:rgba(0,0,0,.9); backdrop-filter:blur(5px) }
  </style>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /* =============================
       CONFIG
    ============================= */
    const firebaseConfig = {
      apiKey: "AIzaSyASPGZJO1JU5GeoBtmj5UTP8ErPSQIPeFA",
      authDomain: "logiops-data.firebaseapp.com",
      projectId: "logiops-data",
      storageBucket: "logiops-data.firebasestorage.app",
      messagingSenderId: "791163499354",
      appId: "1:791163499354:web:2bb76506331db9d240b963"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* =============================
       HELPERS
    ============================= */
    const path = c      => collection(db, 'artifacts', 'logiops-v2-production', 'public', 'data', c);
    const ref  = (c,id) => doc(db, 'artifacts', 'logiops-v2-production', 'public', 'data', c, id);

    // Local helper + attach to window so inline handlers can use it
    const getById = id => document.getElementById(id);
    window.$ = getById;   // <-- FIX: expose $ globally to avoid "$ is not defined"

    const log = (msg, type = "INFO") => addDoc(path('logs'), { msg, type, t: Date.now() });

    /* =============================
       GLOBAL STATE
    ============================= */
    let user   = null;
    let role   = null;
    let pseudo = null;
    let grade  = null;

    /* =============================
       AUTH
    ============================= */
    async function initAuth() {
      await signInAnonymously(auth);
    }
    initAuth();

    onAuthStateChanged(auth, u => {
      if (!u) return;
      user = u;
      const authScreen = document.getElementById('auth');
      if (authScreen) authScreen.classList.remove('hidden');
    });

    /* =============================
       LOGIN LOGIC
    ============================= */
    window.loginSL = async () => {
      const g = getById('sl-grade').value;
      const p = getById('sl-pseudo').value.toUpperCase();
      if (!p) return;

      await setDoc(ref('settings', 'global'), {
        slSessionId: user.uid,
        slName: `${g} ${p}`
      }, { merge: true });

      await setDoc(ref('users', user.uid), {
        pseudo: p,
        grade: g,
        role: 'SL',
        isOnline: true
      }, { merge: true });

      role   = 'SL';
      pseudo = p;
      grade  = g;

      getById('auth').classList.add('hidden');
      getById('ui').classList.remove('hidden');
    };

    window.loginLOG = async (id, p, g) => {
      await setDoc(ref('users', user.uid), {
        pseudo: p,
        grade: g,
        role: 'LOG',
        rosterId: id,
        isOnline: true
      }, { merge: true });

      role   = 'LOG';
      pseudo = p;
      grade  = g;

      getById('auth').classList.add('hidden');
      getById('ui').classList.remove('hidden');
    };

    /* =============================
       VEHICLE LIVE GRID (MINIMAL TEST VIEW)
    ============================= */
    onSnapshot(path('vehicles'), snap => {
      const grid = document.getElementById('grid');
      if (!grid) return;
      grid.innerHTML = "";

      // Basic rendering + a few simple visual "test cases"
      snap.forEach(d => {
        const v = d.data();
        const status = v.status || 'UNKNOWN';
        const color  = status === 'OPS' ? 'text-green-400' : status === 'MISSION' ? 'text-blue-400' : 'text-gray-300';

        const card = document.createElement('div');
        card.className = 'p-3 border border-green-900/40 rounded bg-black/40 flex flex-col gap-1';
        card.innerHTML = `
          <div class="font-bold text-green-400 truncate">${v.name || 'SANS NOM'}</div>
          <div class="text-xs text-gray-400">${v.category || 'NC'}</div>
          <div class="text-xs ${color}">STATUT: ${status}</div>
        `;
        grid.appendChild(card);
      });

      // Simple visual test card if no vehicles exist
      if (snap.empty) {
        const testCard = document.createElement('div');
        testCard.className = 'p-3 border border-dashed border-gray-600 rounded bg-black/40 text-xs text-gray-400';
        testCard.innerHTML = `Aucun véhicule en base. <span class="text-green-400">(Test: affichage OK)</span>`;
        grid.appendChild(testCard);
      }
    });
  </script>
</head>
<body class="h-screen w-screen">

  <!-- AUTH -->
  <div id="auth" class="hidden fixed inset-0 flex items-center justify-center p-4 bg-black">
    <div class="hud p-6 rounded w-full max-w-md">
      <h1 class="text-center text-3xl text-green-500 mb-6">LOGIOPS V2</h1>

      <div class="flex flex-col gap-3">
        <button onclick="$('sl').classList.toggle('hidden')" class="btn py-3 font-bold">SQUAD LEADER</button>
        <button onclick="$('log').classList.toggle('hidden')" class="btn py-3 font-bold">LOGISTICIEN</button>
      </div>

      <!-- SL FORM -->
      <div id="sl" class="hidden mt-4">
        <select id="sl-grade" class="w-full bg-black border border-green-700 p-2 mb-2">
          <option value="Sgt">Sgt</option>
          <option value="Sgt-Chef">Sgt-Chef</option>
          <option value="Adj">Adj</option>
        </select>
        <input id="sl-pseudo" class="w-full bg-black border border-green-700 p-2 mb-3" placeholder="PSEUDO">
        <button onclick="loginSL()" class="btn py-2 w-full">VALIDER</button>
      </div>

      <!-- LOG FORM (mini jeu de test : un seul profil en dur) -->
      <div id="log" class="hidden mt-4">
        <button onclick="loginLOG('ID123','WHIZZPER','Cpl')" class="btn py-2 w-full">WHIZZPER (Cpl)</button>
      </div>
    </div>
  </div>

  <!-- MAIN UI MINIMALE POUR TEST -->
  <div id="ui" class="hidden flex flex-col h-full">
    <header class="p-4 border-b border-green-900 text-green-400 font-bold flex justify-between items-center">
      <span>LOGIOPS — INTERFACE</span>
      <span class="text-xs text-gray-400">(mode démo optimisé)</span>
    </header>
    <main class="flex-1 overflow-y-auto p-4">
      <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
    </main>
  </div>

</body>
</html>
