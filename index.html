import React, { useState, useMemo } from 'react';
import { 
  Shield, 
  Settings, 
  Save, 
  RotateCcw, 
  Activity, 
  Box, 
  Cross, 
  Flame,
  Minus,
  Plus,
  HeartPulse
} from 'lucide-react';

export default function MilitaryMdtFull() {
  const [supplyStock, setSupplyStock] = useState(6000);
  const [medicActive, setMedicActive] = useState(true);
  
  // DONNÉES COMPLÈTES
  const initialFleet = [
    // --- ETAT MAJOR (VIOLET) ---
    { id: 'em1', category: 'Transport EM', type: 'Jeep EM', deployed: 2, cost: 110, status: 'Opérationnel', destroyed: 0, group: 'em' },
    { id: 'em2', category: 'EM', type: 'QG Mobile', deployed: 0, cost: 420, status: 'Pas déployé', destroyed: 0, group: 'em' },
    
    // --- LOGISTIQUE (ROSE) ---
    { id: 'log1', category: 'Maintenance', type: 'Camion Réparation', deployed: 1, cost: 175, status: 'Opérationnel', destroyed: 0, group: 'logi' },
    { id: 'log2', category: 'Ravitaillement', type: 'Camion Citerne', deployed: 1, cost: 160, status: 'Opérationnel', destroyed: 0, group: 'logi' },
    { id: 'log3', category: 'Ravitaillement', type: 'Camion Arsenal', deployed: 0, cost: 380, status: 'Pas déployé', destroyed: 0, group: 'logi' },
    { id: 'log4', category: 'Ravitaillement', type: 'Camion Construction', deployed: 1, cost: 260, status: 'Opérationnel', destroyed: 0, group: 'logi' },
    
    // --- TRANSPORT DE TROUPES (JAUNE) ---
    { id: 'tra1', category: 'Transport de troupes', type: 'Camion', deployed: 4, cost: 200, status: 'Opérationnel', destroyed: 0, group: 'transport' },
    { id: 'tra2', category: 'Transport de troupes', type: 'VAB', deployed: 4, cost: 1200, status: 'Opérationnel', destroyed: 0, group: 'transport' },
    { id: 'tra3', category: 'Transport de troupes', type: 'Stryker (non armé)', deployed: 0, cost: 1000, status: 'Pas déployé', destroyed: 0, group: 'transport' },
    
    // --- VÉHICULE BLINDÉ MULTI-RÔLE (ORANGE) ---
    { id: 'bl1', category: 'Véhicule blindé', type: 'JLTV M1280', deployed: 0, cost: 650, status: 'Pas déployé', destroyed: 0, group: 'blinde' },
    { id: 'bl2', category: 'Véhicule blindé', type: 'JLTV M1281 - M2HB (12.7)', deployed: 0, cost: 1000, status: 'Pas déployé', destroyed: 0, group: 'blinde' },
    { id: 'bl3', category: 'Véhicule blindé', type: 'JLTV M1281 - M134 (7.62)', deployed: 0, cost: 2000, status: 'Pas déployé', destroyed: 0, group: 'blinde' },
    { id: 'bl4', category: 'Véhicule blindé', type: 'JLTV M1278 - M2HB (12.7 télé)', deployed: 1, cost: 1500, status: 'Opérationnel', destroyed: 0, group: 'blinde' },
    { id: 'bl5', category: 'Véhicule blindé', type: 'JLTV AN-MSY-2 v2 (7.62 télé)', deployed: 0, cost: 2760, status: 'Pas déployé', destroyed: 0, group: 'blinde' },
    { id: 'bl6', category: 'Véhicule blindé', type: 'JLTV M1278 - M230LF (30mm)', deployed: 0, cost: 2750, status: 'Pas déployé', destroyed: 0, group: 'blinde' },
    { id: 'bl7', category: 'Véhicule blindé', type: 'JLTV M1278 + Javelin', deployed: 0, cost: 3700, status: 'Pas déployé', destroyed: 0, group: 'blinde' },
    { id: 'bl8', category: 'Véhicule blindé', type: 'JLTV AN-MSY-2 v1 (Stinger)', deployed: 0, cost: 3700, status: 'Pas déployé', destroyed: 0, group: 'blinde' },

    // --- COMBAT INFANTERIE (VERT CLAIR) ---
    { id: 'inf1', category: 'Combat Infanterie', type: 'Stryker M1126 - M2HB', deployed: 2, cost: 2000, status: 'Opérationnel', destroyed: 0, group: 'infanterie' },
    { id: 'inf2', category: 'Combat Infanterie', type: 'Stryker M1296 (30mm)', deployed: 1, cost: 3000, status: 'Opérationnel', destroyed: 0, group: 'infanterie' },
    { id: 'inf3', category: 'Combat Infanterie', type: 'Stryker M1128 (105mm)', deployed: 1, cost: 5000, status: 'Opérationnel', destroyed: 0, group: 'infanterie' },

    // --- SANITAIRE (VERT FONCÉ) ---
    { id: 'san1', category: 'Véhicule sanitaire', type: 'Stryker EVASAN', deployed: 1, cost: 975, status: 'Opérationnel', destroyed: 0, group: 'sanitaire' },
    { id: 'san2', category: 'Véhicule sanitaire', type: 'VAB EVASAN', deployed: 0, cost: 975, status: 'Pas déployé', destroyed: 0, group: 'sanitaire' },

    // --- CHARS (VIOLET/ROSE FONCÉ) ---
    { id: 'char1', category: 'Char de bataille', type: 'Leclerc', deployed: 0, cost: 8000, status: 'Pas déployé', destroyed: 0, group: 'char' },
    { id: 'char2', category: 'Char de bataille', type: 'Leclerc XLR', deployed: 0, cost: 8500, status: 'Pas déployé', destroyed: 1, group: 'char' },
    
    // --- ALAT (BLEU) ---
    { id: 'air1', category: 'MEDEVAC', type: 'NH90 "Caïman"', deployed: 0, cost: 3000, status: 'Pas déployé', destroyed: 0, group: 'alat' },
    { id: 'air2', category: 'Appui / Transport', type: 'NH90 "Caïman"', deployed: 0, cost: 3000, status: 'Pas déployé', destroyed: 0, group: 'alat' },
    { id: 'air3', category: 'Appui / Transport', type: 'Gazelle SA342L (Mistral)', deployed: 0, cost: 2500, status: 'Pas déployé', destroyed: 0, group: 'alat' },
    { id: 'air4', category: 'Appui / Transport', type: 'Gazelle SA342L Strike (Gatling)', deployed: 0, cost: 3000, status: 'Pas déployé', destroyed: 0, group: 'alat' },
    { id: 'air5', category: 'Appui / Transport', type: 'Gazelle SA342L Canon (20mm)', deployed: 0, cost: 3500, status: 'Pas déployé', destroyed: 0, group: 'alat' },
    { id: 'air6', category: 'Appui / Transport', type: 'Gazelle SA342L HAP (Roq. 68)', deployed: 0, cost: 3500, status: 'Pas déployé', destroyed: 1, group: 'alat' },
    { id: 'air7', category: 'Appui / Transport', type: 'EC665 Tigre', deployed: 0, cost: 7000, status: 'Pas déployé', destroyed: 0, group: 'alat' },
  ];

  const [fleet, setFleet] = useState(initialFleet);

  // Calculs
  const totalDeployed = useMemo(() => fleet.reduce((acc, item) => acc + item.deployed, 0), [fleet]);
  const totalDestroyed = useMemo(() => fleet.reduce((acc, item) => acc + item.destroyed, 0), [fleet]);
  const totalCost = useMemo(() => fleet.reduce((acc, item) => acc + (item.deployed * item.cost), 0), [fleet]);

  const updateFleet = (id, field, value) => {
    setFleet(fleet.map(item => item.id === id ? { ...item, [field]: value } : item));
  };

  const groups = [
    { id: 'em', label: 'Etat Major', color: 'bg-[#9b72cf]', text: 'text-[#9b72cf]', border: 'border-[#9b72cf]' },
    { id: 'logi', label: 'Logistique', color: 'bg-[#e0aaff]', text: 'text-[#e0aaff]', border: 'border-[#e0aaff]' },
    { id: 'transport', label: 'Transport de Troupes', color: 'bg-[#ffd60a]', text: 'text-[#ffd60a]', border: 'border-[#ffd60a]' },
    { id: 'blinde', label: 'Véhicules Blindés (JLTV)', color: 'bg-[#fb8500]', text: 'text-[#fb8500]', border: 'border-[#fb8500]' },
    { id: 'infanterie', label: 'Combat Infanterie (Stryker)', color: 'bg-[#55a630]', text: 'text-[#55a630]', border: 'border-[#55a630]' },
    { id: 'sanitaire', label: 'Sanitaire / EVASAN', color: 'bg-[#2b9348]', text: 'text-[#2b9348]', border: 'border-[#2b9348]' },
    { id: 'char', label: 'Chars de Bataille', color: 'bg-[#7209b7]', text: 'text-[#7209b7]', border: 'border-[#7209b7]' },
    { id: 'alat', label: 'Aérien (ALAT)', color: 'bg-[#4361ee]', text: 'text-[#4361ee]', border: 'border-[#4361ee]' },
  ];

  return (
    <div className="flex flex-col h-screen w-full bg-[#121212] text-slate-200 font-sans overflow-hidden">
      
      {/* HEADER AMÉLIORÉ */}
      <header className="bg-[#1a1a1a] border-b border-slate-800 p-4 shrink-0 shadow-lg z-20">
        <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
          
          {/* Logo & Titre */}
          <div className="flex items-center gap-6">
            <div className="w-16 h-16 bg-blue-900/10 rounded-xl border border-blue-500/20 flex items-center justify-center shrink-0 shadow-[0_0_15px_rgba(59,130,246,0.15)]">
               <Shield size={36} className="text-blue-500" strokeWidth={1.5} />
            </div>
            <div>
              <h1 className="text-2xl font-black text-white tracking-tight uppercase font-heading">Fiche Logistique</h1>
              <div className="flex items-center gap-2 text-red-500 animate-pulse font-mono text-sm font-bold mt-1 bg-red-500/10 px-2 py-0.5 rounded w-fit">
                <Activity size={14} />
                DEFCON 3 - ACTIF
              </div>
            </div>
          </div>

          {/* Stats Centrales */}
          <div className="flex gap-4 bg-[#0a0a0a] p-2 rounded-xl border border-slate-800 shadow-inner">
             <div className="px-6 py-1 border-r border-slate-800 text-center">
                <div className="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1">Total Déployé</div>
                <span className="text-2xl font-mono font-bold text-blue-400">{totalDeployed}</span>
             </div>
             <div className="px-6 py-1 border-r border-slate-800 text-center">
                <div className="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1">Total Détruit</div>
                <span className="text-2xl font-mono font-bold text-red-500">{totalDestroyed}</span>
             </div>
             <div className="px-6 py-1 text-center min-w-[120px]">
                <div className="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1">Coût Total</div>
                <span className="text-xl font-mono font-bold text-yellow-500">{totalCost} pts</span>
             </div>
          </div>

          {/* Contrôles Droite : Supply & Medic */}
          <div className="flex flex-row gap-4 items-stretch">
             {/* Medic V2 Switch (Déplacé ici) */}
             <button 
                onClick={() => setMedicActive(!medicActive)}
                className={`
                   flex flex-col items-center justify-center px-4 rounded-xl border transition-all min-w-[100px]
                   ${medicActive 
                      ? 'bg-green-950/30 border-green-500/50 text-green-400' 
                      : 'bg-[#0a0a0a] border-slate-800 text-slate-500 hover:border-slate-600'}
                `}
             >
                <HeartPulse size={20} className={medicActive ? 'animate-pulse' : ''} />
                <span className="text-[10px] font-bold uppercase mt-1">
                   {medicActive ? 'Medic ON' : 'Medic OFF'}
                </span>
             </button>

             {/* Supply Control */}
            <div className="flex flex-col justify-between bg-[#0a0a0a] px-4 py-2 rounded-xl border border-slate-800 min-w-[180px] shadow-sm">
              <div className="flex items-center gap-2 text-amber-500 font-bold text-[10px] uppercase mb-1">
                <Box size={14} /> Supply Base
              </div>
              <div className="flex items-center justify-between gap-3">
                 <button onClick={() => setSupplyStock(s => s - 100)} className="w-8 h-8 rounded bg-slate-800 flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700 active:scale-95 transition-all font-bold text-lg">-</button>
                 <span className="font-mono text-xl text-white font-bold">{supplyStock}</span>
                 <button onClick={() => setSupplyStock(s => s + 100)} className="w-8 h-8 rounded bg-slate-800 flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700 active:scale-95 transition-all font-bold text-lg">+</button>
              </div>
            </div>
          </div>
        </div>
      </header>

      {/* CONTENT - GRID SYSTEM */}
      <div className="flex-1 overflow-y-auto overflow-x-hidden p-6 space-y-8 bg-[#121212]">
        
        {groups.map(group => {
          const groupItems = fleet.filter(item => item.group === group.id);
          if (groupItems.length === 0) return null;

          return (
            <div key={group.id} className="animate-in fade-in slide-in-from-bottom-4 duration-500">
              <div className="flex items-center gap-3 mb-4 pl-1">
                <div className={`w-1 h-6 rounded-full ${group.color}`}></div>
                <h2 className={`text-lg font-bold uppercase tracking-widest ${group.text} opacity-90`}>{group.label}</h2>
                <div className="h-px bg-slate-800 flex-1 ml-4"></div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4">
                {groupItems.map(item => (
                  <div 
                    key={item.id}
                    className={`
                      relative rounded-xl border-2 transition-all duration-200 overflow-hidden group flex flex-col
                      ${item.deployed > 0 
                          ? 'bg-[#1a1a1a] border-slate-700 hover:border-slate-500' 
                          : 'bg-[#151515] border-slate-800 opacity-75 hover:opacity-100'}
                      ${item.destroyed > 0 ? 'border-red-900/30' : ''}
                    `}
                  >
                    {/* Status Strip */}
                    <div className={`h-1 w-full ${item.destroyed > 0 ? 'bg-gradient-to-r from-slate-700 via-red-500 to-slate-700' : item.deployed > 0 ? 'bg-blue-500' : 'bg-slate-700'}`}></div>

                    <div className="p-4 flex-1 flex flex-col">
                      {/* Header Card */}
                      <div className="flex justify-between items-start mb-4 min-h-[48px]">
                        <div className="pr-2">
                          <h3 className="font-bold text-md leading-tight text-slate-100">
                            {item.type}
                          </h3>
                        </div>
                        <div className="bg-[#0a0a0a] px-2 py-1 rounded text-xs font-mono font-bold text-slate-400 border border-slate-800 whitespace-nowrap">
                          {item.cost}pts
                        </div>
                      </div>

                      {/* Double Counters: Deployed & Destroyed */}
                      <div className="grid grid-cols-2 gap-3 mb-4">
                        {/* DEPLOYED */}
                        <div className="bg-[#0a0a0a] rounded-lg border border-slate-800 p-1.5 flex flex-col items-center">
                           <span className="text-[10px] uppercase font-bold text-blue-400 mb-1">Déployés</span>
                           <div className="flex items-center justify-between w-full">
                              <button 
                                onClick={() => updateFleet(item.id, 'deployed', Math.max(0, item.deployed - 1))}
                                className="w-8 h-8 rounded bg-slate-800/50 flex items-center justify-center text-slate-400 hover:bg-slate-700 hover:text-white transition-colors"
                              ><Minus size={14} strokeWidth={3} /></button>
                              <span className={`text-xl font-mono font-bold ${item.deployed > 0 ? 'text-white' : 'text-slate-600'}`}>{item.deployed}</span>
                              <button 
                                onClick={() => updateFleet(item.id, 'deployed', item.deployed + 1)}
                                className="w-8 h-8 rounded bg-blue-600/20 flex items-center justify-center text-blue-400 hover:bg-blue-600 hover:text-white transition-colors"
                              ><Plus size={14} strokeWidth={3} /></button>
                           </div>
                        </div>

                        {/* DESTROYED */}
                        <div className="bg-[#2a1212] rounded-lg border border-red-900/30 p-1.5 flex flex-col items-center">
                           <span className="text-[10px] uppercase font-bold text-red-400 mb-1 flex items-center gap-1"><Flame size={10} /> Détruits</span>
                           <div className="flex items-center justify-between w-full">
                              <button 
                                onClick={() => updateFleet(item.id, 'destroyed', Math.max(0, item.destroyed - 1))}
                                className="w-8 h-8 rounded bg-red-900/20 flex items-center justify-center text-red-400 hover:bg-red-900/40 transition-colors"
                              ><Minus size={14} strokeWidth={3} /></button>
                              <span className={`text-xl font-mono font-bold ${item.destroyed > 0 ? 'text-red-500' : 'text-slate-600'}`}>{item.destroyed}</span>
                              <button 
                                onClick={() => updateFleet(item.id, 'destroyed', item.destroyed + 1)}
                                className="w-8 h-8 rounded bg-red-900/20 flex items-center justify-center text-red-400 hover:bg-red-900/40 transition-colors"
                              ><Plus size={14} strokeWidth={3} /></button>
                           </div>
                        </div>
                      </div>

                      {/* Status Selector (Full Width) */}
                      <div className="mt-auto">
                        <select 
                          value={item.status}
                          onChange={(e) => updateFleet(item.id, 'status', e.target.value)}
                          className={`
                            w-full py-2 px-3 rounded-lg text-xs font-bold uppercase tracking-wide appearance-none border cursor-pointer outline-none transition-colors text-center
                            ${item.status === 'Opérationnel' ? 'bg-emerald-950/30 text-emerald-400 border-emerald-900/50 hover:border-emerald-700' : ''}
                            ${item.status === 'Pas déployé' ? 'bg-slate-800/50 text-slate-400 border-slate-700 hover:border-slate-600' : ''}
                            ${item.status === 'Maintenance' ? 'bg-yellow-950/30 text-yellow-400 border-yellow-900/50' : ''}
                            ${item.status === 'Détruit' ? 'bg-red-950/30 text-red-400 border-red-900/50' : ''}
                          `}
                        >
                          <option value="Opérationnel">Opérationnel</option>
                          <option value="Pas déployé">Pas déployé</option>
                          <option value="Maintenance">Maintenance</option>
                          <option value="Détruit">Détruit (Total)</option>
                        </select>
                      </div>
                      
                    </div>
                  </div>
                ))}
              </div>
            </div>
          );
        })}

        <div className="h-20"></div>
      </div>

       {/* FOOTER ACTIONS */}
       <div className="h-16 bg-[#1a1a1a] border-t border-slate-800 flex items-center justify-end px-6 shrink-0 z-20 shadow-[0_-5px_20px_rgba(0,0,0,0.3)] gap-3">
          <button className="flex items-center gap-2 px-6 py-3 bg-[#252525] hover:bg-[#303030] text-slate-300 rounded-lg border border-slate-700 text-sm font-bold transition-all active:scale-95">
            <RotateCcw size={16} /> RESET
          </button>
          <button className="flex items-center gap-2 px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg border border-blue-400 text-sm font-bold transition-all shadow-lg shadow-blue-900/20 active:scale-95">
            <Save size={16} /> SAUVEGARDER
          </button>
      </div>
    </div>
  );
}
