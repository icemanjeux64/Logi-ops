<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOGI-OPS V9.0 (HYBRID)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons (Version Fixe et Stable) -->
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>

    <!-- FIREBASE (Base de données) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap');
        body { font-family: 'JetBrains Mono', monospace; background-color: #050505; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #000; border-left: 1px solid #14532d; }
        ::-webkit-scrollbar-thumb { background: #14532d; border: 1px solid #000; }
        ::-webkit-scrollbar-thumb:hover { background: #22c55e; }
        @keyframes scanline { 0% { transform: translateY(0); } 100% { transform: translateY(100vh); } }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Animation login */
        .login-scan {
            background: linear-gradient(to bottom, transparent 50%, rgba(0, 255, 0, 0.02) 51%, transparent 51%);
            background-size: 100% 4px;
            animation: scan 2s linear infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURATION FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyASPGZJO1JU5GeoBtmj5UTP8ErPSQIPeFA",
            authDomain: "logiops-data.firebaseapp.com",
            projectId: "logiops-data",
            storageBucket: "logiops-data.firebasestorage.app",
            messagingSenderId: "791163499354",
            appId: "1:791163499354:web:2bb76506331db9d240b963",
            measurementId: "G-FFMXKH47M9"
        };

        // --- LOGIQUE DE DÉTECTION & STORAGE ---
        let db = null;
        let USE_FIREBASE = false;
        const isConfigured = firebaseConfig.projectId !== "PROJECT_ID";

        if (typeof __firebase_config !== 'undefined') {
            try {
                const envConfig = JSON.parse(__firebase_config);
                if (!firebase.apps.length) firebase.initializeApp(envConfig);
                db = firebase.firestore();
                USE_FIREBASE = true;
                console.log("Mode: CANEVAS (Online)");
            } catch (e) { console.warn("Erreur init Canvas config", e); }
        } else if (isConfigured) {
            try {
                if (!firebase.apps.length) {
                    const app = firebase.initializeApp(firebaseConfig);
                    if (firebase.analytics) { firebase.analytics(); }
                }
                db = firebase.firestore();
                USE_FIREBASE = true;
                console.log("Mode: PROD (Online) - Connecté à " + firebaseConfig.projectId);
            } catch (e) {
                console.error("Erreur connexion Firebase:", e);
                USE_FIREBASE = false;
            }
        } else {
            console.log("Mode: LOCAL (Offline)");
            USE_FIREBASE = false;
        }

        const SESSION_ID = typeof __app_id !== 'undefined' ? __app_id : "operation_actuelle";
        const LOCAL_STORAGE_KEY = "logiops_data_v9";

        const StorageService = {
            save: (data) => {
                if (USE_FIREBASE && db) {
                    db.collection('logiops').doc(SESSION_ID).set(data, { merge: true }).catch(err => console.warn("Erreur save cloud:", err));
                } else {
                    try {
                        const existing = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '{}');
                        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ ...existing, ...data }));
                    } catch (e) { console.warn("Erreur save local:", e); }
                }
            },
            loadInitial: (callback) => {
                if (USE_FIREBASE && db) {
                    return db.collection('logiops').doc(SESSION_ID).onSnapshot((doc) => {
                        if (doc.exists) callback(doc.data()); else callback(null);
                    }, err => {
                        const local = localStorage.getItem(LOCAL_STORAGE_KEY);
                        if (local) callback(JSON.parse(local));
                    });
                } else {
                    const local = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (local) callback(JSON.parse(local)); else callback(null);
                    return () => {};
                }
            }
        };

        const { useState, useMemo, useEffect } = React;

        // --- DONNÉES & CONFIG ---
        const INITIAL_CATALOG = [
            { id: 'l1', cat: 'LOGI', name: 'JEEP EM', type: 'TRANSPORT EM', cost: 110, stock: 2 },
            { id: 'l2', cat: 'LOGI', name: 'CAMION RÉPA.', type: 'MAINTENANCE', cost: 175, stock: 1 },
            { id: 'l4', cat: 'LOGI', name: 'CAMION CITERNE', type: 'RAVITAILLEMENT', cost: 160, stock: 1 },
            { id: 'l5', cat: 'LOGI', name: 'CAMION ARSENAL', type: 'RAVITAILLEMENT', cost: 380, stock: 1 },
            { id: 'l6', cat: 'LOGI', name: 'CAMION CONST.', type: 'RAVITAILLEMENT', cost: 260, stock: 1 },
            { id: 't1', cat: 'TRANS', name: 'CAMION TROUPES', type: 'TRANSPORT', cost: 200, stock: 4 },
            { id: 't2', cat: 'TRANS', name: 'VAB', type: 'TRANSPORT BLINDÉ', cost: 1200, stock: 1 },
            { id: 'b1', cat: 'BLINDE', name: 'JLTV M1280', type: 'LÉGER NON-ARMÉ', cost: 650, stock: 1 },
            { id: 'b2', cat: 'BLINDE', name: 'JLTV M1281', type: 'LÉGER 12.7', cost: 1000, stock: 1 },
            { id: 'b4', cat: 'BLINDE', name: 'JLTV M1278', type: 'LÉGER TÉLÉ-OP', cost: 1500, stock: 1 },
            { id: 'c1', cat: 'VCI', name: 'STRYKER M1126', type: 'COMBAT INFANTERIE', cost: 2000, stock: 2 },
            { id: 'c2', cat: 'VCI', name: 'STRYKER M1296', type: 'CANON 30MM', cost: 3000, stock: 1 },
            { id: 's1', cat: 'SANTE', name: 'STRYKER EVASAN', type: 'SANITAIRE', cost: 975, stock: 1 },
            { id: 'h1', cat: 'CHAR', name: 'LECLERC', type: 'CHAR DE BATAILLE', cost: 8000, stock: 1 },
            { id: 'h2', cat: 'CHAR', name: 'LECLERC XLR', type: 'CHAR DE BATAILLE', cost: 8300, stock: 1 },
            { id: 'a1', cat: 'AIR', name: 'NH90 FAUCON', type: 'MEDEVAC', cost: 3000, stock: 1 },
            { id: 'a2', cat: 'AIR', name: 'NH90 FAUCON', type: 'TRANSPORT', cost: 3000, stock: 1 },
            { id: 'a6', cat: 'AIR', name: 'GAZELLE HAP', type: 'ATTAQUE', cost: 3500, stock: 1 },
        ];

        const CATEGORIES = {
            'LOGI': { label: 'LOGISTIQUE', icon: 'Truck', color: 'border-yellow-600 text-yellow-500 bg-yellow-900/10' },
            'TRANS': { label: 'TRANSPORT', icon: 'Package', color: 'border-blue-600 text-blue-400 bg-blue-900/10' },
            'BLINDE': { label: 'BLINDÉS', icon: 'Shield', color: 'border-orange-600 text-orange-400 bg-orange-900/10' },
            'VCI': { label: 'VCI', icon: 'Crosshair', color: 'border-red-600 text-red-400 bg-red-900/10' },
            'SANTE': { label: 'SANITAIRE', icon: 'Activity', color: 'border-emerald-600 text-emerald-400 bg-emerald-900/10' },
            'CHAR': { label: 'LOURD', icon: 'Shield', color: 'border-purple-600 text-purple-400 bg-purple-900/10' },
            'AIR': { label: 'AÉRIEN', icon: 'Plane', color: 'border-cyan-600 text-cyan-300 bg-cyan-900/10' },
        };

        // --- ADAPTATEUR ICÔNES LUCIDE (Version Sécurisée Sans Déstructuration) ---
        const createLucideIcon = (iconName) => {
            return ({ size = 24, className, ...props }) => {
                if (typeof lucide === 'undefined' || !lucide.icons) return null;
                
                const keys = Object.keys(lucide.icons);
                const key = keys.find(k => k.toLowerCase() === iconName.toLowerCase());
                const iconData = key ? lucide.icons[key] : null;

                // Vérification stricte
                if (!iconData || !Array.isArray(iconData)) return null;

                // Extraction manuelle pour éviter les erreurs de déstructuration Babel
                const tag = iconData[0];
                const attrs = iconData[1] || {};
                const children = iconData[2] || [];

                // Si le tag n'est pas une chaîne, on annule
                if (typeof tag !== 'string') return null;

                return React.createElement(
                    tag,
                    {
                        ...attrs,
                        width: size,
                        height: size,
                        className: className,
                        ...props,
                        stroke: props.color || "currentColor",
                        strokeWidth: props.strokeWidth || attrs['stroke-width'] || 2,
                        strokeLinecap: attrs['stroke-linecap'] || 'round',
                        strokeLinejoin: attrs['stroke-linejoin'] || 'round',
                    },
                    Array.isArray(children) ? children.map((child, i) => {
                        const childTag = child[0];
                        const childAttrs = child[1];
                        return React.createElement(childTag, { ...childAttrs, key: i });
                    }) : null
                );
            };
        };

        const Icons = {};
        ['Truck','Activity','AlertTriangle','Crosshair','Shield','Plane','Package','Plus','ArrowRight','RotateCcw','XCircle','LayoutGrid','List','PlayCircle','CheckCircle','Wrench','Skull','MapPin','User','FileText','Clock','ArrowUpRight','PieChart','BarChart3','Timer','Database','Trash2','Save','Users','UserPlus','UserMinus','LogOut','ScrollText','Warehouse','LayoutDashboard','Settings','Target','Radio','Wifi','PlusCircle','MinusCircle','Edit','Play','Lock','Unlock'].forEach(name => {
            Icons[name] = createLucideIcon(name);
        });

        // --- COMPOSANT LOGIN ---
        function LoginScreen({ onLogin }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const Shield = Icons['Shield'];
            const Lock = Icons['Lock'];
            const User = Icons['User'];

            const handleSL = (e) => {
                e.preventDefault();
                if (username === 'SLLogi' && password === 'sllogie') {
                    onLogin('SL');
                } else {
                    setError('IDENTIFIANTS INCORRECTS');
                }
            };

            return (
                <div className="min-h-screen bg-black flex items-center justify-center p-4 login-scan">
                    <div className="w-full max-w-md border border-green-800 bg-black relative p-8 shadow-[0_0_50px_rgba(0,255,0,0.1)]">
                        <div className="absolute top-0 left-0 w-2 h-2 border-t-2 border-l-2 border-green-500"></div>
                        <div className="absolute top-0 right-0 w-2 h-2 border-t-2 border-r-2 border-green-500"></div>
                        <div className="absolute bottom-0 left-0 w-2 h-2 border-b-2 border-l-2 border-green-500"></div>
                        <div className="absolute bottom-0 right-0 w-2 h-2 border-b-2 border-r-2 border-green-500"></div>

                        <div className="text-center mb-8">
                            <div className="inline-block p-3 border border-green-700 bg-green-900/10 mb-4">
                                {Shield && <Shield size={40} className="text-green-500"/>}
                            </div>
                            <h1 className="text-2xl font-black text-green-500 tracking-[0.3em] mb-1">LOGI-OPS</h1>
                            <p className="text-[10px] text-green-800 uppercase font-mono">Système de Gestion Tactique V9</p>
                        </div>

                        <div className="space-y-6">
                            <form onSubmit={handleSL} className="space-y-4 border-b border-green-900/50 pb-6">
                                <h2 className="text-xs font-bold text-green-600 uppercase flex items-center gap-2 mb-4">
                                    {Lock && <Lock size={12}/>} ACCÈS COMMANDEMENT (SL)
                                </h2>
                                <div>
                                    <input 
                                        type="text" 
                                        placeholder="IDENTIFIANT" 
                                        value={username}
                                        onChange={e => setUsername(e.target.value)}
                                        className="w-full bg-green-900/10 border border-green-800 p-3 text-green-400 text-xs font-bold outline-none focus:border-green-500 placeholder-green-900"
                                    />
                                </div>
                                <div>
                                    <input 
                                        type="password" 
                                        placeholder="MOT DE PASSE" 
                                        value={password}
                                        onChange={e => setPassword(e.target.value)}
                                        className="w-full bg-green-900/10 border border-green-800 p-3 text-green-400 text-xs font-bold outline-none focus:border-green-500 placeholder-green-900"
                                    />
                                </div>
                                {error && <p className="text-red-500 text-[10px] font-bold bg-red-900/10 p-2 border border-red-900 text-center">{error}</p>}
                                <button type="submit" className="w-full bg-green-600 text-black font-black py-3 text-xs tracking-widest hover:bg-green-500 transition-colors">
                                    CONNEXION SL
                                </button>
                            </form>

                            <div>
                                <button onClick={() => onLogin('LOGI')} className="w-full border border-dashed border-blue-900 text-blue-500 py-3 text-xs font-bold hover:bg-blue-900/10 transition-colors flex items-center justify-center gap-2 group">
                                    {User && <User size={14} className="group-hover:text-blue-400"/>} 
                                    ACCÈS LOGISTICIEN (LECTURE SEULE)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- MAIN APP ---
        function LogiOpsV9() {
            const [userRole, setUserRole] = useState(null); // 'SL' ou 'LOGI'
            const [activeTab, setActiveTab] = useState('dashboard'); 
            
            // États de données
            const [activeUnits, setActiveUnits] = useState([]);
            const [catalog, setCatalog] = useState(INITIAL_CATALOG);
            const [squad, setSquad] = useState([]); 
            const [globalLogs, setGlobalLogs] = useState([]); 
            const [supplySources, setSupplySources] = useState([{ id: 'base', name: 'BASE PRINCIPALE', amount: 38000 }]);
            const [slName, setSlName] = useState(''); 
            const [isSlActive, setIsSlActive] = useState(false);
            const [configurations, setConfigurations] = useState([]);
            const [dataLoaded, setDataLoaded] = useState(false);

            // États UI
            const [actionModal, setActionModal] = useState(null);
            const [showSupplyModal, setShowSupplyModal] = useState(false);
            const [showStockModal, setShowStockModal] = useState(false);
            const [showConfigModal, setShowConfigModal] = useState(false);
            const [currentConfigId, setCurrentConfigId] = useState(null);
            const [inputReason, setInputReason] = useState('');
            const [selectedMemberId, setSelectedMemberId] = useState('');

            const canEdit = userRole === 'SL'; // Vérification des droits

            // --- CHARGEMENT INITIAL ---
            useEffect(() => {
                const unsubscribe = StorageService.loadInitial((data) => {
                    if (data) {
                        if(data.activeUnits) setActiveUnits(data.activeUnits);
                        if(data.catalog) setCatalog(data.catalog);
                        if(data.squad) setSquad(data.squad);
                        if(data.globalLogs) setGlobalLogs(data.globalLogs);
                        if(data.supplySources) setSupplySources(data.supplySources);
                        if(data.slName) setSlName(data.slName);
                        if(typeof data.isSlActive !== 'undefined') setIsSlActive(data.isSlActive);
                        if(data.configurations) setConfigurations(data.configurations);
                    }
                    setDataLoaded(true);
                });
                return () => unsubscribe && unsubscribe();
            }, []);

            // --- ACTIONS METIERS (PROTÉGÉES) ---
            const logEvent = (type, message) => {
                const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const newLog = { id: Date.now(), time: timestamp, type, msg: message };
                const newLogs = [newLog, ...globalLogs].slice(0, 50); 
                setGlobalLogs(newLogs);
                StorageService.save({ globalLogs: newLogs });
            };

            const updateStock = (modelId, delta) => {
                if (!canEdit) return;
                const newCatalog = catalog.map(m => m.id === modelId ? { ...m, stock: Math.max(0, m.stock + delta) } : m);
                setCatalog(newCatalog);
                StorageService.save({ catalog: newCatalog });
            };

            const deployUnit = (modelId) => {
                if (!canEdit) return;
                const model = catalog.find(m => m.id === modelId);
                if (!model) return;
                const currentlyDeployed = activeUnits.filter(u => u.modelId === model.id).length;
                if (currentlyDeployed >= model.stock) return;

                const newUnit = {
                    uuid: Date.now() + Math.random(),
                    modelId: model.id,
                    name: model.name,
                    cat: model.cat,
                    cost: model.cost,
                    status: 'operational', 
                    responsible: 'BASE',
                    reasonHS: '',
                    missionStartTime: null,
                    deployTime: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    logs: []
                };
                const newUnits = [newUnit, ...activeUnits];
                setActiveUnits(newUnits);
                StorageService.save({ activeUnits: newUnits });
                logEvent('GARAGE', `DÉPLOIEMENT: ${model.name}`);
            };

            const toggleSlShift = () => {
                if (!canEdit || !slName) return;
                const newState = !isSlActive;
                setIsSlActive(newState);
                StorageService.save({ isSlActive: newState, slName });
                logEvent('RH', newState ? `PRISE POSTE SL: ${slName}` : `FIN SERVICE SL: ${slName}`);
            };

            const addSquadMember = (name) => {
                if (!canEdit || !name) return;
                const newMember = { id: Date.now(), name: name.toUpperCase(), role: 'LOGISTICIEN', status: 'active', startTime: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) };
                const newSquad = [...squad, newMember];
                setSquad(newSquad);
                StorageService.save({ squad: newSquad });
                logEvent('RH', `RENFORT: ${name.toUpperCase()}`);
            };

            const removeSquadMember = (id) => {
                if (!canEdit) return;
                const member = squad.find(m => m.id === id);
                if(member) { 
                    const newSquad = squad.filter(m => m.id !== id);
                    setSquad(newSquad);
                    StorageService.save({ squad: newSquad });
                    logEvent('RH', `DÉPART: ${member.name}`); 
                }
            };

            const updateUnitStatus = (uuid, newStatus, additionalData = {}) => {
                if (!canEdit) return;
                const newUnits = activeUnits.map(u => {
                    if (u.uuid !== uuid) return u;
                    let logMsg = `Statut: ${newStatus.toUpperCase()}`;
                    if (newStatus === 'mission') logMsg += ` (Chef: ${additionalData.responsible})`;
                    if (newStatus === 'destroyed') logMsg += ` (Cause: ${additionalData.reasonHS})`;
                    return { ...u, status: newStatus, ...additionalData, logs: [...(u.logs || []), { time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), msg: logMsg }] };
                });
                setActiveUnits(newUnits);
                StorageService.save({ activeUnits: newUnits });
                const unit = activeUnits.find(u => u.uuid === uuid);
                if(unit) logEvent('FLOTTE', `${unit.name}: ${newStatus.toUpperCase()}`);
            };

            const endMission = (unit) => {
                if (!canEdit || !unit.missionStartTime) return;
                const durationMs = Date.now() - unit.missionStartTime;
                const minutes = Math.floor(durationMs / 60000);
                const durationStr = `${minutes} min`;
                const newUnits = activeUnits.map(u => {
                    if (u.uuid !== unit.uuid) return u;
                    return { ...u, status: 'operational', missionStartTime: null, responsible: 'BASE', logs: [...(u.logs||[]), { time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), msg: `RETOUR MISSION (${durationStr})` }] };
                });
                setActiveUnits(newUnits);
                StorageService.save({ activeUnits: newUnits });
                logEvent('FLOTTE', `${unit.name}: RETOUR BASE (${durationStr})`);
            };

            const returnToBase = (uuid) => {
                if (!canEdit) return;
                if (window.confirm("CONFIRMER RTB ?")) {
                    const unit = activeUnits.find(u => u.uuid === uuid);
                    const newUnits = activeUnits.filter(u => u.uuid !== uuid);
                    setActiveUnits(newUnits);
                    StorageService.save({ activeUnits: newUnits });
                    if(unit) logEvent('GARAGE', `RTB: ${unit.name}`);
                }
            };

            const updateSupplySource = (id, field, value) => {
                if (!canEdit) return;
                const newSupply = supplySources.map(s => s.id === id ? { ...s, [field]: value } : s);
                setSupplySources(newSupply);
                StorageService.save({ supplySources: newSupply });
            };

            const addSupplySource = () => { 
                if (!canEdit) return;
                const newSupply = [...supplySources, { id: Date.now(), name: 'NOUVELLE SOURCE', amount: 0 }];
                setSupplySources(newSupply);
                StorageService.save({ supplySources: newSupply });
            };

            const removeSupplySource = (id) => { 
                if (!canEdit || supplySources.length <= 1) return; 
                const newSupply = supplySources.filter(s => s.id !== id);
                setSupplySources(newSupply);
                StorageService.save({ supplySources: newSupply });
            };

            // --- CONFIG PHASES (PROTÉGÉ) ---
            const createConfiguration = () => {
                if (!canEdit) return;
                const newConfig = { id: Date.now(), name: `PHASE ${configurations.length + 1}`, content: {} };
                const newConfigs = [...configurations, newConfig];
                setConfigurations(newConfigs);
                setCurrentConfigId(newConfig.id);
                StorageService.save({ configurations: newConfigs });
            };
            const updateConfiguration = (configId, modelId, delta) => {
                if (!canEdit) return;
                const config = configurations.find(c => c.id === configId);
                if(!config) return;
                const currentCount = config.content[modelId] || 0;
                const newCount = Math.max(0, currentCount + delta);
                const newContent = { ...config.content, [modelId]: newCount };
                if (newCount === 0) delete newContent[modelId];
                const newConfigs = configurations.map(c => c.id === configId ? { ...c, content: newContent } : c);
                setConfigurations(newConfigs);
                StorageService.save({ configurations: newConfigs });
            };
            const setConfigurationCount = (configId, modelId, value) => {
                if (!canEdit) return;
                const config = configurations.find(c => c.id === configId);
                if(!config) return;
                const newCount = Math.max(0, parseInt(value) || 0);
                const newContent = { ...config.content, [modelId]: newCount };
                if (newCount === 0) delete newContent[modelId];
                const newConfigs = configurations.map(c => c.id === configId ? { ...c, content: newContent } : c);
                setConfigurations(newConfigs);
                StorageService.save({ configurations: newConfigs });
            };
            const renameConfiguration = (configId, newName) => {
                if (!canEdit) return;
                const newConfigs = configurations.map(c => c.id === configId ? { ...c, name: newName.toUpperCase() } : c);
                setConfigurations(newConfigs);
                StorageService.save({ configurations: newConfigs });
            };
            const deleteConfiguration = (configId) => {
                if (!canEdit) return;
                if(!window.confirm("Supprimer cette phase ?")) return;
                const newConfigs = configurations.filter(c => c.id !== configId);
                setConfigurations(newConfigs);
                if (currentConfigId === configId) setCurrentConfigId(null);
                StorageService.save({ configurations: newConfigs });
            };
            const deployConfiguration = (configId) => {
                if (!canEdit) return;
                const config = configurations.find(c => c.id === configId);
                if (!config) return;
                let deployedCount = 0;
                let newActiveUnits = [...activeUnits];
                Object.entries(config.content).forEach(([modelId, targetCount]) => {
                    const model = catalog.find(m => m.id === modelId);
                    if (!model) return;
                    const currentDeployed = newActiveUnits.filter(u => u.modelId === modelId).length;
                    const needed = targetCount - currentDeployed;
                    if (needed > 0) {
                        const availableSlots = model.stock - currentDeployed;
                        const toDeploy = Math.min(needed, availableSlots);
                        for (let i = 0; i < toDeploy; i++) {
                            newActiveUnits.push({
                                uuid: Date.now() + Math.random() + i,
                                modelId: model.id,
                                name: model.name,
                                cat: model.cat,
                                cost: model.cost,
                                status: 'operational', 
                                responsible: 'BASE',
                                reasonHS: '',
                                missionStartTime: null,
                                deployTime: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                                logs: []
                            });
                            deployedCount++;
                        }
                    }
                });
                if (deployedCount > 0) {
                    setActiveUnits(newActiveUnits);
                    StorageService.save({ activeUnits: newActiveUnits });
                    logEvent('GARAGE', `DÉPLOIEMENT PHASE: ${config.name} (+${deployedCount} UNITÉS)`);
                    alert(`${config.name} DÉPLOYÉE : ${deployedCount} véhicules sortis.`);
                } else {
                    alert("Configuration déjà complète sur le terrain ou stock insuffisant.");
                }
            };

            // --- HANDLERS MODALES ---
            const handleStatusClick = (unit, targetStatus) => {
                if (!canEdit) return; // Bloqué pour LOGI
                if (unit.status === targetStatus && targetStatus !== 'mission') return;
                if (targetStatus === 'mission') { setSelectedMemberId(''); setActionModal({ type: 'mission', unit }); } 
                else if (targetStatus === 'destroyed') { setInputReason(''); setActionModal({ type: 'destroy', unit }); } 
                else { updateUnitStatus(unit.uuid, targetStatus); }
            };
            const confirmMission = () => {
                if (!actionModal) return;
                let respName = "INDÉFINI";
                if (selectedMemberId === 'SL') respName = slName || "CHEF LOGI";
                else { const member = squad.find(m => m.id === parseInt(selectedMemberId)); if (member) respName = member.name; }
                updateUnitStatus(actionModal.unit.uuid, 'mission', { responsible: respName, missionStartTime: Date.now() });
                setActionModal(null);
            };
            const confirmDestruction = () => {
                if (!actionModal || !inputReason) return;
                updateUnitStatus(actionModal.unit.uuid, 'destroyed', { reasonHS: inputReason, missionStartTime: null });
                setActionModal(null);
            };

            const stats = useMemo(() => {
                const deployedCost = activeUnits.reduce((sum, u) => u.status !== 'stored' ? sum + u.cost : sum, 0);
                const destroyedCount = activeUnits.filter(u => u.status === 'destroyed').length;
                const missionCount = activeUnits.filter(u => u.status === 'mission').length;
                const activeCount = activeUnits.length;
                const totalSupply = supplySources.reduce((acc, src) => acc + (parseInt(src.amount) || 0), 0);
                return { deployedCost, destroyedCount, activeCount, missionCount, totalSupply };
            }, [activeUnits, supplySources]);

            // --- ICONS ---
            const Activity = Icons['Activity'];
            const Database = Icons['Database'];
            const LayoutDashboard = Icons['LayoutDashboard'];
            const Warehouse = Icons['Warehouse'];
            const Users = Icons['Users'];
            const ScrollText = Icons['ScrollText'];
            const Target = Icons['Target'];
            const Shield = Icons['Shield'];
            const Plus = Icons['Plus'];
            const Wifi = Icons['Wifi'];
            const LogOut = Icons['LogOut'];
            const ArrowUpRight = Icons['ArrowUpRight'];
            const Settings = Icons['Settings'];
            const XCircle = Icons['XCircle'];
            const Trash2 = Icons['Trash2'];
            const RotateCcw = Icons['RotateCcw'];
            const Clock = Icons['Clock'];
            const List = Icons['List'];
            const Play = Icons['Play'];
            const PlusCircle = Icons['PlusCircle'];
            const MinusCircle = Icons['MinusCircle'];

            // --- LOGIC LOGIN ---
            if (!userRole) return <LoginScreen onLogin={(role) => setUserRole(role)} />;
            if (!dataLoaded) return <div className="min-h-screen bg-black flex items-center justify-center text-green-500 font-mono animate-pulse">INITIALISATION SYSTÈME...</div>;

            return (
                <div className="min-h-screen bg-black text-green-500 flex flex-col selection:bg-green-900 selection:text-white overflow-hidden relative max-w-5xl mx-auto border-x border-green-900/50 shadow-[0_0_50px_rgba(0,255,0,0.05)]">
                    <div className="absolute inset-0 pointer-events-none z-0 opacity-10 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] bg-[length:100%_4px,3px_100%]"></div>

                    {/* HEADER */}
                    <header className="bg-black border-b-2 border-green-900 p-3 z-50 flex justify-between items-center shadow-[0_0_20px_rgba(0,255,0,0.1)] relative">
                        <div className="flex items-center gap-4">
                            <div className="border border-green-700 p-1 bg-green-900/20">
                                {Activity && <Activity size={24} className="text-green-500 animate-pulse"/>}
                            </div>
                            <div>
                                <h1 className="font-black text-xl tracking-[0.2em] text-green-500 leading-none">LOGI-OPS <span className="text-xs align-top text-green-800">V9.0</span></h1>
                                <div className="flex items-center gap-3 text-[10px] font-bold text-green-700 mt-1">
                                    <span className={`flex items-center gap-1 ${isSlActive ? "text-green-400" : "text-red-500 animate-pulse"}`}>
                                        <div className={`w-2 h-2 rounded-full ${isSlActive ? "bg-green-500" : "bg-red-500"}`}></div>
                                        SL: {slName || "N/A"}
                                    </span>
                                    <span className="border-l border-green-900 pl-3">SQD: {squad.length} PAX</span>
                                    <span className={`ml-2 ${USE_FIREBASE ? 'text-blue-500' : 'text-orange-500'}`}>
                                        [{USE_FIREBASE ? 'ONLINE' : 'LOCAL'}]
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div className="text-right">
                            <div className="text-[9px] font-bold text-green-800 uppercase mb-1 flex items-center justify-end gap-1">
                                {Database && <Database size={10}/>} GLOBAL SUPPLY
                            </div>
                            <button onClick={() => canEdit && setShowSupplyModal(true)} className={`text-xl font-black bg-green-900/10 px-3 py-1 border border-green-800 transition-all flex items-center gap-2 ${canEdit ? 'text-green-400 hover:bg-green-900/30 hover:border-green-500' : 'text-gray-500 cursor-default'}`}>
                                {stats.totalSupply.toLocaleString()}
                            </button>
                        </div>
                    </header>

                    {/* MAIN CONTENT */}
                    <main className="flex-1 overflow-y-auto p-3 pb-20 scrollbar-thin scrollbar-thumb-green-900 scrollbar-track-black relative z-10">
                        {/* DASHBOARD */}
                        {activeTab === 'dashboard' && (
                            <div className="space-y-4 animate-in fade-in duration-300">
                                <div className="grid grid-cols-3 gap-2 mb-4">
                                    <div className="bg-green-900/10 border border-green-800 p-2 text-center relative overflow-hidden">
                                        <div className="absolute top-0 left-0 w-2 h-2 border-t border-l border-green-500"></div>
                                        <span className="text-2xl font-black text-green-500 block leading-none">{activeUnits.filter(u => u.status === 'operational').length}</span>
                                        <span className="text-[9px] font-bold text-green-800 uppercase tracking-widest">DISPO</span>
                                    </div>
                                    <div className="bg-blue-900/10 border border-blue-800 p-2 text-center relative overflow-hidden">
                                        <div className="absolute top-0 left-0 w-2 h-2 border-t border-l border-blue-500"></div>
                                        <span className="text-2xl font-black text-blue-500 block leading-none">{stats.missionCount}</span>
                                        <span className="text-[9px] font-bold text-blue-800 uppercase tracking-widest">MISSION</span>
                                    </div>
                                    <div className="bg-red-900/10 border border-red-800 p-2 text-center relative overflow-hidden">
                                        <div className="absolute top-0 left-0 w-2 h-2 border-t border-l border-red-500"></div>
                                        <span className="text-2xl font-black text-red-500 block leading-none">{stats.destroyedCount}</span>
                                        <span className="text-[9px] font-bold text-red-800 uppercase tracking-widest">PERTES</span>
                                    </div>
                                </div>

                                {activeUnits.length === 0 ? (
                                    <div className="flex flex-col items-center justify-center h-64 border border-dashed border-green-900 bg-green-900/5">
                                        {Target && <Target size={48} className="mb-4 text-green-900 opacity-50" />}
                                        <p className="text-xs font-bold uppercase text-green-800 tracking-widest">AUCUNE UNITÉ DÉPLOYÉE</p>
                                        {canEdit && <p className="text-[10px] text-green-900 mt-1">ACCÉDER AU GARAGE POUR DÉPLOIEMENT</p>}
                                    </div>
                                ) : (
                                    Object.keys(CATEGORIES).map(catKey => {
                                        const unitsInCat = activeUnits.filter(u => u.cat === catKey);
                                        if (unitsInCat.length === 0) return null;
                                        const conf = CATEGORIES[catKey];
                                        return (
                                            <div key={catKey} className="mb-4">
                                                <div className={`flex items-center gap-2 mb-2 px-2 border-l-2 ${conf.color.split(' ')[0]} bg-black`}>
                                                    <span className="font-black text-[10px] tracking-[0.2em] uppercase text-gray-500">{conf.label}</span>
                                                </div>
                                                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                                    {unitsInCat.map(unit => (
                                                        <UnitCard 
                                                            key={unit.uuid} 
                                                            unit={unit} 
                                                            onStatusChange={(s) => handleStatusClick(unit, s)}
                                                            onEndMission={() => endMission(unit)}
                                                            onRTB={() => returnToBase(unit.uuid)}
                                                            onShowLogs={() => setActionModal({ type: 'logs', unit })}
                                                            Icons={Icons}
                                                            readOnly={!canEdit} // Mode lecture seule
                                                        />
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        )}

                        {/* GARAGE (Seulement si SL) */}
                        {activeTab === 'garage' && canEdit && (
                            <div className="space-y-6 animate-in fade-in duration-300">
                                <div className="flex flex-col gap-2 border-b border-green-900 pb-4">
                                    <div className="flex justify-between items-center">
                                        <h2 className="text-sm font-black text-green-500 flex items-center gap-2 uppercase tracking-widest">
                                            {Warehouse && <Warehouse size={16}/>} CATALOGUE DÉPLOIEMENT
                                        </h2>
                                        <div className="flex gap-2">
                                            <button onClick={() => setShowConfigModal(true)} className="text-[9px] font-bold bg-blue-900/20 border border-blue-800 px-3 py-1 text-blue-400 hover:bg-blue-900/40 hover:border-blue-500 flex items-center gap-2 transition-colors">
                                                {List && <List size={12} />} CONFIG PHASES
                                            </button>
                                            <button onClick={() => setShowStockModal(true)} className="text-[9px] font-bold bg-green-900/20 border border-green-800 px-3 py-1 hover:bg-green-900/40 hover:text-green-300 flex items-center gap-2 transition-colors">
                                                {Settings && <Settings size={12} />} ÉDITER STOCKS
                                            </button>
                                        </div>
                                    </div>
                                    {/* ZONE DEPLOIEMENT RAPIDE DES PHASES */}
                                    {configurations.length > 0 && (
                                        <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-green-900">
                                            {configurations.map(config => (
                                                <button 
                                                    key={config.id}
                                                    onClick={() => deployConfiguration(config.id)}
                                                    className="flex items-center gap-2 px-3 py-2 bg-black border border-green-900 hover:border-green-500 hover:bg-green-900/20 whitespace-nowrap group transition-all"
                                                >
                                                    {Play && <Play size={12} className="text-green-700 group-hover:text-green-400"/>}
                                                    <span className="text-[10px] font-black text-green-600 group-hover:text-green-400 uppercase">{config.name}</span>
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                <div className="space-y-6">
                                    {Object.keys(CATEGORIES).map(catKey => {
                                        const models = catalog.filter(m => m.cat === catKey);
                                        if(models.length === 0) return null;
                                        const IconComp = Icons[CATEGORIES[catKey].icon];
                                        return (
                                            <div key={catKey} className="bg-black border border-green-900 p-3 relative">
                                                <div className="absolute top-0 left-0 w-2 h-2 border-t border-l border-green-700"></div>
                                                <div className="absolute top-0 right-0 w-2 h-2 border-t border-r border-green-700"></div>
                                                <div className="absolute bottom-0 left-0 w-2 h-2 border-b border-l border-green-700"></div>
                                                <div className="absolute bottom-0 right-0 w-2 h-2 border-b border-r border-green-700"></div>

                                                <div className="flex items-center gap-2 mb-3 pb-1 border-b border-green-900/50">
                                                    <span className={CATEGORIES[catKey].color.split(' ')[1]}>{IconComp && <IconComp size={16}/>}</span>
                                                    <span className="font-black text-xs text-gray-400 tracking-wider">{CATEGORIES[catKey].label}</span>
                                                </div>
                                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                                                    {models.map(model => {
                                                        const activeCount = activeUnits.filter(u => u.modelId === model.id).length;
                                                        const totalSlots = model.stock;
                                                        return Array.from({ length: totalSlots }).map((_, index) => {
                                                            const isVehicleInGarage = index >= activeCount; 
                                                            return (
                                                                <button
                                                                    key={`${model.id}-${index}`}
                                                                    disabled={!isVehicleInGarage}
                                                                    onClick={() => isVehicleInGarage && deployUnit(model.id)}
                                                                    className={`relative p-2 border flex flex-col items-center justify-center text-center h-20 transition-all ${isVehicleInGarage ? 'bg-green-900/10 border-green-800 hover:bg-green-900/30 hover:border-green-500 active:scale-95 group' : 'bg-black border-green-900/30 opacity-30 cursor-default'}`}
                                                                >
                                                                    {isVehicleInGarage ? (
                                                                        <>
                                                                            <div className="absolute top-1 right-1 w-1 h-1 bg-green-500 shadow-[0_0_5px_#22c55e]"></div>
                                                                            <span className="mt-1 text-[9px] font-black text-green-400 leading-tight uppercase">{model.name}</span>
                                                                            <span className="text-[8px] text-green-800 font-mono">{model.cost} PTS</span>
                                                                        </>
                                                                    ) : (
                                                                        <div className="flex flex-col items-center">
                                                                            {ArrowUpRight && <ArrowUpRight size={16} className="text-green-900 mb-1"/>}
                                                                            <span className="text-[8px] font-black text-green-900 uppercase tracking-widest">EN MISSION</span>
                                                                        </div>
                                                                    )}
                                                                    <div className="absolute bottom-1 left-1 text-[7px] font-mono text-green-900">SLOT {index+1}</div>
                                                                </button>
                                                            );
                                                        });
                                                    })}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* SQUAD */}
                        {activeTab === 'squad' && (
                            <div className="space-y-4 animate-in fade-in duration-300">
                                <div className="bg-black border border-green-800 p-4 relative">
                                    <div className="absolute top-0 left-0 w-full h-1 bg-green-900/30"></div>
                                    <h3 className="text-[10px] font-black text-green-600 uppercase mb-3 flex items-center gap-2 tracking-widest">
                                        {Shield && <Shield size={12}/>} COMMANDEMENT LOGISTIQUE
                                    </h3>
                                    <div className="flex gap-2">
                                        <input 
                                            type="text" 
                                            placeholder="NOM DU SL..." 
                                            value={slName}
                                            disabled={!canEdit || isSlActive}
                                            onChange={(e) => setSlName(e.target.value)}
                                            className="flex-1 bg-green-900/10 border border-green-800 px-3 text-sm font-bold text-green-400 uppercase focus:border-green-500 outline-none placeholder-green-900 disabled:opacity-50"
                                        />
                                        {canEdit && (
                                            <button onClick={toggleSlShift} disabled={!slName} className={`px-4 border font-bold text-[10px] transition-all ${isSlActive ? 'bg-red-900/20 text-red-500 border-red-800 hover:bg-red-900/40' : 'bg-green-900/20 text-green-400 border-green-600 hover:bg-green-900/40'}`}>
                                                {isSlActive ? 'FIN SERVICE' : 'PRISE POSTE'}
                                            </button>
                                        )}
                                    </div>
                                </div>
                                <div className="bg-black border border-green-900/50 p-4">
                                    <h3 className="text-[10px] font-black text-gray-500 uppercase mb-3 flex items-center gap-2 tracking-widest">
                                        {Users && <Users size={12}/>} ESCUADE LOGISTIQUE ({squad.length})
                                    </h3>
                                    <div className="space-y-2 mb-4">
                                        {squad.length === 0 && <p className="text-center text-[10px] text-green-900 italic py-4 border border-dashed border-green-900/30">AUCUN EFFECTIF</p>}
                                        {squad.map(member => (
                                            <div key={member.id} className="flex justify-between items-center bg-green-900/5 p-2 border border-green-900/30">
                                                <div>
                                                    <div className="font-bold text-xs text-green-400 flex items-center gap-2">
                                                        {Wifi && <Wifi size={10} className="text-green-600 animate-pulse"/>}
                                                        {member.name}
                                                    </div>
                                                    <div className="text-[9px] text-green-800 font-mono">T-IN: {member.startTime}</div>
                                                </div>
                                                {canEdit && (
                                                    <button onClick={() => removeSquadMember(member.id)} className="text-green-800 hover:text-red-500 p-1">
                                                        {LogOut && <LogOut size={14}/>}
                                                    </button>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                    {canEdit && (
                                        <div className="flex gap-2 border-t border-green-900/30 pt-3">
                                            <input type="text" id="newMemberName" placeholder="NOUVEAU MEMBRE..." className="flex-1 bg-black border border-green-900 px-3 py-2 text-xs font-bold text-green-400 uppercase focus:border-green-600 outline-none placeholder-green-900" onKeyDown={(e) => { if(e.key === 'Enter') { addSquadMember(e.target.value); e.target.value = ''; } }} />
                                            <button onClick={() => { const el = document.getElementById('newMemberName'); addSquadMember(el.value); el.value = ''; }} className="bg-green-900/20 hover:bg-green-900/40 text-green-500 border border-green-800 px-3">
                                                {Plus && <Plus size={16}/>}
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* JOURNAL (Caché pour Logi) */}
                        {activeTab === 'journal' && canEdit && (
                            <div className="space-y-4 animate-in fade-in duration-300">
                                <h2 className="text-xs font-black text-green-600 flex items-center gap-2 uppercase tracking-widest border-b border-green-900 pb-2">
                                    {ScrollText && <ScrollText size={14}/>} JOURNAL DE MARCHE ET OPÉRATIONS
                                </h2>
                                <div className="space-y-0 font-mono text-xs">
                                    {globalLogs.length === 0 && <p className="text-[10px] text-green-900 italic">Aucune entrée.</p>}
                                    {globalLogs.map(log => (
                                        <div key={log.id} className="flex gap-3 py-2 border-b border-green-900/20 text-green-400">
                                            <span className="text-green-800 font-bold w-12 shrink-0">{log.time}</span>
                                            <div>
                                                <span className="text-[9px] font-black bg-green-900/20 px-1 rounded text-green-600 mr-2">{log.type}</span>
                                                <span className="text-gray-400">{log.msg}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* NAVIGATION */}
                    <nav className="fixed bottom-0 w-full max-w-5xl left-1/2 -translate-x-1/2 bg-black border-t border-green-900 grid grid-cols-4 h-14 z-50 pb-safe shadow-[0_-5px_20px_rgba(0,0,0,0.5)]">
                        <NavButton icon={LayoutDashboard && <LayoutDashboard size={18}/>} label="OPS" active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} />
                        
                        {/* Le Garage est désactivé visuellement pour Logi */}
                        <NavButton 
                            icon={Warehouse && <Warehouse size={18}/>} 
                            label="GARAGE" 
                            active={activeTab === 'garage'} 
                            onClick={() => canEdit && setActiveTab('garage')} 
                            disabled={!canEdit}
                        />
                        
                        <NavButton icon={Users && <Users size={18}/>} label="SQUAD" active={activeTab === 'squad'} onClick={() => setActiveTab('squad')} />
                        
                        {/* Le Journal est désactivé visuellement pour Logi */}
                        <NavButton 
                            icon={ScrollText && <ScrollText size={18}/>} 
                            label="JMO" 
                            active={activeTab === 'journal'} 
                            onClick={() => canEdit && setActiveTab('journal')} 
                            disabled={!canEdit}
                        />
                    </nav>

                    {/* MODALES */}
                    
                    {/* GESTIONNAIRE DE PHASES (NOUVEAU) */}
                    {showConfigModal && canEdit && (
                        <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                            <div className="bg-black border border-blue-800 w-full max-w-4xl h-[80vh] flex flex-col shadow-[0_0_50px_rgba(30,64,175,0.2)]">
                                <div className="p-3 border-b border-blue-900 bg-blue-900/10 flex justify-between items-center">
                                    <h3 className="font-black text-blue-500 text-sm tracking-widest flex items-center gap-2">
                                        {List && <List size={16}/>} CONFIGURATEUR DE PHASES
                                    </h3>
                                    <button onClick={() => { setShowConfigModal(false); setCurrentConfigId(null); }}>
                                        {XCircle && <XCircle size={18} className="text-blue-700 hover:text-blue-400"/>}
                                    </button>
                                </div>
                                <div className="flex-1 flex overflow-hidden">
                                    {/* LISTE DES PHASES (GAUCHE) */}
                                    <div className="w-1/3 border-r border-blue-900/50 overflow-y-auto p-2 space-y-2 bg-black">
                                        <button onClick={createConfiguration} className="w-full py-2 border border-dashed border-blue-700 text-blue-500 text-[10px] font-bold hover:bg-blue-900/20 flex items-center justify-center gap-2">
                                            {Plus && <Plus size={12}/>} NOUVELLE PHASE
                                        </button>
                                        {configurations.map(config => (
                                            <div key={config.id} className={`flex items-center justify-between p-3 border transition-all cursor-pointer ${currentConfigId === config.id ? 'border-blue-500 bg-blue-900/20' : 'border-blue-900/30 hover:bg-blue-900/10'}`} onClick={() => setCurrentConfigId(config.id)}>
                                                <span className="text-xs font-bold text-blue-400">{config.name}</span>
                                                <button onClick={(e) => { e.stopPropagation(); deleteConfiguration(config.id); }} className="text-blue-800 hover:text-red-500">
                                                    {Trash2 && <Trash2 size={12}/>}
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                    
                                    {/* CONTENU EDITEUR (DROITE) */}
                                    <div className="w-2/3 overflow-y-auto p-4 bg-black">
                                        {currentConfigId ? (
                                            <div className="space-y-4">
                                                <div className="flex items-center gap-2 border-b border-blue-900 pb-2 mb-4">
                                                    <span className="text-[10px] font-bold text-blue-700">NOM :</span>
                                                    <input 
                                                        type="text" 
                                                        value={configurations.find(c => c.id === currentConfigId)?.name}
                                                        onChange={(e) => renameConfiguration(currentConfigId, e.target.value)}
                                                        className="bg-transparent text-blue-400 font-black uppercase outline-none w-full"
                                                    />
                                                </div>
                                                <div className="grid grid-cols-2 gap-3">
                                                    {catalog.map(model => {
                                                        const count = configurations.find(c => c.id === currentConfigId)?.content[model.id] || 0;
                                                        return (
                                                            <div key={model.id} className={`flex justify-between items-center p-2 border ${count > 0 ? 'border-blue-600 bg-blue-900/10' : 'border-blue-900/30 opacity-60'}`}>
                                                                <span className="text-[9px] font-bold text-gray-400 truncate max-w-[100px]">{model.name}</span>
                                                                <div className="flex items-center gap-1">
                                                                    <button onClick={() => updateConfiguration(currentConfigId, model.id, -1)} className="text-blue-700 hover:text-blue-400 px-1">{MinusCircle && <MinusCircle size={14}/>}</button>
                                                                    
                                                                    {/* INPUT QUANTITÉ SAISISSABLE */}
                                                                    <input 
                                                                        type="number" 
                                                                        value={count} 
                                                                        onChange={(e) => setConfigurationCount(currentConfigId, model.id, e.target.value)}
                                                                        className="w-10 bg-black text-blue-400 font-mono font-bold text-center text-xs border border-blue-900/50 focus:border-blue-500 outline-none p-1"
                                                                        onClick={(e) => e.target.select()} // Sélectionne tout le texte au clic pour remplacement rapide
                                                                    />

                                                                    <button onClick={() => updateConfiguration(currentConfigId, model.id, 1)} className="text-blue-700 hover:text-blue-400 px-1">{PlusCircle && <PlusCircle size={14}/>}</button>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="h-full flex items-center justify-center text-blue-900 text-xs font-bold italic">
                                                SÉLECTIONNEZ OU CRÉEZ UNE PHASE
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <div className="p-3 border-t border-blue-900 bg-black flex justify-end">
                                    <button onClick={() => { setShowConfigModal(false); setCurrentConfigId(null); }} className="px-6 py-2 bg-blue-900/20 border border-blue-800 text-blue-500 text-[10px] font-bold hover:bg-blue-900/40">TERMINER</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* AUTRES MODALES EXISTANTES (Mission, Destroy, Stock, Supply, Logs) */}
                    {actionModal?.type === 'mission' && canEdit && (
                        <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                            <div className="bg-black border border-blue-700 w-full max-w-sm p-6 relative shadow-[0_0_30px_rgba(29,78,216,0.2)]">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-lg font-black uppercase text-blue-500 tracking-widest">ORDRE DE MISSION</h3>
                                    <button onClick={() => setActionModal(null)} className="text-blue-700 hover:text-blue-400">{XCircle && <XCircle size={20} />}</button>
                                </div>
                                <div className="mb-6">
                                    <label className="text-[9px] font-bold text-blue-800 uppercase block mb-1">CHEF DE BORD / PILOTE</label>
                                    <select value={selectedMemberId} onChange={(e) => setSelectedMemberId(e.target.value)} className="w-full bg-blue-900/10 border border-blue-800 p-3 text-blue-300 focus:border-blue-500 outline-none font-bold uppercase text-xs appearance-none">
                                        <option value="">-- SÉLECTIONNER PERSONNEL --</option>
                                        {slName && <option value="SL">SL - {slName}</option>}
                                        {squad.map(m => (<option key={m.id} value={m.id}>{m.name}</option>))}
                                    </select>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => setActionModal(null)} className="py-3 border border-gray-800 text-gray-500 font-bold text-xs hover:text-white hover:border-gray-500 transition-colors">ANNULER</button>
                                    <button onClick={confirmMission} disabled={!selectedMemberId} className="py-3 bg-blue-600 text-black font-black text-xs hover:bg-blue-500 disabled:opacity-50">DÉPART</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {actionModal?.type === 'destroy' && canEdit && (
                        <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                            <div className="bg-black border-2 border-red-700 w-full max-w-sm p-6 relative shadow-[0_0_50px_rgba(185,28,28,0.3)]">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-black uppercase text-red-600 tracking-widest animate-pulse">RAPPORT DE PERTE</h3>
                                    <button onClick={() => setActionModal(null)} className="text-red-700 hover:text-red-400">{XCircle && <XCircle size={20} />}</button>
                                </div>
                                <input autoFocus type="text" value={inputReason} onChange={(e) => setInputReason(e.target.value)} className="w-full bg-red-900/10 border border-red-800 p-3 text-red-200 mb-6 font-bold uppercase outline-none focus:border-red-500 text-sm" placeholder="CAUSE (EX: IED, ROQUETTE...)" />
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => setActionModal(null)} className="py-3 border border-gray-800 text-gray-500 font-bold text-xs hover:text-white">ANNULER</button>
                                    <button onClick={confirmDestruction} disabled={!inputReason} className="py-3 bg-red-700 text-white font-black text-xs hover:bg-red-600">CONFIRMER</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showStockModal && canEdit && (
                        <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                            <div className="bg-black border border-green-800 w-full max-w-md flex flex-col max-h-[80vh]">
                                <div className="p-3 border-b border-green-900 bg-green-900/20 flex justify-between items-center">
                                    <h3 className="font-black text-green-500 text-sm tracking-widest">GESTION STOCKS</h3>
                                    <button onClick={() => setShowStockModal(false)}>{XCircle && <XCircle size={18} className="text-green-700 hover:text-green-400"/>}</button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                    {Object.keys(CATEGORIES).map(catKey => {
                                        const models = catalog.filter(m => m.cat === catKey);
                                        if(models.length === 0) return null;
                                        return (
                                            <div key={catKey}>
                                                <h4 className={`text-[10px] font-black mb-2 uppercase ${CATEGORIES[catKey].color.split(' ')[1]}`}>{CATEGORIES[catKey].label}</h4>
                                                <div className="space-y-1">
                                                    {models.map(model => (
                                                        <div key={model.id} className="flex items-center justify-between bg-green-900/5 p-2 border border-green-900/30">
                                                            <div className="flex-1">
                                                                <div className="text-[10px] font-bold text-gray-400">{model.name}</div>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <button onClick={() => updateStock(model.id, -1)} className="w-5 h-5 flex items-center justify-center bg-black border border-red-900 text-red-500 hover:bg-red-900/20 font-mono text-xs">-</button>
                                                                <span className="w-6 text-center font-mono font-bold text-green-400 text-xs">{model.stock}</span>
                                                                <button onClick={() => updateStock(model.id, 1)} className="w-5 h-5 flex items-center justify-center bg-black border border-green-900 text-green-500 hover:bg-green-900/20 font-mono text-xs">+</button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="p-3 border-t border-green-900/20 bg-black">
                                    <button onClick={() => setShowStockModal(false)} className="w-full py-2 bg-green-900/20 border border-green-800 text-green-500 text-[10px] font-bold hover:bg-green-900/40 flex items-center justify-center gap-2">FERMER</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showSupplyModal && canEdit && (
                        <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                            <div className="bg-black border border-green-800 w-full max-w-md">
                                <div className="p-3 border-b border-green-900 bg-green-900/20 flex justify-between items-center">
                                    <h3 className="font-black text-green-500 text-sm tracking-widest">INVENTAIRE LOGISTIQUE</h3>
                                    <button onClick={() => setShowSupplyModal(false)}>{XCircle && <XCircle size={18} className="text-green-700 hover:text-green-400"/>}</button>
                                </div>
                                <div className="p-4 space-y-2">
                                    {supplySources.map((src, idx) => (
                                        <div key={src.id} className="flex items-center justify-between bg-black p-2 border border-green-900/50">
                                            <span className="text-xs font-bold text-green-600 uppercase">{src.name}</span>
                                            <div className="flex items-center gap-2">
                                                <input type="number" value={src.amount} onChange={(e) => updateSupplySource(src.id, 'amount', parseInt(e.target.value) || 0)} className="w-20 bg-green-900/10 text-green-400 font-mono font-bold text-right p-1 outline-none border border-green-900 focus:border-green-500 text-xs" />
                                                <button onClick={() => removeSupplySource(src.id)} className="text-green-800 hover:text-red-500">{Trash2 && <Trash2 size={14}/>}</button>
                                            </div>
                                        </div>
                                    ))}
                                    <button onClick={addSupplySource} className="w-full py-2 border border-dashed border-green-900 text-green-700 text-[10px] font-bold hover:border-green-500 hover:text-green-500 flex items-center justify-center gap-2 mt-4">AJOUTER SOURCE</button>
                                    <button onClick={() => setShowSupplyModal(false)} className="w-full py-2 bg-green-900/20 border border-green-800 text-green-500 text-[10px] font-bold hover:bg-green-900/40 flex items-center justify-center gap-2 mt-2">FERMER</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {actionModal?.type === 'logs' && (
                        <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center animate-in fade-in">
                            <div className="bg-black border border-green-800 w-full max-w-md h-[60vh] flex flex-col relative">
                                <div className="p-3 border-b border-green-900 bg-green-900/20 flex justify-between items-center">
                                    <h3 className="font-black text-green-500 text-sm tracking-widest">HISTORIQUE VÉHICULE</h3>
                                    <button onClick={() => setActionModal(null)}>{XCircle && <XCircle size={18} className="text-green-700 hover:text-green-400"/>}</button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-4 font-mono text-xs">
                                    {actionModal.unit.logs?.slice().reverse().map((log, i) => (
                                        <div key={i} className="border-l border-green-900 pl-3 text-green-400">
                                            <span className="text-green-800 font-bold block text-[9px]">{log.time}</span>
                                            <p className="text-gray-400 uppercase">{log.msg}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function NavButton({ icon, label, active, onClick, disabled }) {
            return (
                <button 
                    onClick={onClick} 
                    disabled={disabled}
                    className={`flex flex-col items-center justify-center gap-1 transition-all border-t-2 ${active ? 'text-green-400 border-green-500 bg-green-900/20' : disabled ? 'text-green-900 opacity-30 cursor-not-allowed border-transparent' : 'text-green-900 border-transparent hover:text-green-600'}`}
                >
                    {icon}
                    <span className="text-[8px] font-black tracking-widest">{label}</span>
                </button>
            );
        }

        function MissionTimer({ startTime }) {
            const [duration, setDuration] = useState('00:00:00');
            useEffect(() => {
                const timer = setInterval(() => {
                    const diff = Date.now() - startTime;
                    const hrs = Math.floor(diff / 3600000).toString().padStart(2, '0');
                    const mins = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
                    const secs = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
                    setDuration(`${hrs}:${mins}:${secs}`);
                }, 1000);
                return () => clearInterval(timer);
            }, [startTime]);
            return <span className="font-mono text-blue-400 font-bold bg-blue-900/30 px-2 py-0.5 text-[10px] border border-blue-900">T+{duration}</span>;
        }

        function UnitCard({ unit, onStatusChange, onEndMission, onRTB, onShowLogs, Icons, readOnly }) {
            let borderColor = 'border-green-600';
            let statusText = 'text-green-500';
            if (unit.status === 'mission') { borderColor = 'border-blue-600'; statusText = 'text-blue-500'; }
            else if (unit.status === 'damaged') { borderColor = 'border-orange-600'; statusText = 'text-orange-500'; }
            else if (unit.status === 'destroyed') { borderColor = 'border-red-600'; statusText = 'text-red-600'; }

            const IconComp = Icons[CATEGORIES[unit.cat].icon];
            const List = Icons['List'];
            const Clock = Icons['Clock'];
            const RotateCcw = Icons['RotateCcw'];
            const XCircle = Icons['XCircle'];

            return (
                <div className={`relative border-l-2 ${borderColor} bg-green-900/5 p-2 flex flex-col h-full border-t border-r border-b border-green-900/30 hover:bg-green-900/10 transition-all`}>
                    <div className="flex justify-between items-start mb-2">
                        <div className="flex gap-2 overflow-hidden">
                            <div className={`p-1.5 bg-black border border-green-900 flex items-center justify-center h-8 w-8 shrink-0 ${statusText}`}>
                                {IconComp && <IconComp size={16}/>}
                            </div>
                            <div className="min-w-0">
                                <h3 className={`font-black text-xs text-gray-300 truncate uppercase leading-tight ${unit.status === 'destroyed' && 'line-through opacity-50'}`}>{unit.name}</h3>
                                <div className="flex items-center gap-1 mt-0.5">
                                    <span className="text-[8px] text-green-800 font-mono">{unit.cost} PTS</span>
                                    {unit.responsible !== 'BASE' && (
                                        <span className="text-[8px] bg-blue-900/20 px-1 text-blue-400 border border-blue-900/50 truncate max-w-[80px]">{unit.responsible}</span>
                                    )}
                                </div>
                            </div>
                        </div>
                        <button onClick={onShowLogs} className="text-green-900 hover:text-green-500 p-1 shrink-0">{List && <List size={14} />}</button>
                    </div>
                    {unit.status === 'mission' && (
                        <div className="mb-2 flex items-center gap-1 justify-center">
                            {Clock && <Clock size={10} className="text-blue-600"/>}
                            <MissionTimer startTime={unit.missionStartTime} />
                        </div>
                    )}
                    {unit.status === 'destroyed' ? (
                        <div className="bg-red-900/10 border border-red-900/50 p-1 text-center mb-2">
                            <p className="text-[8px] text-red-700 font-bold uppercase">CAUSE: {unit.reasonHS}</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-4 gap-1 mb-2 mt-auto">
                            <StatusBtn label="OPS" active={unit.status === 'operational'} color="green" onClick={() => !readOnly && onStatusChange('operational')} />
                            <StatusBtn label="MIS" active={unit.status === 'mission'} color="blue" onClick={() => !readOnly && (unit.status === 'mission' ? onEndMission() : onStatusChange('mission'))} />
                            <StatusBtn label="RÉP" active={unit.status === 'damaged'} color="orange" onClick={() => !readOnly && onStatusChange('damaged')} />
                            <StatusBtn label="HS" active={false} color="red" onClick={() => !readOnly && onStatusChange('destroyed')} />
                        </div>
                    )}
                    <div className="flex justify-end pt-1 border-t border-green-900/20 mt-auto">
                        {unit.status !== 'destroyed' ? (
                            !readOnly && (
                                <button onClick={onRTB} className="text-[8px] font-bold text-green-800 hover:text-green-500 uppercase flex items-center gap-1">
                                    {RotateCcw && <RotateCcw size={8} />} RENTRER
                                </button>
                            )
                        ) : (
                            !readOnly && (
                                <button onClick={onRTB} className="text-[8px] font-bold text-red-800 hover:text-red-500 uppercase flex items-center gap-1">
                                    {XCircle && <XCircle size={8} />} ARCHIVER
                                </button>
                            )
                        )}
                    </div>
                </div>
            );
        }

        function StatusBtn({ label, active, color, onClick }) {
            const styles = {
                green: active ? 'bg-green-600 text-black' : 'bg-black text-green-700 border-green-900 hover:text-green-500',
                blue: active ? 'bg-blue-600 text-black' : 'bg-black text-blue-700 border-blue-900 hover:text-blue-500',
                orange: active ? 'bg-orange-600 text-black' : 'bg-black text-orange-700 border-orange-900 hover:text-orange-500',
                red: 'bg-black text-red-800 border-red-900 hover:text-red-500'
            };
            return (
                <button onClick={onClick} className={`text-[8px] font-black py-1 border ${styles[color]} transition-all uppercase`}>
                {label}
                </button>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LogiOpsV9 />);
    </script>
</body>
</html>
