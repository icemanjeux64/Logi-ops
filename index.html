<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOGIOPS - Centre OpÃ©rationnel</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        mono: ['"JetBrains Mono"', 'monospace'],
                    },
                    colors: {
                        mil: {
                            900: '#0a0f0d',
                            800: '#111a16',
                            700: '#1a2621',
                            green: '#00ff41',
                            dim: '#008F11',
                            alert: '#ff3333',
                            warn: '#ffcc00'
                        }
                    },
                    backgroundImage: {
                        'grid-pattern': "linear-gradient(to right, #1a2621 1px, transparent 1px), linear-gradient(to bottom, #1a2621 1px, transparent 1px)"
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase Compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>

    <style>
        body {
            background-color: #050807;
            color: #e0e0e0;
        }
        .scanline {
            width: 100%;
            height: 100px;
            z-index: 10;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(0, 255, 65, 0.04) 50%, rgba(0,0,0,0) 100%);
            opacity: 0.1;
            position: absolute;
            bottom: 100%;
            animation: scanline 10s linear infinite;
            pointer-events: none;
        }
        @keyframes scanline {
            0% { bottom: 100%; }
            100% { bottom: -100px; }
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111a16; }
        ::-webkit-scrollbar-thumb { background: #008F11; }
        ::-webkit-scrollbar-thumb:hover { background: #00ff41; }
        
        .crt-flicker {
            animation: flicker 0.15s infinite;
        }
        @keyframes flicker {
            0% { opacity: 0.97; }
            50% { opacity: 1; }
            100% { opacity: 0.98; }
        }
    </style>
</head>
<body class="font-mono overflow-hidden h-screen w-screen text-sm">
    <div id="root"></div>

    <script type="text/babel">
        /*******************************************************
         * 1. CONFIGURATION & INITIALISATION FIREBASE
         *******************************************************/
        const firebaseConfig = {
            apiKey: "AIzaSyASPGZJO1JU5GeoBtmj5UTP8ErPSQIPeFA",
            authDomain: "logiops-data.firebaseapp.com",
            projectId: "logiops-data",
            storageBucket: "logiops-data.firebasestorage.app",
            messagingSenderId: "791163499354",
            appId: "1:791163499354:web:2bb76506331db9d240b963",
            measurementId: "G-FFMXKH47M9"
        };

        let db = null;
        let USE_FIREBASE = false;
        let IS_CUSTOM_DB = false;

        try {
            if (!firebase.apps.length) {
                const app = firebase.initializeApp(firebaseConfig);
                if (typeof firebase.analytics === 'function') firebase.analytics();
            }
            db = firebase.firestore();
            USE_FIREBASE = true;
            IS_CUSTOM_DB = true;
            console.log("ðŸ”¥ Firebase connectÃ© Ã  :", firebaseConfig.projectId);
        } catch (e) {
            console.warn("âš ï¸ Erreur Initialisation Firebase (Mode Local):", e);
            USE_FIREBASE = false;
        }

        /*******************************************************
         * 2. SERVICE DE STOCKAGE (HYBRIDE)
         *******************************************************/
        const LOCAL_STORAGE_KEY = "logiops_v19_1";
        
        const DEFAULT_DATA = {
            units: [],
            logs: [],
            squad: [],
            sitreps: [],
            destroyedHistory: [],
            missions: [],
            supplySources: [{ id: "main", name: "BASE PRINCIPALE", amount: 5000 }]
        };

        const StorageService = {
            // Sauvegarde (Cloud ou Local)
            save: async (newData) => {
                const timestamp = new Date().toISOString();
                if (USE_FIREBASE && db) {
                    try {
                        await db.collection('logiops').doc('operation_actuelle').set(newData, { merge: true });
                    } catch (err) {
                        console.error("Save Error Firebase:", err);
                    }
                } else {
                    // LocalStorage Fallback
                    const current = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || JSON.stringify(DEFAULT_DATA));
                    const merged = { ...current, ...newData };
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(merged));
                }
            },

            // Chargement initial + Subscription
            loadInitial: (onUpdate) => {
                if (USE_FIREBASE && db) {
                    // Mode Temps RÃ©el
                    return db.collection('logiops').doc('operation_actuelle')
                        .onSnapshot((doc) => {
                            if (doc.exists) {
                                const data = doc.data();
                                // Merge soft pour Ã©viter d'Ã©craser des champs manquants
                                onUpdate({ ...DEFAULT_DATA, ...data });
                            } else {
                                // Init doc s'il n'existe pas
                                db.collection('logiops').doc('operation_actuelle').set(DEFAULT_DATA);
                                onUpdate(DEFAULT_DATA);
                            }
                        }, (error) => {
                            console.error("Snapshot Error:", error);
                            // Fallback si la co coupe en cours de route ?
                        });
                } else {
                    // Mode Local
                    const localData = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (localData) {
                        onUpdate(JSON.parse(localData));
                    } else {
                        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(DEFAULT_DATA));
                        onUpdate(DEFAULT_DATA);
                    }
                    // Simulation d'un "listener" local rudimentaire via setInterval ou events si besoin
                    // Ici on renvoie une fonction de cleanup vide
                    return () => {}; 
                }
            }
        };

        /*******************************************************
         * 3. ICONS (SVG)
         *******************************************************/
        const Icons = {
            Tank: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>,
            Truck: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0" /></svg>,
            Wrench: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
            Alert: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>,
            Check: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
            Refresh: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
            Trash: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
        };

        /*******************************************************
         * 4. HOOKS & UTILS
         *******************************************************/
        
        function useData() {
            const [data, setData] = React.useState(null);
            const [isConnected, setIsConnected] = React.useState(false);

            React.useEffect(() => {
                const unsubscribe = StorageService.loadInitial((newData) => {
                    setData(newData);
                    setIsConnected(USE_FIREBASE);
                });
                return () => unsubscribe();
            }, []);

            const save = (updatePayload) => {
                // updatePayload doit contenir l'objet complet ou partiel pour Firestore merge
                StorageService.save(updatePayload);
            };

            const addLog = (message, author) => {
                if (!data) return;
                const newLog = {
                    id: Date.now(),
                    timestamp: new Date().toLocaleTimeString(),
                    message,
                    author
                };
                const updatedLogs = [newLog, ...data.logs].slice(0, 50); // Garder les 50 derniers
                save({ logs: updatedLogs });
            };

            return { data, save, addLog, isConnected };
        }

        const VEHICLE_CATALOG = [
            { id: 'logi_truck', name: 'Logi Truck (R-37)', cost: 0, type: 'logi', maxHp: 100, maxFuel: 1000 },
            { id: 'transport', name: 'Transport Troop', cost: 0, type: 'transport', maxHp: 80, maxFuel: 600 },
            { id: 'jeep_mg', name: 'Light Jeep MG', cost: 0, type: 'light', maxHp: 50, maxFuel: 400 },
            { id: 'apc_wheel', name: 'BTR-80 (Wheeled)', cost: 0, type: 'armor', maxHp: 300, maxFuel: 800 },
            { id: 'mbt', name: 'T-72 (MBT)', cost: 0, type: 'armor', maxHp: 1200, maxFuel: 1200 },
        ];

        /*******************************************************
         * 5. COMPOSANTS UI
         *******************************************************/

        // --- AUTHENTIFICATION ---
        const AuthScreen = ({ onLogin }) => {
            const [pseudo, setPseudo] = React.useState('');
            const [role, setRole] = React.useState('SL');
            const [grade, setGrade] = React.useState('Sgt');

            const handleSubmit = (e) => {
                e.preventDefault();
                if(pseudo.trim()) onLogin({ pseudo, role, grade });
            };

            return (
                <div className="flex items-center justify-center h-screen bg-mil-900 bg-[size:20px_20px] bg-grid-pattern relative">
                    <div className="scanline"></div>
                    <div className="border border-mil-green/50 bg-mil-800 p-8 w-96 shadow-[0_0_15px_rgba(0,255,65,0.2)]">
                        <h1 className="text-2xl font-bold text-mil-green mb-6 text-center tracking-widest">LOGIOPS ACCESS</h1>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs text-mil-green mb-1">IDENTIFIANT</label>
                                <input 
                                    type="text" 
                                    value={pseudo} 
                                    onChange={e => setPseudo(e.target.value.toUpperCase())}
                                    className="w-full bg-mil-900 border border-mil-700 text-mil-green p-2 focus:outline-none focus:border-mil-green"
                                    placeholder="CALLSIGN..."
                                />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs text-mil-green mb-1">ROLE</label>
                                    <select value={role} onChange={e => setRole(e.target.value)} className="w-full bg-mil-900 border border-mil-700 text-mil-green p-2">
                                        <option value="SL">SQUAD LEAD</option>
                                        <option value="LOGI">LOGISTIQUE</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs text-mil-green mb-1">GRADE</label>
                                    <select value={grade} onChange={e => setGrade(e.target.value)} className="w-full bg-mil-900 border border-mil-700 text-mil-green p-2">
                                        <option value="Cpl">Cpl</option>
                                        <option value="Sgt">Sgt</option>
                                        <option value="Lt">Lt</option>
                                        <option value="Cpt">Cpt</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" className="w-full bg-mil-dim hover:bg-mil-green text-black font-bold py-2 px-4 transition-colors">
                                CONNEXION SYSTÃˆME
                            </button>
                        </form>
                        <div className="mt-4 text-xs text-center text-mil-green/50">
                            {USE_FIREBASE ? "CLOUD UPLINK: ACTIF" : "CLOUD UPLINK: ERREUR (MODE LOCAL)"}
                        </div>
                    </div>
                </div>
            );
        };

        // --- DASHBOARD VEHICULE ---
        const UnitCard = ({ unit, user, onUpdate, onDelete }) => {
            const getStatusColor = (s) => {
                switch(s) {
                    case 'operational': return 'text-mil-green border-mil-green';
                    case 'mission': return 'text-blue-400 border-blue-400';
                    case 'rtb_requested': return 'text-yellow-400 border-yellow-400 animate-pulse';
                    case 'maintenance': return 'text-orange-500 border-orange-500';
                    case 'destroyed': return 'text-red-600 border-red-600';
                    default: return 'text-gray-500 border-gray-500';
                }
            };

            const handleAction = (action) => {
                let updates = {};
                if (action === 'start_mission') updates = { status: 'mission' };
                if (action === 'request_rtb') updates = { status: 'rtb_requested' };
                if (action === 'validate_rtb') {
                    // Logic check
                    if (unit.hp < unit.maxHp * 0.9) updates = { status: 'maintenance' };
                    else updates = { status: 'operational' };
                }
                if (action === 'finish_maintenance') updates = { status: 'operational', hp: unit.maxHp, fuel: unit.maxFuel };
                if (action === 'report_destroyed') updates = { status: 'destroyed' };
                
                onUpdate(unit.id, updates);
            };

            const handleDamage = (amount) => {
                const newHp = Math.max(0, unit.hp - amount);
                onUpdate(unit.id, { hp: newHp });
            }

            return (
                <div className={`border p-2 mb-2 bg-mil-900/80 flex flex-col gap-2 ${getStatusColor(unit.status)}`}>
                    <div className="flex justify-between items-center">
                        <div className="flex items-center gap-2 font-bold">
                            {unit.type === 'armor' ? <Icons.Tank /> : <Icons.Truck />}
                            {unit.name} <span className="text-xs opacity-70">#{unit.id.slice(-4)}</span>
                        </div>
                        <span className="text-xs uppercase px-1 border border-current">{unit.status.replace('_', ' ')}</span>
                    </div>

                    {/* Barres de vie / fuel */}
                    <div className="space-y-1 text-xs">
                        <div className="flex justify-between">
                            <span>INTÃ‰GRITÃ‰</span>
                            <span>{Math.round((unit.hp/unit.maxHp)*100)}%</span>
                        </div>
                        <div className="w-full bg-gray-800 h-1">
                            <div className="bg-current h-1" style={{ width: `${(unit.hp/unit.maxHp)*100}%` }}></div>
                        </div>
                        
                        <div className="flex justify-between text-blue-300">
                            <span>CARBURANT</span>
                            <span>{Math.round((unit.fuel/unit.maxFuel)*100)}%</span>
                        </div>
                        <div className="w-full bg-gray-800 h-1">
                            <div className="bg-blue-500 h-1" style={{ width: `${(unit.fuel/unit.maxFuel)*100}%` }}></div>
                        </div>
                    </div>

                    {/* Actions contextuelles */}
                    <div className="grid grid-cols-2 gap-1 mt-1">
                        {user.role === 'SL' && unit.status === 'operational' && (
                            <button onClick={() => handleAction('start_mission')} className="bg-blue-900/50 hover:bg-blue-900 text-xs p-1">DEPART MISSION</button>
                        )}
                        {user.role === 'SL' && unit.status === 'mission' && (
                            <button onClick={() => handleAction('request_rtb')} className="bg-yellow-900/50 hover:bg-yellow-900 text-xs p-1">DEMANDE RTB</button>
                        )}
                        {user.role === 'SL' && unit.status !== 'destroyed' && (
                            <button onClick={() => handleAction('report_destroyed')} className="bg-red-900/50 hover:bg-red-900 text-xs p-1 col-span-2">SIGNALER DÃ‰TRUIT</button>
                        )}

                        {user.role === 'LOGI' && unit.status === 'rtb_requested' && (
                            <button onClick={() => handleAction('validate_rtb')} className="bg-mil-dim hover:bg-mil-green text-black text-xs p-1 col-span-2">VALIDER RETOUR</button>
                        )}
                        {user.role === 'LOGI' && unit.status === 'maintenance' && (
                            <button onClick={() => handleAction('finish_maintenance')} className="bg-mil-dim hover:bg-mil-green text-black text-xs p-1 col-span-2">FIN MAINTENANCE</button>
                        )}
                         {user.role === 'LOGI' && unit.status !== 'destroyed' && (
                             <>
                                <button onClick={() => handleDamage(10)} className="border border-red-500 text-red-500 text-xs p-1">-10 HP</button>
                                <button onClick={() => onDelete(unit.id)} className="border border-red-900 text-red-900 text-xs p-1">SUPPRIMER</button>
                             </>
                        )}
                    </div>
                </div>
            );
        };

        // --- GARAGE (Modal) ---
        const GaragePanel = ({ isOpen, onClose, onBuy }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
                    <div className="border border-mil-green bg-mil-900 w-full max-w-2xl p-4 max-h-[80vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4 border-b border-mil-green/30 pb-2">
                            <h2 className="text-xl font-bold text-mil-green">RÃ‰QUISITION VÃ‰HICULE</h2>
                            <button onClick={onClose} className="text-red-500 font-bold">X</button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {VEHICLE_CATALOG.map(v => (
                                <div key={v.id} className="border border-mil-green/50 p-3 hover:bg-mil-green/10 cursor-pointer" 
                                     onClick={() => { onBuy(v); onClose(); }}>
                                    <div className="font-bold text-mil-green">{v.name}</div>
                                    <div className="text-xs text-gray-400">HP: {v.maxHp} | Fuel: {v.maxFuel}</div>
                                    <div className="text-xs text-mil-green mt-2 text-right">REQUISITIONNER &gt;</div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- SITREP MODAL ---
        const SitrepModal = ({ isOpen, onClose, onSend }) => {
            const [text, setText] = React.useState('');
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-red-900/20 backdrop-blur-sm z-50 flex items-center justify-center">
                    <div className="border-2 border-red-600 bg-black p-6 w-full max-w-lg shadow-[0_0_50px_rgba(255,0,0,0.3)]">
                        <h2 className="text-red-500 font-bold text-2xl mb-4 animate-pulse">ALERTE SITREP</h2>
                        <textarea 
                            className="w-full bg-mil-900 border border-red-500/50 p-2 text-red-100 h-32 focus:outline-none"
                            placeholder="NATURE DE L'ALERTE / CONTACT / POSITION..."
                            value={text} onChange={e => setText(e.target.value)}
                        />
                        <div className="flex gap-2 mt-4">
                            <button onClick={() => { onSend(text); onClose(); setText(''); }} className="flex-1 bg-red-600 text-black font-bold py-2">DIFFUSER L'ALERTE</button>
                            <button onClick={onClose} className="border border-red-600 text-red-600 px-4">ANNULER</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [user, setUser] = React.useState(null);
            const { data, save, addLog, isConnected } = useData();
            
            // UI States
            const [showGarage, setShowGarage] = React.useState(false);
            const [showSitrep, setShowSitrep] = React.useState(false);
            const [activeFilter, setActiveFilter] = React.useState('all');

            if (!user) return <AuthScreen onLogin={setUser} />;
            if (!data) return <div className="h-screen flex items-center justify-center text-mil-green animate-pulse">INITIALISATION DATALINK...</div>;

            // Logique MÃ©tier
            const handleBuyVehicle = (template) => {
                const newUnit = {
                    ...template,
                    id: `${template.id}_${Date.now().toString().slice(-4)}`,
                    status: 'operational',
                    hp: template.maxHp,
                    fuel: template.maxFuel
                };
                save({ units: [...data.units, newUnit] });
                addLog(`RÃ©quisition vÃ©hicule : ${newUnit.name}`, user.pseudo);
            };

            const handleUpdateUnit = (id, updates) => {
                const newUnits = data.units.map(u => {
                    if (u.id === id) {
                        const updated = { ...u, ...updates };
                        // Si dÃ©truit, dÃ©placer vers historique
                        if (updated.status === 'destroyed') {
                            // On le supprime de units dans le useEffect ou ici ? 
                            // Pour simplifier, on le garde en status 'destroyed' jusqu'Ã  nettoyage, ou on bouge direct.
                            // Bougeons le direct pour l'archive.
                            return null;
                        }
                        return updated;
                    }
                    return u;
                }).filter(Boolean);

                // Gestion destruction
                const destroyedUnit = data.units.find(u => u.id === id);
                let newHistory = data.destroyedHistory || [];
                if (updates.status === 'destroyed' && destroyedUnit) {
                    newHistory = [...newHistory, { ...destroyedUnit, destroyedAt: new Date().toISOString(), destroyedBy: user.pseudo }];
                    addLog(`PERTE CONFIRMÃ‰E: ${destroyedUnit.name}`, user.pseudo);
                }

                save({ units: newUnits, destroyedHistory: newHistory });
                
                // Logs auto pour changement de status
                if(updates.status && updates.status !== 'destroyed') {
                    const unitName = data.units.find(u => u.id === id)?.name || id;
                    addLog(`Unit ${unitName} status: ${updates.status}`, "SYS");
                }
            };

            const handleDeleteUnit = (id) => {
                 const newUnits = data.units.filter(u => u.id !== id);
                 save({ units: newUnits });
                 addLog(`VÃ©hicule supprimÃ© manuellement`, user.pseudo);
            }

            const handleSitrep = (msg) => {
                const newSitrep = { id: Date.now(), msg, time: new Date().toLocaleTimeString(), author: user.pseudo };
                save({ sitreps: [newSitrep, ...data.sitreps] });
                addLog(`SITREP: ${msg}`, user.pseudo);
            };

            const handleSupplyUpdate = (id, amount) => {
                const newSources = data.supplySources.map(s => s.id === id ? { ...s, amount: parseInt(amount) } : s);
                save({ supplySources: newSources });
            };

            const filteredUnits = data.units.filter(u => activeFilter === 'all' || u.type === activeFilter);

            // Stats
            const stats = {
                ops: data.units.filter(u => u.status === 'operational').length,
                mission: data.units.filter(u => u.status === 'mission').length,
                maint: data.units.filter(u => u.status === 'maintenance' || u.status === 'rtb_requested').length,
                loss: (data.destroyedHistory || []).length
            };

            return (
                <div className="flex h-screen bg-mil-900 bg-[size:30px_30px] bg-grid-pattern overflow-hidden relative">
                    {/* Scanline Effect */}
                    <div className="scanline"></div>

                    {/* --- LEFT SIDEBAR (NAV & STATS) --- */}
                    <aside className="w-64 border-r border-mil-green/30 bg-mil-800/50 flex flex-col p-4 z-20 backdrop-blur-sm">
                        <div className="mb-6 border-b border-mil-green pb-2">
                            <h1 className="text-xl font-bold text-mil-green tracking-widest">LOGIOPS V1</h1>
                            <div className="text-xs text-mil-green/60 mt-1">
                                {user.grade} {user.pseudo} [{user.role}]
                                <div className={`w-2 h-2 rounded-full inline-block ml-2 ${isConnected ? 'bg-mil-green' : 'bg-red-500'}`}></div>
                            </div>
                        </div>

                        <div className="space-y-4 flex-1">
                            <div className="border border-mil-green/30 p-2">
                                <h3 className="text-xs text-mil-green mb-2 border-b border-mil-green/20">Ã‰TAT FLOTTE</h3>
                                <div className="grid grid-cols-2 gap-2 text-center text-xs">
                                    <div className="bg-mil-green/10 p-1 rounded">
                                        <div className="text-mil-green font-bold text-lg">{stats.ops}</div>
                                        <div className="text-gray-400">PRÃŠT</div>
                                    </div>
                                    <div className="bg-blue-900/30 p-1 rounded">
                                        <div className="text-blue-400 font-bold text-lg">{stats.mission}</div>
                                        <div className="text-gray-400">MSN</div>
                                    </div>
                                    <div className="bg-orange-900/30 p-1 rounded">
                                        <div className="text-orange-400 font-bold text-lg">{stats.maint}</div>
                                        <div className="text-gray-400">MAINT</div>
                                    </div>
                                    <div className="bg-red-900/30 p-1 rounded">
                                        <div className="text-red-500 font-bold text-lg">{stats.loss}</div>
                                        <div className="text-gray-400">PERTE</div>
                                    </div>
                                </div>
                            </div>

                            <nav className="space-y-1">
                                <button onClick={() => setActiveFilter('all')} className={`w-full text-left px-2 py-1 text-sm ${activeFilter === 'all' ? 'bg-mil-green text-black' : 'text-mil-green hover:bg-mil-green/20'}`}>TOUS LES VÃ‰HICULES</button>
                                <button onClick={() => setActiveFilter('logi')} className={`w-full text-left px-2 py-1 text-sm ${activeFilter === 'logi' ? 'bg-mil-green text-black' : 'text-mil-green hover:bg-mil-green/20'}`}>LOGISTIQUES</button>
                                <button onClick={() => setActiveFilter('armor')} className={`w-full text-left px-2 py-1 text-sm ${activeFilter === 'armor' ? 'bg-mil-green text-black' : 'text-mil-green hover:bg-mil-green/20'}`}>BLINDÃ‰S</button>
                            </nav>

                            <div className="mt-auto border-t border-mil-green/30 pt-4 space-y-2">
                                {user.role === 'SL' && (
                                    <>
                                        <button onClick={() => setShowGarage(true)} className="w-full border border-mil-green text-mil-green py-2 hover:bg-mil-green hover:text-black font-bold transition-all">
                                            + RÃ‰QUISITION
                                        </button>
                                        <button onClick={() => setShowSitrep(true)} className="w-full border border-red-500 text-red-500 py-2 hover:bg-red-500 hover:text-black font-bold animate-pulse">
                                            ! SITREP !
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                    </aside>

                    {/* --- CENTER (DASHBOARD) --- */}
                    <main className="flex-1 p-4 overflow-y-auto z-10 relative">
                        {/* ALERTS BANNER */}
                        {data.sitreps.length > 0 && (
                            <div className="mb-4 space-y-2">
                                {data.sitreps.slice(0, 2).map(s => (
                                    <div key={s.id} className="bg-red-900/40 border-l-4 border-red-600 p-2 flex justify-between items-start animate-pulse">
                                        <div>
                                            <span className="font-bold text-red-400">SITREP [{s.time}] {s.author}:</span>
                                            <span className="ml-2 text-red-200">{s.msg}</span>
                                        </div>
                                        <button onClick={() => save({ sitreps: data.sitreps.filter(x => x.id !== s.id) })} className="text-red-500 hover:text-white">x</button>
                                    </div>
                                ))}
                            </div>
                        )}

                        <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                            {filteredUnits.length === 0 ? (
                                <div className="col-span-3 text-center text-gray-600 py-10 border border-gray-800 border-dashed">AUCUNE UNITÃ‰ DANS CE SECTEUR</div>
                            ) : (
                                filteredUnits.map(unit => (
                                    <UnitCard 
                                        key={unit.id} 
                                        unit={unit} 
                                        user={user} 
                                        onUpdate={handleUpdateUnit}
                                        onDelete={handleDeleteUnit}
                                    />
                                ))
                            )}
                        </div>
                    </main>

                    {/* --- RIGHT SIDEBAR (LOGS & SUPPLY) --- */}
                    <aside className="w-72 bg-mil-800/80 border-l border-mil-green/30 flex flex-col z-20 backdrop-blur-sm">
                        
                        {/* SUPPLY PANEL */}
                        <div className="h-1/3 border-b border-mil-green/30 p-2 overflow-y-auto">
                            <h3 className="text-xs text-mil-green font-bold mb-2 sticky top-0 bg-mil-800">LOGISTIQUE / RESSOURCES</h3>
                            {data.supplySources.map(source => (
                                <div key={source.id} className="mb-2 bg-black/40 p-2 border border-mil-green/20">
                                    <div className="flex justify-between text-xs mb-1">
                                        <span className="text-gray-300">{source.name}</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <div className="text-mil-green font-bold text-lg">{source.amount}</div>
                                        {user.role === 'LOGI' && (
                                            <div className="flex gap-1 ml-auto">
                                                <button onClick={() => handleSupplyUpdate(source.id, source.amount + 500)} className="bg-mil-green/20 text-mil-green px-1 text-xs">+</button>
                                                <button onClick={() => handleSupplyUpdate(source.id, Math.max(0, source.amount - 500))} className="bg-red-900/20 text-red-400 px-1 text-xs">-</button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* JMO / LOGS */}
                        <div className="flex-1 p-2 overflow-hidden flex flex-col">
                            <div className="flex justify-between items-center mb-2">
                                <h3 className="text-xs text-mil-green font-bold">JMO (LOGS)</h3>
                                {user.role === 'SL' && (
                                    <button onClick={() => save({ logs: [] })} className="text-[10px] text-red-500 border border-red-900 px-1 hover:bg-red-900">CLEAR</button>
                                )}
                            </div>
                            <div className="flex-1 overflow-y-auto font-mono text-xs space-y-1 pr-1 bg-black/20 p-1">
                                {data.logs.map(log => (
                                    <div key={log.id} className="border-b border-gray-800 pb-1">
                                        <span className="text-gray-500">[{log.timestamp}]</span>
                                        <span className="text-mil-dim font-bold ml-1">{log.author}:</span>
                                        <span className="text-gray-300 ml-1">{log.message}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* CHAT INPUT (SIMPLE LOG) */}
                        <div className="p-2 border-t border-mil-green/30">
                            <input 
                                type="text" 
                                placeholder="Ajouter entrÃ©e JMO..."
                                className="w-full bg-black border border-mil-green/30 text-mil-green text-xs p-2 focus:outline-none focus:border-mil-green"
                                onKeyDown={(e) => {
                                    if(e.key === 'Enter' && e.target.value.trim()) {
                                        addLog(e.target.value, user.pseudo);
                                        e.target.value = '';
                                    }
                                }}
                            />
                        </div>
                    </aside>

                    {/* MODALS */}
                    <GaragePanel isOpen={showGarage} onClose={() => setShowGarage(false)} onBuy={handleBuyVehicle} />
                    <SitrepModal isOpen={showSitrep} onClose={() => setShowSitrep(false)} onSend={handleSitrep} />

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
