<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>LOGIOPS V2 // MILITARY LOGISTICS</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Google Fonts: Share Tech Mono for that HUD look -->
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, collection, doc, setDoc, getDoc, updateDoc,
      onSnapshot, deleteDoc, serverTimestamp, query, orderBy, addDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CONFIGURATION ---
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
      apiKey: "AIzaSyASPGZJO1JU5GeoBtmj5UTP8ErPSQIPeFA",
      authDomain: "logiops-data.firebaseapp.com",
      projectId: "logiops-data",
      storageBucket: "logiops-data.firebasestorage.app",
      messagingSenderId: "791163499354",
      appId: "1:791163499354:web:2bb76506331db9d240b963",
      measurementId: "G-FFMXKH47M9"
    };

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'logiops-v2-production';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global State
    let currentUser = null;
    let userRole = null; // 'SL' or 'LOG'
    let userPseudo = null;
    let userGrade = null;
    let currentUserId = null;

    // --- UTILS ---
    const formatTime = (date) => {
      if (!date) return "--:--:--";
      const d = date.toDate ? date.toDate() : new Date(date);
      return d.toLocaleTimeString('fr-FR', { hour12: false, hour: '2-digit', minute: '2-digit' });
    };

    const getMillis = (d) => {
      if (!d) return 0;
      return d.toMillis ? d.toMillis() : new Date(d).getTime();
    };

    const safeSetText = (id, text) => {
      const el = document.getElementById(id);
      if (el) el.innerText = text;
    };

    // --- PATH HELPERS ---
    const publicPath = (col) => collection(db, 'artifacts', appId, 'public', 'data', col);
    const publicDoc = (col, id) => doc(db, 'artifacts', appId, 'public', 'data', col, id);

    // --- AUTHENTICATION & INIT ---
    async function initAuth() {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth Error:", error);
        alert("Erreur de connexion au système. Veuillez rafraîchir.");
      }
    }

    initAuth();

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        currentUserId = user.uid;
        console.log("System Connected. UID:", currentUserId);
        checkAppState();
      } else {
        console.log("Waiting for auth...");
      }
    });

    // --- APP LOGIC ---

    function checkAppState() {
      // Listen to Global Settings
      onSnapshot(publicDoc('settings', 'global'), (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          safeSetText('supply-count', data.supply || 0);

          const headerSlEl = document.getElementById('header-sl-name');
          if (headerSlEl && data.slName) {
            headerSlEl.innerText = `CMD: ${data.slName}`;
          }
        } else {
          // Create if not exists (fail-safe)
          setDoc(publicDoc('settings', 'global'), { supply: 1000, slSessionId: null, slName: 'AUCUN' }).catch(console.error);
        }
      }, (error) => {
        console.error("Settings listener error:", error);
      });

      if (userRole) {
        loadInterface();
      } else {
        const authScreen = document.getElementById('auth-screen');
        if (authScreen) authScreen.classList.remove('hidden');
      }
    }

    async function addLog(message, type = 'INFO') {
      if (!currentUserId) return;
      try {
        await addDoc(publicPath('logs'), {
          message: message,
          type: type,
          timestamp: serverTimestamp()
        });
        await addDoc(publicPath('notifications'), {
          message: message,
          type: type,
          timestamp: serverTimestamp(),
          read: false
        });
      } catch (e) {
        console.error("Log error:", e);
      }
    }

    // --- ACTIONS ---
    window.loginSL = async () => {
      if (!currentUserId) return alert("Connexion au réseau en cours... Veuillez patienter.");

      const pseudo = document.getElementById('sl-pseudo').value.toUpperCase();
      const grade = document.getElementById('sl-grade').value;

      if (!pseudo) return alert("Pseudo requis");

      try {
        const globalSnap = await getDoc(publicDoc('settings', 'global'));
        const globalData = globalSnap.data();

        if (globalData && globalData.slSessionId && globalData.slSessionId !== currentUserId) {
          if (!confirm(`⚠️ ALERTE SÉCURITÉ ⚠️\n\nLe Squad Leader ${globalData.slName} est déjà en poste.\n\nÊtes-vous certain de vouloir prendre le commandement et écraser sa session ?`)) {
            return;
          }
        }

        // Use setDoc with merge to be safe if doc doesn't exist yet
        await setDoc(publicDoc('settings', 'global'), {
          slSessionId: currentUserId,
          slName: `${grade} ${pseudo}`,
          lastLogin: serverTimestamp()
        }, { merge: true });

        await setDoc(publicDoc('users', currentUserId), {
          pseudo: pseudo,
          grade: grade,
          role: 'SL',
          isOnline: true,
          lastActive: serverTimestamp()
        });

        userRole = 'SL';
        userPseudo = pseudo;
        userGrade = grade;

        addLog(`PRISE DE SERVICE SL: ${grade} ${pseudo}`, 'CMD');
        document.getElementById('auth-screen').classList.add('hidden');
        loadInterface();

      } catch (error) {
        console.error("Login SL Error:", error);
        alert("Erreur lors de la prise de service. Vérifiez la console.");
      }
    };

    window.showLogLogin = async () => {
      document.getElementById('login-sl-form').classList.add('hidden');
      document.getElementById('login-log-form').classList.remove('hidden');

      const rosterDiv = document.getElementById('roster-list-login');
      rosterDiv.innerHTML = '<div class="text-center animate-pulse py-4">CHARGEMENT DU ROSTER...</div>';

      onSnapshot(publicPath('roster'), (snapshot) => {
        rosterDiv.innerHTML = '';
        if (snapshot.empty) {
          rosterDiv.innerHTML = '<div class="text-red-500 text-center py-4">Aucun logisticien enregistré.</div>';
          return;
        }
        snapshot.forEach(doc => {
          const data = doc.data();
          const btn = document.createElement('button');
          btn.className = "w-full text-left border border-green-900 bg-gray-900/50 active:bg-green-900/30 p-4 mb-2 rounded flex justify-between items-center group transition-all touch-manipulation";
          btn.innerHTML = `
                        <span class="font-bold text-green-400 text-lg">${data.grade} ${data.pseudo}</span>
                        <i class="fas fa-sign-in-alt text-green-600"></i>
                    `;
          btn.onclick = () => loginLOG(doc.id, data.pseudo, data.grade);
          rosterDiv.appendChild(btn);
        });
      }, (error) => {
        rosterDiv.innerHTML = '<div class="text-red-500 text-center">Erreur chargement roster.</div>';
      });
    };

    window.loginLOG = async (rosterId, pseudo, grade) => {
      if (!currentUserId) return alert("Connexion au réseau en cours...");

      try {
        await setDoc(publicDoc('users', currentUserId), {
          pseudo: pseudo,
          grade: grade,
          role: 'LOG',
          rosterId: rosterId,
          isOnline: true,
          currentVehicle: null,
          lastActive: serverTimestamp()
        });

        userRole = 'LOG';
        userPseudo = pseudo;
        userGrade = grade;

        addLog(`CONNEXION LOGISTICIEN: ${grade} ${pseudo}`, 'CONNECT');
        document.getElementById('auth-screen').classList.add('hidden');
        loadInterface();
      } catch (error) {
        console.error("Login LOG Error:", error);
        alert("Erreur de connexion.");
      }
    };

    function loadInterface() {
      const ui = document.getElementById('main-interface');
      if (ui) ui.classList.remove('hidden');

      safeSetText('user-identity', `${userGrade} ${userPseudo}`);
      safeSetText('user-badge', userRole);

      setupNotifications();
      setupVehiclesListener();
      setupMissionsListener();

      const slControls = document.getElementById('sl-controls');
      const logControls = document.getElementById('log-controls');

      if (userRole === 'SL') {
        setupSLInterface();
        if (slControls) slControls.classList.remove('hidden');
        if (logControls) logControls.classList.add('hidden');
      } else {
        // setupLOGInterface(); // Not needed if empty
        if (slControls) slControls.classList.add('hidden');
        if (logControls) logControls.classList.remove('hidden');
      }
    }

    // --- NOTIFICATIONS & LOGS ---
    function setupNotifications() {
      const feed = document.getElementById('notif-feed');
      const q = publicPath('notifications');

      onSnapshot(q, (snapshot) => {
        if (!feed) return;
        feed.innerHTML = '';
        let docs = snapshot.docs.map(doc => doc.data());
        docs.sort((a, b) => getMillis(b.timestamp) - getMillis(a.timestamp));

        docs.slice(0, 20).forEach(data => {
          const div = document.createElement('div');
          div.className = "text-xs border-b border-green-900/50 p-2 text-green-300 font-mono break-words";
          div.innerHTML = `<span class="text-green-600">[${formatTime(data.timestamp)}]</span> ${data.message}`;
          feed.appendChild(div);
        });
      });

      // Always load logs table content, even if not SL, just in case.
      // But we can filter visibility via CSS if needed.
      const logBody = document.getElementById('vacation-log-body');
      const qLogs = publicPath('logs');

      if (logBody) {
        onSnapshot(qLogs, (snapshot) => {
          logBody.innerHTML = '';
          let docs = snapshot.docs.map(doc => doc.data());
          docs.sort((a, b) => getMillis(b.timestamp) - getMillis(a.timestamp));

          docs.slice(0, 50).forEach(data => {
            const row = document.createElement('tr');
            row.className = "border-b border-green-900/30 hover:bg-green-900/10";
            row.innerHTML = `
                            <td class="p-2 text-green-600 whitespace-nowrap">${formatTime(data.timestamp)}</td>
                            <td class="p-2 font-bold text-green-500 whitespace-nowrap">${data.type}</td>
                            <td class="p-2 text-green-300 break-all">${data.message}</td>
                        `;
            logBody.appendChild(row);
          });
        });
      }
    }

    // --- VEHICLE MANAGEMENT ---
    function setupVehiclesListener() {
      const container = document.getElementById('vehicle-grid');
      onSnapshot(publicPath('vehicles'), (snapshot) => {
        if (!container) return;
        container.innerHTML = '';
        let stats = { total: 0, ops: 0, mission: 0, repair: 0, destroyed: 0 };

        snapshot.forEach(doc => {
          const data = doc.data();
          const id = doc.id;

          stats.total++;
          if (data.status === 'OPS') stats.ops++;
          if (data.status === 'MISSION') stats.mission++;
          if (data.status === 'REPAIR') stats.repair++;
          if (data.status === 'DESTROYED') stats.destroyed++;

          container.appendChild(createVehicleCard(id, data));
        });
        updateDashboardStats(stats);
      });
    }

    function updateDashboardStats(stats) {
      safeSetText('stat-total-veh', stats.total);
      safeSetText('stat-ops', stats.ops);
      safeSetText('stat-mission', stats.mission);
      safeSetText('stat-repair', stats.repair);
      safeSetText('stat-destroyed', stats.destroyed);
    }

    function createVehicleCard(id, data) {
      const statusColors = {
        'OPS': 'border-green-500 shadow-[0_0_10px_rgba(34,197,94,0.2)]',
        'MISSION': 'border-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.2)]',
        'REPAIR': 'border-orange-500 opacity-80',
        'DESTROYED': 'border-red-600 opacity-50 grayscale'
      };

      const div = document.createElement('div');
      div.className = `relative bg-gray-900/90 border-2 ${statusColors[data.status] || 'border-gray-500'} p-3 rounded clip-corner flex flex-col gap-2 transition-all active:scale-[0.99] touch-manipulation`;

      div.innerHTML = `
                <div class="flex justify-between items-start border-b border-gray-700 pb-2 mb-1">
                    <div>
                        <div class="text-[10px] text-gray-400 font-mono">${data.category}</div>
                        <div class="text-lg font-bold font-mono tracking-widest text-white truncate max-w-[150px]">${data.name}</div>
                    </div>
                    <div class="font-bold text-xs px-2 py-1 bg-black/50 rounded ${data.status === 'DESTROYED' ? 'text-red-500' : 'text-white'}">${data.status}</div>
                </div>
            `;

      const seatsContainer = document.createElement('div');
      seatsContainer.className = "grid grid-cols-3 gap-2 my-2";

      ['driver', 'copilot', 'gunner'].forEach(role => {
        const occupant = data.seats[role];
        const seatBtn = document.createElement('button');

        let icon = role === 'driver' ? 'fa-steering-wheel' : (role === 'copilot' ? 'fa-map' : 'fa-crosshairs');

        seatBtn.className = `p-2 text-xs border rounded flex flex-col items-center justify-center h-16 active:scale-95 transition-transform touch-manipulation
                    ${occupant ? 'bg-green-900/60 border-green-500 text-green-300' : 'bg-gray-800 border-gray-700 text-gray-500 hover:border-green-500'}`;

        seatBtn.innerHTML = `
                    <i class="fas ${icon} mb-1 text-base"></i>
                    <span class="truncate w-full text-center text-[9px] font-bold">${occupant ? occupant.name : 'LIBRE'}</span>
                `;

        if (data.status !== 'DESTROYED') {
          seatBtn.onclick = (e) => { e.stopPropagation(); handleSeatClick(id, data, role); };
        }

        seatsContainer.appendChild(seatBtn);
      });
      div.appendChild(seatsContainer);

      if (userRole === 'SL') {
        const actions = document.createElement('div');
        actions.className = "mt-auto pt-2 border-t border-gray-700 grid grid-cols-2 gap-2 text-xs";

        const btnClass = "p-3 border rounded font-bold active:bg-opacity-50 touch-manipulation";

        if (data.status !== 'DESTROYED') {
          actions.innerHTML = `
                        <button onclick="setVehicleStatus('${id}', 'REPAIR')" class="${btnClass} border-orange-500 text-orange-500 hover:bg-orange-500 hover:text-black">RÉPARER</button>
                        <button onclick="setVehicleStatus('${id}', 'DESTROYED')" class="${btnClass} border-red-500 text-red-500 hover:bg-red-500 hover:text-black">DÉTRUIRE</button>
                        <button onclick="setVehicleStatus('${id}', 'OPS')" class="${btnClass} border-green-500 text-green-500 hover:bg-green-500 hover:text-black col-span-2">RÉTABLIR OPS</button>
                    `;
        } else {
          actions.innerHTML = `
                         <button onclick="deleteVehicle('${id}')" class="${btnClass} border-red-900 text-red-900 hover:bg-red-900 hover:text-white col-span-2">SUPPRIMER L'ÉPAVE</button>
                    `;
        }
        div.appendChild(actions);
      }

      return div;
    }

    window.handleSeatClick = async (vehId, vehData, seatRole) => {
      if (!currentUserId) return;
      const currentSeat = vehData.seats[seatRole];
      if (currentSeat && currentSeat.uid === currentUserId) {
        const newSeats = { ...vehData.seats, [seatRole]: null };
        await updateDoc(publicDoc('vehicles', vehId), { seats: newSeats });
        addLog(`${userPseudo} est descendu de ${vehData.name} (${seatRole})`);
        return;
      }
      if (currentSeat) {
        alert(`Place occupée par ${currentSeat.name}`);
        return;
      }
      const newSeats = { ...vehData.seats, [seatRole]: { uid: currentUserId, name: userPseudo } };
      await updateDoc(publicDoc('vehicles', vehId), { seats: newSeats });
      addLog(`${userPseudo} est monté dans ${vehData.name} (${seatRole})`);
    };

    window.setVehicleStatus = async (id, status) => {
      if (!currentUserId) return;
      await updateDoc(publicDoc('vehicles', id), { status: status });
      addLog(`Véhicule passé en ${status}`, 'VEHICULE');
    };

    window.deleteVehicle = async (id) => {
      if (!currentUserId) return;
      if (confirm('Supprimer définitivement ce véhicule ?')) {
        await deleteDoc(publicDoc('vehicles', id));
      }
    };

    // --- SL LOGIC ---
    window.createVehicle = async () => {
      if (!currentUserId) return;
      const typeEl = document.getElementById('new-veh-type');
      const nameEl = document.getElementById('new-veh-name');
      if (!typeEl || !nameEl) return;

      const type = typeEl.value;
      const name = nameEl.value;
      const costs = { 'LOGI': 300, 'JEEP': 100, 'TRANSPORT': 200, 'BLINDE': 600 };
      const cost = costs[type];

      const globalSnap = await getDoc(publicDoc('settings', 'global'));
      const currentSupply = globalSnap.data()?.supply || 0;

      if (currentSupply < cost) {
        alert("Supply insuffisant !");
        return;
      }

      await setDoc(publicDoc('settings', 'global'), { supply: currentSupply - cost }, { merge: true });
      await addDoc(publicPath('vehicles'), {
        name: name || `${type}-${Math.floor(Math.random() * 100)}`,
        category: type,
        cost: cost,
        status: 'OPS',
        missionId: null,
        seats: { driver: null, copilot: null, gunner: null },
        createdAt: serverTimestamp()
      });

      addLog(`Véhicule sorti du garage: ${type} (-${cost} supply)`, 'LOGISTICS');
      toggleModal('garage-modal');
    };

    window.addToRoster = async () => {
      if (!currentUserId) return;
      const pseudo = prompt("Pseudo du logisticien:");
      if (!pseudo) return;
      const grade = prompt("Grade (ex: Sdt, Cpl):", "Sdt");

      await addDoc(publicPath('roster'), {
        pseudo: pseudo,
        grade: grade,
        addedAt: serverTimestamp()
      });
      addLog(`Ajout au roster: ${grade} ${pseudo}`, 'ADMIN');
    };

    function setupSLInterface() {
      const list = document.getElementById('sl-roster-list');
      if (!list) return;

      onSnapshot(publicPath('roster'), (snap) => {
        list.innerHTML = '';
        snap.forEach(doc => {
          const d = doc.data();
          const div = document.createElement('div');
          div.className = "flex justify-between items-center text-sm p-3 border-b border-green-900/30";
          div.innerHTML = `
                        <span class="text-green-300 font-bold">${d.grade} ${d.pseudo}</span> 
                        <button class="text-red-500 p-2" onclick="removeFromRoster('${doc.id}')"><i class="fas fa-trash"></i></button>
                    `;
          list.appendChild(div);
        });
        safeSetText('stat-log-count', snap.size);
      });
    }

    window.removeFromRoster = async (id) => {
      if (confirm('Retirer du roster ?')) await deleteDoc(publicDoc('roster', id));
    };

    window.addSupply = async (amount) => {
      if (!currentUserId) return;
      const globalSnap = await getDoc(publicDoc('settings', 'global'));
      const current = globalSnap.data()?.supply || 0;
      await setDoc(publicDoc('settings', 'global'), { supply: current + amount }, { merge: true });
      addLog(`Ravitaillement reçu: +${amount}`, 'SUPPLY');
    };

    window.clearLogs = async () => {
      if (confirm("Effacer tout le journal ?")) {
        addLog("JOURNAL EFFACÉ PAR LE SL", "ADMIN");
      }
    };

    window.createMission = async () => {
      if (!currentUserId) return;
      const name = prompt("Nom de l'opération / Mission :");
      if (!name) return;
      await addDoc(publicPath('missions'), {
        name: name,
        status: 'ACTIVE',
        leaderId: currentUserId,
        createdAt: serverTimestamp()
      });
      addLog(`Nouvelle mission créée: ${name}`, 'MISSION');
    };

    function setupMissionsListener() {
      const container = document.getElementById('mission-list');
      if (!container) return;
      const q = publicPath('missions');

      onSnapshot(q, (snap) => {
        container.innerHTML = '';
        let docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        docs.sort((a, b) => getMillis(b.createdAt) - getMillis(a.createdAt));

        docs.forEach(data => {
          if (data.status === 'ARCHIVED') return;
          const el = document.createElement('div');
          el.className = "border border-green-500/50 p-3 mb-2 bg-green-900/10 rounded";
          el.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-green-400 truncate pr-2">${data.name}</h3>
                            <span class="text-[10px] bg-green-900 text-green-200 px-1 rounded flex-shrink-0">ACTIF</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="sendCitrep('${data.name}')" class="flex-1 text-xs bg-blue-900/30 px-2 py-2 border border-blue-500 rounded text-blue-200 active:bg-blue-500 active:text-white">CITREP</button>
                            ${userRole === 'SL' ? `<button onclick="archiveMission('${data.id}')" class="flex-1 text-xs bg-red-900/30 px-2 py-2 border border-red-500 rounded text-red-200 active:bg-red-500 active:text-white">FIN</button>` : ''}
                        </div>
                    `;
          container.appendChild(el);
        });
      });
    }

    window.archiveMission = async (id) => {
      await updateDoc(publicDoc('missions', id), { status: 'ARCHIVED' });
      addLog("Mission terminée et archivée", "MISSION");
    };

    window.sendCitrep = async (missionName) => {
      const text = prompt("Message CITREP :");
      if (text) addLog(`[CITREP ${missionName}] ${text}`, 'RADIO');
    };

    window.requestRTB = () => {
      addLog(`DEMANDE DE RTB (RETOUR BASE) POUR ${userPseudo}`, 'RADIO');
    };

    // --- UTILS FOR UI ---
    window.toggleModal = (id) => {
      const el = document.getElementById(id);
      if (el) el.classList.toggle('hidden');
    };

    window.toggleSidebar = () => {
      const sidebar = document.getElementById('sidebar');
      const backdrop = document.getElementById('sidebar-backdrop');

      if (sidebar && backdrop) {
        if (sidebar.classList.contains('-translate-x-full')) {
          sidebar.classList.remove('-translate-x-full');
          backdrop.classList.remove('hidden');
        } else {
          sidebar.classList.add('-translate-x-full');
          backdrop.classList.add('hidden');
        }
      }
    };

  </script>

  <!-- Custom CSS for HUD & Mobile -->
  <style>
    :root {
      --neon-green: #22c55e;
      --bg-dark: #0f172a;
    }

    /* Mobile Reset & WebKit Tweaks */
    html,
    body {
      height: 100%;
      overflow: hidden;
      background-color: #050505;
      color: #e2e8f0;
      font-family: 'Share Tech Mono', monospace;
      -webkit-tap-highlight-color: transparent;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    /* Prevent rubber-banding on iOS */
    body {
      overscroll-behavior: none;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }

    ::-webkit-scrollbar-track {
      background: #0f172a;
    }

    ::-webkit-scrollbar-thumb {
      background: #15803d;
      border-radius: 2px;
    }

    /* Hide scrollbar utility */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* iOS Input Zoom Fix */
    @media screen and (max-width: 768px) {

      input,
      select,
      textarea {
        font-size: 16px !important;
      }
    }

    /* HUD Effects */
    .hud-panel {
      background: rgba(10, 20, 10, 0.95);
      border: 1px solid rgba(34, 197, 94, 0.3);
      box-shadow: 0 0 15px rgba(34, 197, 94, 0.1), inset 0 0 30px rgba(0, 0, 0, 0.9);
      position: relative;
    }

    .hud-panel::before {
      content: " ";
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
      background-size: 100% 2px;
      pointer-events: none;
      z-index: 0;
    }

    .clip-corner {
      clip-path: polygon(0 0,
          100% 0,
          100% calc(100% - 15px),
          calc(100% - 15px) 100%,
          0 100%);
    }

    .text-glow {
      text-shadow: 0 0 5px rgba(34, 197, 94, 0.8);
    }

    /* Scanline Animation - Subtle */
    .scan-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom, transparent, rgba(34, 197, 94, 0.05), transparent);
      animation: scanline 6s linear infinite;
      pointer-events: none;
      z-index: 9999;
    }

    @keyframes scanline {
      0% {
        transform: translateY(-100%);
      }

      100% {
        transform: translateY(100vh);
      }
    }

    .btn-tac {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid var(--neon-green);
      color: var(--neon-green);
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      touch-action: manipulation;
      /* Faster touch response */
    }

    .btn-tac:active {
      background: var(--neon-green);
      color: black;
      box-shadow: 0 0 15px var(--neon-green);
    }

    .modal-bg {
      background-color: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(4px);
    }

    /* Gradient Mask for scrolling containers */
    .mask-gradient {
      mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
      -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
    }
  </style>
</head>

<body class="flex flex-col">

  <!-- Scanline Effect -->
  <div class="scan-overlay"></div>

  <!-- AUTHENTICATION SCREEN -->
  <div id="auth-screen" class="fixed inset-0 z-[60] bg-black flex items-center justify-center p-4">
    <div class="hud-panel w-full max-w-md p-6 clip-corner relative flex flex-col max-h-[90vh] overflow-y-auto">
      <h1 class="text-3xl md:text-4xl font-bold text-center mb-2 text-green-500 text-glow tracking-tighter">LOGIOPS V2
      </h1>
      <div class="h-1 w-full bg-green-900 mb-6"></div>

      <!-- Role Selection -->
      <div class="flex gap-4 mb-6">
        <button
          onclick="document.getElementById('login-sl-form').classList.remove('hidden'); document.getElementById('login-log-form').classList.add('hidden');"
          class="flex-1 py-4 border border-green-700 active:bg-green-900/40 text-green-400 font-bold rounded touch-manipulation">
          <i class="fas fa-chess-king mb-1 block text-2xl"></i> SQUAD LEADER
        </button>
        <button onclick="showLogLogin()"
          class="flex-1 py-4 border border-green-700 active:bg-green-900/40 text-green-400 font-bold rounded touch-manipulation">
          <i class="fas fa-boxes mb-1 block text-2xl"></i> LOGISTICIEN
        </button>
      </div>

      <!-- SL Form -->
      <div id="login-sl-form" class="space-y-4">
        <div>
          <label class="text-xs text-green-700 block mb-1">GRADE</label>
          <div class="relative">
            <select id="sl-grade"
              class="w-full bg-gray-900 border border-green-800 p-3 text-white appearance-none rounded">
              <option>Sgt</option>
              <option>Sgt-Chef</option>
              <option>Adj</option>
              <option>Adj-Chef</option>
              <option>Lt</option>
              <option>Cpt</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-green-500">
              <i class="fas fa-chevron-down text-xs"></i>
            </div>
          </div>
        </div>
        <div>
          <label class="text-xs text-green-700 block mb-1">PSEUDO</label>
          <input id="sl-pseudo" type="text"
            class="w-full bg-gray-900 border border-green-800 p-3 text-white uppercase rounded" placeholder="NOM">
        </div>
        <button onclick="loginSL()" class="btn-tac w-full py-4 mt-4 font-bold rounded">PRENDRE LE SERVICE</button>
      </div>

      <!-- LOG Form -->
      <div id="login-log-form" class="hidden flex-1 flex flex-col min-h-0">
        <p class="text-xs text-green-600 mb-2 uppercase tracking-wider font-bold">Effectifs disponibles</p>
        <div id="roster-list-login"
          class="flex-1 overflow-y-auto pr-1 border border-green-900/30 bg-black/40 rounded p-2">
          <!-- Dynamic List -->
        </div>
      </div>

      <div class="mt-6 text-[10px] text-gray-600 text-center font-mono">
        SECURE CONNECTION // ENCRYPTED // FIREBASE RELAY
      </div>
    </div>
  </div>

  <!-- MAIN INTERFACE -->
  <div id="main-interface" class="flex-1 flex hidden relative z-10 h-full overflow-hidden">

    <!-- MOBILE SIDEBAR BACKDROP -->
    <div id="sidebar-backdrop" onclick="toggleSidebar()"
      class="fixed inset-0 bg-black/80 z-30 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

    <!-- SIDEBAR (DRAWER ON MOBILE) -->
    <aside id="sidebar"
      class="fixed inset-y-0 left-0 z-40 w-72 bg-gray-900/95 border-r border-green-900/50 flex flex-col transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out shadow-2xl md:shadow-none md:relative">
      <div class="p-4 border-b border-green-900/50 flex justify-between items-center bg-black/20">
        <div>
          <h2 class="text-2xl font-bold text-green-500 tracking-tighter">LOGIOPS</h2>
          <div class="text-[10px] text-green-700">LOGISTICS OPERATIONS COMMAND</div>
        </div>
        <button onclick="toggleSidebar()" class="md:hidden text-green-500 p-2"><i
            class="fas fa-times text-xl"></i></button>
      </div>

      <!-- User Card -->
      <div class="p-4 bg-green-900/10 border-b border-green-900/30">
        <div class="text-[10px] text-gray-500 uppercase mb-1">Session Active</div>
        <div id="user-identity" class="font-bold text-xl text-white tracking-wide">--</div>
        <div id="user-badge" class="inline-block px-2 py-0.5 bg-green-700 text-black text-xs font-bold rounded mt-2">--
        </div>
      </div>

      <!-- Active Mission List -->
      <div class="flex-1 p-4 overflow-y-auto -webkit-overflow-scrolling-touch">
        <div class="text-xs text-gray-500 mb-3 uppercase border-b border-gray-800 pb-1 font-bold">Missions en cours
        </div>
        <div id="mission-list" class="space-y-3 pb-20">
          <!-- Missions render here -->
        </div>
      </div>

      <!-- Controls (Bottom Sidebar) -->
      <div class="mt-auto border-t border-green-900/50 bg-black/40">
        <div id="sl-controls" class="p-4 hidden space-y-2">
          <button onclick="createMission()"
            class="btn-tac w-full py-3 text-sm font-bold rounded flex items-center justify-center gap-2"><i
              class="fas fa-plus-circle"></i> CRÉER MISSION</button>
          <button onclick="toggleModal('roster-modal')"
            class="btn-tac w-full py-3 text-sm font-bold rounded flex items-center justify-center gap-2"><i
              class="fas fa-users"></i> GÉRER ROSTER</button>
        </div>
        <div id="log-controls" class="p-4 hidden">
          <button onclick="requestRTB()"
            class="btn-tac w-full py-3 text-sm border-orange-500 text-orange-500 active:bg-orange-500 active:text-black font-bold rounded flex items-center justify-center gap-2"><i
              class="fas fa-home"></i> DEMANDER RTB</button>
        </div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col bg-black/80 relative min-w-0">

      <!-- HEADER / STATS BAR -->
      <header
        class="h-16 md:h-16 border-b border-green-900/50 flex items-center px-2 md:px-4 justify-between bg-gray-900/80 backdrop-blur z-20 shadow-md gap-2">

        <!-- Burger Menu -->
        <button onclick="toggleSidebar()" class="md:hidden p-3 text-green-500 active:text-white rounded">
          <i class="fas fa-bars text-xl"></i>
        </button>

        <div id="header-sl-name"
          class="hidden md:block font-mono text-green-600 text-xs border border-green-900 px-2 py-1 rounded whitespace-nowrap">
          CMD: --</div>

        <!-- KPI SCROLLABLE CONTAINER -->
        <div class="flex-1 overflow-x-auto no-scrollbar mx-2 mask-gradient">
          <div class="flex gap-4 md:gap-8 text-sm font-mono min-w-max px-2 items-center h-full py-1">
            <div class="flex flex-col items-center">
              <span class="text-[9px] text-gray-500 uppercase">Supply</span>
              <span id="supply-count" class="text-xl font-bold text-white text-glow">0</span>
            </div>
            <div class="w-px bg-green-900/50 h-6"></div>
            <div class="flex flex-col items-center">
              <span class="text-[9px] text-gray-500 uppercase">Total</span>
              <span class="text-lg font-bold text-green-400"><span id="stat-total-veh">0</span></span>
            </div>
            <div class="flex flex-col items-center">
              <span class="text-[9px] text-gray-500 uppercase">Ops</span>
              <span id="stat-ops" class="text-lg font-bold text-green-500">0</span>
            </div>
            <div class="flex flex-col items-center">
              <span class="text-[9px] text-gray-500 uppercase">Mission</span>
              <span id="stat-mission" class="text-lg font-bold text-blue-500">0</span>
            </div>
            <div class="flex flex-col items-center">
              <span class="text-[9px] text-gray-500 uppercase">Repair</span>
              <span id="stat-repair" class="text-lg font-bold text-orange-500">0</span>
            </div>
            <div class="flex flex-col items-center">
              <span class="text-[9px] text-gray-500 uppercase">Détruits</span>
              <span id="stat-destroyed" class="text-lg font-bold text-red-600">0</span>
            </div>
          </div>
        </div>

        <div>
          <button onclick="toggleModal('garage-modal')"
            class="btn-tac px-3 py-2 font-bold text-xs md:text-sm bg-green-900/20 rounded whitespace-nowrap flex items-center gap-2">
            <i class="fas fa-warehouse"></i> <span class="hidden sm:inline">GARAGE</span>
          </button>
        </div>
      </header>

      <!-- DASHBOARD GRID -->
      <div
        class="flex-1 p-2 md:p-4 overflow-y-auto -webkit-overflow-scrolling-touch bg-gradient-to-b from-transparent to-black/50">
        <div id="vehicle-grid"
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 md:gap-4 pb-4">
          <!-- Vehicle Cards Generated Here -->
          <div class="col-span-full text-center text-gray-600 mt-20 animate-pulse flex flex-col items-center">
            <i class="fas fa-satellite-dish text-4xl mb-4 opacity-50"></i>
            <span>INITIALISATION DU RÉSEAU...</span>
          </div>
        </div>
      </div>

      <!-- LOGS / NOTIFICATIONS FOOTER -->
      <div
        class="h-1/3 md:h-48 border-t border-green-900/50 bg-gray-900/95 flex text-xs font-mono shadow-[0_-5px_15px_rgba(0,0,0,0.5)] z-20">
        <!-- Notifications Live Feed -->
        <div class="w-2/5 md:w-1/3 border-r border-green-900/50 flex flex-col">
          <div
            class="bg-black/40 p-2 text-green-400 font-bold flex justify-between items-center border-b border-green-900/30">
            <span><i class="fas fa-satellite-dish mr-1"></i> LIVE</span>
            <span class="animate-pulse text-[10px] text-red-500">● REC</span>
          </div>
          <div id="notif-feed" class="flex-1 overflow-y-auto p-0 no-scrollbar -webkit-overflow-scrolling-touch">
            <!-- Live items -->
          </div>
        </div>

        <!-- Vacation Log (Table) -->
        <div class="flex-1 flex flex-col min-w-0">
          <div
            class="bg-black/40 p-2 text-green-400 font-bold flex justify-between items-center border-b border-green-900/30">
            <span class="truncate"><i class="fas fa-clipboard-list mr-1"></i> LOGS</span>
            <div class="flex gap-2">
              <button onclick="clearLogs()"
                class="hover:text-white px-2 py-1 rounded bg-red-900/20 text-[10px]">CLR</button>
            </div>
          </div>
          <div class="flex-1 overflow-y-auto -webkit-overflow-scrolling-touch">
            <table class="w-full text-left border-collapse">
              <tbody id="vacation-log-body" class="bg-black/20">
                <!-- Log rows -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- MODAL: GARAGE -->
  <div id="garage-modal" class="modal-bg fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="hud-panel w-full max-w-md p-6 relative rounded shadow-2xl">
      <button onclick="toggleModal('garage-modal')"
        class="absolute top-3 right-3 text-green-500 p-2 active:text-white"><i
          class="fas fa-times text-xl"></i></button>
      <h3 class="text-xl font-bold text-green-500 mb-4 border-b border-green-900 pb-2 flex items-center gap-2"><i
          class="fas fa-warehouse"></i> GARAGE CENTRAL</h3>

      <div class="space-y-4">
        <div>
          <label class="text-xs text-gray-400 block mb-1">TYPE DE VÉHICULE</label>
          <div class="relative">
            <select id="new-veh-type"
              class="w-full bg-black border border-green-700 p-3 text-white appearance-none rounded">
              <option value="LOGI">CAMION LOGISTIQUE (300s)</option>
              <option value="JEEP">JEEP LEGÈRE (100s)</option>
              <option value="TRANSPORT">CAMION TRANSPORT (200s)</option>
              <option value="BLINDE">BLINDÉ LÉGER (600s)</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-green-500">
              <i class="fas fa-chevron-down text-xs"></i>
            </div>
          </div>
        </div>
        <div>
          <label class="text-xs text-gray-400 block mb-1">NOM DE CODE</label>
          <input id="new-veh-name" type="text"
            class="w-full bg-black border border-green-700 p-3 text-white uppercase rounded" placeholder="EX: ALPHA-1">
        </div>

        <div class="pt-4 border-t border-green-900/50 mt-4 bg-green-900/10 p-3 rounded">
          <p class="text-[10px] text-gray-500 mb-2 font-bold uppercase">Ravitaillement Rapide</p>
          <div class="grid grid-cols-2 gap-3">
            <button onclick="addSupply(500)"
              class="border border-green-800 p-2 text-xs active:bg-green-900 rounded font-bold">+500 SUPPLY</button>
            <button onclick="addSupply(1000)"
              class="border border-green-800 p-2 text-xs active:bg-green-900 rounded font-bold">+1000 SUPPLY</button>
          </div>
        </div>

        <button onclick="createVehicle()" class="btn-tac w-full py-4 mt-2 font-bold rounded shadow-lg">SORTIR DU
          GARAGE</button>
      </div>
    </div>
  </div>

  <!-- MODAL: ROSTER -->
  <div id="roster-modal" class="modal-bg fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="hud-panel w-full max-w-md p-6 relative rounded shadow-2xl h-[80vh] flex flex-col">
      <button onclick="toggleModal('roster-modal')"
        class="absolute top-3 right-3 text-green-500 p-2 active:text-white"><i
          class="fas fa-times text-xl"></i></button>
      <h3 class="text-xl font-bold text-green-500 mb-4 border-b border-green-900 pb-2 flex items-center gap-2"><i
          class="fas fa-users-cog"></i> GESTION PERSONNEL</h3>

      <div class="flex-1 flex flex-col min-h-0">
        <div class="flex justify-between text-xs text-gray-400 mb-2 items-center">
          <span>ENREGISTRÉS: <span id="stat-log-count" class="text-white font-bold">0</span></span>
          <button onclick="addToRoster()"
            class="text-green-900 bg-green-500 hover:bg-green-400 px-3 py-2 rounded font-bold shadow-lg shadow-green-500/20 active:translate-y-0.5 transition-all"><i
              class="fas fa-plus mr-1"></i> AJOUTER</button>
        </div>
        <div id="sl-roster-list"
          class="flex-1 bg-black/50 border border-green-900 p-2 overflow-y-auto space-y-1 rounded -webkit-overflow-scrolling-touch">
          <!-- List -->
        </div>
      </div>
    </div>
  </div>

</body>

</html>
